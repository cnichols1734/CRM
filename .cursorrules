# CRM Project - Cursor AI Rules

## Plan Mode

- At the end of each plan, give me a list of unresolved questions to answer, if any.


## Project Overview
This is a Flask-based CRM application for Origen Realty real estate agents.
- **Framework**: Flask with SQLAlchemy
- **Database**: Supabase PostgreSQL (connection string in `.env`)
- **Hosting**: Railway
- **Repo**: https://github.com/cnichols1734/CRM

## Local Development
- **Port**: 5011
- **Start command**: `python3 app.py` (from project root)
- **Local URL**: http://127.0.0.1:5011

## Testing Rules
Never auto test UI tests unless I specifically ask for it  
- Once a feature is complete ask me if I am ready to push a PR for it before pushing it

## Testing Credentials
Test credentials are stored in the `.env` file:
- `TEST_USERNAME` - email for login
- `TEST_PASSWORD` - password for login

When testing features locally, read the `.env` file to get these credentials, then use the browser tools to:
1. Navigate to http://127.0.0.1:5011
2. Login with the test credentials
3. Test the feature

**Browser Login Form Note**: When filling the login form, use separate `browser_type` calls for username and password fields. Do NOT use `browser_fill_form` - it times out. Fill each field individually then click Sign in.

## AI Features
All AI features use a centralized service with GPT-5.1 fallback chain:
- **Service file**: `services/ai_service.py`
- **Model hierarchy**: GPT-5.1 → GPT-5-mini → GPT-4o

AI feature routes (each has its own custom prompt):
- `routes/action_plan.py` - 2026 Lead Generation Action Plan
- `routes/daily_todo.py` - AI-generated daily task list
- `routes/ai_chat.py` - B.O.B. (Business Optimization Buddy) chat assistant

## Deployment Workflow
After pushing changes to GitHub:
1. SSH into PythonAnywhere or use Bash console
2. Run: `cd ~/mysite && git pull origin main`
3. If new packages: `pip install -r requirements.txt --user`
4. Go to Web tab and click "Reload"

## Key Files
- `app.py` - Main Flask application
- `models.py` - SQLAlchemy database models
- `config.py` - Configuration (reads from .env)
- `feature_flags.py` - Feature toggles (deploys with code via git)
- `.env` - Environment variables (gitignored, contains secrets)
- `services/` - Shared services (AI, SendGrid)
- `routes/` - Flask blueprints/routes
- `templates/` - Jinja2 HTML templates
- `static/` - CSS, JS, images

## Feature Flags
Toggle features on/off in `feature_flags.py`. Changes deploy with git pull - no need to edit .env on server.


## Database
- **Production**: Supabase PostgreSQL
- **Local test DB**: is the same db in supabase that we use for prod so be careful
- **Production data backup**: `instance/crm (1).db`

## Database Migrations

This project uses Flask-Migrate (Alembic) for database migrations, managed through `manage_db.py`.

### Migration Commands
| Command | Description |
|---------|-------------|
| `python3 manage_db.py status` | Show current migration head and history |
| `python3 manage_db.py upgrade` | Apply pending migrations to database |
| `python3 manage_db.py migrate "message"` | Auto-generate a new migration |
| `python3 manage_db.py backup` | Create database backup (SQLite only) |

### Creating a New Migration (CRITICAL)

**ALWAYS check the current head before creating a migration:**

```bash
python3 manage_db.py status
```

Look for the **Current revision** line - this is the head your migration must depend on.

**When writing a migration file manually** (in `migrations/versions/`):
1. Set `down_revision` to the current head revision ID (e.g., `'4fc5aacd858e'`)
2. Use a descriptive `revision` ID (e.g., `'add_google_calendar_sync'`)
3. Use `IF NOT EXISTS` / `IF EXISTS` in SQL for safety

**Example migration file structure:**
```python
revision = 'add_my_feature'
down_revision = '<CURRENT_HEAD_ID>'  # Get this from `manage_db.py status`
branch_labels = None
depends_on = None

def upgrade():
    op.execute("""
        ALTER TABLE my_table
        ADD COLUMN IF NOT EXISTS my_column VARCHAR(255);
    """)

def downgrade():
    op.execute("""
        ALTER TABLE my_table
        DROP COLUMN IF EXISTS my_column;
    """)
```

### Common Migration Issues

**Multiple head revisions error:**
If you see "Multiple head revisions are present", your migration's `down_revision` points to an old revision. Fix by updating `down_revision` to the actual current head.

**Running migrations:**
After creating or updating a migration file, run:
```bash
python3 manage_db.py upgrade
```

## PR & Commit Rules
Always use the PR workflow - commit changes to a branch and push for review in GitHub.

### Branch & Commit Naming Convention
Use conventional commit prefixes for branches and commit messages:

| Prefix | Use For |
|--------|---------|
| `feat:` | New features (e.g., `feat: add contact import wizard`) |
| `fix:` | Bug fixes (e.g., `fix: resolve login redirect loop`) |
| `chore:` | Maintenance, dependencies, configs (e.g., `chore: update requirements.txt`) |
| `refactor:` | Code restructuring without behavior change (e.g., `refactor: extract base.html inline JS`) |
| `docs:` | Documentation only (e.g., `docs: update README with deploy steps`) |
| `style:` | Formatting, CSS, no logic change (e.g., `style: fix button alignment on mobile`) |
| `test:` | Adding or updating tests (e.g., `test: add scheduled integration tests`) |
| `perf:` | Performance improvements (e.g., `perf: optimize contact list query`) |

### Branch Naming
Use the same prefix with kebab-case description:
- `feat/contact-import-wizard`
- `fix/login-redirect-loop`
- `chore/update-dependencies`
- `refactor/base-js`

### PR Workflow
**IMPORTANT: Before starting ANY new feature or fix:**
1. Ensure you are on `main` branch
2. Run `git pull origin main` to sync with remote
3. Only then create the feature branch and begin work

**Steps:**
1. Sync with main: `git checkout main && git pull origin main`
2. Create feature branch with appropriate prefix
3. Make commits with conventional prefixes
4. Push branch to origin
5. User reviews and creates PR via GitHub UI (one-click merge)

## Important Notes
- The `.env` file is gitignored - never commit secrets
- PythonAnywhere has its own `.env` file at `~/mysite/.env`
