{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "document-definition-v1.0",
  "title": "Document Definition",
  "description": "Schema for document definitions that drive the document generation system",
  "type": "object",
  "required": ["schema_version", "slug", "name", "docuseal_template_id", "type", "display", "roles", "fields"],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$",
      "description": "Schema version (e.g., '1.0')"
    },
    "slug": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "Stable identifier, kebab-case"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "description": "Display name for the document"
    },
    "docuseal_template_id": {
      "type": "integer",
      "minimum": 1,
      "description": "DocuSeal template ID"
    },
    "type": {
      "type": "string",
      "enum": ["form-driven", "pdf-preview"],
      "description": "Document type"
    },
    "display": {
      "type": "object",
      "required": ["color", "icon", "sort_order"],
      "properties": {
        "color": {
          "type": "string",
          "pattern": "^#[0-9A-Fa-f]{6}$",
          "description": "Hex color code"
        },
        "icon": {
          "type": "string",
          "description": "Font Awesome icon class"
        },
        "sort_order": {
          "type": "integer",
          "minimum": 0,
          "description": "Display order (lower = first)"
        }
      },
      "additionalProperties": false
    },
    "form": {
      "type": "object",
      "required": ["template", "partial"],
      "properties": {
        "template": {
          "type": "string",
          "description": "Form template filename"
        },
        "partial": {
          "type": "string",
          "description": "Form partial filename"
        }
      },
      "additionalProperties": false,
      "description": "Required for form-driven documents"
    },
    "roles": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["role_key", "docuseal_role", "email_source", "name_source"],
        "properties": {
          "role_key": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$",
            "description": "Stable internal identifier, snake_case"
          },
          "docuseal_role": {
            "type": "string",
            "minLength": 1,
            "description": "Exact DocuSeal role name"
          },
          "email_source": {
            "type": "string",
            "description": "Source path for email"
          },
          "name_source": {
            "type": "string",
            "description": "Source path for display name"
          },
          "optional": {
            "type": "boolean",
            "default": false,
            "description": "Skip if source resolves to null"
          },
          "auto_complete": {
            "type": "boolean",
            "default": false,
            "description": "Auto-complete this submitter (for roles with only readonly/pre-filled fields)"
          }
        },
        "additionalProperties": false
      }
    },
    "fields": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["field_key", "docuseal_field", "role_key"],
        "properties": {
          "field_key": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$",
            "description": "Stable internal identifier, snake_case"
          },
          "docuseal_field": {
            "type": "string",
            "minLength": 1,
            "description": "Exact DocuSeal field name"
          },
          "role_key": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$",
            "description": "Role this field belongs to"
          },
          "source": {
            "type": ["string", "null"],
            "description": "Single data source path (null = manual entry). Use 'source' for single fields, 'sources' for combined fields."
          },
          "sources": {
            "type": "array",
            "items": { "type": "string" },
            "minItems": 2,
            "description": "Multiple source paths for combined fields (e.g., address components). Use with 'template'."
          },
          "template": {
            "type": "string",
            "description": "Format template for combined fields. Supports positional ({0}, {1}) or named ({field_name}) placeholders."
          },
          "transform": {
            "type": "string",
            "description": "Optional transform function name (applied after combining for combined fields)"
          },
          "condition_field": {
            "type": "string",
            "description": "Field to check for conditional inclusion (e.g., 'form.doc_responsibility')"
          },
          "condition_equals": {
            "type": "string",
            "description": "Value that condition_field must equal for this field to be included"
          }
        },
        "additionalProperties": false,
        "oneOf": [
          {
            "properties": {
              "source": { "type": ["string", "null"] }
            },
            "not": { "required": ["sources"] }
          },
          {
            "required": ["sources", "template"],
            "not": { "required": ["source"] }
          }
        ]
      }
    }
  },
  "additionalProperties": false,
  "allOf": [
    {
      "if": {
        "properties": { "type": { "const": "form-driven" } }
      },
      "then": {
        "required": ["form"]
      }
    }
  ]
}

