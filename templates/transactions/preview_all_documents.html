{% extends "base.html" %}

{% block title %}Preview Documents - {{ transaction.street_address }}{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* DocuSeal embed container and PDF iframe container */
    .docuseal-embed-container {
        min-height: 700px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
    }
    
    /* PDF iframe styling - taller to show full single-page documents */
    .pdf-embed-container {
        min-height: 1100px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
    }
    
    .pdf-embed-container iframe {
        width: 100%;
        height: 1100px;
        border: none;
        border-radius: 8px;
    }

    .docuseal-embed-container docuseal-form {
        display: block;
        width: 100%;
        min-height: 700px;
    }

    /* Hide DocuSeal submit button in preview mode */
    docuseal-form::part(submit-button) {
        display: none !important;
    }

    /* Document tabs */
    .doc-tab {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .doc-tab.active {
        border-color: #f97316;
        background: linear-gradient(135deg, #fff7ed, #ffedd5);
    }

    .doc-tab:not(.active):hover {
        border-color: #cbd5e1;
        background: #f8fafc;
    }

    /* Document preview panel - all visible for scrolling */
    .doc-preview-panel {
        display: block;
        scroll-margin-top: 140px; /* Account for sticky header */
    }
    
    /* Smooth scrolling for the page */
    html {
        scroll-behavior: smooth;
    }
    
    /* Back to top button */
    .back-to-top {
        position: fixed;
        bottom: 100px;
        right: 24px;
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 45;
    }
    
    .back-to-top.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .back-to-top:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(249, 115, 22, 0.5);
    }
    
    @media (max-width: 640px) {
        .back-to-top {
            bottom: 140px;
        }
    }

    /* Mock mode placeholder */
    .mock-preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-radius: 12px;
        border: 2px dashed #e2e8f0;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .loading-overlay.show {
        display: flex;
        animation: overlayFadeIn 0.3s ease-out forwards;
    }

    @keyframes overlayFadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2.5rem 3rem;
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: contentSlideUp 0.4s ease-out forwards;
    }

    @keyframes contentSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .spinner-ring {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        border: 4px solid #f1f5f9;
        border-top-color: #f97316;
        border-right-color: #8b5cf6;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        margin-top: 1.5rem;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
    }

    .loading-subtext {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #64748b;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }
    
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-out forwards;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
    <!-- Header -->
    <div class="bg-white border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Back button and title -->
                <div class="flex items-center gap-4">
                    <a href="{{ url_for('transactions.fill_all_documents', id=transaction.id) }}"
                        class="flex items-center gap-2 text-slate-600 hover:text-slate-800 transition-colors">
                        <i class="fas fa-arrow-left"></i>
                        <span class="hidden sm:inline">Back to Forms</span>
                    </a>
                    <div class="h-6 w-px bg-slate-200"></div>
                    <div>
                        <h1 class="text-lg font-semibold text-slate-800">Preview & Send Documents</h1>
                        <p class="text-xs text-slate-500">{{ transaction.street_address }}</p>
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="flex items-center gap-2 sm:gap-3">
                    {% if mock_mode %}
                    <span class="px-2 py-1 text-xs bg-amber-100 text-amber-700 rounded-full font-medium">
                        <i class="fas fa-flask mr-1"></i>Test Mode
                    </span>
                    {% endif %}
                    <a href="{{ url_for('transactions.fill_all_documents', id=transaction.id) }}" 
                       class="px-3 py-2 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-edit"></i>
                        <span class="hidden sm:inline">Edit Forms</span>
                    </a>
                    <button onclick="printAllDocuments()" 
                            class="px-3 py-2 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-print"></i>
                        <span class="hidden sm:inline">Print All</span>
                    </button>
                    <button onclick="confirmAndSendAll()" 
                            class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-lg shadow-sm transition-all flex items-center gap-2"
                            {% if not signers %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i>
                        <span class="hidden sm:inline">Send All</span>
                        <span class="px-1.5 py-0.5 text-xs bg-white/20 rounded">{{ documents|length }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview info banner -->
    <div class="bg-blue-50 border-b border-blue-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center gap-3 text-blue-800">
                <i class="fas fa-eye text-blue-500"></i>
                <p class="text-sm">
                    <strong>Preview Mode:</strong>
                    Review each document below. Print for physical signatures, or click "Send All for Signature" for e-signing.
                </p>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

        <!-- Document Tabs -->
        {% if documents|length > 1 %}
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
            <div class="flex flex-wrap gap-3">
                {% for doc in documents %}
                {% set preview = preview_docs[loop.index0] %}
                {% set config = preview.config %}
                <button type="button" class="doc-tab flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 border-slate-200 font-medium text-sm transition-all
                               {% if loop.first %}active{% endif %}" data-doc-index="{{ loop.index0 }}"
                    onclick="switchDocument({{ loop.index0 }})">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center
                        {% if config %}bg-{{ config.color }}-100{% else %}bg-slate-100{% endif %}">
                        <i class="fas {{ config.icon if config else 'fa-file-alt' }}
                            {% if config %}text-{{ config.color }}-600{% else %}text-slate-600{% endif %}"></i>
                    </div>
                    <span class="text-slate-700">{{ doc.template_name }}</span>
                    {% if preview.is_static %}
                    <span class="px-1.5 py-0.5 text-[10px] font-semibold rounded bg-teal-100 text-teal-700">Static</span>
                    {% elif preview.is_external %}
                    <span class="px-1.5 py-0.5 text-[10px] font-semibold rounded bg-purple-100 text-purple-700">External</span>
                    {% endif %}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Document Preview Panels -->
        {% for doc in documents %}
        {% set preview = preview_docs[loop.index0] %}
        {% set config = preview.config %}

        <div id="doc-panel-{{ loop.index0 }}" class="doc-preview-panel" data-doc-index="{{ loop.index0 }}">
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                <!-- Document header with explicit gradient colors -->
                {% set color_map = {
                    'orange': ['#ea580c', '#c2410c'],
                    'blue': ['#2563eb', '#1d4ed8'],
                    'emerald': ['#059669', '#047857'],
                    'purple': ['#9333ea', '#7e22ce'],
                    'teal': ['#0d9488', '#0f766e'],
                    'slate': ['#475569', '#334155'],
                    'red': ['#dc2626', '#b91c1c'],
                    'amber': ['#d97706', '#b45309'],
                    'indigo': ['#4f46e5', '#4338ca'],
                    'rose': ['#e11d48', '#be123c']
                } %}
                {% set header_colors = color_map.get(config.color, ['#475569', '#334155']) if config else ['#475569', '#334155'] %}
                <div class="px-6 py-4" style="background: linear-gradient(to right, {{ header_colors[0] }}, {{ header_colors[1] }});">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                            <i class="fas {{ config.icon if config else 'fa-file-alt' }} text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h2 class="font-semibold text-white text-lg">{{ doc.template_name }}</h2>
                            {% if preview.is_static %}
                            <p class="text-white/80 text-sm">Uploaded document (no signatures required)</p>
                            {% elif preview.is_external %}
                            <p class="text-white/80 text-sm">External document with signature fields</p>
                            {% else %}
                            <p class="text-white/80 text-sm">Scroll through to review all pages</p>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2">
                            {% if preview.is_static %}
                            <span class="px-3 py-1.5 bg-teal-400/30 text-white text-xs font-medium rounded-full">
                                <i class="fas fa-file-pdf mr-1"></i>Static PDF
                            </span>
                            {% elif preview.is_external %}
                            <span class="px-3 py-1.5 bg-purple-400/30 text-white text-xs font-medium rounded-full">
                                <i class="fas fa-file-import mr-1"></i>External
                            </span>
                            {% endif %}
                            {% if documents|length > 1 %}
                            <span class="px-3 py-1.5 bg-white/20 text-white text-sm font-medium rounded-full">
                                Document {{ loop.index }} of {{ documents|length }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Document preview body -->
                <div class="p-6">
                    {% if preview.pdf_url %}
                    <!-- Static/External document - PDF iframe preview (taller to show full page) -->
                    <div class="pdf-embed-container" style="min-height: 1100px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; background: #f9fafb;">
                        <iframe src="{{ preview.pdf_url }}" 
                                style="width: 100%; height: 1100px; border: none; border-radius: 8px;"
                                title="{{ doc.template_name }}">
                        </iframe>
                    </div>
                    {% if preview.is_static %}
                    <div class="mt-4 p-4 bg-teal-50 border border-teal-200 rounded-lg">
                        <p class="text-sm text-teal-800 flex items-center gap-2">
                            <i class="fas fa-info-circle"></i>
                            This document is included as-is and does not require signatures.
                        </p>
                    </div>
                    {% elif preview.is_external %}
                    <div class="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-signature text-purple-600 mt-0.5"></i>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium text-purple-800">
                                        Signature Fields Configured
                                    </p>
                                    <a href="{{ url_for('transactions.document_field_editor', id=transaction.id, doc_id=doc.id) }}" 
                                       target="_blank"
                                       class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium rounded-lg transition-colors">
                                        <i class="fas fa-eye"></i>
                                        View Field Positions
                                    </a>
                                </div>
                                {% if preview.field_summary %}
                                <div class="flex flex-wrap gap-2">
                                    {% for role, info in preview.field_summary.items() %}
                                    <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-user-pen"></i>
                                        {{ role }}: {{ info.count }} field{{ 's' if info.count > 1 else '' }}
                                        <span class="text-purple-500">({{ info.types|join(', ') }})</span>
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-xs text-purple-600">
                                    This document has signature fields placed and will be sent for e-signature.
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% elif mock_mode and not preview.is_static and not preview.is_external %}
                    <!-- Mock mode placeholder for template docs -->
                    <div class="mock-preview-placeholder">
                        <div class="w-20 h-20 rounded-full bg-amber-100 flex items-center justify-center mb-4">
                            <i class="fas fa-file-alt text-4xl text-amber-500"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-800 mb-2">{{ doc.template_name }}</h3>
                        <p class="text-slate-600 max-w-md text-center mb-6">
                            DocuSeal is running in test mode. In production, the actual filled PDF document
                            would be displayed here for you to review.
                        </p>
                        <div class="bg-white rounded-xl border border-slate-200 p-6 max-w-md text-left">
                            <h4 class="font-medium text-slate-700 mb-3 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Document Ready
                            </h4>
                            <ul class="space-y-2 text-sm text-slate-600">
                                <li class="flex items-center gap-2">
                                    <i class="fas fa-edit text-slate-400 w-4"></i>
                                    Form data has been filled
                                </li>
                                <li class="flex items-center gap-2">
                                    <i class="fas fa-file-pdf text-red-400 w-4"></i>
                                    PDF will be generated on send
                                </li>
                                <li class="flex items-center gap-2">
                                    <i class="fas fa-paper-plane text-blue-400 w-4"></i>
                                    Ready for e-signature
                                </li>
                            </ul>
                        </div>
                    </div>
                    {% elif preview.embed_src %}
                    <!-- Real DocuSeal embed preview -->
                    <div class="docuseal-embed-container">
                        <script src="https://cdn.docuseal.com/js/form.js"></script>
                        <docuseal-form data-src="{{ preview.embed_src }}" data-preview="true" data-readonly="true">
                        </docuseal-form>
                    </div>
                    {% elif preview.error %}
                    <!-- Error state -->
                    <div class="text-center py-12">
                        <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                        </div>
                        <h3 class="font-semibold text-slate-800 mb-2">Preview Error</h3>
                        <p class="text-slate-600 mb-4">{{ preview.error }}</p>
                        <a href="{{ url_for('transactions.fill_all_documents', id=transaction.id) }}"
                            class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors">
                            <i class="fas fa-edit"></i>
                            Edit Form Data
                        </a>
                    </div>
                    {% else %}
                    <!-- No template configured -->
                    <div class="text-center py-12">
                        <div class="w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-cog text-2xl text-amber-500"></i>
                        </div>
                        <h3 class="font-semibold text-slate-800 mb-2">Template Not Configured</h3>
                        <p class="text-slate-600">
                            This document template hasn't been set up in DocuSeal yet.
                            Contact support to configure e-signatures for this document.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Navigation between documents (for multi-doc) -->
        {% if documents|length > 1 %}
        <div class="flex justify-between items-center bg-white rounded-xl shadow-sm border border-slate-200 px-6 py-4">
            <button type="button" id="prevDocBtn" onclick="prevDocument()"
                class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                <i class="fas fa-arrow-left"></i>
                Previous Document
            </button>
            <span id="docCounter" class="text-sm text-slate-500">Document 1 of {{ documents|length }}</span>
            <button type="button" id="nextDocBtn" onclick="nextDocument()"
                class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium flex items-center gap-2 transition-colors">
                Next Document
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
        {% endif %}

        <!-- Signers Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                        <i class="fas fa-users text-white"></i>
                    </div>
                    <div>
                        <h2 class="font-semibold text-white">Signers</h2>
                        <p class="text-xs text-orange-100">These people will receive the signing invitation</p>
                    </div>
                </div>
            </div>

            <div class="p-6">
                {% if signers %}
                <div class="space-y-4">
                    {% for signer in signers %}
                    <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl">
                        <div
                            class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white font-bold text-lg">
                            {{ signer.name[0]|upper if signer.name else '?' }}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-slate-800">{{ signer.name }}</h4>
                            <p class="text-sm text-slate-500">{{ signer.email }}</p>
                        </div>
                        <span class="px-3 py-1.5 bg-slate-200 text-slate-700 text-xs font-medium rounded-full">
                            {{ signer.role }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-amber-500"></i>
                    </div>
                    <h3 class="font-semibold text-slate-800 mb-2">No Signers Found</h3>
                    <p class="text-slate-600 mb-4">Please ensure the transaction has participants with valid email
                        addresses.</p>
                    <a href="{{ url_for('transactions.view_transaction', id=transaction.id) }}"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                        <i class="fas fa-user-plus"></i>
                        Add Participants
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Summary Card -->
        {% set static_count = preview_docs|selectattr('is_static')|list|length %}
        {% set external_count = preview_docs|selectattr('is_external')|list|length %}
        {% set template_count = documents|length - static_count - external_count %}
        <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-2xl shadow-lg p-6 text-white">
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                    <i class="fas fa-envelope-open-text text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-bold text-lg mb-1">Ready to Send</h3>
                    <p class="text-emerald-100 text-sm mb-3">
                        When you send, {{ signers|length }} signer(s) will receive an email with a link to sign
                        all documents in one session. They can sign from any device.
                    </p>
                    <div class="flex flex-wrap gap-2">
                        {% if template_count > 0 %}
                        <span class="px-2 py-1 bg-white/20 rounded text-xs font-medium">
                            <i class="fas fa-file-signature mr-1"></i>{{ template_count }} Template Doc{{ 's' if template_count > 1 else '' }}
                        </span>
                        {% endif %}
                        {% if external_count > 0 %}
                        <span class="px-2 py-1 bg-purple-400/40 rounded text-xs font-medium">
                            <i class="fas fa-file-import mr-1"></i>{{ external_count }} External Doc{{ 's' if external_count > 1 else '' }}
                        </span>
                        {% endif %}
                        {% if static_count > 0 %}
                        <span class="px-2 py-1 bg-teal-400/40 rounded text-xs font-medium">
                            <i class="fas fa-file-pdf mr-1"></i>{{ static_count }} Static PDF{{ 's' if static_count > 1 else '' }} (no signature)
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Add padding for any mobile elements -->
    <div class="h-8"></div>
    
    <!-- Floating action bar for mobile -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 sm:hidden z-50">
        <div class="flex gap-2">
            <a href="{{ url_for('transactions.fill_all_documents', id=transaction.id) }}" 
               class="px-3 py-3 text-center text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <i class="fas fa-edit"></i>
            </a>
            <button onclick="printAllDocuments()" 
                    class="px-3 py-3 text-center text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                <i class="fas fa-print"></i>
            </button>
            <button onclick="confirmAndSendAll()" 
                    class="flex-1 px-4 py-3 text-center text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-lg shadow-sm transition-all"
                    {% if not signers %}disabled{% endif %}>
                <i class="fas fa-paper-plane mr-2"></i>Send All ({{ documents|length }})
            </button>
        </div>
    </div>
    
    <!-- Add padding for mobile action bar -->
    <div class="h-20 sm:hidden"></div>
    
    <!-- Back to Top Button -->
    <button id="backToTopBtn" class="back-to-top" onclick="scrollToTop()" title="Back to top">
        <i class="fas fa-arrow-up"></i>
    </button>
</div>

<!-- Confirmation Modal -->
<div id="sendModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 relative animate-fade-in-up">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-full bg-orange-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-paper-plane text-2xl text-orange-600"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">Send All Documents?</h3>
                <p class="text-slate-600 mt-2">
                    This will send <strong>{{ documents|length }} document{{ 's' if documents|length > 1 else '' }}</strong> to all signers via email.
                </p>
            </div>
            
            <!-- Documents summary -->
            <div class="bg-slate-50 rounded-xl p-4 mb-4">
                <h4 class="text-sm font-medium text-slate-700 mb-2">Documents:</h4>
                <div class="space-y-1 max-h-32 overflow-y-auto">
                    {% for doc in documents %}
                    <div class="flex items-center gap-2 text-sm text-slate-600">
                        <i class="fas fa-file-alt text-slate-400"></i>
                        {{ doc.template_name }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Signers list -->
            <div class="bg-slate-50 rounded-xl p-4 mb-6">
                <h4 class="text-sm font-medium text-slate-700 mb-3">Signers:</h4>
                <div class="space-y-2">
                    {% for signer in signers %}
                    <div class="flex items-center gap-3 text-sm">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white font-bold text-xs">
                            {{ signer.name[0]|upper if signer.name else '?' }}
                        </div>
                        <div>
                            <div class="font-medium text-slate-800">{{ signer.name }}</div>
                            <div class="text-slate-500">{{ signer.email }} â€¢ {{ signer.role }}</div>
                        </div>
                    </div>
                    {% endfor %}
                    {% if not signers %}
                    <div class="text-sm text-amber-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        No signers found. Add participants with email addresses.
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeModal()" 
                        class="flex-1 px-4 py-3 text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
                    Cancel
                </button>
                <form action="{{ url_for('transactions.send_all_for_signature', id=transaction.id) }}" method="POST" class="flex-1">
                    <button type="submit" 
                            id="confirmSendBtn"
                            onclick="showSendingOverlay()"
                            class="w-full px-4 py-3 text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2"
                            {% if not signers %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i>
                        Send Now
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner-ring"></div>
        <div class="loading-text">Sending Documents...</div>
        <div class="loading-subtext">Preparing signature requests</div>
    </div>
</div>

<script>
    const totalDocs = {{ documents| length }};
    let currentDocIndex = 0;

    function switchDocument(index) {
        currentDocIndex = index;

        // Update active tab styling
        document.querySelectorAll('.doc-tab').forEach((tab, i) => {
            tab.classList.toggle('active', i === index);
        });

        // Scroll to the document panel
        const targetPanel = document.getElementById(`doc-panel-${index}`);
        if (targetPanel) {
            targetPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function prevDocument() {
        if (currentDocIndex > 0) {
            switchDocument(currentDocIndex - 1);
        }
    }

    function nextDocument() {
        if (currentDocIndex < totalDocs - 1) {
            switchDocument(currentDocIndex + 1);
        }
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Show/hide back to top button based on scroll position
    function handleScroll() {
        const backToTopBtn = document.getElementById('backToTopBtn');
        if (window.scrollY > 400) {
            backToTopBtn.classList.add('visible');
        } else {
            backToTopBtn.classList.remove('visible');
        }
        
        // Update active tab based on scroll position
        updateActiveTabOnScroll();
    }
    
    function updateActiveTabOnScroll() {
        const panels = document.querySelectorAll('.doc-preview-panel');
        const tabs = document.querySelectorAll('.doc-tab');
        
        panels.forEach((panel, index) => {
            const rect = panel.getBoundingClientRect();
            // If the panel is near the top of the viewport
            if (rect.top <= 200 && rect.bottom > 200) {
                currentDocIndex = index;
                tabs.forEach((tab, i) => {
                    tab.classList.toggle('active', i === index);
                });
            }
        });
    }

    // Modal functions
    function confirmAndSendAll() {
        const signerCount = {{ signers|length }};
        if (signerCount === 0) {
            showToast('Please add signers with email addresses before sending.', 'error');
            return;
        }
        document.getElementById('sendModal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('sendModal').classList.add('hidden');
    }
    
    function showSendingOverlay() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.add('show');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        // Add scroll listener for back-to-top button and active tab tracking
        window.addEventListener('scroll', handleScroll);
        
        // Initial check
        handleScroll();
    });
    
    // Document IDs for printing
    const transactionId = {{ transaction.id }};
    const documentIds = [{% for doc in documents %}{{ doc.id }}{% if not loop.last %}, {% endif %}{% endfor %}];
    
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-24 sm:bottom-6 right-6 px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3 ${
            type === 'success' ? 'bg-green-600 text-white' : 
            type === 'error' ? 'bg-red-600 text-white' : 
            'bg-slate-800 text-white'
        }`;
        toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
            toast.style.transition = 'all 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }
    
    async function printAllDocuments() {
        showToast('Preparing combined document for printing...', 'info');
        
        try {
            // Fetch the COMBINED PDF URL (all docs merged into one)
            const response = await fetch(`/transactions/${transactionId}/documents/print-all-pdf`);
            const data = await response.json();
            
            if (data.success && data.url) {
                // Open the combined PDF in a new tab
                const printWindow = window.open(data.url, '_blank');
                if (printWindow) {
                    showToast(`Combined PDF opened (${data.document_count} documents). Use browser print (Ctrl/Cmd+P).`, 'success');
                } else {
                    // Popup blocked - show link
                    showPrintLink(data.url, data.filename);
                }
            } else {
                showToast(data.error || 'Failed to prepare combined PDF for printing.', 'error');
            }
        } catch (err) {
            console.error('Error fetching combined PDF:', err);
            showToast('Failed to prepare documents for printing. Please try again.', 'error');
        }
    }
    
    function showPrintLink(url, filename) {
        // Remove any existing modal
        const existingModal = document.getElementById('printModal');
        if (existingModal) existingModal.remove();
        
        // Create modal with single link
        const modal = document.createElement('div');
        modal.id = 'printModal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
        modal.innerHTML = `
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closePrintModal()"></div>
            <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6 animate-fade-in-up">
                <button onclick="closePrintModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
                
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-amber-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800">Pop-up Blocked</h3>
                    <p class="text-slate-600 mt-2">
                        Your browser blocked the PDF. Click below to open it manually.
                    </p>
                </div>
                
                <a href="${url}" target="_blank" onclick="closePrintModal()"
                   class="flex items-center justify-center gap-3 w-full p-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors font-medium">
                    <i class="fas fa-file-pdf"></i>
                    Open Combined PDF
                    <i class="fas fa-external-link-alt text-sm"></i>
                </a>
                
                <p class="text-xs text-slate-500 text-center mt-4">
                    Use your browser's print function (Ctrl/Cmd+P) after opening.
                </p>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    function closePrintModal() {
        const modal = document.getElementById('printModal');
        if (modal) modal.remove();
    }
</script>
{% endblock %}