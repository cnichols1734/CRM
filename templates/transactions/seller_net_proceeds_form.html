{% extends "base.html" %}

{% block title %}Seller's Estimated Net Proceeds - {{ transaction.street_address }} - TechnolOG{% endblock %}

{% block content %}
<style>
    /* Document-style form styling */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    /* Document container - modern paper look */
    .document-container {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 30px -5px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        max-width: 850px;
        margin: 0 auto;
    }

    .document-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 1rem 1rem 0 0;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .document-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.1) 0%, transparent 50%);
        pointer-events: none;
    }

    .document-header h1 {
        font-size: 1.375rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        margin: 0;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .document-header .subtitle {
        font-size: 0.75rem;
        opacity: 0.85;
        margin-top: 0.375rem;
        letter-spacing: 0.025em;
    }

    .document-body {
        padding: 1.75rem 2rem 2rem;
    }

    .disclaimer-text {
        font-size: 0.8125rem;
        font-style: italic;
        color: #64748b;
        text-align: center;
        margin-bottom: 1.75rem;
        padding-bottom: 1.25rem;
        border-bottom: 1px solid #f1f5f9;
    }

    /* Form layout sections */
    .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        gap: 0.5rem;
    }

    .form-row label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #333;
        white-space: nowrap;
    }

    .form-row .field-line {
        flex: 1;
        border-bottom: 1.5px solid #ccc;
        min-height: 1.75rem;
        display: flex;
        align-items: flex-end;
    }

    .form-row input.doc-field {
        border: none;
        border-bottom: 2px solid #3b82f6;
        background: #f8fafc;
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
        width: 100%;
        transition: all 0.2s;
    }

    .form-row input.doc-field:focus {
        outline: none;
        background: #eff6ff;
        border-bottom-color: #1d4ed8;
    }

    .form-row input.doc-field[readonly] {
        background: #f1f5f9;
        border-bottom-color: #94a3b8;
        color: #64748b;
    }

    .form-row input.doc-field.calculated {
        background: #ecfdf5;
        border-bottom-color: #10b981;
        color: #065f46;
        font-weight: 600;
    }

    /* Two-column sections */
    .two-column-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .two-column-section {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }

    .section-box {
        border: 1.5px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 1.25rem;
        background: #fafbfc;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .section-title {
        font-size: 0.9375rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 1rem;
        padding-bottom: 0.625rem;
        border-bottom: 2px solid #334155;
        letter-spacing: 0.01em;
    }

    /* Cost row - label on left, amount on right */
    .cost-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.8125rem;
    }

    .cost-row label {
        color: #475569;
        flex: 1;
    }

    .cost-row .percent-input {
        width: 45px;
        padding: 0.25rem;
        border: 1.5px solid #ccc;
        border-radius: 0.25rem;
        font-size: 0.8125rem;
        text-align: center;
        margin-right: 0.25rem;
    }

    .cost-row .percent-input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    /* Money field wrapper with $ prefix */
    .money-field-wrapper {
        display: flex;
        align-items: center;
        max-width: 150px;
        background: #f8fafc;
        border-bottom: 2px solid #3b82f6;
        transition: all 0.2s;
    }

    .money-field-wrapper:focus-within {
        background: #eff6ff;
        border-bottom-color: #1d4ed8;
    }

    .money-prefix {
        padding: 0.375rem 0 0.375rem 0.5rem;
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .money-field-wrapper .doc-field.money-field {
        border: none;
        background: transparent;
        padding: 0.375rem 0.5rem 0.375rem 0.25rem;
        width: 100%;
    }

    .money-field-wrapper .doc-field.money-field:focus {
        outline: none;
        background: transparent;
    }

    /* Money input wrapper for cost rows */
    .money-input-wrapper {
        display: flex;
        align-items: center;
        border: 1.5px solid #e2e8f0;
        border-radius: 0.375rem;
        background: #fff;
        overflow: hidden;
        transition: all 0.2s;
        min-width: 110px;
    }

    .money-input-wrapper:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .money-input-wrapper .dollar-sign {
        padding: 0.25rem 0 0.25rem 0.5rem;
        color: #94a3b8;
        font-size: 0.8125rem;
        font-weight: 500;
        background: #f8fafc;
    }

    .money-input-wrapper.calculated {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .money-input-wrapper.calculated .dollar-sign {
        background: #f1f5f9;
        color: #94a3b8;
    }

    .cost-row .money-input {
        width: 100%;
        padding: 0.3rem 0.5rem 0.3rem 0.25rem;
        border: none;
        font-size: 0.8125rem;
        text-align: right;
        background: transparent;
    }

    .cost-row .money-input:focus {
        outline: none;
    }

    .cost-row .money-input[readonly] {
        background: transparent;
        color: #64748b;
        font-weight: 600;
    }

    .cost-row .money-input.calculated {
        background: transparent;
        color: #64748b;
        font-weight: 600;
        cursor: not-allowed;
    }

    /* Custom row - user adds their own */
    .custom-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .custom-row .custom-label-input {
        flex: 1;
        padding: 0.3rem 0.5rem;
        border: none;
        border-bottom: 1.5px dashed #cbd5e1;
        font-size: 0.8125rem;
        background: transparent;
        transition: all 0.2s;
    }

    .custom-row .custom-label-input:focus {
        outline: none;
        border-bottom-color: #3b82f6;
        border-bottom-style: solid;
        background: #f8fafc;
    }

    .custom-row .custom-label-input::placeholder {
        color: #94a3b8;
        font-style: italic;
    }

    .custom-row .money-input-wrapper {
        min-width: 110px;
    }

    .custom-row .money-input {
        width: 100%;
        padding: 0.3rem 0.5rem 0.3rem 0.25rem;
        border: none;
        font-size: 0.8125rem;
        text-align: right;
        background: transparent;
    }

    /* Total row */
    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.75rem;
        margin-top: 0.75rem;
        border-top: 2px solid #334155;
        font-weight: 700;
        font-size: 0.9375rem;
    }

    .total-row .money-input-wrapper.total-wrapper {
        background: #f1f5f9;
        border-color: #94a3b8;
        border-width: 2px;
        min-width: 120px;
    }

    .total-row .money-input-wrapper.total-wrapper .dollar-sign {
        background: #f1f5f9;
        color: #64748b;
        font-weight: 700;
    }

    .total-row .money-input {
        width: 100%;
        padding: 0.375rem 0.5rem 0.375rem 0.25rem;
        border: none;
        font-size: 0.9375rem;
        text-align: right;
        font-weight: 700;
        background: transparent;
        color: #475569;
    }

    /* Proceeds section styling */
    .proceeds-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .proceeds-row label {
        color: #1e293b;
        font-weight: 500;
    }

    .proceeds-row .parentheses {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .proceeds-row .parentheses::before {
        content: '(';
        font-weight: 600;
        color: #dc2626;
    }

    .proceeds-row .parentheses::after {
        content: ')';
        font-weight: 600;
        color: #dc2626;
    }

    /* Proceeds section money wrapper - match cost-row styling */
    .proceeds-row .money-input-wrapper {
        min-width: 110px;
    }

    .proceeds-row .money-input-wrapper .money-input {
        width: 100%;
        padding: 0.3rem 0.5rem 0.3rem 0.25rem;
        border: none;
        font-size: 0.8125rem;
        text-align: right;
        background: transparent;
    }

    .proceeds-row .money-input-wrapper .money-input:focus {
        outline: none;
    }

    .proceeds-row .money-input-wrapper.calculated .money-input {
        color: #64748b;
        font-weight: 600;
    }

    /* Net proceeds total - prominent styling */
    .net-proceeds-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 1rem;
        margin-top: 1rem;
        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
        border: 2px solid #10b981;
        border-radius: 0.5rem;
    }

    .net-proceeds-row label {
        font-weight: 700;
        font-size: 1rem;
        color: #065f46;
    }

    .net-proceeds-row .money-input-wrapper.net-proceeds-wrapper {
        background: white;
        border: 2px solid #059669;
        border-radius: 0.375rem;
        min-width: 140px;
    }

    .net-proceeds-row .money-input-wrapper .dollar-sign {
        background: white;
        color: #059669;
        font-weight: 700;
        font-size: 1rem;
        padding: 0.5rem 0 0.5rem 0.625rem;
    }

    .net-proceeds-row .money-input {
        width: 100%;
        padding: 0.5rem 0.625rem 0.5rem 0.25rem;
        border: none;
        font-size: 1.125rem;
        text-align: right;
        font-weight: 700;
        background: transparent;
        color: #059669;
    }

    /* Checkbox group for financing */
    .financing-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.625rem;
    }

    .financing-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.875rem;
        background: #f8fafc;
        border: 1.5px solid #e2e8f0;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .financing-option:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .financing-option:has(input:checked) {
        background: #eff6ff;
        border-color: #3b82f6;
    }

    .financing-option input[type="checkbox"] {
        width: 1rem;
        height: 1rem;
        accent-color: #3b82f6;
        cursor: pointer;
    }

    .financing-option span {
        font-size: 0.8125rem;
        color: #475569;
        font-weight: 500;
    }

    .financing-option:has(input:checked) span {
        color: #1d4ed8;
    }

    /* Prepared by section */
    .prepared-by-section {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .prepared-by-section label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #475569;
    }

    .prepared-by-section .agent-name {
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
    }

    /* Notes section */
    .notes-section {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e2e8f0;
    }

    .notes-section .note-text {
        font-size: 0.75rem;
        color: #64748b;
        font-style: italic;
    }

    /* Floating action bar */
    .floating-action-bar {
        position: fixed;
        bottom: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.8);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 0.625rem;
    }

    .premium-btn {
        transition: all 0.2s ease-out;
        border-radius: 0.625rem;
        font-weight: 500;
    }

    .premium-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.12);
    }

    .premium-btn:active {
        transform: translateY(0);
    }

    .form-bottom-spacer {
        height: 100px;
    }

    /* Progress bar */
    .progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #f1f5f9;
        z-index: 1000;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #1e3a5f 0%, #3b82f6 50%, #10b981 100%);
        transition: width 0.3s ease-out;
        border-radius: 0 3px 3px 0;
    }

    /* Sales price warning modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        max-width: 400px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-content h3 {
        color: #f59e0b;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-content p {
        color: #475569;
        font-size: 0.9375rem;
        margin-bottom: 1rem;
    }

    .modal-buttons {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    .modal-buttons button {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-buttons .btn-cancel {
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        color: #64748b;
    }

    .modal-buttons .btn-confirm {
        background: #f59e0b;
        border: none;
        color: white;
    }

    .modal-buttons .btn-confirm:hover {
        background: #d97706;
    }
</style>

<!-- Progress Bar -->
<div class="progress-bar">
    <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
</div>

<!-- Sales Price Warning Modal -->
<div class="modal-overlay" id="salesPriceModal">
    <div class="modal-content">
        <h3><i class="fas fa-exclamation-triangle"></i> Change Sales Price?</h3>
        <p>This value is different from the sales price on the transaction record. Are you sure you want to use a different amount for this estimate?</p>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="cancelSalesPriceChange()">Cancel</button>
            <button class="btn-confirm" onclick="confirmSalesPriceChange()">Yes, Update It</button>
        </div>
    </div>
</div>

<!-- Premium gradient background -->
<div class="min-h-full bg-gradient-to-br from-slate-100 via-white to-blue-50/30">
    <div class="p-4 md:p-6">
        <!-- Back Link -->
        <a href="{{ url_for('transactions.view_transaction', id=transaction.id) }}" 
           class="inline-flex items-center text-slate-500 hover:text-blue-600 text-sm mb-4 transition-colors animate-fade-in-up max-w-[850px] mx-auto block">
            <i class="fas fa-arrow-left mr-2"></i>Back to Transaction
        </a>

        <!-- Main Form -->
        <form id="netProceedsForm" method="POST" action="{{ url_for('transactions.save_document_form', id=transaction.id, doc_id=document.id) }}">
            <div class="document-container animate-fade-in-up">
                <!-- Document Header -->
                <div class="document-header">
                    <h1>SELLER'S ESTIMATED NET PROCEEDS</h1>
                    <div class="subtitle">TXR-1935 • Texas Association of REALTORS®</div>
                </div>

                <div class="document-body">
                    <p class="disclaimer-text">
                        The figures below are estimates. Actual costs and proceeds will vary. Estimates are not guaranteed.
                    </p>

                    <!-- Seller Name -->
                    <div class="form-row">
                        <label>Seller:</label>
                        <div class="field-line">
                            <input type="text" name="field_seller_name" class="doc-field" 
                                   value="{{ prefill_data.get('seller_name', '') }}" readonly>
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="form-row">
                        <label>Address:</label>
                        <div class="field-line">
                            <input type="text" name="field_property_address" class="doc-field" 
                                   value="{{ prefill_data.get('property_address', '') }}" readonly>
                        </div>
                    </div>

                    <!-- Anticipated Closing Date -->
                    <div class="form-row">
                        <label>Anticipated Closing Date:</label>
                        <div class="field-line" style="max-width: 180px;">
                            <input type="date" name="field_closing_date" id="closingDate" class="doc-field"
                                   value="{{ prefill_data.get('closing_date', '') }}"
                                   onchange="recalculateAll()">
                        </div>
                    </div>

                    <!-- Estimated Annual Property Taxes -->
                    <div class="form-row">
                        <label>Estimated Annual Property Taxes:</label>
                        <div class="money-field-wrapper">
                            <span class="money-prefix">$</span>
                            <input type="text" name="field_annual_property_taxes" id="annualPropertyTaxes" class="doc-field money-field"
                                   value="{{ prefill_data.get('annual_property_taxes', '') }}"
                                   placeholder="0.00"
                                   oninput="formatMoney(this); recalculateAll()">
                        </div>
                    </div>

                    <!-- Estimated Annual Maintenance Fees -->
                    <div class="form-row">
                        <label>Estimated Annual Maintenance Fees:</label>
                        <div class="money-field-wrapper">
                            <span class="money-prefix">$</span>
                            <input type="text" name="field_annual_maintenance_fees" id="annualMaintenanceFees" class="doc-field money-field"
                                   value="{{ prefill_data.get('annual_maintenance_fees', '') }}"
                                   placeholder="0.00"
                                   oninput="formatMoney(this)">
                        </div>
                    </div>

                    <!-- Buyer's Anticipated Financing -->
                    <div style="margin-top: 1rem; margin-bottom: 1rem;">
                        <label style="font-size: 0.875rem; font-weight: 500; color: #333;">Buyer's Anticipated Financing:</label>
                        <div class="financing-group">
                            <label class="financing-option">
                                <input type="checkbox" name="field_financing_conventional" value="1"
                                       {{ 'checked' if prefill_data.get('financing_conventional') else '' }}>
                                <span>Conventional</span>
                            </label>
                            <label class="financing-option">
                                <input type="checkbox" name="field_financing_va" value="1"
                                       {{ 'checked' if prefill_data.get('financing_va') else '' }}>
                                <span>VA</span>
                            </label>
                            <label class="financing-option">
                                <input type="checkbox" name="field_financing_fha" value="1"
                                       {{ 'checked' if prefill_data.get('financing_fha') else '' }}>
                                <span>FHA</span>
                            </label>
                            <label class="financing-option">
                                <input type="checkbox" name="field_financing_usda" value="1"
                                       {{ 'checked' if prefill_data.get('financing_usda') else '' }}>
                                <span>USDA</span>
                            </label>
                            <label class="financing-option">
                                <input type="checkbox" name="field_financing_reverse" value="1"
                                       {{ 'checked' if prefill_data.get('financing_reverse') else '' }}>
                                <span>Reverse Mortgage</span>
                            </label>
                            <label class="financing-option">
                                <input type="checkbox" name="field_financing_assumption" value="1"
                                       {{ 'checked' if prefill_data.get('financing_assumption') else '' }}>
                                <span>Assumption</span>
                            </label>
                            <label class="financing-option">
                                <input type="checkbox" name="field_financing_owner" value="1"
                                       {{ 'checked' if prefill_data.get('financing_owner') else '' }}>
                                <span>Owner</span>
                            </label>
                            <label class="financing-option">
                                <input type="checkbox" name="field_financing_cash" value="1"
                                       {{ 'checked' if prefill_data.get('financing_cash') else '' }}>
                                <span>Cash</span>
                            </label>
                        </div>
                    </div>

                    <!-- Two Column Layout: Estimated Costs & Proceeds -->
                    <div class="two-column-section">
                        <!-- Left Column: Estimated Costs -->
                        <div class="section-box">
                            <div class="section-title">Estimated Costs</div>
                            
                            <div class="cost-row">
                                <label>Attorney's Fees / Doc. Prep.</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_attorneys_fees" class="money-input cost-input"
                                           value="{{ prefill_data.get('attorneys_fees', '180.00') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Brokers' Fees</label>
                                <input type="text" name="field_brokers_fee_percent" id="brokersFeePercent" class="percent-input"
                                       value="{{ prefill_data.get('brokers_fee_percent', '') }}"
                                       placeholder="%" oninput="calculateBrokersFee()">
                                <span style="font-size: 0.75rem; color: #64748b;">%</span>
                                <div class="money-input-wrapper calculated">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_brokers_fee" id="brokersFee" class="money-input calculated cost-input"
                                           value="{{ prefill_data.get('brokers_fee', '') }}"
                                           placeholder="0" readonly>
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Condo. Transfer Fee</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_condo_transfer_fee" class="money-input cost-input"
                                           value="{{ prefill_data.get('condo_transfer_fee', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Courier & Express Mail Fees</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_courier_fees" class="money-input cost-input"
                                           value="{{ prefill_data.get('courier_fees', '40.00') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Escrow Fee (one-half)</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_escrow_fee" class="money-input cost-input"
                                           value="{{ prefill_data.get('escrow_fee', '80.00') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div style="font-size: 0.8125rem; color: #475569; font-weight: 500; margin: 0.5rem 0 0.25rem;">Prorations*:</div>
                            
                            <div class="cost-row" style="margin-left: 0.75rem;">
                                <label>Taxes <span id="proratedDays" style="font-size: 0.75rem; color: #64748b;">Prorated for ___ days</span></label>
                                <div class="money-input-wrapper calculated">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_prorated_taxes" id="proratedTaxes" class="money-input calculated cost-input"
                                           value="{{ prefill_data.get('prorated_taxes', '') }}"
                                           placeholder="0" readonly>
                                </div>
                            </div>
                            
                            <div class="cost-row" style="margin-left: 0.75rem;">
                                <label>Interest (Assumptions)**</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_prorated_interest" class="money-input cost-input"
                                           value="{{ prefill_data.get('prorated_interest', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row" style="margin-left: 0.75rem;">
                                <label>Maintenance Fees</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_prorated_maintenance" class="money-input cost-input"
                                           value="{{ prefill_data.get('prorated_maintenance', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row" style="margin-left: 0.75rem;">
                                <label>Assessments</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_assessments" class="money-input cost-input"
                                           value="{{ prefill_data.get('assessments', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row" style="margin-left: 0.75rem;">
                                <label>Rents</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_rents" class="money-input cost-input"
                                           value="{{ prefill_data.get('rents', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Recording Fees</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_recording_fees" class="money-input cost-input"
                                           value="{{ prefill_data.get('recording_fees', '50.00') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Repairs Required by Buyer</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_repairs_buyer" class="money-input cost-input"
                                           value="{{ prefill_data.get('repairs_buyer', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Repairs Required by Lender</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_repairs_lender" class="money-input cost-input"
                                           value="{{ prefill_data.get('repairs_lender', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Residential Service Contract</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_residential_service" class="money-input cost-input"
                                           value="{{ prefill_data.get('residential_service', '450.00') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Seller Allowances or FHA/VA Nonallowables (Para. 12)</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_seller_allowances" class="money-input cost-input"
                                           value="{{ prefill_data.get('seller_allowances', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Survey Fee</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_survey_fee" class="money-input cost-input"
                                           value="{{ prefill_data.get('survey_fee', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Tax Certificate Fee</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_tax_cert_fee" class="money-input cost-input"
                                           value="{{ prefill_data.get('tax_cert_fee', '100.00') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Title Policy - Owner's</label>
                                <div class="money-input-wrapper calculated">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_title_policy" id="titlePolicy" class="money-input calculated cost-input"
                                           value="{{ prefill_data.get('title_policy', '') }}"
                                           placeholder="0" readonly>
                                </div>
                            </div>
                            
                            <div class="cost-row">
                                <label>Wiring Fees</label>
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_wiring_fees" class="money-input cost-input"
                                           value="{{ prefill_data.get('wiring_fees', '40.00') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <!-- 4 Custom rows -->
                            <div class="custom-row">
                                <input type="text" name="field_custom_label_1" class="custom-label-input"
                                       value="{{ prefill_data.get('custom_label_1', '') }}"
                                       placeholder="Other...">
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_custom_amount_1" class="money-input cost-input"
                                           value="{{ prefill_data.get('custom_amount_1', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="custom-row">
                                <input type="text" name="field_custom_label_2" class="custom-label-input"
                                       value="{{ prefill_data.get('custom_label_2', '') }}"
                                       placeholder="Other...">
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_custom_amount_2" class="money-input cost-input"
                                           value="{{ prefill_data.get('custom_amount_2', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="custom-row">
                                <input type="text" name="field_custom_label_3" class="custom-label-input"
                                       value="{{ prefill_data.get('custom_label_3', '') }}"
                                       placeholder="Other...">
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_custom_amount_3" class="money-input cost-input"
                                           value="{{ prefill_data.get('custom_amount_3', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="custom-row">
                                <input type="text" name="field_custom_label_4" class="custom-label-input"
                                       value="{{ prefill_data.get('custom_label_4', '') }}"
                                       placeholder="Other...">
                                <div class="money-input-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_custom_amount_4" class="money-input cost-input"
                                           value="{{ prefill_data.get('custom_amount_4', '') }}"
                                           placeholder="0" oninput="formatMoney(this); recalculateCosts()">
                                </div>
                            </div>
                            
                            <div class="total-row">
                                <label>Total Estimated Costs</label>
                                <div class="money-input-wrapper total-wrapper">
                                    <span class="dollar-sign">$</span>
                                    <input type="text" name="field_total_costs" id="totalCosts" class="money-input" 
                                           value="{{ prefill_data.get('total_costs', '') }}"
                                           readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Estimated Proceeds to Seller -->
                        <div>
                            <div class="section-box" style="margin-bottom: 1rem;">
                                <div class="section-title">Estimated Proceeds to Seller:</div>
                                
                                <div class="proceeds-row">
                                    <label>Sales Price</label>
                                    <div class="money-input-wrapper proceeds-money">
                                        <span class="dollar-sign">$</span>
                                        <input type="text" name="field_sales_price" id="salesPrice" class="money-input"
                                               value="{{ prefill_data.get('sales_price', prefill_data.get('list_price', '')) }}"
                                               placeholder="0"
                                               onfocus="checkSalesPriceEdit(this)"
                                               oninput="formatMoney(this); recalculateAll()">
                                    </div>
                                    <input type="hidden" id="originalSalesPrice" value="{{ prefill_data.get('list_price', '') }}">
                                </div>
                                
                                <div class="proceeds-row">
                                    <label>Less Estimated Costs</label>
                                    <div class="parentheses">
                                        <div class="money-input-wrapper calculated">
                                            <span class="dollar-sign">$</span>
                                            <input type="text" name="field_less_costs" id="lessCosts" class="money-input calculated"
                                                   value="{{ prefill_data.get('less_costs', '') }}"
                                                   readonly>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="proceeds-row">
                                    <label>Less Estimated Loan Payoff</label>
                                    <div class="parentheses">
                                        <div class="money-input-wrapper">
                                            <span class="dollar-sign">$</span>
                                            <input type="text" name="field_loan_payoff" id="loanPayoff" class="money-input"
                                                   value="{{ prefill_data.get('loan_payoff', '') }}"
                                                   placeholder="0"
                                                   oninput="formatMoney(this); recalculateNetProceeds()">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="net-proceeds-row">
                                    <label>Estimated Net Proceeds:</label>
                                    <div class="money-input-wrapper net-proceeds-wrapper">
                                        <span class="dollar-sign">$</span>
                                        <input type="text" name="field_net_proceeds" id="netProceeds" class="money-input"
                                               value="{{ prefill_data.get('net_proceeds', '') }}"
                                               readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- After Closing Refunds -->
                            <div class="section-box">
                                <div class="section-title">After Closing Refunds</div>
                                
                                <div class="cost-row">
                                    <label>Estimated Unused Insurance</label>
                                    <div class="money-input-wrapper">
                                        <span class="dollar-sign">$</span>
                                        <input type="text" name="field_unused_insurance" class="money-input refund-input"
                                               value="{{ prefill_data.get('unused_insurance', '') }}"
                                               placeholder="0" oninput="formatMoney(this); recalculateRefunds()">
                                    </div>
                                </div>
                                
                                <div class="cost-row">
                                    <label>Estimated Escrow Balance</label>
                                    <div class="money-input-wrapper">
                                        <span class="dollar-sign">$</span>
                                        <input type="text" name="field_escrow_balance" class="money-input refund-input"
                                               value="{{ prefill_data.get('escrow_balance', '') }}"
                                               placeholder="0" oninput="formatMoney(this); recalculateRefunds()">
                                    </div>
                                </div>
                                
                                <div class="total-row">
                                    <label>Total Estimated Refunds:</label>
                                    <div class="money-input-wrapper total-wrapper">
                                        <span class="dollar-sign">$</span>
                                        <input type="text" name="field_total_refunds" id="totalRefunds" class="money-input"
                                               value="{{ prefill_data.get('total_refunds', '') }}"
                                               readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="notes-section">
                        <p class="note-text">
                            <strong>Note:</strong> Seller may be required to pay some costs directly to the service providers before closing.
                        </p>
                        <p class="note-text" style="margin-top: 0.5rem;">
                            * Prorations are calculated through the closing date.<br>
                            ** Interest is prorated only in assumption transactions.
                        </p>
                    </div>

                    <!-- Prepared By -->
                    <div class="prepared-by-section">
                        <label>Prepared by:</label>
                        <span class="agent-name">{{ current_user.first_name }} {{ current_user.last_name }}</span>
                        <input type="hidden" name="field_prepared_by" value="{{ current_user.first_name }} {{ current_user.last_name }}">
                    </div>
                </div>
            </div>

            <!-- Spacer for floating action bar -->
            <div class="form-bottom-spacer"></div>
        </form>
        
        <!-- Floating Action Bar -->
        <div class="floating-action-bar">
            <a href="{{ url_for('transactions.view_transaction', id=transaction.id) }}" 
               class="premium-btn px-5 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors">
                Cancel
            </a>
            <div class="w-px h-8 bg-slate-200"></div>
            <button type="submit" form="netProceedsForm" name="submit_action" value="save" 
                    class="premium-btn px-5 py-2.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg flex items-center gap-2 transition-colors">
                <i class="fas fa-save text-slate-500"></i>
                Save Draft
            </button>
            <button type="button" onclick="saveAndPreview()" 
                    class="premium-btn px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-emerald-600 hover:from-blue-700 hover:to-emerald-700 rounded-lg flex items-center gap-2 shadow-sm transition-colors">
                <i class="fas fa-check-circle"></i>
                Save & Continue
            </button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
    <div id="toastContent" class="flex items-center gap-3 px-5 py-4 bg-white rounded-2xl shadow-2xl border border-slate-200">
        <i id="toastIcon" class="fas fa-info-circle text-blue-500"></i>
        <span id="toastMessage" class="text-sm font-medium text-slate-700"></span>
    </div>
</div>

<!-- Texas Title Policy Calculator -->
<script src="{{ url_for('static', filename='js/texas_title_policy.js') }}"></script>

<script>
// =============================================================================
// INITIALIZATION
// =============================================================================

let salesPriceEditAllowed = false;
let pendingSalesPriceValue = '';

document.addEventListener('DOMContentLoaded', function() {
    recalculateAll();
    updateProgress();
    
    // Add input listeners for progress tracking
    document.querySelectorAll('input').forEach(el => {
        el.addEventListener('change', updateProgress);
        el.addEventListener('input', updateProgress);
    });
});

// =============================================================================
// MONEY FORMATTING
// =============================================================================

function formatMoney(input) {
    // Remove all non-numeric except decimal
    let value = input.value.replace(/[^0-9.]/g, '');
    
    // Ensure only one decimal point
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }
    
    // Parse and format
    if (value) {
        const num = parseFloat(value);
        if (!isNaN(num)) {
            // Format with commas, keeping decimal if present
            const formatted = num.toLocaleString('en-US', {
                minimumFractionDigits: value.includes('.') ? 2 : 0,
                maximumFractionDigits: 2
            });
            input.value = formatted;
        }
    }
}

function parseMoneyValue(str) {
    if (!str) return 0;
    // Remove $ and commas, then parse
    const cleaned = str.replace(/[$,]/g, '');
    return parseFloat(cleaned) || 0;
}

function formatAsMoney(num) {
    return num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// =============================================================================
// SALES PRICE EDIT WARNING
// =============================================================================

function checkSalesPriceEdit(input) {
    const original = document.getElementById('originalSalesPrice').value;
    if (original && !salesPriceEditAllowed) {
        input.blur();
        pendingSalesPriceValue = input.value;
        document.getElementById('salesPriceModal').classList.add('show');
    }
}

function cancelSalesPriceChange() {
    document.getElementById('salesPriceModal').classList.remove('show');
    document.getElementById('salesPrice').value = pendingSalesPriceValue;
}

function confirmSalesPriceChange() {
    document.getElementById('salesPriceModal').classList.remove('show');
    salesPriceEditAllowed = true;
    document.getElementById('salesPrice').focus();
}

// =============================================================================
// CALCULATIONS
// =============================================================================

function recalculateAll() {
    calculateProratedTaxes();
    calculateBrokersFee();
    calculateTitlePolicy();
    recalculateCosts();
    recalculateRefunds();
    recalculateNetProceeds();
    updateProgress();
}

function calculateTitlePolicy() {
    const salesPrice = parseMoneyValue(document.getElementById('salesPrice').value);
    const titlePolicyInput = document.getElementById('titlePolicy');
    
    if (!salesPrice || salesPrice <= 0) {
        titlePolicyInput.value = '';
        return;
    }
    
    // Use the Texas Title Policy calculator (from texas_title_policy.js)
    if (typeof calculateTexasTitlePremium === 'function') {
        const premium = calculateTexasTitlePremium(salesPrice);
        titlePolicyInput.value = formatAsMoney(premium);
    }
}

function calculateProratedTaxes() {
    const closingDateStr = document.getElementById('closingDate').value;
    const annualTaxes = parseMoneyValue(document.getElementById('annualPropertyTaxes').value);
    
    if (!closingDateStr || !annualTaxes) {
        document.getElementById('proratedTaxes').value = '';
        document.getElementById('proratedDays').textContent = 'Prorated for ___ days';
        return;
    }
    
    // Calculate days from Jan 1 to closing date
    const closingDate = new Date(closingDateStr);
    const yearStart = new Date(closingDate.getFullYear(), 0, 1); // January 1
    const diffTime = closingDate - yearStart;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include closing day
    
    // Calculate prorated taxes
    const dailyRate = annualTaxes / 365;
    const proratedAmount = dailyRate * diffDays;
    
    document.getElementById('proratedDays').textContent = `Prorated for ${diffDays} days`;
    document.getElementById('proratedTaxes').value = formatAsMoney(proratedAmount);
    
    recalculateCosts();
}

function calculateBrokersFee() {
    const percentStr = document.getElementById('brokersFeePercent').value;
    const salesPrice = parseMoneyValue(document.getElementById('salesPrice').value);
    
    if (!percentStr || !salesPrice) {
        document.getElementById('brokersFee').value = '';
        recalculateCosts();
        return;
    }
    
    const percent = parseFloat(percentStr) || 0;
    const fee = (salesPrice * percent) / 100;
    
    document.getElementById('brokersFee').value = formatAsMoney(fee);
    recalculateCosts();
}

function recalculateCosts() {
    const costInputs = document.querySelectorAll('.cost-input');
    let total = 0;
    
    costInputs.forEach(input => {
        total += parseMoneyValue(input.value);
    });
    
    document.getElementById('totalCosts').value = formatAsMoney(total);
    document.getElementById('lessCosts').value = formatAsMoney(total);
    
    recalculateNetProceeds();
}

function recalculateRefunds() {
    const refundInputs = document.querySelectorAll('.refund-input');
    let total = 0;
    
    refundInputs.forEach(input => {
        total += parseMoneyValue(input.value);
    });
    
    document.getElementById('totalRefunds').value = formatAsMoney(total);
}

function recalculateNetProceeds() {
    const salesPrice = parseMoneyValue(document.getElementById('salesPrice').value);
    const lessCosts = parseMoneyValue(document.getElementById('lessCosts').value);
    const loanPayoff = parseMoneyValue(document.getElementById('loanPayoff').value);
    
    const netProceeds = salesPrice - lessCosts - loanPayoff;
    
    document.getElementById('netProceeds').value = formatAsMoney(netProceeds);
}

// =============================================================================
// PROGRESS TRACKING
// =============================================================================

function updateProgress() {
    const form = document.getElementById('netProceedsForm');
    const allInputs = form.querySelectorAll('input:not([type="hidden"]):not([readonly])');
    let filledCount = 0;
    let totalCount = 0;
    
    allInputs.forEach(input => {
        if (input.type === 'checkbox') {
            // Don't count checkboxes toward progress
        } else if (input.value && input.value.trim()) {
            filledCount++;
            totalCount++;
        } else {
            totalCount++;
        }
    });
    
    const progress = totalCount > 0 ? Math.min((filledCount / totalCount) * 100, 100) : 0;
    document.getElementById('progressFill').style.width = progress + '%';
}

// =============================================================================
// FORM SUBMISSION
// =============================================================================

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toastIcon');
    document.getElementById('toastMessage').textContent = message;
    
    icon.className = 'fas';
    if (type === 'success') {
        icon.classList.add('fa-check-circle', 'text-green-500');
    } else if (type === 'error') {
        icon.classList.add('fa-exclamation-circle', 'text-red-500');
    } else if (type === 'warning') {
        icon.classList.add('fa-exclamation-triangle', 'text-amber-500');
    } else {
        icon.classList.add('fa-info-circle', 'text-blue-500');
    }
    
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 4000);
}

function saveAndPreview() {
    const form = document.getElementById('netProceedsForm');
    const formData = new FormData(form);
    
    showToast('Saving document...', 'info');
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showToast('Opening preview...', 'success');
            setTimeout(() => {
                window.location.href = "{{ url_for('transactions.document_preview', id=transaction.id, doc_id=document.id) }}";
            }, 500);
        } else {
            showToast('Error saving form. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error saving form. Please try again.', 'error');
    });
}
</script>
{% endblock %}

