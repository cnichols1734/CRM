{% extends "base.html" %}

{% block title %}Fill All Documents - {{ transaction.street_address }} - TechnolOG{% endblock %}

{% block content %}
<style>
    /* Premium animations */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInFromRight {
        from { opacity: 0; transform: translateX(50px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    /* Document divider */
    .document-divider {
        position: relative;
        padding: 3rem 0;
    }

    .document-divider::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 4px;
        background: linear-gradient(90deg, transparent, #e2e8f0 10%, #e2e8f0 90%, transparent);
        transform: translateY(-50%);
    }

    .document-divider-content {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 1rem;
        padding: 0 2rem;
        background: linear-gradient(to right, #f8fafc, white, #f8fafc);
        margin: 0 auto;
        left: 50%;
        transform: translateX(-50%);
    }

    .document-badge {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.875rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Dynamic document badge colors - generated from registry config */
    .document-badge-orange {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
    }
    .document-badge-violet {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
    }
    .document-badge-blue {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }
    .document-badge-emerald {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    .document-badge-rose {
        background: linear-gradient(135deg, #f43f5e, #e11d48);
        color: white;
    }
    .document-badge-amber {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }
    .document-badge-cyan {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }
    .document-badge-indigo {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
    }
    .document-badge-default {
        background: linear-gradient(135deg, #64748b, #475569);
        color: white;
    }

    /* Premium card styling */
    .premium-card {
        background: white;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: all 0.3s ease-out;
    }

    .premium-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    /* Section styling */
    .form-section {
        border-left: 4px solid transparent;
        transition: all 0.3s ease-out;
    }

    .form-section:hover {
        border-left-color: var(--section-color, #f97316);
    }

    .form-section.active {
        border-left-color: var(--section-color, #f97316);
        background: linear-gradient(to right, rgba(249, 115, 22, 0.02), transparent);
    }

    /* Document color themes - CSS variables set dynamically via style attribute */
    .doc-section { --section-color: #64748b; }  /* Default, overridden per-doc */

    /* Section header */
    .section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .section-number {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
    }

    .section-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    /* Premium input styling */
    .premium-input {
        border: 2px solid #e2e8f0;
        border-radius: 0.625rem;
        background-color: #f8fafc;
        transition: all 0.2s ease-out;
        padding: 0.75rem 1rem;
        font-size: 0.9375rem;
        width: 100%;
    }

    .premium-input:focus {
        border-color: var(--focus-color, #f97316);
        background-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        outline: none;
    }

    /* Focus colors use CSS variable from doc-section */
    .doc-section .premium-input:focus {
        border-color: var(--section-color, #f97316);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--section-color, #f97316) 10%, transparent);
    }

    .premium-input::placeholder {
        color: #94a3b8;
    }

    .premium-input[readonly] {
        background-color: #f1f5f9;
        color: #64748b;
        cursor: not-allowed;
    }

    /* Form label */
    .form-label {
        display: block;
        font-size: 0.9375rem;
        font-weight: 600;
        color: #334155;
        margin-bottom: 0.5rem;
    }

    .form-label-required::after {
        content: ' *';
        color: #ef4444;
    }

    /* Help text */
    .help-text {
        font-size: 0.8125rem;
        color: #64748b;
        margin-top: 0.5rem;
        line-height: 1.5;
    }

    /* Option card */
    .option-card {
        display: flex;
        align-items: center;
        padding: 1rem 1.25rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease-out;
        background: #f8fafc;
    }

    .option-card:hover {
        border-color: #cbd5e1;
        background: #f1f5f9;
    }

    .option-card.selected {
        border-color: var(--section-color, #f97316);
        background: linear-gradient(135deg, #fff7ed, #ffedd5);
    }

    /* Selected option cards use section color - fallback to standard gradient */
    .doc-section .option-card.selected {
        border-color: var(--section-color, #f97316);
    }

    .option-card input[type="radio"],
    .option-card input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.875rem;
        accent-color: var(--section-color, #f97316);
        flex-shrink: 0;
    }

    .option-label {
        font-weight: 500;
        color: #1e293b;
    }

    .option-description {
        font-size: 0.8125rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    /* Conditional section */
    .conditional-section {
        display: none;
        padding-left: 1.5rem;
        margin-top: 1rem;
        border-left: 3px solid #e2e8f0;
        animation: fadeInUp 0.3s ease-out;
    }

    .conditional-section.show {
        display: block;
    }

    /* Input with prefix/suffix */
    .input-group {
        position: relative;
        display: flex;
        align-items: stretch;
    }

    .input-prefix,
    .input-suffix {
        display: flex;
        align-items: center;
        padding: 0 1rem;
        background: #e2e8f0;
        color: #64748b;
        font-weight: 500;
        font-size: 0.9375rem;
        border: 2px solid #e2e8f0;
    }

    .input-prefix {
        border-right: none;
        border-radius: 0.625rem 0 0 0.625rem;
    }

    .input-suffix {
        border-left: none;
        border-radius: 0 0.625rem 0.625rem 0;
    }

    .input-group .premium-input {
        border-radius: 0;
    }

    /* Callouts */
    .callout-info {
        background: linear-gradient(135deg, #eff6ff, #dbeafe);
        border: 1px solid #93c5fd;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        margin-top: 0.75rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .callout-info i {
        color: #3b82f6;
        flex-shrink: 0;
    }

    .callout-info p {
        font-size: 0.875rem;
        color: #1e40af;
        line-height: 1.6;
        margin: 0;
    }

    .callout-warning {
        background: linear-gradient(135deg, #fffbeb, #fef3c7);
        border: 1px solid #fcd34d;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        margin-top: 0.75rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .callout-warning i {
        color: #f59e0b;
        flex-shrink: 0;
    }

    .callout-warning p {
        font-size: 0.875rem;
        color: #92400e;
        line-height: 1.6;
        margin: 0;
    }

    /* Progress bar */
    .progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: #e2e8f0;
        z-index: 1000;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #f97316, #8b5cf6);
        transition: width 0.3s ease-out;
    }

    /* Document counter */
    .document-counter {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: white;
        padding: 0.75rem 1.25rem;
        border-radius: 9999px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
        z-index: 100;
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
    }

    .document-counter span {
        color: #1e293b;
    }

    /* Floating action bar */
    .floating-action-bar {
        position: fixed;
        bottom: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0.875rem 1.25rem;
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.06);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    /* Premium button */
    .premium-btn {
        transition: all 0.2s ease-out;
        border-radius: 0.75rem;
    }

    .premium-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Premium textarea */
    .premium-textarea {
        border: 2px solid #e2e8f0;
        border-radius: 0.625rem;
        background-color: #f8fafc;
        transition: all 0.2s ease-out;
        padding: 0.75rem 1rem;
        font-size: 0.9375rem;
        width: 100%;
        resize: vertical;
        min-height: 100px;
    }

    .premium-textarea:focus {
        border-color: var(--focus-color, #f97316);
        background-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        outline: none;
    }
    
    .form-bottom-spacer {
        height: 100px;
    }
</style>

<!-- Progress Bar -->
<div class="progress-bar">
    <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
</div>

<!-- Document Counter -->
<div class="document-counter">
    Filling <span>{{ documents|length }}</span> document{{ 's' if documents|length != 1 }}
</div>

<!-- Premium gradient background -->
<div class="min-h-full bg-gradient-to-br from-slate-50 via-white to-orange-50/30">
    <div class="p-4 md:p-6 max-w-4xl mx-auto">
        <!-- Back Link -->
        <a href="{{ url_for('transactions.view_transaction', id=transaction.id) }}" 
           class="inline-flex items-center text-slate-500 hover:text-orange-600 text-sm mb-4 transition-colors animate-fade-in-up">
            <i class="fas fa-arrow-left mr-2"></i>Back to Transaction
        </a>
        
        <!-- Header Section -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 animate-fade-in-up">
            <div class="flex items-start space-x-4">
                <div class="hidden md:flex w-14 h-14 rounded-2xl bg-gradient-to-br from-slate-700 to-slate-900 items-center justify-center shadow-lg flex-shrink-0">
                    <i class="fas fa-layer-group text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Fill All Documents</h1>
                    <p class="text-slate-500 mt-1">{{ transaction.street_address }}</p>
                    <p class="text-xs text-slate-400 mt-1">{{ documents|length }} document{{ 's' if documents|length != 1 }} to fill</p>
                </div>
            </div>
        </div>

        <!-- Documents Overview -->
        <div class="premium-card p-4 mb-8 animate-fade-in-up">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm font-medium text-slate-600">Documents included:</span>
                {% for doc in documents %}
                {% set config = doc_configs.get(doc.template_slug) %}
                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold
                    {% if config %}bg-{{ config.color }}-100 text-{{ config.color }}-700{% else %}bg-slate-100 text-slate-700{% endif %}">
                    <i class="fas {{ config.icon if config else 'fa-file-alt' }} mr-1.5"></i>{{ doc.template_name }}
                </span>
                {% endfor %}
            </div>
        </div>

        <!-- Main Form -->
        <form id="fillAllForm" method="POST" action="{{ url_for('transactions.save_all_documents', id=transaction.id) }}">
            
            {% for doc in documents %}
            {% set config = doc_configs.get(doc.template_slug) %}
            
            <!-- Document Divider (not on first) -->
            {% if not loop.first %}
            <div class="document-divider">
                <div class="document-divider-content">
                    <span class="document-badge document-badge-{{ config.color if config else 'default' }}">
                        <i class="fas {{ config.icon if config else 'fa-file-alt' }}"></i>
                        {{ doc.template_name }}
                    </span>
                </div>
            </div>
            {% else %}
            <!-- First Document Header -->
            <div class="flex items-center gap-3 mb-6 animate-fade-in-up">
                <span class="document-badge document-badge-{{ config.color if config else 'default' }}">
                    <i class="fas {{ config.icon if config else 'fa-file-alt' }}"></i>
                    Document 1: {{ doc.template_name }}
                </span>
            </div>
            {% endif %}
            
            <!-- Include the form content from registry-defined partial template -->
            {% if config %}
            <div class="doc-section" style="--section-color: {{ config.section_color_var }}">
                {% include config.partial_template %}
            </div>
            {% else %}
            <!-- No specialized form for this document type -->
            <div class="premium-card p-6 mb-6">
                <p class="text-slate-500">No specialized form available for {{ doc.template_name }}. Use the individual document form.</p>
            </div>
            {% endif %}
            
            {% endfor %}

            <!-- Spacer for floating action bar -->
            <div class="form-bottom-spacer"></div>
        </form>
        
        <!-- Floating Action Bar -->
        <div class="floating-action-bar">
            <a href="{{ url_for('transactions.view_transaction', id=transaction.id) }}" 
               class="premium-btn px-5 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors">
                Cancel
            </a>
            <div class="w-px h-8 bg-slate-200"></div>
            <button type="submit" form="fillAllForm" name="submit_action" value="save" 
                    class="premium-btn px-5 py-2.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg flex items-center gap-2 transition-colors">
                <i class="fas fa-save text-slate-500"></i>
                Save All Drafts
            </button>
            <button type="submit" form="fillAllForm" name="submit_action" value="continue" 
                    class="premium-btn px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-violet-600 hover:from-orange-600 hover:to-violet-700 rounded-lg flex items-center gap-2 shadow-sm transition-colors">
                <i class="fas fa-check-circle"></i>
                Save All & Continue
            </button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
    <div id="toastContent" class="flex items-center gap-3 px-5 py-4 bg-white rounded-2xl shadow-2xl border border-slate-200">
        <i id="toastIcon" class="fas fa-info-circle text-blue-500"></i>
        <span id="toastMessage" class="text-sm font-medium text-slate-700"></span>
    </div>
</div>

<script>
// =============================================================================
// INITIALIZATION
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize all conditional sections based on current values
    initializeConditionalSections();
    
    // Initialize option cards styling
    initializeOptionCards();
    
    // Update progress bar
    updateProgress();
    
    // Add input listeners for progress tracking
    document.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('change', updateProgress);
        el.addEventListener('input', updateProgress);
    });
});

function initializeConditionalSections() {
    // Check all radio buttons and apply their conditional logic
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        const fieldName = radio.name.replace(/^doc_\d+_field_/, '');
        handleConditionalLogic(fieldName, radio.value, radio);
    });
}

function initializeOptionCards() {
    document.querySelectorAll('.option-card').forEach(card => {
        const input = card.querySelector('input[type="radio"], input[type="checkbox"]');
        if (input && input.checked) {
            card.classList.add('selected');
        }
    });
}

// =============================================================================
// OPTION SELECTION
// =============================================================================

function selectOption(element, fieldName, value) {
    // Update visual state for radio buttons in the same group
    const container = element.closest('.grid, .flex');
    if (container) {
        container.querySelectorAll('.option-card').forEach(card => {
            card.classList.remove('selected');
        });
    }
    element.classList.add('selected');
    
    // Handle conditional logic
    const input = element.querySelector('input');
    handleConditionalLogic(fieldName, value, input);
}

function handleConditionalLogic(fieldName, value, inputEl) {
    // Get the document context (which document's conditional sections to update)
    const docContainer = inputEl ? inputEl.closest('.doc-section') : null;
    
    // Extract the base field name without doc prefix
    const baseFieldName = fieldName.replace(/^doc_\d+_field_/, '');
    
    switch(baseFieldName) {
        case 'doc_responsibility':
            handleDocResponsibility(value, docContainer);
            break;
        case 'has_exclusions':
            toggleConditional('exclusionsSection', value === 'yes', docContainer);
            break;
        case 'offer_buyer_agent_comp':
            toggleConditional('section5A', value === 'yes', docContainer);
            toggleConditional('section5B', value === 'no', docContainer);
            break;
        case 'enter_mls':
            toggleConditional('mlsYesSection', value === 'yes', docContainer);
            toggleConditional('mlsNoSection', value === 'no', docContainer);
            break;
        case 'mls_timing':
            toggleConditional('mlsDelaySection', value === 'delayed', docContainer);
            break;
        case 'internet_display':
            toggleConditional('internetYesSection', value === 'yes', docContainer);
            break;
        case 'has_liens':
            toggleConditional('liensSection', value === 'yes', docContainer);
            break;
        case 'has_delinquencies':
            toggleConditional('delinquenciesSection', value === 'yes', docContainer);
            break;
        case 'has_special_districts':
            toggleConditional('specialDistrictsSection', value === 'yes', docContainer);
            break;
        case 'is_foreign_seller':
            toggleConditional('firptaWarningSection', value === 'yes' || value === 'not_sure', docContainer);
            break;
        case 'is_condo':
            toggleConditional('condoCallout', value === 'yes', docContainer);
            break;
    }
    
    updateProgress();
}

function toggleConditional(sectionId, show, container) {
    let section;
    if (container) {
        section = container.querySelector('#' + sectionId);
    }
    if (!section) {
        section = document.getElementById(sectionId);
    }
    if (section) {
        section.classList.toggle('show', show);
        if (section.style) {
            section.style.display = show ? 'block' : 'none';
        }
    }
}

function handleDocResponsibility(value, container) {
    toggleConditional('sellerDaysSection', value === 'seller', container);
    toggleConditional('buyerDaysSection', value === 'buyer', container);
    toggleConditional('updatedResaleSection', value === 'already_received', container);
    toggleConditional('notRequiredWarning', value === 'not_required', container);
}

// =============================================================================
// PROGRESS TRACKING
// =============================================================================

function updateProgress() {
    const form = document.getElementById('fillAllForm');
    const allInputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
    let filledCount = 0;
    let totalCount = 0;
    
    allInputs.forEach(input => {
        if (input.type === 'radio') {
            const name = input.name;
            if (!form.querySelector(`[name="${name}"][data-counted]`)) {
                totalCount++;
                if (form.querySelector(`[name="${name}"]:checked`)) {
                    filledCount++;
                }
                input.setAttribute('data-counted', 'true');
            }
        } else if (input.type === 'checkbox') {
            // Don't count checkboxes toward progress
        } else if (input.value && input.value.trim()) {
            filledCount++;
            totalCount++;
        } else if (input.required) {
            totalCount++;
        }
    });
    
    // Reset counted flags
    form.querySelectorAll('[data-counted]').forEach(el => el.removeAttribute('data-counted'));
    
    const progress = totalCount > 0 ? Math.min((filledCount / totalCount) * 100, 100) : 0;
    document.getElementById('progressFill').style.width = progress + '%';
}

// =============================================================================
// CURRENCY FORMATTING
// =============================================================================

function formatCurrency(input) {
    let value = input.value.replace(/[^0-9]/g, '');
    if (value) {
        value = parseInt(value, 10).toLocaleString('en-US');
        input.value = value;
    }
}

// =============================================================================
// TOAST NOTIFICATIONS
// =============================================================================

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toastIcon');
    document.getElementById('toastMessage').textContent = message;
    
    icon.className = 'fas';
    if (type === 'success') {
        icon.classList.add('fa-check-circle', 'text-green-500');
    } else if (type === 'error') {
        icon.classList.add('fa-exclamation-circle', 'text-red-500');
    } else if (type === 'warning') {
        icon.classList.add('fa-exclamation-triangle', 'text-amber-500');
    } else {
        icon.classList.add('fa-info-circle', 'text-blue-500');
    }
    
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 4000);
}

function toggleCheckbox(element) {
    element.classList.toggle('checked');
}
</script>
{% endblock %}

