{% extends "base.html" %}

{% block title %}Fill All Documents - {{ transaction.street_address }} - Origen TechnolOG{% endblock %}

{% block content %}
<style>
    /* Premium animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInFromRight {
        from {
            opacity: 0;
            transform: translateX(50px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    /* Document divider */
    .document-divider {
        position: relative;
        padding: 3rem 0;
    }

    .document-divider::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 4px;
        background: linear-gradient(90deg, transparent, #e2e8f0 10%, #e2e8f0 90%, transparent);
        transform: translateY(-50%);
    }

    .document-divider-content {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 1rem;
        padding: 0 2rem;
        background: linear-gradient(to right, #f8fafc, white, #f8fafc);
        margin: 0 auto;
        left: 50%;
        transform: translateX(-50%);
    }

    .document-badge {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.875rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Dynamic document badge colors - generated from registry config */
    .document-badge-orange {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
    }

    .document-badge-violet {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
    }

    .document-badge-blue {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }

    .document-badge-emerald {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .document-badge-rose {
        background: linear-gradient(135deg, #f43f5e, #e11d48);
        color: white;
    }

    .document-badge-amber {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .document-badge-cyan {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }

    .document-badge-indigo {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
    }

    .document-badge-default {
        background: linear-gradient(135deg, #64748b, #475569);
        color: white;
    }

    /* Premium card styling */
    .premium-card {
        background: white;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease-out;
    }

    .premium-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Section styling */
    .form-section {
        border-left: 4px solid transparent;
        transition: all 0.3s ease-out;
    }

    .form-section:hover {
        border-left-color: var(--section-color, #f97316);
    }

    .form-section.active {
        border-left-color: var(--section-color, #f97316);
        background: linear-gradient(to right, rgba(249, 115, 22, 0.02), transparent);
    }

    /* Document color themes - CSS variables set dynamically via style attribute */
    .doc-section {
        --section-color: #64748b;
    }

    /* Default, overridden per-doc */

    /* Section header */
    .section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .section-number {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
    }

    .section-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    /* Premium input styling */
    .premium-input {
        border: 2px solid #e2e8f0;
        border-radius: 0.625rem;
        background-color: #f8fafc;
        transition: all 0.2s ease-out;
        padding: 0.75rem 1rem;
        font-size: 0.9375rem;
        width: 100%;
    }

    .premium-input:focus {
        border-color: var(--focus-color, #f97316);
        background-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        outline: none;
    }

    /* Focus colors use CSS variable from doc-section */
    .doc-section .premium-input:focus {
        border-color: var(--section-color, #f97316);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--section-color, #f97316) 10%, transparent);
    }

    .premium-input::placeholder {
        color: #94a3b8;
    }

    .premium-input[readonly] {
        background-color: #f1f5f9;
        color: #64748b;
        cursor: not-allowed;
    }

    /* Form label */
    .form-label {
        display: block;
        font-size: 0.9375rem;
        font-weight: 600;
        color: #334155;
        margin-bottom: 0.5rem;
    }

    .form-label-required::after {
        content: ' *';
        color: #ef4444;
    }

    /* Help text */
    .help-text {
        font-size: 0.8125rem;
        color: #64748b;
        margin-top: 0.5rem;
        line-height: 1.5;
    }

    /* Option card */
    .option-card {
        display: flex;
        align-items: center;
        padding: 1rem 1.25rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease-out;
        background: #f8fafc;
    }

    .option-card:hover {
        border-color: #cbd5e1;
        background: #f1f5f9;
    }

    .option-card.selected {
        border-color: var(--section-color, #f97316);
        background: linear-gradient(135deg, #fff7ed, #ffedd5);
    }

    /* Selected option cards use section color - fallback to standard gradient */
    .doc-section .option-card.selected {
        border-color: var(--section-color, #f97316);
    }

    .option-card input[type="radio"],
    .option-card input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.875rem;
        accent-color: var(--section-color, #f97316);
        flex-shrink: 0;
    }

    .option-label {
        font-weight: 500;
        color: #1e293b;
    }

    .option-description {
        font-size: 0.8125rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    /* Conditional section */
    .conditional-section {
        display: none;
        padding-left: 1.5rem;
        margin-top: 1rem;
        border-left: 3px solid #e2e8f0;
        animation: fadeInUp 0.3s ease-out;
    }

    .conditional-section.show {
        display: block;
    }

    /* Input with prefix/suffix */
    .input-group {
        position: relative;
        display: flex;
        align-items: stretch;
    }

    .input-prefix,
    .input-suffix {
        display: flex;
        align-items: center;
        padding: 0 1rem;
        background: #e2e8f0;
        color: #64748b;
        font-weight: 500;
        font-size: 0.9375rem;
        border: 2px solid #e2e8f0;
    }

    .input-prefix {
        border-right: none;
        border-radius: 0.625rem 0 0 0.625rem;
    }

    .input-suffix {
        border-left: none;
        border-radius: 0 0.625rem 0.625rem 0;
    }

    .input-group .premium-input {
        border-radius: 0;
    }

    /* Callouts */
    .callout-info {
        background: linear-gradient(135deg, #eff6ff, #dbeafe);
        border: 1px solid #93c5fd;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        margin-top: 0.75rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .callout-info i {
        color: #3b82f6;
        flex-shrink: 0;
    }

    .callout-info p {
        font-size: 0.875rem;
        color: #1e40af;
        line-height: 1.6;
        margin: 0;
    }

    .callout-warning {
        background: linear-gradient(135deg, #fffbeb, #fef3c7);
        border: 1px solid #fcd34d;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        margin-top: 0.75rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .callout-warning i {
        color: #f59e0b;
        flex-shrink: 0;
    }

    .callout-warning p {
        font-size: 0.875rem;
        color: #92400e;
        line-height: 1.6;
        margin: 0;
    }

    /* Progress bar */
    .progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: #e2e8f0;
        z-index: 1000;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #f97316, #8b5cf6);
        transition: width 0.3s ease-out;
    }

    /* Document counter */
    .document-counter {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: white;
        padding: 0.75rem 1.25rem;
        border-radius: 9999px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        z-index: 100;
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
    }

    .document-counter span {
        color: #1e293b;
    }

    /* Toast: top center, slide-in */
    #toast.toast-enter:not(.hidden) {
        animation: toastSlideIn 0.35s ease-out forwards;
    }
    @keyframes toastSlideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -100%);
        }
        to {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    }
    #toast.toast-warning #toastContent {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        box-shadow: 0 8px 24px rgba(245, 158, 11, 0.25);
    }
    #toast.toast-warning #toastMessage {
        color: #92400e;
        font-weight: 600;
    }

    /* Floating action bar */
    .floating-action-bar {
        position: fixed;
        bottom: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 0.875rem 1.25rem;
        border-radius: 1rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.06);
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    /* Premium button */
    .premium-btn {
        transition: all 0.2s ease-out;
        border-radius: 0.75rem;
    }

    .premium-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Premium textarea */
    .premium-textarea {
        border: 2px solid #e2e8f0;
        border-radius: 0.625rem;
        background-color: #f8fafc;
        transition: all 0.2s ease-out;
        padding: 0.75rem 1rem;
        font-size: 0.9375rem;
        width: 100%;
        resize: vertical;
        min-height: 100px;
    }

    .premium-textarea:focus {
        border-color: var(--focus-color, #f97316);
        background-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        outline: none;
    }

    .form-bottom-spacer {
        height: 100px;
    }

    /* Checkbox group */
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.625rem;
        cursor: pointer;
        transition: all 0.2s ease-out;
        background: #f8fafc;
    }

    .checkbox-item:hover {
        border-color: #cbd5e1;
    }

    .checkbox-item.checked {
        border-color: var(--section-color, #f97316);
        background: #fff7ed;
    }

    .checkbox-item input[type="checkbox"] {
        width: 1.125rem;
        height: 1.125rem;
        margin-right: 0.75rem;
        accent-color: var(--section-color, #f97316);
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .loading-overlay.show {
        display: flex;
        animation: overlayFadeIn 0.3s ease-out forwards;
    }

    @keyframes overlayFadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2.5rem 3rem;
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: contentSlideUp 0.4s ease-out forwards;
    }

    @keyframes contentSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .spinner-ring {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        border: 4px solid #f1f5f9;
        border-top-color: #f97316;
        border-right-color: #8b5cf6;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        margin-top: 1.5rem;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
    }

    .loading-subtext {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #64748b;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }
</style>

<!-- Progress Bar -->
<div class="progress-bar">
    <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
</div>

<!-- Document Counter -->
{% set total_docs = documents|length + (preview_data|length if preview_data else 0) + (static_documents|length if static_documents else 0) + (external_documents|length if external_documents else 0) %}
<div class="document-counter">
    <span>{{ total_docs }}</span> document{{ 's' if total_docs != 1 }} in package
</div>

<!-- Premium gradient background -->
<div class="min-h-full bg-gradient-to-br from-slate-50 via-white to-orange-50/30">
    <div class="p-4 md:p-6 max-w-6xl mx-auto">
        <!-- Back Link -->
        <a href="{{ url_for('transactions.view_transaction', id=transaction.id) }}"
            class="inline-flex items-center text-slate-500 hover:text-orange-600 text-sm mb-4 transition-colors animate-fade-in-up">
            <i class="fas fa-arrow-left mr-2"></i>Back to Transaction
        </a>

        <!-- Header Section -->
        <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 animate-fade-in-up">
            <div class="flex items-start space-x-4">
                <div
                    class="hidden md:flex w-14 h-14 rounded-2xl bg-gradient-to-br from-slate-700 to-slate-900 items-center justify-center shadow-lg flex-shrink-0">
                    <i class="fas fa-layer-group text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Fill All Documents</h1>
                    <p class="text-slate-500 mt-1">{{ transaction.street_address }}</p>
                    <p class="text-xs text-slate-400 mt-1">{{ total_docs }} document{{ 's' if total_docs != 1 }} in package</p>
                </div>
            </div>
        </div>

        <!-- Documents Overview - Card style matching preview page -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-8 animate-fade-in-up">
            <div class="flex flex-wrap gap-3">
                {% for doc in documents %}
                {% set config = doc_configs.get(doc.template_slug) %}
                <div class="flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 border-slate-200 font-medium text-sm bg-white">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center
                        {% if config %}bg-{{ config.color }}-100{% else %}bg-slate-100{% endif %}">
                        <i class="fas {{ config.icon if config else 'fa-file-alt' }}
                            {% if config %}text-{{ config.color }}-600{% else %}text-slate-600{% endif %}"></i>
                    </div>
                    <span class="text-slate-700">{{ doc.template_name }}</span>
                </div>
                {% endfor %}
                {% if preview_data %}
                {% for preview in preview_data %}
                <div class="flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 border-slate-200 font-medium text-sm bg-white">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-indigo-100">
                        <i class="fas fa-file-pdf text-indigo-600"></i>
                    </div>
                    <span class="text-slate-700">{{ preview.doc.template_name }}</span>
                </div>
                {% endfor %}
                {% endif %}
                {% if static_documents %}
                {% for doc in static_documents %}
                <div class="flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 border-slate-200 font-medium text-sm bg-white">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-teal-100">
                        <i class="fas fa-file-pdf text-teal-600"></i>
                    </div>
                    <span class="text-slate-700">{{ doc.template_name }}</span>
                    <span class="px-1.5 py-0.5 text-[10px] font-semibold rounded bg-teal-100 text-teal-700">Static</span>
                </div>
                {% endfor %}
                {% endif %}
                {% if external_documents %}
                {% for doc in external_documents %}
                <div class="flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 border-slate-200 font-medium text-sm bg-white">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-purple-100">
                        <i class="fas fa-file-signature text-purple-600"></i>
                    </div>
                    <span class="text-slate-700">{{ doc.template_name }}</span>
                    <span class="px-1.5 py-0.5 text-[10px] font-semibold rounded bg-purple-100 text-purple-700">External</span>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- Main Form -->
        <form id="fillAllForm" method="POST"
            action="{{ url_for('transactions.save_all_documents', id=transaction.id) }}">

            {% for doc in documents %}
            {% set config = doc_configs.get(doc.template_slug) %}

            <!-- Document Divider (not on first) -->
            {% if not loop.first %}
            <div class="document-divider">
                <div class="document-divider-content">
                    <span class="document-badge document-badge-{{ config.color if config else 'default' }}">
                        <i class="fas {{ config.icon if config else 'fa-file-alt' }}"></i>
                        {{ doc.template_name }}
                    </span>
                </div>
            </div>
            {% else %}
            <!-- First Document Header -->
            <div class="flex items-center gap-3 mb-6 animate-fade-in-up">
                <span class="document-badge document-badge-{{ config.color if config else 'default' }}">
                    <i class="fas {{ config.icon if config else 'fa-file-alt' }}"></i>
                    Document 1: {{ doc.template_name }}
                </span>
            </div>
            {% endif %}

            <!-- Include the form content from registry-defined partial template -->
            {% if config %}
            <div class="doc-section" style="--section-color: {{ config.section_color_var }}">
                {% include config.partial_template %}
            </div>
            {% else %}
            <!-- No specialized form for this document type -->
            <div class="premium-card p-6 mb-6">
                <p class="text-slate-500">No specialized form available for {{ doc.template_name }}. Use the individual
                    document form.</p>
            </div>
            {% endif %}

            {% endfor %}

        </form>

        <!-- Preview-Only Documents Section -->
        {% if has_preview_docs and preview_data %}
        <div class="preview-documents-section mt-8">
            <!-- Section Divider -->
            <div class="document-divider">
                <div class="document-divider-content">
                    <span class="document-badge document-badge-indigo">
                        <i class="fas fa-file-pdf"></i>
                        Pre-Filled Documents
                    </span>
                </div>
            </div>

            <p class="text-sm text-slate-500 text-center mb-6">
                These documents are pre-filled with relevant data. Review the preview below.
            </p>

            {% for preview in preview_data %}
            {% set config = preview.config %}
            {% set doc = preview.doc %}

            <!-- Preview Document Card -->
            <div class="premium-card p-6 mb-6" style="--section-color: {{ config.section_color_var }}">
                <!-- Document Header -->
                <div class="section-header">
                    <div class="section-number bg-{{ config.color }}-100 text-{{ config.color }}-700">
                        <i class="fas {{ config.icon }}"></i>
                    </div>
                    <div>
                        <h3 class="section-title">{{ doc.template_name }}</h3>
                        {% if doc.template_slug == 'iabs' %}
                        <p class="section-subtitle">Auto-populated from your agent profile</p>
                        {% else %}
                        <p class="section-subtitle">Pre-filled with property address - seller completes during signing</p>
                        {% endif %}
                    </div>
                    <span
                        class="ml-auto inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                        <i class="fas fa-check-circle mr-1"></i>
                        Ready
                    </span>
                </div>

                <!-- DocuSeal Preview Embed -->
                <div class="preview-embed-container rounded-lg overflow-hidden border border-slate-200"
                    style="min-height: 600px;">
                    {% if preview.mock_mode %}
                    <!-- Mock mode placeholder -->
                    <div
                        class="flex flex-col items-center justify-center h-full min-h-[400px] bg-gradient-to-br from-slate-50 to-{{ config.color }}-50 p-8">
                        <div class="w-20 h-20 rounded-full bg-{{ config.color }}-100 flex items-center justify-center mb-4">
                            <i class="fas fa-file-pdf text-4xl text-{{ config.color }}-500"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-800 mb-2">{{ doc.template_name }}</h4>
                        {% if doc.template_slug == 'iabs' %}
                        <p class="text-slate-500 text-center max-w-md mb-6">
                            Document preview is available in production mode. This document has been
                            pre-filled with your agent and supervisor information.
                        </p>
                        <div class="bg-white rounded-xl border border-slate-200 p-6 max-w-sm text-left">
                            <h5 class="font-medium text-slate-700 mb-3 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Pre-filled Fields
                            </h5>
                            <ul class="space-y-2 text-sm text-slate-600">
                                {% if doc.field_data %}
                                <li class="flex items-center gap-2">
                                    <i class="fas fa-user text-indigo-400 w-4"></i>
                                    Agent: {{ doc.field_data.get('agent_name', 'N/A') }}
                                </li>
                                <li class="flex items-center gap-2">
                                    <i class="fas fa-id-card text-indigo-400 w-4"></i>
                                    License: {{ doc.field_data.get('agent_license', 'N/A') }}
                                </li>
                                <li class="flex items-center gap-2">
                                    <i class="fas fa-user-tie text-indigo-400 w-4"></i>
                                    Supervisor: {{ doc.field_data.get('supervisor_name', 'N/A') }}
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        {% else %}
                        <p class="text-slate-500 text-center max-w-md mb-6">
                            Document preview is available in production mode. The property address has been
                            pre-filled. The seller will complete this form during the signing process.
                        </p>
                        <div class="bg-white rounded-xl border border-slate-200 p-6 max-w-sm text-left">
                            <h5 class="font-medium text-slate-700 mb-3 flex items-center gap-2">
                                <i class="fas fa-check-circle text-green-500"></i>
                                Pre-filled Fields
                            </h5>
                            <ul class="space-y-2 text-sm text-slate-600">
                                <li class="flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-blue-400 w-4"></i>
                                    Address: {{ doc.field_data.get('property_address', transaction.full_address) if doc.field_data else transaction.full_address }}
                                </li>
                            </ul>
                            <p class="text-xs text-slate-500 mt-3">
                                <i class="fas fa-pen-fancy mr-1"></i>
                                Seller completes disclosure questions during signing
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    {% elif preview.embed_src %}
                    <!-- Real DocuSeal embed preview -->
                    <script src="https://cdn.docuseal.com/js/form.js"></script>
                    <docuseal-form data-src="{{ preview.embed_src }}" data-preview="true" data-readonly="true"
                        style="min-height: 600px;">
                    </docuseal-form>
                    {% elif preview.error %}
                    <!-- Error state -->
                    <div class="flex flex-col items-center justify-center h-full min-h-[300px] bg-red-50 p-8">
                        <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-red-800 mb-2">Preview Error</h4>
                        <p class="text-red-600 text-center max-w-md">{{ preview.error }}</p>
                    </div>
                    {% else %}
                    <!-- No preview available -->
                    <div class="flex flex-col items-center justify-center h-full min-h-[300px] bg-slate-50 p-8">
                        <div class="w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center mb-4">
                            <i class="fas fa-file-alt text-3xl text-slate-400"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-700 mb-2">Preview Not Available</h4>
                        <p class="text-slate-500 text-center max-w-md">
                            The document preview could not be generated. The document will still be included when sent
                            for signature.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Static Documents Section (Uploaded PDFs, no signing) -->
        {% if has_static_docs and static_documents %}
        <div class="static-documents-section mt-8">
            <!-- Section Divider -->
            <div class="document-divider">
                <div class="document-divider-content">
                    <span class="document-badge document-badge-cyan">
                        <i class="fas fa-file-pdf"></i>
                        Uploaded Documents
                    </span>
                </div>
            </div>

            <p class="text-sm text-slate-500 text-center mb-6">
                These documents have been uploaded and will be included in the final package.
            </p>

            {% for doc in static_documents %}
            <!-- Static Document Card -->
            <div class="premium-card p-6 mb-6">
                <!-- Document Header -->
                <div class="section-header">
                    <div class="section-number bg-teal-100 text-teal-700">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div>
                        <h3 class="section-title">{{ doc.template_name }}</h3>
                        <p class="section-subtitle">Uploaded document - no signatures required</p>
                    </div>
                    <span class="ml-auto inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-teal-100 text-teal-700">
                        <i class="fas fa-check-circle mr-1"></i>
                        Will be included
                    </span>
                </div>

                <!-- Document Preview -->
                <div class="flex items-center justify-center p-8 bg-gradient-to-br from-slate-50 to-teal-50 rounded-lg border border-slate-200">
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full bg-teal-100 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-pdf text-3xl text-teal-600"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-800 mb-2">{{ doc.template_name }}</h4>
                        <p class="text-sm text-slate-500 mb-4">
                            This document will be included in the package when sent to the client.
                        </p>
                        {% if doc.included_reason %}
                        <p class="text-xs text-slate-400">
                            <i class="fas fa-info-circle mr-1"></i>{{ doc.included_reason }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- External Documents Section (PDFs with signature fields) -->
        {% if has_external_docs and external_documents %}
        <div class="external-documents-section mt-8">
            <!-- Section Divider -->
            <div class="document-divider">
                <div class="document-divider-content">
                    <span class="document-badge" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
                        <i class="fas fa-file-signature"></i>
                        External Documents
                    </span>
                </div>
            </div>

            <p class="text-sm text-slate-500 text-center mb-6">
                These external documents have signature fields configured and will be sent for e-signature.
            </p>

            {% for doc in external_documents %}
            <!-- External Document Card -->
            <div class="premium-card p-6 mb-6">
                <!-- Document Header -->
                <div class="section-header">
                    <div class="section-number bg-purple-100 text-purple-700">
                        <i class="fas fa-file-signature"></i>
                    </div>
                    <div>
                        <h3 class="section-title">{{ doc.template_name }}</h3>
                        <p class="section-subtitle">External document with signature fields</p>
                    </div>
                    <span class="ml-auto inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-700">
                        <i class="fas fa-check-circle mr-1"></i>
                        Will be sent for signature
                    </span>
                </div>

                <!-- Document Preview -->
                <div class="flex items-center justify-center p-8 bg-gradient-to-br from-slate-50 to-purple-50 rounded-lg border border-slate-200">
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full bg-purple-100 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-signature text-3xl text-purple-600"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-800 mb-2">{{ doc.template_name }}</h4>
                        <p class="text-sm text-slate-500 mb-4">
                            This document has signature fields placed and will be sent for e-signature.
                        </p>
                        <a href="{{ url_for('transactions.document_field_editor', id=transaction.id, doc_id=doc.id) }}" 
                           target="_blank"
                           class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors">
                            <i class="fas fa-eye"></i>
                            View Field Positions
                        </a>
                        {% if doc.included_reason %}
                        <p class="text-xs text-slate-400 mt-4">
                            <i class="fas fa-info-circle mr-1"></i>{{ doc.included_reason }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Spacer for floating action bar -->
        <div class="form-bottom-spacer"></div>

        <!-- Floating Action Bar -->
        <div class="floating-action-bar">
            <a href="{{ url_for('transactions.view_transaction', id=transaction.id) }}"
                class="premium-btn px-5 py-2.5 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors">
                Cancel
            </a>
            <div class="w-px h-8 bg-slate-200"></div>
            <button type="submit" form="fillAllForm" name="submit_action" value="save"
                class="premium-btn px-5 py-2.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg flex items-center gap-2 transition-colors">
                <i class="fas fa-save text-slate-500"></i>
                Save All Drafts
            </button>
            <button type="submit" form="fillAllForm" name="submit_action" value="continue"
                class="premium-btn px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-violet-600 hover:from-orange-600 hover:to-violet-700 rounded-lg flex items-center gap-2 shadow-sm transition-colors">
                <i class="fas fa-check-circle"></i>
                Save All & Continue
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner-ring"></div>
        <div class="loading-text">Generating Documents...</div>
        <div class="loading-subtext">This may take a few moments</div>
    </div>
</div>

<!-- Toast Notification (top center, slides in) -->
<div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[1001] hidden toast-enter">
    <div id="toastContent"
        class="flex items-center gap-3 px-6 py-4 bg-white rounded-xl shadow-2xl border-2 border-slate-200 min-w-[320px] max-w-[480px]">
        <i id="toastIcon" class="fas fa-info-circle text-blue-500 text-lg flex-shrink-0"></i>
        <span id="toastMessage" class="text-sm font-medium text-slate-700"></span>
    </div>
</div>

<script>
    // =============================================================================
    // INITIALIZATION
    // =============================================================================

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize all conditional sections based on current values
        initializeConditionalSections();

        // Initialize option cards styling
        initializeOptionCards();

        // Update progress bar
        updateProgress();

        // Add input listeners for progress tracking
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', updateProgress);
            el.addEventListener('input', updateProgress);
        });

        // Initialize T-47.1 property description sync from Listing Agreement
        initializeT47PropertyDescSync();

        // Cross-document sync: Listing Agreement <-> Seller Net Proceeds
        initializeCrossDocSync();
    });

    // =============================================================================
    // T-47.1 PROPERTY DESCRIPTION SYNC FROM LISTING AGREEMENT
    // =============================================================================

    function initializeT47PropertyDescSync() {
        // Find all Listing Agreement property description source fields
        const laFieldPatterns = [
            'legal_lot',
            'legal_block', 
            'legal_subdivision',
            'property_city',
            'property_county',
            'property_address'
        ];

        // Find all T-47.1 property description fields
        const t47PropDescFields = document.querySelectorAll('[name*="_field_property_description"]');
        
        // Find the T-47 document's property description field specifically
        // (it will have a name like doc_123_field_property_description where 123 is the T-47 doc ID)
        let t47Field = null;
        t47PropDescFields.forEach(field => {
            // Check if this is inside a T-47 section (amber colored)
            const section = field.closest('.doc-section');
            if (section) {
                const sectionColor = section.style.getPropertyValue('--section-color');
                // Amber color is #f59e0b
                if (sectionColor && sectionColor.includes('f59e0b')) {
                    t47Field = field;
                }
            }
        });

        // Alternative: look for field in the t47 partial by checking nearby labels
        if (!t47Field) {
            t47PropDescFields.forEach(field => {
                const card = field.closest('.premium-card');
                if (card) {
                    const header = card.querySelector('.section-title, h2');
                    if (header && (header.textContent.includes('T-47') || header.textContent.includes('Property Declaration'))) {
                        t47Field = field;
                    }
                }
            });
        }

        if (!t47Field) {
            // No T-47 form found on this page
            return;
        }

        // Find all Listing Agreement source fields
        const laFields = {};
        laFieldPatterns.forEach(pattern => {
            const field = document.querySelector(`[name*="_field_${pattern}"]`);
            if (field) {
                laFields[pattern] = field;
            }
        });

        // If we have LA fields, set up listeners
        if (Object.keys(laFields).length > 0) {
            // Function to build the property description
            function buildPropertyDescription() {
                const lot = laFields.legal_lot?.value || '';
                const block = laFields.legal_block?.value || '';
                const subdivision = laFields.legal_subdivision?.value || '';
                const city = laFields.property_city?.value || '';
                const county = laFields.property_county?.value || '';
                const address = laFields.property_address?.value || '';

                const parts = [];
                
                if (lot) parts.push(`Lot ${lot}`);
                if (block) parts.push(`Block ${block}`);
                if (subdivision) parts.push(`${subdivision} Addition`);
                if (city) parts.push(`City of ${city}`);
                if (county) parts.push(`${county} County, TX`);
                if (address) parts.push(`known as ${address}`);

                return parts.join(', ');
            }

            // Function to update T-47 field
            function updateT47PropertyDesc() {
                const newValue = buildPropertyDescription();
                // Update if we have content AND user hasn't manually edited
                // (autoSynced is 'true' by default, becomes 'false' only on manual keydown)
                if (newValue && t47Field.dataset.autoSynced !== 'false') {
                    t47Field.value = newValue;
                    // Trigger change event for any listeners (but not our own)
                    t47Field.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }

            // Add listeners to all LA fields
            Object.values(laFields).forEach(field => {
                if (field) {
                    field.addEventListener('input', updateT47PropertyDesc);
                    field.addEventListener('change', updateT47PropertyDesc);
                }
            });

            // Track if user manually types in the T-47 field (not via our sync)
            let userIsTyping = false;
            t47Field.addEventListener('keydown', function() {
                userIsTyping = true;
            });
            t47Field.addEventListener('blur', function() {
                if (userIsTyping) {
                    // User manually edited, stop auto-syncing
                    this.dataset.autoSynced = 'false';
                    userIsTyping = false;
                }
            });

            // Mark as auto-synced since it was pre-populated from server
            t47Field.dataset.autoSynced = 'true';
            
            // Initial sync - always update to include any LA fields that may be filled
            updateT47PropertyDesc();
        }

        // Also sync the county field
        syncT47CountyField();
    }

    function syncT47CountyField() {
        // Find Listing Agreement county field
        const laCountyField = document.querySelector('[name*="_field_property_county"]');
        
        // Find T-47 county field
        const t47CountyFields = document.querySelectorAll('[name*="_field_county"]');
        let t47CountyField = null;
        
        t47CountyFields.forEach(field => {
            const card = field.closest('.premium-card');
            if (card) {
                const header = card.querySelector('.section-title, h2');
                if (header && (header.textContent.includes('T-47') || header.textContent.includes('Property Declaration'))) {
                    t47CountyField = field;
                }
            }
        });

        if (laCountyField && t47CountyField) {
            // Mark as auto-synced by default
            t47CountyField.dataset.autoSynced = 'true';
            
            laCountyField.addEventListener('input', function() {
                if (t47CountyField.dataset.autoSynced !== 'false') {
                    t47CountyField.value = this.value;
                }
            });

            // Track manual edits
            t47CountyField.addEventListener('keydown', function() {
                this.dataset.autoSynced = 'false';
            });

            // Initial sync
            if (laCountyField.value) {
                t47CountyField.value = laCountyField.value;
            }
        }
    }

    // =============================================================================
    // CROSS-DOCUMENT SYNC: LISTING AGREEMENT <-> SELLER NET PROCEEDS
    // =============================================================================

    function initializeCrossDocSync() {
        const laListPrice = document.querySelector('input[name*="_field_list_price"]');
        const snpSalesPrice = document.querySelector('input[name*="_field_sales_price"]');
        const laStartDate = document.querySelector('input[name*="_field_listing_start_date"]');
        const snpClosingDate = document.querySelector('input[name*="_field_closing_date"]');

        if (!laListPrice && !snpSalesPrice && !laStartDate && !snpClosingDate) {
            return;
        }

        const snpDocId = snpSalesPrice ? (snpSalesPrice.id && snpSalesPrice.id.startsWith('snp_salesPrice_') ? snpSalesPrice.id.replace('snp_salesPrice_', '') : null) : null;

        function parseMoney(val) {
            if (val == null || val === '') return null;
            const s = String(val).replace(/[$,]/g, '').trim();
            const n = parseFloat(s);
            return isNaN(n) ? null : n;
        }
        function formatMoney(num) {
            if (num == null || isNaN(num)) return '';
            return Number(num).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        // ---- List price <-> Sales price (bidirectional) ----
        if (laListPrice && snpSalesPrice) {
            laListPrice.addEventListener('input', function () {
                const raw = this.value.replace(/[$,]/g, '').trim();
                if (raw === '') {
                    snpSalesPrice.value = '';
                } else {
                    const n = parseFloat(raw);
                    if (!isNaN(n)) {
                        snpSalesPrice.value = formatMoney(n);
                        snpSalesPrice.dispatchEvent(new Event('input', { bubbles: true }));
                        if (snpDocId && typeof snpRecalculateAll === 'function') {
                            snpRecalculateAll(snpDocId);
                        }
                    }
                }
            });
            laListPrice.addEventListener('change', function () {
                const raw = this.value.replace(/[$,]/g, '').trim();
                if (raw !== '') {
                    const n = parseFloat(raw);
                    if (!isNaN(n)) {
                        snpSalesPrice.value = formatMoney(n);
                        snpSalesPrice.dispatchEvent(new Event('change', { bubbles: true }));
                        if (snpDocId && typeof snpRecalculateAll === 'function') {
                            snpRecalculateAll(snpDocId);
                        }
                    }
                }
            });

            snpSalesPrice.addEventListener('change', function () {
                const num = parseMoney(this.value);
                if (num != null) {
                    const prev = laListPrice.value;
                    const newVal = formatMoney(num);
                    laListPrice.value = newVal;
                    laListPrice.dispatchEvent(new Event('input', { bubbles: true }));
                    if (prev !== newVal) {
                        showToast('Sales Price was updated in Seller Net Proceeds. Listing Agreement list price has been updated to match â€” please verify this is correct.', 'warning');
                    }
                }
            });

            if (laListPrice.value && !snpSalesPrice.value) {
                const n = parseMoney(laListPrice.value);
                if (n != null) {
                    snpSalesPrice.value = formatMoney(n);
                    if (snpDocId && typeof snpRecalculateAll === 'function') {
                        snpRecalculateAll(snpDocId);
                    }
                }
            }
        }

        // ---- Financing checkboxes (shared: conventional, va, fha, cash) ----
        const sharedFinancing = ['conventional', 'va', 'fha', 'cash'];
        const laSections = document.querySelectorAll('.doc-section');
        let laSection = null;
        let snpSection = null;
        laSections.forEach(section => {
            if (section.querySelector('input[name*="_field_list_price"]')) laSection = section;
            if (section.querySelector('input[name*="_field_sales_price"]')) snpSection = section;
        });

        if (laSection && snpSection) {
            sharedFinancing.forEach(key => {
                const laCheck = laSection.querySelector(`input[name*="_field_financing_${key}"]`);
                const snpCheck = snpSection.querySelector(`input[name*="_field_financing_${key}"]`);
                if (!laCheck || !snpCheck) return;

                laCheck.addEventListener('change', function () {
                    snpCheck.checked = this.checked;
                    snpCheck.dispatchEvent(new Event('change', { bubbles: true }));
                });
                snpCheck.addEventListener('change', function () {
                    const wasChecked = laCheck.checked;
                    laCheck.checked = this.checked;
                    laCheck.dispatchEvent(new Event('change', { bubbles: true }));
                    if (wasChecked !== laCheck.checked) {
                        showToast('Financing selection was updated in Seller Net Proceeds. Listing Agreement has been updated to match â€” please verify this is correct.', 'warning');
                    }
                });

                if (laCheck.checked && !snpCheck.checked) {
                    snpCheck.checked = true;
                } else if (!laCheck.checked && snpCheck.checked) {
                    laCheck.checked = true;
                }
            });
        }

        // ---- Closing date from listing start + 90 days (one-way LA -> SNP) ----
        if (laStartDate && snpClosingDate) {
            snpClosingDate.dataset.autoSynced = snpClosingDate.value ? 'false' : 'true';

            function setClosingFromStart() {
                const startVal = laStartDate.value;
                if (!startVal) return;
                const start = new Date(startVal);
                if (isNaN(start.getTime())) return;
                const close = new Date(start);
                close.setDate(close.getDate() + 90);
                const closeStr = close.toISOString().slice(0, 10);
                if (snpClosingDate.dataset.autoSynced !== 'false') {
                    snpClosingDate.value = closeStr;
                    snpClosingDate.dataset.autoSynced = 'true';
                    snpClosingDate.dispatchEvent(new Event('change', { bubbles: true }));
                    if (snpDocId && typeof snpRecalculateAll === 'function') {
                        snpRecalculateAll(snpDocId);
                    }
                }
            }

            laStartDate.addEventListener('change', setClosingFromStart);
            laStartDate.addEventListener('input', setClosingFromStart);

            snpClosingDate.addEventListener('focus', function () {
                this.dataset.autoSynced = 'false';
            });
            snpClosingDate.addEventListener('change', function () {
                this.dataset.autoSynced = 'false';
            });

            if (laStartDate.value && (!snpClosingDate.value || snpClosingDate.dataset.autoSynced === 'true')) {
                setClosingFromStart();
            }
        }
    }

    function initializeConditionalSections() {
        // Check all radio buttons and apply their conditional logic
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            const fieldName = radio.name.replace(/^doc_\d+_field_/, '');
            handleConditionalLogic(fieldName, radio.value, radio);
        });
    }

    function initializeOptionCards() {
        document.querySelectorAll('.option-card').forEach(card => {
            const input = card.querySelector('input[type="radio"], input[type="checkbox"]');
            if (input && input.checked) {
                card.classList.add('selected');
            }
        });
    }

    // =============================================================================
    // OPTION SELECTION
    // =============================================================================

    function selectOption(element, fieldName, value) {
        // Update visual state for radio buttons in the same group
        const container = element.closest('.grid, .flex');
        if (container) {
            container.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        element.classList.add('selected');

        // Handle conditional logic
        const input = element.querySelector('input');
        handleConditionalLogic(fieldName, value, input);
    }

    function handleConditionalLogic(fieldName, value, inputEl) {
        // Get the document context (which document's conditional sections to update)
        const docContainer = inputEl ? inputEl.closest('.doc-section') : null;

        // Extract the base field name without doc prefix
        const baseFieldName = fieldName.replace(/^doc_\d+_field_/, '');

        switch (baseFieldName) {
            case 'doc_responsibility':
                handleDocResponsibility(value, docContainer);
                break;
            case 'has_exclusions':
                toggleConditional('exclusionsSection', value === 'yes', docContainer);
                break;
            case 'offer_buyer_agent_comp':
                toggleConditional('section5A', value === 'yes', docContainer);
                toggleConditional('section5B', value === 'no', docContainer);
                break;
            case 'enter_mls':
                toggleConditional('mlsYesSection', value === 'yes', docContainer);
                toggleConditional('mlsNoSection', value === 'no', docContainer);
                break;
            case 'mls_timing':
                toggleConditional('mlsDelaySection', value === 'delayed', docContainer);
                break;
            case 'internet_display':
                toggleConditional('internetYesSection', value === 'yes', docContainer);
                break;
            case 'has_liens':
                toggleConditional('liensSection', value === 'yes', docContainer);
                break;
            case 'has_delinquencies':
                toggleConditional('delinquenciesSection', value === 'yes', docContainer);
                break;
            case 'has_special_districts':
                toggleConditional('specialDistrictsSection', value === 'yes', docContainer);
                break;
            case 'is_foreign_seller':
                toggleConditional('firptaWarningSection', value === 'yes' || value === 'not_sure', docContainer);
                break;
            case 'is_condo':
                toggleConditional('condoCallout', value === 'yes', docContainer);
                break;
        }

        updateProgress();
    }

    function toggleConditional(sectionId, show, container) {
        let section;
        if (container) {
            section = container.querySelector('#' + sectionId);
        }
        if (!section) {
            section = document.getElementById(sectionId);
        }
        if (section) {
            section.classList.toggle('show', show);
            if (section.style) {
                section.style.display = show ? 'block' : 'none';
            }
        }
    }

    function handleDocResponsibility(value, container) {
        toggleConditional('sellerDaysSection', value === 'seller', container);
        toggleConditional('buyerDaysSection', value === 'buyer', container);
        toggleConditional('updatedResaleSection', value === 'already_received', container);
        toggleConditional('notRequiredWarning', value === 'not_required', container);

        // Clear sub-option fields when their parent option is deselected
        if (value !== 'already_received') {
            // Clear the require_updated_resale radio buttons within this container
            const searchRoot = container || document;
            searchRoot.querySelectorAll('input[name*="require_updated_resale"]').forEach(radio => {
                radio.checked = false;
                // Also remove the 'selected' class from option cards
                const card = radio.closest('.option-card');
                if (card) card.classList.remove('selected');
            });
        }
    }

    // =============================================================================
    // PROGRESS TRACKING
    // =============================================================================

    function updateProgress() {
        const form = document.getElementById('fillAllForm');
        const allInputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
        let filledCount = 0;
        let totalCount = 0;

        allInputs.forEach(input => {
            if (input.type === 'radio') {
                const name = input.name;
                if (!form.querySelector(`[name="${name}"][data-counted]`)) {
                    totalCount++;
                    if (form.querySelector(`[name="${name}"]:checked`)) {
                        filledCount++;
                    }
                    input.setAttribute('data-counted', 'true');
                }
            } else if (input.type === 'checkbox') {
                // Don't count checkboxes toward progress
            } else if (input.value && input.value.trim()) {
                filledCount++;
                totalCount++;
            } else if (input.required) {
                totalCount++;
            }
        });

        // Reset counted flags
        form.querySelectorAll('[data-counted]').forEach(el => el.removeAttribute('data-counted'));

        const progress = totalCount > 0 ? Math.min((filledCount / totalCount) * 100, 100) : 0;
        document.getElementById('progressFill').style.width = progress + '%';
    }

    // =============================================================================
    // CURRENCY FORMATTING
    // =============================================================================

    function formatCurrency(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        if (value) {
            value = parseInt(value, 10).toLocaleString('en-US');
            input.value = value;
        }
    }

    // =============================================================================
    // DATE CALCULATIONS
    // =============================================================================

    function updateEndDateFromStart(startInput) {
        // Find the corresponding end date input in the same form section
        const section = startInput.closest('.premium-card') || startInput.closest('.form-section');
        if (section) {
            const endInput = section.querySelector('.listing-end-date');
            if (endInput && startInput.value) {
                // Only update if end date is empty or hasn't been manually changed
                if (!endInput.value || endInput.dataset.autoSet === 'true') {
                    const startDate = new Date(startInput.value);
                    // Add 6 months
                    startDate.setMonth(startDate.getMonth() + 6);
                    // Format as YYYY-MM-DD for input[type="date"]
                    const year = startDate.getFullYear();
                    const month = String(startDate.getMonth() + 1).padStart(2, '0');
                    const day = String(startDate.getDate()).padStart(2, '0');
                    endInput.value = `${year}-${month}-${day}`;
                    endInput.dataset.autoSet = 'true';
                }
            }
        }
    }

    // Initialize end date listeners to clear auto-set flag when user manually changes
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.listing-end-date').forEach(function (endInput) {
            endInput.addEventListener('input', function () {
                this.dataset.autoSet = 'false';
            });
        });
    });

    // =============================================================================
    // TOAST NOTIFICATIONS
    // =============================================================================

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        document.getElementById('toastMessage').textContent = message;

        toast.classList.remove('toast-warning');
        icon.className = 'fas flex-shrink-0 text-lg';
        if (type === 'success') {
            icon.classList.add('fa-check-circle', 'text-green-500');
        } else if (type === 'error') {
            icon.classList.add('fa-exclamation-circle', 'text-red-500');
        } else if (type === 'warning') {
            icon.classList.add('fa-exclamation-triangle', 'text-amber-600');
            toast.classList.add('toast-warning');
        } else {
            icon.classList.add('fa-info-circle', 'text-blue-500');
        }

        toast.classList.remove('hidden');
        const duration = type === 'warning' ? 6000 : 4000;
        setTimeout(() => toast.classList.add('hidden'), duration);
    }

    function toggleCheckbox(element) {
        element.classList.toggle('checked');
    }

    // =============================================================================
    // LOADING OVERLAY
    // =============================================================================

    function showLoadingOverlay() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.add('show');
        }
    }

    function hideLoadingOverlay() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('show');
        }
    }

    // Intercept form submission for "Save All & Continue" button
    document.addEventListener('DOMContentLoaded', function () {
        // The continue button is OUTSIDE the form (in floating action bar)
        // It uses form="fillAllForm" attribute to submit the form
        const continueBtn = document.querySelector('button[form="fillAllForm"][value="continue"]');

        if (continueBtn) {
            continueBtn.addEventListener('click', function (e) {
                // Show loading overlay before form submits
                showLoadingOverlay();
            });
        }
    });
</script>
{% endblock %}