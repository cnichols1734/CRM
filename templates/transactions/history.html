{% extends "base.html" %}

{% block title %}Activity History - {{ transaction.street_address }} - TechnolOG{% endblock %}

{% block content %}
<style>
    /* Premium animations */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    /* Premium card styling */
    .premium-card {
        background: white;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: all 0.2s ease-out;
    }

    .premium-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    /* Timeline styling */
    .timeline {
        position: relative;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 1.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #f97316, #ea580c);
        opacity: 0.2;
    }

    .timeline-item {
        position: relative;
        padding-left: 4rem;
        padding-bottom: 1.5rem;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-icon {
        position: absolute;
        left: 0;
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .timeline-icon.success { background: #dcfce7; color: #166534; }
    .timeline-icon.info { background: #dbeafe; color: #1e40af; }
    .timeline-icon.warning { background: #fef3c7; color: #92400e; }
    .timeline-icon.danger { background: #fee2e2; color: #991b1b; }
    .timeline-icon.primary { background: #fed7aa; color: #c2410c; }
    .timeline-icon.secondary { background: #f1f5f9; color: #475569; }

    .timeline-content {
        background: #f8fafc;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease-out;
    }

    .timeline-content:hover {
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .timeline-label {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.9375rem;
    }

    .timeline-time {
        font-size: 0.75rem;
        color: #94a3b8;
        white-space: nowrap;
    }

    .timeline-description {
        color: #64748b;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .timeline-actor {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        color: #94a3b8;
        margin-top: 0.5rem;
    }

    .timeline-actor i {
        font-size: 0.625rem;
    }

    .timeline-metadata {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e2e8f0;
    }

    .metadata-item {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        color: #64748b;
        background: #f1f5f9;
        padding: 0.25rem 0.625rem;
        border-radius: 9999px;
        margin-right: 0.375rem;
        margin-bottom: 0.375rem;
    }

    /* Filter buttons */
    .filter-btn {
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid #e2e8f0;
        background: white;
        color: #64748b;
        transition: all 0.2s ease-out;
        cursor: pointer;
    }

    .filter-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }

    .filter-btn.active {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        border-color: transparent;
    }

    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #f97316;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #94a3b8;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>

<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="animate-fade-in-up mb-6">
        <div class="flex items-center gap-3 mb-2">
            <a href="{{ url_for('transactions.view_transaction', id=transaction.id) }}"
               class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-2xl font-bold text-gray-800">Activity History</h1>
        </div>
        <p class="text-gray-500 ml-7">{{ transaction.street_address }}</p>
    </div>

    <!-- Filters -->
    <div class="premium-card p-4 mb-6 animate-fade-in-up" style="animation-delay: 0.1s;">
        <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm text-gray-500 mr-2">Filter:</span>
            <button class="filter-btn active" data-filter="all">All Events</button>
            <button class="filter-btn" data-filter="transaction">Transaction</button>
            <button class="filter-btn" data-filter="document">Documents</button>
            <button class="filter-btn" data-filter="signature">Signatures</button>
            <button class="filter-btn" data-filter="webhook">System</button>
        </div>
    </div>

    <!-- Timeline -->
    <div class="premium-card p-6 animate-fade-in-up" style="animation-delay: 0.2s;">
        <div id="timeline-container">
            <div class="flex justify-center py-8">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination-container" class="hidden mt-6 pt-4 border-t border-gray-100">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-500">
                    Showing <span id="showing-count">0</span> of <span id="total-count">0</span> events
                </span>
                <div class="flex gap-2">
                    <button id="prev-page" class="px-4 py-2 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-1"></i> Previous
                    </button>
                    <button id="next-page" class="px-4 py-2 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentFilter = 'all';
    let totalPages = 1;

    const filterMap = {
        'all': null,
        'transaction': ['transaction_created', 'transaction_updated', 'transaction_status_changed', 'transaction_deleted', 'participant_added', 'participant_removed'],
        'document': ['document_added', 'document_removed', 'document_filled', 'document_generated', 'document_package_generated', 'intake_saved'],
        'signature': ['document_sent', 'envelope_sent', 'document_resent', 'document_voided', 'document_viewed', 'document_signed'],
        'webhook': ['webhook_received']
    };

    // Fetch and render events
    async function loadEvents(page = 1) {
        const container = document.getElementById('timeline-container');
        container.innerHTML = '<div class="flex justify-center py-8"><div class="loading-spinner"></div></div>';

        try {
            const response = await fetch(`{{ url_for('transactions.transaction_history', id=transaction.id) }}?page=${page}&per_page=50`);
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to load events');
            }

            let events = data.events;

            // Apply filter
            if (currentFilter !== 'all' && filterMap[currentFilter]) {
                events = events.filter(e => filterMap[currentFilter].includes(e.event_type));
            }

            renderTimeline(events);
            updatePagination(data.pagination, events.length);

        } catch (error) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Error loading activity history</p>
                    <p class="text-sm mt-2">${error.message}</p>
                </div>
            `;
        }
    }

    function renderTimeline(events) {
        const container = document.getElementById('timeline-container');

        if (events.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>No activity recorded yet</p>
                    <p class="text-sm mt-2">Events will appear here as you work with this transaction</p>
                </div>
            `;
            return;
        }

        let html = '<div class="timeline">';

        events.forEach(event => {
            const time = formatTime(event.created_at);
            const metadata = renderMetadata(event);

            html += `
                <div class="timeline-item" data-event-type="${event.event_type}">
                    <div class="timeline-icon ${event.color}">
                        <i class="${event.icon}"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-label">${event.label}</span>
                            <span class="timeline-time">${time}</span>
                        </div>
                        <p class="timeline-description">${event.description || ''}</p>
                        ${event.actor_name ? `
                            <div class="timeline-actor">
                                <i class="fas fa-user"></i>
                                ${event.actor_name}
                            </div>
                        ` : ''}
                        ${metadata}
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    function renderMetadata(event) {
        const meta = event.metadata;
        if (!meta || Object.keys(meta).length === 0) return '';

        let items = [];

        // Document-related
        if (meta.template_name) items.push(`<span class="metadata-item"><i class="fas fa-file"></i> ${meta.template_name}</span>`);
        if (meta.document_count) items.push(`<span class="metadata-item"><i class="fas fa-copy"></i> ${meta.document_count} documents</span>`);

        // Participant-related
        if (meta.role) items.push(`<span class="metadata-item"><i class="fas fa-user-tag"></i> ${meta.role}</span>`);
        if (meta.name && !event.description.includes(meta.name)) items.push(`<span class="metadata-item"><i class="fas fa-user"></i> ${meta.name}</span>`);

        // Status changes
        if (meta.old_status && meta.new_status) {
            items.push(`<span class="metadata-item"><i class="fas fa-exchange-alt"></i> ${formatStatus(meta.old_status)} â†’ ${formatStatus(meta.new_status)}</span>`);
        }

        // Signers
        if (meta.signer_count) items.push(`<span class="metadata-item"><i class="fas fa-signature"></i> ${meta.signer_count} signers</span>`);
        if (meta.signer_email) items.push(`<span class="metadata-item"><i class="fas fa-envelope"></i> ${meta.signer_email}</span>`);

        // Resend count
        if (meta.resent_count !== undefined) items.push(`<span class="metadata-item"><i class="fas fa-redo"></i> ${meta.resent_count} emails resent</span>`);

        // DocuSeal ID
        if (meta.docuseal_submission_id) items.push(`<span class="metadata-item"><i class="fas fa-hashtag"></i> ${meta.docuseal_submission_id}</span>`);

        if (items.length === 0) return '';

        return `<div class="timeline-metadata">${items.join('')}</div>`;
    }

    function formatTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;

        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
        });
    }

    function formatStatus(status) {
        return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function updatePagination(pagination, filteredCount) {
        const paginationContainer = document.getElementById('pagination-container');
        const showingCount = document.getElementById('showing-count');
        const totalCount = document.getElementById('total-count');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');

        totalPages = pagination.pages;
        currentPage = pagination.page;

        showingCount.textContent = filteredCount;
        totalCount.textContent = pagination.total;

        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        paginationContainer.classList.remove('hidden');
    }

    // Event listeners for filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            currentPage = 1;
            loadEvents(1);
        });
    });

    // Pagination
    document.getElementById('prev-page').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            loadEvents(currentPage);
        }
    });

    document.getElementById('next-page').addEventListener('click', function() {
        if (currentPage < totalPages) {
            currentPage++;
            loadEvents(currentPage);
        }
    });

    // Initial load
    loadEvents(1);
});
</script>
{% endblock %}
