{# 
Seller's Estimated Net Proceeds Form Fields Partial
TXR-1935 - Seller's Estimated Net Proceeds

This partial creates a document-style form UI that mimics the actual TXR form layout.
Includes real-time calculations for prorated taxes, broker fees, and totals.

Variables expected: prefill_data (dict), doc (optional - for field prefixing in combined view)
#}

{% set field_prefix = 'doc_' ~ (doc.id if doc else 'snp') ~ '_field_' %}
{% set doc_id = doc.id if doc else 'snp' %}

<!-- ============================================================== -->
<!-- SELLER'S ESTIMATED NET PROCEEDS - DOCUMENT STYLE -->
<!-- ============================================================== -->
<style>
    .snp-document { background: #fff; border-radius: 0.75rem; box-shadow: 0 2px 12px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 1.5rem; overflow: hidden; }
    .snp-header { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); color: white; padding: 1rem 1.25rem; text-align: center; }
    .snp-header h2 { font-size: 1.125rem; font-weight: 700; letter-spacing: 0.05em; margin: 0; }
    .snp-body { padding: 1.25rem 1.5rem; }
    .snp-disclaimer { font-size: 0.75rem; font-style: italic; color: #64748b; text-align: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f1f5f9; }
    .snp-form-row { display: flex; align-items: center; margin-bottom: 0.625rem; gap: 0.5rem; }
    .snp-form-row label { font-size: 0.8125rem; font-weight: 500; color: #333; white-space: nowrap; }
    .snp-form-row input.snp-field { border: none; border-bottom: 2px solid #3b82f6; background: #f8fafc; padding: 0.25rem 0.375rem; font-size: 0.8125rem; flex: 1; min-width: 100px; transition: all 0.2s; }
    .snp-form-row input.snp-field:focus { outline: none; background: #eff6ff; border-bottom-color: #1d4ed8; }
    .snp-form-row input.snp-field[readonly] { background: #f1f5f9; border-bottom-color: #94a3b8; color: #64748b; }
    /* Money input wrapper for SNP form */
    .snp-money-wrapper { display: flex; align-items: center; border: 1.5px solid #e2e8f0; border-radius: 0.375rem; background: #fff; overflow: hidden; min-width: 95px; transition: all 0.2s; }
    .snp-money-wrapper:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
    .snp-money-wrapper.calculated { background: #f1f5f9; border-color: #cbd5e1; }
    .snp-money-wrapper .snp-dollar { padding: 0.2rem 0 0.2rem 0.375rem; color: #94a3b8; font-size: 0.75rem; font-weight: 500; background: #f8fafc; }
    .snp-money-wrapper.calculated .snp-dollar { background: #f1f5f9; color: #94a3b8; }
    .snp-money-wrapper .snp-money-input { width: 100%; padding: 0.2rem 0.375rem 0.2rem 0.25rem; border: none; font-size: 0.75rem; text-align: right; background: transparent; }
    .snp-money-wrapper .snp-money-input:focus { outline: none; }
    .snp-money-wrapper .snp-money-input[readonly] { color: #64748b; font-weight: 600; }
    .snp-two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem; }
    @media (max-width: 768px) { .snp-two-col { grid-template-columns: 1fr; gap: 1rem; } }
    .snp-section-box { border: 1.5px solid #e2e8f0; border-radius: 0.625rem; padding: 0.875rem; background: #fafbfc; }
    .snp-section-title { font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.625rem; padding-bottom: 0.5rem; border-bottom: 2px solid #334155; }
    .snp-cost-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.375rem; font-size: 0.75rem; }
    .snp-cost-row label { color: #475569; flex: 1; }
    .snp-cost-row .snp-percent-input { width: 40px; padding: 0.2rem; border: 1.5px solid #e2e8f0; border-radius: 0.25rem; font-size: 0.75rem; text-align: center; margin-right: 0.25rem; }
    .snp-cost-row .snp-percent-input:focus { outline: none; border-color: #3b82f6; }
    .snp-custom-row { display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.375rem; }
    .snp-custom-row .snp-custom-label { flex: 1; padding: 0.25rem; border: none; border-bottom: 1.5px dashed #cbd5e1; font-size: 0.75rem; background: transparent; transition: all 0.2s; }
    .snp-custom-row .snp-custom-label:focus { outline: none; border-bottom-color: #3b82f6; border-bottom-style: solid; }
    .snp-custom-row .snp-custom-label::placeholder { color: #94a3b8; font-style: italic; }
    .snp-total-row { display: flex; justify-content: space-between; align-items: center; padding-top: 0.625rem; margin-top: 0.625rem; border-top: 2px solid #334155; font-weight: 700; font-size: 0.8125rem; }
    .snp-total-row .snp-money-wrapper { background: #f1f5f9; border-color: #94a3b8; border-width: 2px; min-width: 100px; }
    .snp-total-row .snp-money-wrapper .snp-dollar { background: #f1f5f9; color: #64748b; font-weight: 700; }
    .snp-total-row .snp-money-wrapper .snp-money-input { font-size: 0.8125rem; font-weight: 700; color: #475569; }
    .snp-net-proceeds-row { display: flex; justify-content: space-between; align-items: center; padding: 0.625rem; margin-top: 0.75rem; background: linear-gradient(135deg, #ecfdf5, #d1fae5); border: 2px solid #10b981; border-radius: 0.5rem; }
    .snp-net-proceeds-row label { font-weight: 700; font-size: 0.875rem; color: #065f46; }
    .snp-net-proceeds-row .snp-money-wrapper { background: white; border: 2px solid #059669; border-radius: 0.375rem; min-width: 110px; }
    .snp-net-proceeds-row .snp-money-wrapper .snp-dollar { background: white; color: #059669; font-weight: 700; font-size: 0.875rem; }
    .snp-net-proceeds-row .snp-money-wrapper .snp-money-input { font-size: 0.9375rem; font-weight: 700; color: #059669; }
    .snp-financing-group { display: flex; flex-wrap: wrap; gap: 0.375rem; margin-top: 0.375rem; }
    .snp-financing-option { display: flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.625rem; background: #f8fafc; border: 1.5px solid #e2e8f0; border-radius: 0.375rem; cursor: pointer; transition: all 0.15s; }
    .snp-financing-option:hover { background: #f1f5f9; border-color: #cbd5e1; }
    .snp-financing-option:has(input:checked) { background: #eff6ff; border-color: #3b82f6; }
    .snp-financing-option input[type="checkbox"] { width: 0.875rem; height: 0.875rem; accent-color: #3b82f6; cursor: pointer; }
    .snp-financing-option span { font-size: 0.75rem; color: #475569; font-weight: 500; }
    .snp-financing-option:has(input:checked) span { color: #1d4ed8; }
    .snp-prepared-by { margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #e2e8f0; font-size: 0.8125rem; color: #475569; }
    .snp-note-text { font-size: 0.6875rem; color: #64748b; font-style: italic; margin-top: 0.5rem; }
    .snp-parentheses::before { content: '('; font-weight: 600; color: #dc2626; margin-right: 2px; }
    .snp-parentheses::after { content: ')'; font-weight: 600; color: #dc2626; margin-left: 2px; }
</style>

<div class="snp-document" id="snpDocument_{{ doc_id }}">
    <div class="snp-header"><h2>SELLER'S ESTIMATED NET PROCEEDS</h2></div>
    <div class="snp-body">
        <p class="snp-disclaimer">The figures below are estimates. Actual costs and proceeds will vary. Estimates are not guaranteed.</p>

        <div class="snp-form-row"><label>Seller:</label><input type="text" name="{{ field_prefix }}seller_name" class="snp-field" value="{{ prefill_data.get('seller_name', '') }}" readonly></div>
        <div class="snp-form-row"><label>Address:</label><input type="text" name="{{ field_prefix }}property_address" class="snp-field" value="{{ prefill_data.get('property_address', '') }}" readonly></div>
        <div class="snp-form-row"><label>Anticipated Closing Date:</label><input type="date" name="{{ field_prefix }}closing_date" id="snp_closingDate_{{ doc_id }}" class="snp-field" style="max-width: 150px;" value="{{ prefill_data.get('closing_date', '') }}" onchange="snpRecalculateAll('{{ doc_id }}')"></div>
        <div class="snp-form-row"><label>Est. Annual Property Taxes:</label><div class="snp-money-wrapper" style="max-width: 120px;"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}annual_property_taxes" id="snp_annualTaxes_{{ doc_id }}" class="snp-money-input" value="{{ prefill_data.get('annual_property_taxes', '') }}" placeholder="0.00" oninput="snpFormatMoney(this); snpRecalculateAll('{{ doc_id }}')"></div></div>
        <div class="snp-form-row"><label>Est. Annual Maintenance Fees:</label><div class="snp-money-wrapper" style="max-width: 120px;"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}annual_maintenance_fees" class="snp-money-input" value="{{ prefill_data.get('annual_maintenance_fees', '') }}" placeholder="0.00" oninput="snpFormatMoney(this)"></div></div>

        <div style="margin: 0.75rem 0;"><label style="font-size: 0.8125rem; font-weight: 500; color: #333;">Buyer's Anticipated Financing:</label>
            <div class="snp-financing-group">
                <label class="snp-financing-option"><input type="checkbox" name="{{ field_prefix }}financing_conventional" value="1" {{ 'checked' if prefill_data.get('financing_conventional') else '' }}><span>Conventional</span></label>
                <label class="snp-financing-option"><input type="checkbox" name="{{ field_prefix }}financing_va" value="1" {{ 'checked' if prefill_data.get('financing_va') else '' }}><span>VA</span></label>
                <label class="snp-financing-option"><input type="checkbox" name="{{ field_prefix }}financing_fha" value="1" {{ 'checked' if prefill_data.get('financing_fha') else '' }}><span>FHA</span></label>
                <label class="snp-financing-option"><input type="checkbox" name="{{ field_prefix }}financing_usda" value="1" {{ 'checked' if prefill_data.get('financing_usda') else '' }}><span>USDA</span></label>
                <label class="snp-financing-option"><input type="checkbox" name="{{ field_prefix }}financing_reverse" value="1" {{ 'checked' if prefill_data.get('financing_reverse') else '' }}><span>Reverse Mtg</span></label>
                <label class="snp-financing-option"><input type="checkbox" name="{{ field_prefix }}financing_assumption" value="1" {{ 'checked' if prefill_data.get('financing_assumption') else '' }}><span>Assumption</span></label>
                <label class="snp-financing-option"><input type="checkbox" name="{{ field_prefix }}financing_owner" value="1" {{ 'checked' if prefill_data.get('financing_owner') else '' }}><span>Owner</span></label>
                <label class="snp-financing-option"><input type="checkbox" name="{{ field_prefix }}financing_cash" value="1" {{ 'checked' if prefill_data.get('financing_cash') else '' }}><span>Cash</span></label>
            </div>
        </div>

        <div class="snp-two-col">
            <!-- Left: Estimated Costs -->
            <div class="snp-section-box">
                <div class="snp-section-title">Estimated Costs</div>
                <div class="snp-cost-row"><label>Attorney's Fees / Doc. Prep.</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}attorneys_fees" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('attorneys_fees', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Brokers' Fees</label><input type="text" name="{{ field_prefix }}brokers_fee_percent" id="snp_brokerPercent_{{ doc_id }}" class="snp-percent-input" value="{{ prefill_data.get('brokers_fee_percent', '') }}" placeholder="%" oninput="snpCalculateBrokersFee('{{ doc_id }}')"><span style="font-size:0.65rem;color:#64748b;">%</span><div class="snp-money-wrapper calculated"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}brokers_fee" id="snp_brokerFee_{{ doc_id }}" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('brokers_fee', '') }}" placeholder="0" readonly></div></div>
                <div class="snp-cost-row"><label>Condo. Transfer Fee</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}condo_transfer_fee" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('condo_transfer_fee', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Courier & Express Mail</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}courier_fees" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('courier_fees', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Escrow Fee (one-half)</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}escrow_fee" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('escrow_fee', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div style="font-size:0.75rem;color:#475569;font-weight:500;margin:0.375rem 0 0.125rem;">Prorations*:</div>
                <div class="snp-cost-row" style="margin-left:0.5rem;"><label>Taxes <span id="snp_proratedDays_{{ doc_id }}" style="font-size:0.65rem;color:#64748b;">(___ days)</span></label><div class="snp-money-wrapper calculated"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}prorated_taxes" id="snp_proratedTaxes_{{ doc_id }}" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('prorated_taxes', '') }}" placeholder="0" readonly></div></div>
                <div class="snp-cost-row" style="margin-left:0.5rem;"><label>Interest (Assumptions)**</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}prorated_interest" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('prorated_interest', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row" style="margin-left:0.5rem;"><label>Maintenance Fees</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}prorated_maintenance" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('prorated_maintenance', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row" style="margin-left:0.5rem;"><label>Assessments</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}assessments" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('assessments', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row" style="margin-left:0.5rem;"><label>Rents</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}rents" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('rents', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Recording Fees</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}recording_fees" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('recording_fees', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Repairs Required by Buyer</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}repairs_buyer" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('repairs_buyer', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Repairs Required by Lender</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}repairs_lender" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('repairs_lender', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Residential Service Contract</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}residential_service" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('residential_service', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Seller Allowances / FHA/VA</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}seller_allowances" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('seller_allowances', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Survey Fee</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}survey_fee" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('survey_fee', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Tax Certificate Fee</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}tax_cert_fee" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('tax_cert_fee', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-cost-row"><label>Title Policy - Owner's</label><div class="snp-money-wrapper calculated"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}title_policy" id="snp_titlePolicy_{{ doc_id }}" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('title_policy', '') }}" placeholder="0" readonly></div></div>
                <div class="snp-cost-row"><label>Wiring Fees</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}wiring_fees" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('wiring_fees', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-custom-row"><input type="text" name="{{ field_prefix }}custom_label_1" class="snp-custom-label" value="{{ prefill_data.get('custom_label_1', '') }}" placeholder="Other..."><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}custom_amount_1" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('custom_amount_1', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-custom-row"><input type="text" name="{{ field_prefix }}custom_label_2" class="snp-custom-label" value="{{ prefill_data.get('custom_label_2', '') }}" placeholder="Other..."><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}custom_amount_2" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('custom_amount_2', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-custom-row"><input type="text" name="{{ field_prefix }}custom_label_3" class="snp-custom-label" value="{{ prefill_data.get('custom_label_3', '') }}" placeholder="Other..."><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}custom_amount_3" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('custom_amount_3', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-custom-row"><input type="text" name="{{ field_prefix }}custom_label_4" class="snp-custom-label" value="{{ prefill_data.get('custom_label_4', '') }}" placeholder="Other..."><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}custom_amount_4" class="snp-money-input snp-cost-input-{{ doc_id }}" value="{{ prefill_data.get('custom_amount_4', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateCosts('{{ doc_id }}')"></div></div>
                <div class="snp-total-row"><label>Total Estimated Costs</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}total_costs" id="snp_totalCosts_{{ doc_id }}" class="snp-money-input" value="{{ prefill_data.get('total_costs', '') }}" readonly></div></div>
            </div>

            <!-- Right: Proceeds -->
            <div>
                <div class="snp-section-box" style="margin-bottom:0.75rem;">
                    <div class="snp-section-title">Estimated Proceeds to Seller:</div>
                    <div class="snp-cost-row"><label>Sales Price</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}sales_price" id="snp_salesPrice_{{ doc_id }}" class="snp-money-input" value="{{ prefill_data.get('sales_price', prefill_data.get('list_price', '')) }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateAll('{{ doc_id }}')"></div></div>
                    <div class="snp-cost-row"><label>Less Estimated Costs</label><span class="snp-parentheses"><div class="snp-money-wrapper calculated"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}less_costs" id="snp_lessCosts_{{ doc_id }}" class="snp-money-input" value="{{ prefill_data.get('less_costs', '') }}" readonly></div></span></div>
                    <div class="snp-cost-row"><label>Less Estimated Loan Payoff</label><span class="snp-parentheses"><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}loan_payoff" id="snp_loanPayoff_{{ doc_id }}" class="snp-money-input" value="{{ prefill_data.get('loan_payoff', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateNetProceeds('{{ doc_id }}')"></div></span></div>
                    <div class="snp-net-proceeds-row"><label>Estimated Net Proceeds:</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}net_proceeds" id="snp_netProceeds_{{ doc_id }}" class="snp-money-input" value="{{ prefill_data.get('net_proceeds', '') }}" readonly></div></div>
                </div>
                <div class="snp-section-box">
                    <div class="snp-section-title">After Closing Refunds</div>
                    <div class="snp-cost-row"><label>Estimated Unused Insurance</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}unused_insurance" class="snp-money-input snp-refund-input-{{ doc_id }}" value="{{ prefill_data.get('unused_insurance', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateRefunds('{{ doc_id }}')"></div></div>
                    <div class="snp-cost-row"><label>Estimated Escrow Balance</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}escrow_balance" class="snp-money-input snp-refund-input-{{ doc_id }}" value="{{ prefill_data.get('escrow_balance', '') }}" placeholder="0" oninput="snpFormatMoney(this); snpRecalculateRefunds('{{ doc_id }}')"></div></div>
                    <div class="snp-total-row"><label>Total Estimated Refunds:</label><div class="snp-money-wrapper"><span class="snp-dollar">$</span><input type="text" name="{{ field_prefix }}total_refunds" id="snp_totalRefunds_{{ doc_id }}" class="snp-money-input" value="{{ prefill_data.get('total_refunds', '') }}" readonly></div></div>
                </div>
            </div>
        </div>

        <p class="snp-note-text">* Prorations are calculated through the closing date. ** Interest is prorated only in assumption transactions.</p>
        <div class="snp-prepared-by"><strong>Prepared by:</strong> {{ current_user.first_name }} {{ current_user.last_name }}<input type="hidden" name="{{ field_prefix }}prepared_by" value="{{ current_user.first_name }} {{ current_user.last_name }}"></div>
    </div>
</div>

<!-- Texas Title Policy Calculator -->
<script src="{{ url_for('static', filename='js/texas_title_policy.js') }}"></script>

<script>
function snpFormatMoney(input) { let v=input.value.replace(/[^0-9.]/g,''); const p=v.split('.'); if(p.length>2)v=p[0]+'.'+p.slice(1).join(''); if(v){const n=parseFloat(v); if(!isNaN(n))input.value=n.toLocaleString('en-US',{minimumFractionDigits:v.includes('.')?2:0,maximumFractionDigits:2});} }
function snpParseMoney(s) { return s?parseFloat(s.replace(/[$,]/g,''))||0:0; }
function snpFormatAsMoney(n) { return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function snpRecalculateAll(id) { snpCalculateProratedTaxes(id); snpCalculateBrokersFee(id); snpCalculateTitlePolicy(id); snpRecalculateCosts(id); snpRecalculateRefunds(id); snpRecalculateNetProceeds(id); }
function snpCalculateProratedTaxes(id) { const cd=document.getElementById('snp_closingDate_'+id)?.value; const at=snpParseMoney(document.getElementById('snp_annualTaxes_'+id)?.value); if(!cd||!at){const tf=document.getElementById('snp_proratedTaxes_'+id);const df=document.getElementById('snp_proratedDays_'+id);if(tf)tf.value='';if(df)df.textContent='(___ days)';return;} const c=new Date(cd);const y=new Date(c.getFullYear(),0,1);const d=Math.ceil((c-y)/(1000*60*60*24))+1;const dr=at/365;const pa=dr*d;const df=document.getElementById('snp_proratedDays_'+id);if(df)df.textContent='('+d+' days)';const tf=document.getElementById('snp_proratedTaxes_'+id);if(tf)tf.value=snpFormatAsMoney(pa);snpRecalculateCosts(id); }
function snpCalculateBrokersFee(id) { const ps=document.getElementById('snp_brokerPercent_'+id)?.value; const sp=snpParseMoney(document.getElementById('snp_salesPrice_'+id)?.value); const ff=document.getElementById('snp_brokerFee_'+id); if(!ps||!sp){if(ff)ff.value='';snpRecalculateCosts(id);return;} const p=parseFloat(ps)||0;const f=(sp*p)/100;if(ff)ff.value=snpFormatAsMoney(f);snpRecalculateCosts(id); }
function snpCalculateTitlePolicy(id) { const sp=snpParseMoney(document.getElementById('snp_salesPrice_'+id)?.value); const tf=document.getElementById('snp_titlePolicy_'+id); if(!sp||sp<=0){if(tf)tf.value='';return;} if(typeof calculateTexasTitlePremium==='function'){const premium=calculateTexasTitlePremium(sp);if(tf)tf.value=snpFormatAsMoney(premium);} }
function snpRecalculateCosts(id) { const ci=document.querySelectorAll('.snp-cost-input-'+id); let t=0; ci.forEach(i=>{t+=snpParseMoney(i.value);}); const tf=document.getElementById('snp_totalCosts_'+id); const lf=document.getElementById('snp_lessCosts_'+id); if(tf)tf.value=snpFormatAsMoney(t); if(lf)lf.value=snpFormatAsMoney(t); snpRecalculateNetProceeds(id); }
function snpRecalculateRefunds(id) { const ri=document.querySelectorAll('.snp-refund-input-'+id); let t=0; ri.forEach(i=>{t+=snpParseMoney(i.value);}); const tf=document.getElementById('snp_totalRefunds_'+id); if(tf)tf.value=snpFormatAsMoney(t); }
function snpRecalculateNetProceeds(id) { const sp=snpParseMoney(document.getElementById('snp_salesPrice_'+id)?.value); const lc=snpParseMoney(document.getElementById('snp_lessCosts_'+id)?.value); const lp=snpParseMoney(document.getElementById('snp_loanPayoff_'+id)?.value); const np=sp-lc-lp; const nf=document.getElementById('snp_netProceeds_'+id); if(nf)nf.value=snpFormatAsMoney(np); }
document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll('[id^="snpDocument_"]').forEach(function(d){const id=d.id.replace('snpDocument_','');snpRecalculateAll(id);});});
</script>

