{% extends "base.html" %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-semibold text-gray-900">Dashboard</h1>
        <p class="text-sm text-gray-500">Welcome back, {{ current_user.first_name }}</p>
    </div>

    <!-- Filter Tabs (Only show for admin) -->
    {% if current_user.role == 'admin' %}
    <div class="border-b mb-6">
        <div class="flex space-x-6">
            <button 
                class="px-4 py-2 text-sm {% if show_all %}text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:text-gray-800{% endif %}"
                onclick="window.location.href='{{ url_for('main.dashboard', view='all') }}';"
            >
                All contacts
            </button>
            <button 
                class="px-4 py-2 text-sm {% if not show_all %}text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:text-gray-800{% endif %}"
                onclick="window.location.href='{{ url_for('main.dashboard', view='my') }}';"
            >
                My contacts
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Total Commission Card -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Total Potential Commission</h3>
                <span class="bg-green-100 text-green-800 text-xs px-2.5 py-0.5 rounded-full">All time</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-3xl font-bold text-gray-900">${{ "{:,.0f}".format(total_commission) }}</span>
            </div>
        </div>

        <!-- Total Contacts Card -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Total Contacts</h3>
                <span class="bg-blue-100 text-blue-800 text-xs px-2.5 py-0.5 rounded-full">Active</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-3xl font-bold text-gray-900">{{ total_contacts }}</span>
            </div>
        </div>

        <!-- Average Commission Card -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Average Commission</h3>
                <span class="bg-purple-100 text-purple-800 text-xs px-2.5 py-0.5 rounded-full">Per contact</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-3xl font-bold text-gray-900">${{ "{:,.0f}".format(avg_commission) }}</span>
            </div>
        </div>
    </div>

    <!-- Charts and Tables Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Group Distribution Chart -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200 lg:col-span-1">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-medium text-gray-900">Contact Groups</h3>
                <span class="text-sm text-gray-500">Distribution</span>
            </div>
            <div id="groupChart" class="w-full h-64"></div>
            <div class="mt-4">
                <div class="grid grid-cols-1 gap-2">
                    {% for group in group_stats %}
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full mr-2" style="background-color: {{ ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'][loop.index0 % 6] }}"></div>
                            <span class="text-gray-600">{{ group.name }}</span>
                        </div>
                        <span class="font-medium text-gray-900">{{ group.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Top Contacts Table -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200 lg:col-span-2">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Top Contacts by Commission</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            {% if current_user.role == 'admin' and show_all %}
                            <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Owner</th>
                            {% endif %}
                            <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3.5 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Potential Commission</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for contact in top_contacts %}
                        <tr class="hover:bg-white transition-colors duration-150">
                            {% if current_user.role == 'admin' and show_all %}
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs bg-gray-100 text-gray-600 mr-2">
                                        {{ contact.owner.first_name[0] }}{{ contact.owner.last_name[0] }}
                                    </div>
                                    <span class="text-sm text-gray-600">
                                        {{ contact.owner.first_name }} {{ contact.owner.last_name }}
                                    </span>
                                </div>
                            </td>
                            {% endif %}
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="mb-1">
                                    <a href="#" 
                                       onclick="openContactModal({{ contact.id }}); return false;"
                                       class="text-blue-600 hover:text-blue-800">
                                        {{ contact.first_name }} {{ contact.last_name }}
                                    </a>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    {% for group in contact.groups[:2] %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                            {{ group.name }}
                                        </span>
                                    {% endfor %}
                                    {% if contact.groups|length > 2 %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                            +{{ contact.groups|length - 2 }}
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                {{ contact.email or '--' }}
                            </td>
                            <td class="px-6 py-4 text-right text-sm font-medium text-gray-900">
                                ${{ "{:,.0f}".format(contact.potential_commission or 0) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Upcoming Tasks Section -->
    <div class="mt-6">
        <div class="bg-gray-50 rounded-lg shadow-md border border-gray-200">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Upcoming Tasks</h3>
                    <p class="text-sm text-gray-500 mt-1">Tasks due in the next 7 days</p>
                </div>
                <a href="{{ url_for('tasks.tasks') }}" 
                   class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                    View all tasks
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>

            <!-- Task List -->
            {% if upcoming_tasks %}
            <div class="divide-y divide-gray-200">
                {% for task in upcoming_tasks %}
                <div class="group hover:bg-white transition-colors duration-150">
                    <div class="px-6 py-4">
                        <div class="flex items-center">
                            <!-- Quick Actions (Left Side) -->
                            <div class="flex items-center space-x-3 w-14">
                                <!-- Checkbox -->
                                <input type="checkbox" 
                                       class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                       {% if task.status == 'completed' %}checked{% endif %}
                                       onchange="quickUpdateStatus({{ task.id }}, this.checked)"
                                       title="Mark as {% if task.status == 'completed' %}incomplete{% else %}complete{% endif %}">
                                
                                <!-- Priority Indicator -->
                                <div class="relative">
                                    <button onclick="togglePriorityMenu({{ task.id }})"
                                            class="w-3 h-3 rounded-full 
                                            {% if task.priority == 'high' %}
                                                bg-red-500
                                            {% elif task.priority == 'medium' %}
                                                bg-yellow-500
                                            {% else %}
                                                bg-green-500
                                            {% endif %}">
                                    </button>
                                    <!-- Priority Menu (Hidden by default) -->
                                    <div id="priority-menu-{{ task.id }}" 
                                         class="hidden fixed mt-1 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-[100]">
                                        <div class="py-1" role="menu">
                                            <button onclick="quickUpdatePriority({{ task.id }}, 'high')"
                                                    class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full">
                                                <span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                                                High
                                            </button>
                                            <button onclick="quickUpdatePriority({{ task.id }}, 'medium')"
                                                    class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full">
                                                <span class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>
                                                Medium
                                            </button>
                                            <button onclick="quickUpdatePriority({{ task.id }}, 'low')"
                                                    class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full">
                                                <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                                                Low
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Task Info (Middle) -->
                            <div class="flex-1 min-w-0 ml-4">
                                <div class="flex items-center space-x-3">
                                    <a href="#" 
                                       onclick="openTaskModal({{ task.id }}); return false;"
                                       class="text-sm font-medium text-blue-600 hover:text-blue-800">
                                        {{ task.subject }}
                                    </a>
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                            {{ task.task_type.name }}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-50 text-gray-600">
                                            {{ task.task_subtype.name }}
                                        </span>
                                    </div>
                                </div>

                                {% if current_user.role == 'admin' and show_all %}
                                <div class="flex items-center text-gray-500 text-sm mt-0.5">
                                    <div class="w-4 h-4 rounded-full bg-gray-100 flex items-center justify-center text-xs mr-1.5">
                                        {{ task.assigned_to.first_name[0] }}{{ task.assigned_to.last_name[0] }}
                                    </div>
                                    <span>{{ task.assigned_to.first_name }} {{ task.assigned_to.last_name }}</span>
                                </div>
                                {% endif %}

                                <!-- Task Details -->
                                <div class="mt-1 flex items-center space-x-4 text-sm text-gray-500">
                                    <!-- Due Date with Color Coding -->
                                    {% set task_date = task.due_date.date() %}
                                    {% set current_date = now.date() %}
                                    {% set days_until_due = (task_date - current_date).days %}
                                    <div class="flex items-center">
                                        <i class="far fa-calendar-alt mr-1.5 
                                            {% if days_until_due < 0 %}
                                                text-red-500
                                            {% elif days_until_due == 0 %}
                                                text-orange-500
                                            {% elif days_until_due <= 2 %}
                                                text-yellow-500
                                            {% else %}
                                                text-gray-400
                                            {% endif %}">
                                        </i>
                                        <span class="{% if days_until_due < 0 %}text-red-500{% elif days_until_due == 0 %}text-orange-500{% elif days_until_due <= 2 %}text-yellow-500{% endif %}">
                                            {% if days_until_due < 0 %}
                                                Overdue by {{ days_until_due|abs }} day{{ 's' if days_until_due|abs != 1 }}
                                            {% elif days_until_due == 0 %}
                                                Due today
                                            {% elif days_until_due == 1 %}
                                                Due tomorrow
                                            {% else %}
                                                Due in {{ days_until_due }} days
                                            {% endif %}
                                            ({{ task.due_date.strftime('%m/%d/%y') }}{% if task.scheduled_time %} @ {{ task.scheduled_time.strftime('%I:%M %p') }}{% endif %})
                                        </span>
                                    </div>

                                    <!-- Contact -->
                                    {% if task.contact %}
                                    <div class="flex items-center">
                                        <i class="far fa-user mr-1.5 text-gray-400"></i>
                                        <a href="#" 
                                           onclick="openContactModal({{ task.contact.id }}); return false;"
                                           class="hover:text-blue-600">
                                            {{ task.contact.first_name }} {{ task.contact.last_name }}
                                        </a>
                                    </div>
                                    {% endif %}

                                    <!-- Property Address (if exists) -->
                                    {% if task.property_address %}
                                    <div class="flex items-center">
                                        <i class="far fa-building mr-1.5 text-gray-400"></i>
                                        {{ task.property_address }}
                                    </div>
                                    {% endif %}

                                    <!-- Scheduled Time -->
                                    {% if task.scheduled_time %}
                                    <div class="flex items-center">
                                        <i class="far fa-clock mr-1.5 text-gray-400"></i>
                                        {{ task.scheduled_time.strftime('%I:%M %p') }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Right Side: Quick Actions -->
                            <div class="flex items-center space-x-4 ml-4">
                                <!-- Quick Actions (visible on hover) -->
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-150 flex items-center space-x-2">
                                    <a href="{{ url_for('tasks.view_task', task_id=task.id) }}"
                                       class="p-1 rounded-full hover:bg-gray-200"
                                       title="View Details">
                                        <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                                    </a>
                                    <button onclick="deleteTask({{ task.id }})"
                                            class="p-1 rounded-full hover:bg-gray-200"
                                            title="Delete Task">
                                        <i class="fas fa-trash text-gray-400 hover:text-red-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="px-6 py-8 text-center">
                <div class="text-gray-500">No upcoming tasks</div>
                <a href="{{ url_for('tasks.create_task') }}" 
                   class="mt-2 inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-plus mr-2"></i>
                    Create a new task
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Task Modal -->
<div id="taskModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 z-[200] overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-0 md:p-4">
        <div class="relative bg-white w-full md:rounded-lg shadow-xl md:max-w-4xl min-h-screen md:min-h-0">
            <!-- Modal header -->
            <div class="sticky top-0 z-10 flex items-center justify-between px-4 py-3 md:px-6 md:py-4 border-b border-gray-200 bg-gray-50 md:rounded-t-lg">
                <div class="flex items-center space-x-4">
                    <div id="modalTaskPriorityIndicator" class="w-10 h-10 rounded-lg flex items-center justify-center text-lg">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-900" id="modalTaskSubject"></h3>
                        {% if current_user.role == 'admin' and show_all %}
                        <div class="flex items-center text-gray-500 text-sm mt-0.5 mb-1">
                            <div id="modalTaskOwnerInitials" class="w-4 h-4 rounded-full bg-gray-100 flex items-center justify-center text-xs mr-1.5"></div>
                            <span id="modalTaskOwner"></span>
                        </div>
                        {% endif %}
                        <p class="text-sm text-gray-500" id="modalTaskHeaderDueDate"></p>
                    </div>
                </div>
                <button onclick="closeTaskModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            
            <!-- Modal content -->
            <div class="px-4 py-4 md:px-6 space-y-6" id="modalTaskContent">
                <!-- Status and Priority -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-gray-50 rounded-lg p-3 flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                                <i class="fas fa-tasks text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Status</p>
                                <p id="modalTaskStatus" class="text-sm font-medium text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                                <i class="fas fa-flag text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Priority</p>
                                <p id="modalTaskPriority" class="text-sm font-medium text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Due Date and Scheduled Time -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-gray-50 rounded-lg p-3 flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                                <i class="fas fa-calendar text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Due Date</p>
                                <p id="modalTaskDueDate" class="text-sm font-medium text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                    <div id="modalTaskScheduledContainer" class="hidden bg-gray-50 rounded-lg p-3 flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                                <i class="fas fa-clock text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Scheduled Time</p>
                                <p id="modalTaskScheduledTime" class="text-sm font-medium text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Type and Subtype -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                            <i class="fas fa-tag text-gray-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Task Type</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span id="modalTaskType" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800"></span>
                                <span id="modalTaskSubtype" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-50 text-gray-600"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Contact</p>
                            <a id="modalTaskContact" href="#" class="text-sm font-medium text-blue-600 hover:text-blue-800"></a>
                        </div>
                    </div>
                </div>

                <!-- Property Address -->
                <div id="modalTaskPropertyContainer" class="hidden bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                            <i class="fas fa-building text-gray-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Property Address</p>
                            <p id="modalTaskProperty" class="text-sm font-medium text-gray-900"></p>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                            <i class="fas fa-align-left text-gray-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-500">Description</p>
                            <p id="modalTaskDescription" class="mt-1 text-sm text-gray-900 whitespace-pre-line"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal footer -->
            <div class="sticky bottom-0 border-t border-gray-200 bg-gray-50 p-4 md:rounded-b-lg">
                <div class="flex flex-col md:flex-row md:justify-between gap-3">
                    <div class="flex flex-col md:flex-row gap-2 md:items-center md:space-x-4">
                        <button onclick="toggleTaskStatus()" 
                                class="flex-1 md:flex-none text-center px-4 py-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors duration-150 text-sm font-medium">
                            <span id="modalTaskStatusButton"></span>
                        </button>
                    </div>
                    <a id="modalTaskFullView" href="#" 
                       class="flex-1 md:flex-none text-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-150 text-sm font-medium">
                        Open Full View
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contact Modal -->
<div id="contactModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 z-[200] overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full">
            <!-- Modal header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                <div class="flex items-center space-x-4">
                    <div id="modalContactInitials" class="w-10 h-10 rounded-full flex items-center justify-center text-lg font-medium"></div>
                    <h3 class="text-lg font-medium text-gray-900" id="modalContactName"></h3>
                </div>
                <button onclick="closeContactModal()" class="text-gray-400 hover:text-gray-500 p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Modal content -->
            <div class="px-6 py-4 space-y-4">
                <!-- Contact Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Email -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">Email</h3>
                        <p id="modalContactEmail" class="text-gray-900"></p>
                    </div>

                    <!-- Phone -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">Phone</h3>
                        <p id="modalContactPhone" class="text-gray-900"></p>
                    </div>

                    <!-- Address -->
                    <div class="md:col-span-2">
                        <h3 class="text-sm font-medium text-gray-500 mb-1">Address</h3>
                        <p id="modalContactAddress" class="text-gray-900"></p>
                    </div>

                    <!-- Groups -->
                    <div class="md:col-span-2">
                        <h3 class="text-sm font-medium text-gray-500 mb-2">Groups</h3>
                        <div id="modalContactGroups" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Notes -->
                    <div class="md:col-span-2">
                        <h3 class="text-sm font-medium text-gray-500 mb-1">Notes</h3>
                        <p id="modalContactNotes" class="text-gray-900 whitespace-pre-line bg-gray-50 rounded-md p-4"></p>
                    </div>

                    <!-- Potential Commission -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">Potential Commission</h3>
                        <p id="modalContactCommission" class="text-gray-900"></p>
                    </div>

                    <!-- Created Date -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">Created</h3>
                        <p id="modalContactCreated" class="text-gray-900"></p>
                    </div>
                </div>
            </div>
            
            <!-- Modal footer -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-lg flex justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="deleteContactFromModal()" class="text-sm px-4 py-2 border rounded-md text-red-600 hover:bg-red-50 transition-colors duration-150">
                        Delete Contact
                    </button>
                </div>
                <a id="modalContactFullView" href="#" class="text-sm px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-150">
                    Open Full View
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const groupData = {{ group_stats|tojson }};
    const labels = groupData.map(item => item.name);
    const series = groupData.map(item => item.count);

    const options = {
        series: series,
        chart: {
            type: 'donut',
            height: 256,
            sparkline: {
                enabled: true
            }
        },
        labels: labels,
        colors: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'],
        plotOptions: {
            pie: {
                donut: {
                    size: '75%',
                    background: 'transparent'
                }
            }
        },
        stroke: {
            width: 0
        },
        tooltip: {
            enabled: true,
            y: {
                formatter: function(value) {
                    return value + ' contacts'
                }
            }
        },
        legend: {
            show: false
        }
    };

    const chart = new ApexCharts(document.querySelector("#groupChart"), options);
    chart.render();
});

function quickUpdateStatus(taskId, completed) {
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${completed ? 'completed' : 'pending'}`
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task status');
    });
}

function quickUpdatePriority(taskId, priority) {
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `priority=${priority}`
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task priority');
    });
}

function togglePriorityMenu(taskId) {
    const button = event.currentTarget;
    const menu = document.getElementById(`priority-menu-${taskId}`);
    const allMenus = document.querySelectorAll('[id^="priority-menu-"]');
    
    // Close all other menus
    allMenus.forEach(m => {
        if (m.id !== `priority-menu-${taskId}`) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle this menu
    menu.classList.toggle('hidden');
    
    if (!menu.classList.contains('hidden')) {
        // Get button position
        const rect = button.getBoundingClientRect();
        
        // Position menu below the button
        menu.style.left = `${rect.left}px`;
        menu.style.top = `${rect.bottom}px`;
        
        // Ensure menu doesn't go off screen
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        if (menuRect.right > viewportWidth) {
            menu.style.left = `${viewportWidth - menuRect.width - 10}px`;
        }
        
        if (menuRect.bottom > viewportHeight) {
            menu.style.top = `${rect.top - menuRect.height}px`;
        }
    }
}

// Close priority menus when clicking outside
document.addEventListener('click', function(event) {
    const isClickInsideMenu = event.target.closest('[id^="priority-menu-"]');
    const isClickOnPriorityButton = event.target.closest('button[onclick^="togglePriorityMenu"]');
    
    if (!isClickInsideMenu && !isClickOnPriorityButton) {
        const allMenus = document.querySelectorAll('[id^="priority-menu-"]');
        allMenus.forEach(menu => menu.classList.add('hidden'));
    }
});

function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) return;
    
    fetch(`/tasks/${taskId}/delete`, {
        method: 'POST',
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting task');
    });
}

let currentTaskId = null;

function openTaskModal(taskId) {
    currentTaskId = taskId;
    
    // Fetch task details
    fetch(`/tasks/${taskId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(task => {
            // Update modal content
            document.getElementById('modalTaskSubject').textContent = task.subject;
            document.getElementById('modalTaskFullView').href = `/tasks/${task.id}`;
            
            // Owner Info (for admin view)
            {% if current_user.role == 'admin' and show_all %}
            const ownerInitials = document.getElementById('modalTaskOwnerInitials');
            ownerInitials.textContent = `${task.assigned_to.first_name[0]}${task.assigned_to.last_name[0]}`;
            document.getElementById('modalTaskOwner').textContent = `${task.assigned_to.first_name} ${task.assigned_to.last_name}`;
            {% endif %}
            
            // Priority Indicator
            const priorityIndicator = document.getElementById('modalTaskPriorityIndicator');
            priorityIndicator.className = `w-10 h-10 rounded-lg flex items-center justify-center text-lg ${
                task.priority === 'high' ? 'bg-red-100 text-red-700' :
                task.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                'bg-green-100 text-green-700'
            }`;
            
            // Priority
            const priorityText = document.getElementById('modalTaskPriority');
            priorityText.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            
            // Status
            const statusText = document.getElementById('modalTaskStatus');
            statusText.textContent = task.status.charAt(0).toUpperCase() + task.status.slice(1);
            statusText.className = `text-sm font-medium ${
                task.status === 'completed' ? 'text-green-700' : 'text-yellow-700'
            }`;
            
            // Due Date
            const dueDate = new Date(task.due_date);
            const now = new Date();
            const diffTime = dueDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let dueDateText = '';
            if (diffDays < 0) {
                dueDateText = `Overdue by ${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''}`;
            } else if (diffDays === 0) {
                dueDateText = 'Due today';
            } else if (diffDays === 1) {
                dueDateText = 'Due tomorrow';
            } else {
                dueDateText = `Due in ${diffDays} days`;
            }
            
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            const formattedDate = dueDate.toLocaleDateString('en-US', options);
            document.getElementById('modalTaskHeaderDueDate').textContent = `${dueDateText}`;
            document.getElementById('modalTaskDueDate').textContent = formattedDate;
            
            // Scheduled Time
            const scheduledContainer = document.getElementById('modalTaskScheduledContainer');
            const scheduledTimeText = document.getElementById('modalTaskScheduledTime');
            if (task.scheduled_time) {
                const scheduledTime = new Date(task.scheduled_time);
                scheduledTimeText.textContent = scheduledTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                scheduledContainer.classList.remove('hidden');
            } else {
                scheduledContainer.classList.add('hidden');
            }
            
            // Type and Subtype
            document.getElementById('modalTaskType').textContent = task.task_type.name;
            document.getElementById('modalTaskSubtype').textContent = task.task_subtype.name;
            
            // Contact
            const contactLink = document.getElementById('modalTaskContact');
            contactLink.textContent = `${task.contact.first_name} ${task.contact.last_name}`;
            contactLink.href = `/contacts/${task.contact.id}`;
            
            // Property Address
            const propertyContainer = document.getElementById('modalTaskPropertyContainer');
            if (task.property_address) {
                document.getElementById('modalTaskProperty').textContent = task.property_address;
                propertyContainer.classList.remove('hidden');
            } else {
                propertyContainer.classList.add('hidden');
            }
            
            // Description
            document.getElementById('modalTaskDescription').textContent = task.description || 'No description provided';
            
            // Status Button
            const statusButton = document.getElementById('modalTaskStatusButton');
            statusButton.textContent = task.status === 'completed' ? 'Mark as Pending' : 'Mark as Complete';
            
            // Show modal
            document.getElementById('taskModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading task details');
        });
}

function closeTaskModal() {
    document.getElementById('taskModal').classList.add('hidden');
    currentTaskId = null;
}

function toggleTaskStatus() {
    if (!currentTaskId) return;
    
    const newStatus = document.getElementById('modalTaskStatus').textContent.toLowerCase() === 'completed' ? 'pending' : 'completed';
    
    quickUpdateStatus(currentTaskId, newStatus === 'completed');
}

function deleteTaskFromModal() {
    if (!currentTaskId) return;
    
    if (confirm('Are you sure you want to delete this task?')) {
        deleteTask(currentTaskId);
    }
}

// Close task modal when clicking outside or pressing Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeTaskModal();
        closeContactModal();
    }
});

document.addEventListener('click', function(event) {
    const taskModal = document.getElementById('taskModal');
    const taskModalContent = taskModal.querySelector('.relative');
    const contactModal = document.getElementById('contactModal');
    const contactModalContent = contactModal.querySelector('.relative');
    
    // Close task modal if clicking outside
    if (!taskModal.classList.contains('hidden') && 
        !taskModalContent.contains(event.target)) {
        closeTaskModal();
    }
    
    // Close contact modal if clicking outside
    if (!contactModal.classList.contains('hidden') && 
        !contactModalContent.contains(event.target)) {
        closeContactModal();
    }
});

// Update task links to use modal
document.addEventListener('DOMContentLoaded', function() {
    const taskLinks = document.querySelectorAll('[data-task-link]');
    taskLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            openTaskModal(this.dataset.taskId);
        });
    });
});

let currentContactId = null;

function openContactModal(contactId) {
    currentContactId = contactId;
    
    // Fetch contact details
    fetch(`/contact/${contactId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(contact => {
            // Update modal content
            document.getElementById('modalContactName').textContent = `${contact.first_name} ${contact.last_name}`;
            document.getElementById('modalContactFullView').href = `/contact/${contact.id}`;
            
            // Set initials with color
            const initials = `${contact.first_name[0]}${contact.last_name[0]}`;
            const initialsDiv = document.getElementById('modalContactInitials');
            initialsDiv.textContent = initials;
            
            // Color based on first initial
            const colorClasses = {
                'ABCDE': 'bg-blue-100 text-blue-800',
                'FGHIJ': 'bg-green-100 text-green-800',
                'KLMNO': 'bg-yellow-100 text-yellow-800',
                'PQRST': 'bg-red-100 text-red-800',
                'UVWXYZ': 'bg-purple-100 text-purple-800'
            };
            
            let colorClass = 'bg-gray-100 text-gray-800';
            for (const [letters, className] of Object.entries(colorClasses)) {
                if (letters.includes(initials[0].toUpperCase())) {
                    colorClass = className;
                    break;
                }
            }
            initialsDiv.className = `w-10 h-10 rounded-full flex items-center justify-center text-lg font-medium ${colorClass}`;
            
            // Contact details
            document.getElementById('modalContactEmail').textContent = contact.email || '--';
            document.getElementById('modalContactPhone').textContent = contact.phone || '--';
            
            // Address
            const addressParts = [];
            if (contact.street_address) addressParts.push(contact.street_address);
            if (contact.city) addressParts.push(contact.city);
            if (contact.state) addressParts.push(contact.state);
            if (contact.zip_code) addressParts.push(contact.zip_code);
            document.getElementById('modalContactAddress').textContent = addressParts.join(', ') || '--';
            
            // Groups
            const groupsContainer = document.getElementById('modalContactGroups');
            groupsContainer.innerHTML = '';
            if (contact.groups && contact.groups.length > 0) {
                contact.groups.forEach(group => {
                    const span = document.createElement('span');
                    span.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800';
                    span.textContent = group.name;
                    groupsContainer.appendChild(span);
                });
            } else {
                const span = document.createElement('span');
                span.className = 'text-gray-500';
                span.textContent = 'No groups assigned';
                groupsContainer.appendChild(span);
            }
            
            // Notes
            document.getElementById('modalContactNotes').textContent = contact.notes || 'No notes';
            
            // Commission
            document.getElementById('modalContactCommission').textContent = contact.potential_commission ? 
                `$${parseFloat(contact.potential_commission).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : 
                '$0.00';
            
            // Created date
            const createdDate = new Date(contact.created_at);
            document.getElementById('modalContactCreated').textContent = createdDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Show modal
            document.getElementById('contactModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading contact details');
        });
}

function closeContactModal() {
    document.getElementById('contactModal').classList.add('hidden');
    currentContactId = null;
}

function deleteContactFromModal() {
    if (!currentContactId) return;
    
    if (confirm('Are you sure you want to delete this contact? This action cannot be undone.')) {
        fetch(`/contacts/${currentContactId}/delete`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting contact');
        });
    }
}

// Update contact links to use modal
document.addEventListener('DOMContentLoaded', function() {
    // Update contact links in the contacts table
    const contactLinks = document.querySelectorAll('a[href^="/contact/"]');
    contactLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const contactId = this.getAttribute('href').split('/')[2];
            openContactModal(contactId);
        });
    });
});
</script>
{% endblock %}