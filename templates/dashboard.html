{% extends "base.html" %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
<style>
    /* Premium animations from action_plan */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn { 
        from { opacity: 0; } 
        to { opacity: 1; } 
    }
    @keyframes pulse-glow {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.5; }
    }
    .animate-fade-in-up { 
        animation: fadeInUp 0.6s ease-out forwards; 
    }
    .animate-fade-in-up-delay-1 { 
        animation: fadeInUp 0.6s ease-out 0.1s forwards; 
        opacity: 0; 
    }
    .animate-fade-in-up-delay-2 { 
        animation: fadeInUp 0.6s ease-out 0.2s forwards; 
        opacity: 0; 
    }
    .animate-fade-in-up-delay-3 { 
        animation: fadeInUp 0.6s ease-out 0.3s forwards; 
        opacity: 0; 
    }
    .animate-pulse-glow {
        animation: pulse-glow 2s ease-in-out infinite;
    }
    
    /* Premium card hover effects */
    .premium-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .premium-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.1);
    }
    
    /* Premium input focus styling */
    .premium-input:focus {
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15);
    }
    
    /* Premium section headers */
    .section-header {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    }
    
    /* Task item hover */
    .task-item:hover {
        background: linear-gradient(135deg, #fafafa 0%, #f8fafc 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-orange-50/30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-10">
        
        <!-- Premium Header -->
        <div class="animate-fade-in-up mb-8 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-br from-orange-500 to-amber-500 rounded-2xl blur-lg opacity-30 animate-pulse-glow"></div>
                    <div class="relative h-14 w-14 bg-gradient-to-br from-orange-500 via-orange-500 to-amber-500 rounded-2xl shadow-lg flex items-center justify-center transform -rotate-3 hover:rotate-0 transition-transform duration-300">
                        <i class="fas fa-chart-line text-white text-2xl"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 bg-clip-text text-transparent tracking-tight">
                        Dashboard
                    </h1>
                    <p class="text-slate-500 mt-1 font-medium">Welcome back, {{ current_user.first_name }}</p>
                </div>
            </div>
            <button 
                onclick="showDailyTodoModal()"
                class="group relative overflow-hidden px-5 py-2.5 rounded-xl bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 hover:from-indigo-600 hover:via-purple-600 hover:to-pink-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 active:scale-95"
            >
                <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-300"></div>
                <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-xl blur opacity-20 group-hover:opacity-30 transition-opacity duration-300 -z-10"></div>
                
                <div class="flex items-center space-x-3">
                    <svg class="w-5 h-5 transform group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <div class="flex flex-col items-start">
                        <span class="text-sm font-medium">Daily To-Do List</span>
                        <span class="text-xs opacity-90">Generated by B.O.B.</span>
                    </div>
                </div>
            </button>
        </div>

        <!-- Filter Tabs (Only show for admin) -->
        {% if current_user.role == 'admin' %}
        <div class="animate-fade-in-up mb-8">
            <div class="inline-flex bg-white rounded-xl p-1.5 shadow-sm border border-slate-200/60">
                <button 
                    class="px-5 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 {% if show_all %}bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-md{% else %}text-slate-600 hover:text-slate-900 hover:bg-slate-50{% endif %}"
                    onclick="window.location.href='{{ url_for('main.dashboard', view='all') }}'"
                >
                    <i class="fas fa-users mr-2"></i>All contacts
                </button>
                <button 
                    class="px-5 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 {% if not show_all %}bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-md{% else %}text-slate-600 hover:text-slate-900 hover:bg-slate-50{% endif %}"
                    onclick="window.location.href='{{ url_for('main.dashboard', view='my') }}'"
                >
                    <i class="fas fa-user mr-2"></i>My contacts
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Key Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-fade-in-up-delay-1">
            <!-- Total Commission Card -->
            <div class="premium-card bg-white rounded-2xl shadow-xl border border-slate-200/60 p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-emerald-500/10 to-green-500/5 rounded-full -mr-16 -mt-16"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20">
                                <i class="fas fa-dollar-sign text-white"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-slate-600">Total Potential Commission</h3>
                        </div>
                        <span class="bg-emerald-100 text-emerald-700 text-xs font-semibold px-2.5 py-1 rounded-full">All time</span>
                    </div>
                    <div class="flex items-baseline">
                        <span class="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-green-600 bg-clip-text text-transparent">${{ "{:,.0f}".format(total_commission) }}</span>
                    </div>
                </div>
            </div>

            <!-- Total Contacts Card -->
            <div class="premium-card bg-white rounded-2xl shadow-xl border border-slate-200/60 p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-indigo-500/5 rounded-full -mr-16 -mt-16"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                                <i class="fas fa-users text-white"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-slate-600">Total Contacts</h3>
                        </div>
                        <span class="bg-blue-100 text-blue-700 text-xs font-semibold px-2.5 py-1 rounded-full">Active</span>
                    </div>
                    <div class="flex items-baseline">
                        <span class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">{{ total_contacts }}</span>
                    </div>
                </div>
            </div>

            <!-- Average Commission Card -->
            <div class="premium-card bg-white rounded-2xl shadow-xl border border-slate-200/60 p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-500/10 to-violet-500/5 rounded-full -mr-16 -mt-16"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/20">
                                <i class="fas fa-chart-bar text-white"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-slate-600">Average Commission</h3>
                        </div>
                        <span class="bg-purple-100 text-purple-700 text-xs font-semibold px-2.5 py-1 rounded-full">Per contact</span>
                    </div>
                    <div class="flex items-baseline">
                        <span class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-violet-600 bg-clip-text text-transparent">${{ "{:,.0f}".format(avg_commission) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Tasks and Todos Section -->
        <div class="mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in-up-delay-2">
            <!-- Upcoming Tasks Section -->
            <div class="premium-card bg-white rounded-2xl shadow-xl border border-slate-200/60 overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-5 section-header border-b border-slate-100 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-amber-500 rounded-xl flex items-center justify-center shadow-lg shadow-orange-500/20">
                            <i class="fas fa-tasks text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Upcoming Client Tasks</h3>
                            <p class="text-sm text-slate-500">Client tasks due in the next 7 days</p>
                        </div>
                    </div>
                    <a href="{{ url_for('tasks.tasks') }}" 
                       class="group inline-flex items-center px-4 py-2 bg-slate-50 hover:bg-orange-50 text-sm font-medium text-slate-600 hover:text-orange-600 rounded-xl transition-all duration-200 border border-slate-200 hover:border-orange-200">
                        View all
                        <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                    </a>
                </div>

                <!-- Task List -->
                <div class="overflow-y-auto" style="max-height: 420px;">
                    {% if upcoming_tasks %}
                    <div class="divide-y divide-slate-100">
                        {% for task in upcoming_tasks %}
                        <div class="task-item group transition-all duration-200">
                            <div class="p-4">
                                <div class="flex items-start">
                                    <!-- Left Side: Priority and Status -->
                                    <div class="flex items-center space-x-3">
                                        <!-- Status Checkbox -->
                                        <div class="flex items-center">
                                            <input type="checkbox"
                                                class="h-5 w-5 text-orange-500 rounded-lg border-2 border-slate-300 focus:ring-orange-500 focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:border-orange-400"
                                                {% if task.status == 'completed' %}checked{% endif %}
                                                onchange="updateTaskStatus({{ task.id }}, this.checked)">
                                        </div>
                                        <!-- Priority -->
                                        <div class="relative">
                                            <button onclick="togglePriorityMenu({{ task.id }})"
                                                    class="w-9 h-9 rounded-xl flex items-center justify-center transition-all duration-200 hover:scale-105 {% if task.priority == 'high' %}bg-gradient-to-br from-red-100 to-red-50 text-red-600 shadow-sm shadow-red-100{% elif task.priority == 'medium' %}bg-gradient-to-br from-yellow-100 to-amber-50 text-yellow-600 shadow-sm shadow-yellow-100{% else %}bg-gradient-to-br from-green-100 to-emerald-50 text-green-600 shadow-sm shadow-green-100{% endif %}">
                                                <i class="fas fa-flag text-sm"></i>
                                            </button>
                                            <div id="priority-menu-{{ task.id }}"
                                                 class="hidden fixed mt-1 w-36 rounded-xl shadow-xl bg-white ring-1 ring-black ring-opacity-5 z-[100] overflow-hidden">
                                                <div class="py-1" role="menu">
                                                    <button onclick="quickUpdatePriority({{ task.id }}, 'high')"
                                                            class="flex items-center px-4 py-2.5 text-sm text-slate-700 hover:bg-red-50 w-full transition-colors">
                                                        <span class="w-3 h-3 rounded-full bg-gradient-to-br from-red-500 to-red-600 mr-3 shadow-sm"></span>
                                                        High
                                                    </button>
                                                    <button onclick="quickUpdatePriority({{ task.id }}, 'medium')"
                                                            class="flex items-center px-4 py-2.5 text-sm text-slate-700 hover:bg-yellow-50 w-full transition-colors">
                                                        <span class="w-3 h-3 rounded-full bg-gradient-to-br from-yellow-400 to-amber-500 mr-3 shadow-sm"></span>
                                                        Medium
                                                    </button>
                                                    <button onclick="quickUpdatePriority({{ task.id }}, 'low')"
                                                            class="flex items-center px-4 py-2.5 text-sm text-slate-700 hover:bg-green-50 w-full transition-colors">
                                                        <span class="w-3 h-3 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 mr-3 shadow-sm"></span>
                                                        Low
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Task Info (Middle) -->
                                    <div class="flex-1 min-w-0 ml-4">
                                        <div class="flex items-center flex-wrap gap-2">
                                            <a href="{{ url_for('tasks.view_task', task_id=task.id) }}"
                                               class="text-sm font-semibold text-slate-800 hover:text-orange-600 transition-colors">
                                                {{ task.subject }}
                                            </a>
                                            <div class="flex items-center space-x-2">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-700">
                                                    {{ task.task_type.name }}
                                                </span>
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-lg text-xs font-medium bg-slate-50 text-slate-500">
                                                    {{ task.task_subtype.name }}
                                                </span>
                                            </div>
                                        </div>

                                        {% if current_user.role == 'admin' and show_all %}
                                        <div class="flex items-center text-slate-500 text-sm mt-1">
                                            <div class="w-5 h-5 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-xs font-medium mr-2">
                                                {{ task.assigned_to.first_name[0] }}{{ task.assigned_to.last_name[0] }}
                                            </div>
                                            <span>{{ task.assigned_to.first_name }} {{ task.assigned_to.last_name }}</span>
                                        </div>
                                        {% endif %}

                                        <!-- Task Details -->
                                        <div class="mt-2 flex items-center flex-wrap gap-3 text-sm text-slate-500">
                                            <!-- Due Date with Color Coding -->
                                            {% set task_date = task.due_date.date() %}
                                            {% set current_date = now.date() %}
                                            {% set days_until_due = (task_date - current_date).days %}
                                            <div class="flex items-center px-2.5 py-1 rounded-lg {% if days_until_due < 0 %}bg-red-50 text-red-600{% elif days_until_due == 0 %}bg-orange-50 text-orange-600{% elif days_until_due <= 2 %}bg-amber-50 text-amber-600{% else %}bg-slate-50 text-slate-600{% endif %}">
                                                <i class="far fa-calendar-alt mr-1.5"></i>
                                                <span class="font-medium">
                                                    {% if days_until_due < 0 %}
                                                        Overdue by {{ days_until_due|abs }} day{{ 's' if days_until_due|abs != 1 }}
                                                    {% elif days_until_due == 0 %}
                                                        Due today
                                                    {% elif days_until_due == 1 %}
                                                        Due tomorrow
                                                    {% else %}
                                                        Due in {{ days_until_due }} days
                                                    {% endif %}
                                                </span>
                                            </div>

                                            <!-- Contact -->
                                            {% if task.contact %}
                                            <div class="flex items-center">
                                                <i class="far fa-user mr-1.5 text-slate-400"></i>
                                                <a href="#" 
                                                   onclick="openContactModal({{ task.contact.id }}); return false;"
                                                   class="hover:text-orange-600 transition-colors">
                                                    {{ task.contact.first_name }} {{ task.contact.last_name }}
                                                </a>
                                            </div>
                                            {% endif %}

                                            <!-- Scheduled Time -->
                                            {% if task.scheduled_time %}
                                            <div class="flex items-center">
                                                <i class="far fa-clock mr-1.5 text-slate-400"></i>
                                                {{ task.scheduled_time.strftime('%I:%M %p') }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Right Side: Quick Actions -->
                                    <div class="flex items-center space-x-2 ml-4">
                                        <div class="opacity-0 group-hover:opacity-100 transition-all duration-200 flex items-center space-x-1">
                                            <a href="{{ url_for('tasks.view_task', task_id=task.id) }}"
                                               class="p-2 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-all"
                                               title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button onclick="deleteTask({{ task.id }})"
                                                    class="p-2 rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all"
                                                    title="Delete Task">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="px-6 py-12 text-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-tasks text-slate-400 text-2xl"></i>
                        </div>
                        <div class="text-slate-500 font-medium mb-2">No upcoming client tasks</div>
                        <a href="{{ url_for('tasks.create_task') }}" 
                           class="inline-flex items-center text-sm font-medium text-orange-600 hover:text-orange-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            Create a new client task
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Active Todos Section -->
            <div class="premium-card bg-white rounded-2xl shadow-xl border border-slate-200/60 overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-5 section-header border-b border-slate-100 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-violet-500/20">
                            <i class="fas fa-check-square text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Active To Do's</h3>
                            <p class="text-sm text-slate-500">Your current to do list</p>
                        </div>
                    </div>
                    <a href="{{ url_for('user_todo.user_todo') }}" 
                       class="group inline-flex items-center px-4 py-2 bg-slate-50 hover:bg-violet-50 text-sm font-medium text-slate-600 hover:text-violet-600 rounded-xl transition-all duration-200 border border-slate-200 hover:border-violet-200">
                        View all
                        <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                    </a>
                </div>

                <!-- Todo List -->
                <div class="overflow-y-auto" style="max-height: 420px;">
                    <div class="px-6 py-6">
                        <!-- New Todo Input -->
                        <div class="flex items-center space-x-3 mb-6 group">
                            <div class="flex-1 relative">
                                <input type="text" id="dashboardNewTodoInput" 
                                       class="premium-input block w-full rounded-xl border-2 border-slate-200 bg-slate-50 pl-12 pr-4 py-3.5 text-slate-900 placeholder-slate-400 focus:bg-white focus:border-orange-500 focus:ring-0 focus:outline-none hover:border-slate-300 transition-all duration-200" 
                                       placeholder="Add a new to do...">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400 group-focus-within:text-orange-500 transition-colors duration-200">
                                    <i class="fas fa-plus-circle text-lg"></i>
                                </span>
                            </div>
                            <button id="dashboardAddTodoBtn" 
                                    class="group relative overflow-hidden px-6 py-3.5 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-sm font-semibold text-white focus:outline-none shadow-lg shadow-orange-500/25 hover:shadow-orange-500/40 transition-all duration-300 transform hover:-translate-y-0.5">
                                <span class="relative z-10">Add To Do</span>
                            </button>
                        </div>
                        <ul id="dashboardActiveTodoList" class="space-y-3">
                            <!-- Active todos will be inserted here via JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Tables Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in-up-delay-3">
            <!-- Group Distribution Chart -->
            <div class="premium-card bg-white rounded-2xl shadow-xl border border-slate-200/60 p-6 lg:col-span-1 overflow-hidden">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                            <i class="fas fa-pie-chart text-white"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">Contact Groups</h3>
                    </div>
                    <span class="text-sm font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">Distribution</span>
                </div>
                <div id="groupChart" style="min-height: 250px;" class="w-full"></div>
                <div class="mt-4 pt-4 border-t border-slate-100 overflow-y-auto" style="max-height: 200px;">
                    <div class="space-y-2">
                        {% for group in group_stats %}
                        <div class="flex items-center justify-between text-sm p-2 rounded-lg hover:bg-slate-50 transition-colors">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-3 shadow-sm" style="background: linear-gradient(135deg, {{ ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'][loop.index0 % 6] }}, {{ ['#60A5FA', '#34D399', '#FBBF24', '#F87171', '#A78BFA', '#F472B6'][loop.index0 % 6] }})"></div>
                                <span class="text-slate-600 font-medium">{{ group.name }}</span>
                            </div>
                            <span class="font-bold text-slate-800 bg-slate-100 px-2.5 py-0.5 rounded-full text-xs">{{ group.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Top Contacts Table -->
            <div class="premium-card bg-white rounded-2xl shadow-xl border border-slate-200/60 p-6 lg:col-span-2 overflow-hidden">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20">
                        <i class="fas fa-trophy text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800">Top Contacts by Commission</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b-2 border-slate-100">
                                {% if current_user.role == 'admin' and show_all %}
                                <th class="px-4 py-3.5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Owner</th>
                                {% endif %}
                                <th class="px-4 py-3.5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Name</th>
                                <th class="px-4 py-3.5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Last Contact</th>
                                <th class="px-4 py-3.5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Email</th>
                                <th class="px-4 py-3.5 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Commission</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            {% for contact in top_contacts %}
                            <tr class="hover:bg-gradient-to-r hover:from-slate-50 hover:to-transparent transition-all duration-200">
                                {% if current_user.role == 'admin' and show_all %}
                                <td class="px-4 py-4">
                                    <div class="flex items-center">
                                        <div class="w-7 h-7 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-xs font-medium text-slate-600 mr-2 shadow-sm">
                                            {{ contact.owner.first_name[0] }}{{ contact.owner.last_name[0] }}
                                        </div>
                                        <span class="text-sm text-slate-600">
                                            {{ contact.owner.first_name }} {{ contact.owner.last_name }}
                                        </span>
                                    </div>
                                </td>
                                {% endif %}
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <div class="flex flex-col">
                                        <a href="{{ url_for('contacts.view_contact', contact_id=contact.id) }}" 
                                           class="text-sm font-semibold text-slate-800 hover:text-orange-600 transition-colors">
                                            {{ contact.first_name }} {{ contact.last_name }}
                                        </a>
                                        <div class="flex flex-wrap gap-1 mt-1">
                                            {% for group in contact.groups[:2] %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                                                    {{ group.name }}
                                                </span>
                                            {% endfor %}
                                            {% if contact.groups|length > 2 %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                                                    +{{ contact.groups|length - 2 }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-4 py-4 text-sm text-slate-500">
                                    {{ contact.last_contact_date.strftime('%B %d, %Y') if contact.last_contact_date else 'Never' }}
                                </td>
                                <td class="px-4 py-4 text-sm text-slate-500 max-w-[200px] truncate">
                                    {{ contact.email or '--' }}
                                </td>
                                <td class="px-4 py-4 text-right">
                                    <span class="text-sm font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">
                                        ${{ "{:,.0f}".format(contact.potential_commission or 0) }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include modals -->
{% include 'modals/contact_modal.html' %}
{% include 'modals/daily_todo_modal.html' %}

<!-- Todo Item Template -->
<template id="todoItemTemplate">
    <li class="todo-item group bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 ease-in-out transform hover:-translate-y-0.5">
        <div class="px-5 py-4 flex items-center justify-between">
            <div class="flex items-center flex-1 min-w-0">
                <div class="flex-shrink-0 flex items-center space-x-3">
                    <div class="relative">
                        <input type="checkbox" class="todo-checkbox h-5 w-5 text-orange-500 focus:ring-0 focus:outline-none border-2 border-slate-300 rounded-lg cursor-pointer transition-all duration-300 ease-in-out hover:border-orange-400">
                        <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white scale-0 transition-transform duration-200 pointer-events-none check-icon">
                            <i class="fas fa-check text-xs"></i>
                        </span>
                    </div>
                </div>
                <div class="ml-4 flex-1 relative group">
                    <!-- Normal Text View -->
                    <p class="todo-text text-sm font-medium text-slate-800 break-words py-2 px-3 rounded-lg hover:bg-slate-50 cursor-pointer transition-all duration-200">
                        <!-- Text will be inserted here -->
                    </p>
                    <!-- Edit Input (hidden by default) -->
                    <div class="todo-edit-container hidden absolute inset-0 flex items-center">
                        <input type="text" 
                               class="todo-edit-input block w-full rounded-lg border-2 border-slate-200 bg-slate-50 px-3 py-1.5 text-sm font-medium text-slate-900 focus:bg-white focus:border-orange-500 focus:ring-0 focus:outline-none hover:border-slate-300 transition-all duration-200 shadow-sm" 
                               placeholder="Edit to do...">
                    </div>
                    <!-- Edit hint (visible on hover) -->
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-in-out">
                        <i class="fas fa-pencil-alt mr-1"></i>Double-click to edit
                    </span>
                </div>
            </div>
            <div class="ml-4 flex-shrink-0">
                <button class="delete-todo p-2 text-slate-400 hover:text-red-500 transition-all duration-300 ease-in-out rounded-lg hover:bg-red-50 group-hover:opacity-100 opacity-0">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </li>
</template>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Task update function
function updateTaskStatus(taskId, completed) {
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${completed ? 'completed' : 'pending'}`
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task status');
    });
}

// Priority update functions
function quickUpdatePriority(taskId, priority) {
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `priority=${priority}`
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task priority');
    });
}

function togglePriorityMenu(taskId) {
    const button = event.currentTarget;
    const menu = document.getElementById(`priority-menu-${taskId}`);
    const allMenus = document.querySelectorAll('[id^="priority-menu-"]');
    
    // Close all other menus
    allMenus.forEach(m => {
        if (m.id !== `priority-menu-${taskId}`) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle this menu
    menu.classList.toggle('hidden');
    
    if (!menu.classList.contains('hidden')) {
        // Get button position
        const rect = button.getBoundingClientRect();
        
        // Position menu below the button
        menu.style.left = `${rect.left}px`;
        menu.style.top = `${rect.bottom}px`;
        
        // Ensure menu doesn't go off screen
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        if (menuRect.right > viewportWidth) {
            menu.style.left = `${viewportWidth - menuRect.width - 10}px`;
        }
        
        if (menuRect.bottom > viewportHeight) {
            menu.style.top = `${rect.top - menuRect.height}px`;
        }
    }
}

// Close priority menus when clicking outside
document.addEventListener('click', function(event) {
    const isClickInsideMenu = event.target.closest('[id^="priority-menu-"]');
    const isClickOnPriorityButton = event.target.closest('button[onclick^="togglePriorityMenu"]');
    
    if (!isClickInsideMenu && !isClickOnPriorityButton) {
        const allMenus = document.querySelectorAll('[id^="priority-menu-"]');
        allMenus.forEach(menu => menu.classList.add('hidden'));
    }
});

// Initialize Group Distribution Chart
document.addEventListener('DOMContentLoaded', function() {
    var groupData = {{ group_stats|tojson|safe }};
    var chartOptions = {
        series: groupData.map(function(item) { return item.count; }),
        chart: {
            width: '100%',
            height: 250,
            type: 'donut'
        },
        labels: groupData.map(function(item) { return item.name; }),
        colors: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'],
        plotOptions: {
            pie: {
                donut: {
                    size: '75%'
                }
            }
        },
        dataLabels: {
            enabled: false
        },
        legend: {
            show: false
        },
        tooltip: {
            enabled: true,
            y: {
                formatter: function(value) {
                    return value + ' contacts';
                }
            }
        }
    };

    var chart = new ApexCharts(document.querySelector("#groupChart"), chartOptions);
    chart.render();
});
</script>

{% endblock %}

{% block scripts %}
<!-- Include the daily todo JavaScript -->
<script src="{{ url_for('static', filename='js/daily_todo.js') }}"></script>

<!-- Todo Item Template -->
<template id="todoItemTemplate">
    <li class="todo-item group bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 ease-in-out transform hover:-translate-y-0.5">
        <div class="px-5 py-4 flex items-center justify-between">
            <div class="flex items-center flex-1 min-w-0">
                <div class="flex-shrink-0 flex items-center space-x-3">
                    <div class="relative">
                        <input type="checkbox" class="todo-checkbox h-5 w-5 text-orange-500 focus:ring-0 focus:outline-none border-2 border-slate-300 rounded-lg cursor-pointer transition-all duration-300 ease-in-out hover:border-orange-400">
                        <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white scale-0 transition-transform duration-200 pointer-events-none check-icon">
                            <i class="fas fa-check text-xs"></i>
                        </span>
                    </div>
                </div>
                <div class="ml-4 flex-1 relative group">
                    <!-- Normal Text View -->
                    <p class="todo-text text-sm font-medium text-slate-800 break-words py-2 px-3 rounded-lg hover:bg-slate-50 cursor-pointer transition-all duration-200">
                        <!-- Text will be inserted here -->
                    </p>
                    <!-- Edit Input (hidden by default) -->
                    <div class="todo-edit-container hidden absolute inset-0 flex items-center">
                        <input type="text" 
                               class="todo-edit-input block w-full rounded-lg border-2 border-slate-200 bg-slate-50 px-3 py-1.5 text-sm font-medium text-slate-900 focus:bg-white focus:border-orange-500 focus:ring-0 focus:outline-none hover:border-slate-300 transition-all duration-200 shadow-sm" 
                               placeholder="Edit to do...">
                    </div>
                    <!-- Edit hint (visible on hover) -->
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-in-out">
                        <i class="fas fa-pencil-alt mr-1"></i>Double-click to edit
                    </span>
                </div>
            </div>
            <div class="ml-4 flex-shrink-0">
                <button class="delete-todo p-2 text-slate-400 hover:text-red-500 transition-all duration-300 ease-in-out rounded-lg hover:bg-red-50 group-hover:opacity-100 opacity-0">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </li>
</template>

<!-- Task functionality -->
<script>
function handleTaskComplete(event, taskId) {
    // Prevent the default checkbox action so we can do our fetch first
    event.preventDefault();

    const checkbox = event.target;          // The checkbox that was clicked
    const isCompleted = checkbox.checked;   // true if box is checked
    const taskElement = checkbox.closest('.group'); // The .group container for that task row

    // Send the status update to the server
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${isCompleted ? 'completed' : 'pending'}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json(); // Expecting {status: 'success'} from your route
    })
    .then(data => {
        // Once the task is successfully updated, do the fade-out
        taskElement.style.transition = 'opacity 0.3s ease-out';
        taskElement.style.opacity = '0';

        setTimeout(() => {
            // Remove the task from the DOM
            taskElement.remove();

            // Optionally, if you want to show a "No upcoming tasks" message
            // after removing all tasks, check if the container is now empty:
            const taskListContainer = document.querySelector('.divide-y');
            if (taskListContainer && taskListContainer.children.length === 0) {
                taskListContainer.innerHTML = `
                    <div class="px-6 py-8 text-center">
                        <div class="text-slate-500">No upcoming client tasks</div>
                        <a href="/tasks/new" 
                           class="mt-2 inline-flex items-center text-sm text-orange-600 hover:text-orange-700">
                            <i class="fas fa-plus mr-2"></i>
                            Create a new client task
                        </a>
                    </div>
                `;
            }
        }, 300);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task status');
        // If there was an error, revert the checkbox
        checkbox.checked = !checkbox.checked;
    });
}

</script>
{% endblock %}
