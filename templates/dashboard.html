{% extends "base.html" %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900">Dashboard</h1>
            <p class="text-sm text-gray-500">Welcome back, {{ current_user.first_name }}</p>
        </div>
        <button 
            onclick="showDailyTodoModal()"
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Daily To-Do List
        </button>
    </div>

    <!-- Filter Tabs (Only show for admin) -->
    {% if current_user.role == 'admin' %}
    <div class="border-b mb-6">
        <div class="flex space-x-6">
            <button 
                class="px-4 py-2 text-sm {% if show_all %}text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:text-gray-800{% endif %}"
                onclick="window.location.href='{{ url_for('main.dashboard', view='all') }}'"
            >
                All contacts
            </button>
            <button 
                class="px-4 py-2 text-sm {% if not show_all %}text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:text-gray-800{% endif %}"
                onclick="window.location.href='{{ url_for('main.dashboard', view='my') }}'"
            >
                My contacts
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Total Commission Card -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Total Potential Commission</h3>
                <span class="bg-green-100 text-green-800 text-xs px-2.5 py-0.5 rounded-full">All time</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-3xl font-bold text-gray-900">${{ "{:,.0f}".format(total_commission) }}</span>
            </div>
        </div>

        <!-- Total Contacts Card -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Total Contacts</h3>
                <span class="bg-blue-100 text-blue-800 text-xs px-2.5 py-0.5 rounded-full">Active</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-3xl font-bold text-gray-900">{{ total_contacts }}</span>
            </div>
        </div>

        <!-- Average Commission Card -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-500">Average Commission</h3>
                <span class="bg-purple-100 text-purple-800 text-xs px-2.5 py-0.5 rounded-full">Per contact</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-3xl font-bold text-gray-900">${{ "{:,.0f}".format(avg_commission) }}</span>
            </div>
        </div>
    </div>

    <!-- Upcoming Tasks and Todos Section -->
    <div class="mb-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Upcoming Tasks Section -->
        <div class="bg-gray-50 rounded-lg shadow-md border border-gray-200">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Upcoming Tasks</h3>
                    <p class="text-sm text-gray-500 mt-1">Tasks due in the next 7 days</p>
                </div>
                <a href="{{ url_for('tasks.tasks') }}" 
                   class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                    View all tasks
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>

            <!-- Task List -->
            <div class="overflow-y-auto" style="max-height: 420px;">
                {% if upcoming_tasks %}
                <div class="divide-y divide-gray-200">
                    {% for task in upcoming_tasks %}
                    <div class="group hover:bg-gray-50">
                        <div class="p-4">
                            <div class="flex items-start">
                                <!-- Left Side: Priority and Status -->
                                <div class="flex items-center space-x-3">
                                    <!-- Status Checkbox -->
                                    <div class="flex items-center">
                                        <input type="checkbox"
                                            class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                            {% if task.status == 'completed' %}checked{% endif %}
                                            onchange="updateTaskStatus({{ task.id }}, this.checked)">
                                    </div>
                                    <!-- Priority -->
                                    <div class="relative">
                                        <button onclick="togglePriorityMenu({{ task.id }})"
                                                class="w-8 h-8 rounded-lg flex items-center justify-center {% if task.priority == 'high' %}bg-red-100 text-red-700{% elif task.priority == 'medium' %}bg-yellow-100 text-yellow-700{% else %}bg-green-100 text-green-700{% endif %}">
                                            <i class="fas fa-flag"></i>
                                        </button>
                                        <div id="priority-menu-{{ task.id }}"
                                             class="hidden fixed mt-1 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-[100]">
                                            <div class="py-1" role="menu">
                                                <button onclick="quickUpdatePriority({{ task.id }}, 'high')"
                                                        class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full">
                                                    <span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                                                    High
                                                </button>
                                                <button onclick="quickUpdatePriority({{ task.id }}, 'medium')"
                                                        class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full">
                                                    <span class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>
                                                    Medium
                                                </button>
                                                <button onclick="quickUpdatePriority({{ task.id }}, 'low')"
                                                        class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full">
                                                    <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                                                    Low
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Task Info (Middle) -->
                                <div class="flex-1 min-w-0 ml-4">
                                    <div class="flex items-center space-x-3">
                                        <a href="{{ url_for('tasks.view_task', task_id=task.id) }}"
                                           class="text-sm font-medium text-blue-600 hover:text-blue-800">
                                            {{ task.subject }}
                                        </a>
                                        <div class="flex items-center space-x-2">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                                {{ task.task_type.name }}
                                            </span>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-50 text-gray-600">
                                                {{ task.task_subtype.name }}
                                            </span>
                                        </div>
                                    </div>

                                    {% if current_user.role == 'admin' and show_all %}
                                    <div class="flex items-center text-gray-500 text-sm mt-0.5">
                                        <div class="w-4 h-4 rounded-full bg-gray-100 flex items-center justify-center text-xs mr-1.5">
                                            {{ task.assigned_to.first_name[0] }}{{ task.assigned_to.last_name[0] }}
                                        </div>
                                        <span>{{ task.assigned_to.first_name }} {{ task.assigned_to.last_name }}</span>
                                    </div>
                                    {% endif %}

                                    <!-- Task Details -->
                                    <div class="mt-1 flex items-center space-x-4 text-sm text-gray-500">
                                        <!-- Due Date with Color Coding -->
                                        {% set task_date = task.due_date.date() %}
                                        {% set current_date = now.date() %}
                                        {% set days_until_due = (task_date - current_date).days %}
                                        <div class="flex items-center">
                                            <i class="far fa-calendar-alt mr-1.5 
                                                {% if days_until_due < 0 %}
                                                    text-red-500
                                                {% elif days_until_due == 0 %}
                                                    text-orange-500
                                                {% elif days_until_due <= 2 %}
                                                    text-yellow-500
                                                {% else %}
                                                    text-gray-400
                                                {% endif %}">
                                            </i>
                                            <span class="{% if days_until_due < 0 %}text-red-500{% elif days_until_due == 0 %}text-orange-500{% elif days_until_due <= 2 %}text-yellow-500{% endif %}">
                                                {% if days_until_due < 0 %}
                                                    Overdue by {{ days_until_due|abs }} day{{ 's' if days_until_due|abs != 1 }}
                                                {% elif days_until_due == 0 %}
                                                    Due today
                                                {% elif days_until_due == 1 %}
                                                    Due tomorrow
                                                {% else %}
                                                    Due in {{ days_until_due }} days
                                                {% endif %}
                                                ({{ task.due_date.strftime('%m/%d/%y') }}{% if task.scheduled_time %} @ {{ task.scheduled_time.strftime('%I:%M %p') }}{% endif %})
                                            </span>
                                        </div>

                                        <!-- Contact -->
                                        {% if task.contact %}
                                        <div class="flex items-center">
                                            <i class="far fa-user mr-1.5 text-gray-400"></i>
                                            <a href="#" 
                                               onclick="openContactModal({{ task.contact.id }}); return false;"
                                               class="hover:text-blue-600">
                                                {{ task.contact.first_name }} {{ task.contact.last_name }}
                                            </a>
                                        </div>
                                        {% endif %}

                                        <!-- Property Address (if exists) -->
                                        {% if task.property_address %}
                                        <div class="flex items-center">
                                            <i class="far fa-building mr-1.5 text-gray-400"></i>
                                            {{ task.property_address }}
                                        </div>
                                        {% endif %}

                                        <!-- Scheduled Time -->
                                        {% if task.scheduled_time %}
                                        <div class="flex items-center">
                                            <i class="far fa-clock mr-1.5 text-gray-400"></i>
                                            {{ task.scheduled_time.strftime('%I:%M %p') }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Right Side: Quick Actions -->
                                <div class="flex items-center space-x-4 ml-4">
                                    <!-- Quick Actions (visible on hover) -->
                                    <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-150 flex items-center space-x-2">
                                        <a href="{{ url_for('tasks.view_task', task_id=task.id) }}"
                                           class="p-1 rounded-full hover:bg-gray-200"
                                           title="View Details">
                                            <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                                        </a>
                                        <button onclick="deleteTask({{ task.id }})"
                                                class="p-1 rounded-full hover:bg-gray-200"
                                                title="Delete Task">
                                            <i class="fas fa-trash text-gray-400 hover:text-red-500"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="px-6 py-8 text-center">
                    <div class="text-gray-500">No upcoming tasks</div>
                    <a href="{{ url_for('tasks.create_task') }}" 
                       class="mt-2 inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
                        <i class="fas fa-plus mr-2"></i>
                        Create a new task
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Active Todos Section -->
        <div class="bg-gray-50 rounded-lg shadow-md border border-gray-200">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Active To Do's</h3>
                    <p class="text-sm text-gray-500 mt-1">Your current to do list</p>
                </div>
                <a href="{{ url_for('user_todo.user_todo') }}" 
                   class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                    View all to do's
                    <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>

            <!-- Todo List -->
            <div class="overflow-y-auto" style="max-height: 420px;">
                <div class="px-6 py-6">
                    <!-- New Todo Input -->
                    <div class="flex items-center space-x-3 mb-6 group">
                        <div class="flex-1 relative">
                            <input type="text" id="dashboardNewTodoInput" 
                                   class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 pl-12 pr-4 py-3 text-gray-900 placeholder-gray-400 focus:bg-white focus:border-orange-500 focus:ring-0 focus:outline-none hover:border-gray-300 transition-all duration-200 shadow-sm" 
                                   placeholder="Add a new to do...">
                            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-orange-500 transition-colors duration-200">
                                <i class="fas fa-plus-circle"></i>
                            </span>
                        </div>
                        <button id="dashboardAddTodoBtn" 
                                class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 focus:outline-none focus:ring-0 transition-all duration-200 transform hover:scale-105 hover:shadow active:scale-95">
                            Add To Do
                        </button>
                    </div>
                    <ul id="dashboardActiveTodoList" class="space-y-4">
                        <!-- Active todos will be inserted here via JavaScript -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Tables Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Group Distribution Chart -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200 lg:col-span-1">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-medium text-gray-900">Contact Groups</h3>
                <span class="text-sm text-gray-500">Distribution</span>
            </div>
            <div id="groupChart" style="min-height: 250px;" class="w-full"></div>
            <div class="mt-4 overflow-y-auto" style="max-height: 200px;">
                <div class="grid grid-cols-1 gap-2">
                    {% for group in group_stats %}
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full mr-2" style="background-color: {{ ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'][loop.index0 % 6] }}"></div>
                            <span class="text-gray-600">{{ group.name }}</span>
                        </div>
                        <span class="font-medium text-gray-900">{{ group.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Top Contacts Table -->
        <div class="bg-gray-50 rounded-lg shadow-md p-6 border border-gray-200 lg:col-span-2">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Top Contacts by Commission</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            {% if current_user.role == 'admin' and show_all %}
                            <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Owner</th>
                            {% endif %}
                            <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Last Contact</th>
                            <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3.5 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Potential Commission</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for contact in top_contacts %}
                        <tr class="hover:bg-white transition-colors duration-150">
                            {% if current_user.role == 'admin' and show_all %}
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs bg-gray-100 text-gray-600 mr-2">
                                        {{ contact.owner.first_name[0] }}{{ contact.owner.last_name[0] }}
                                    </div>
                                    <span class="text-sm text-gray-600">
                                        {{ contact.owner.first_name }} {{ contact.owner.last_name }}
                                    </span>
                                </div>
                            </td>
                            {% endif %}
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex flex-col">
                                    <a href="{{ url_for('contacts.view_contact', contact_id=contact.id) }}" 
                                       class="text-blue-600 hover:text-blue-800">
                                        {{ contact.first_name }} {{ contact.last_name }}
                                    </a>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        {% for group in contact.groups[:2] %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                                {{ group.name }}
                                            </span>
                                        {% endfor %}
                                        {% if contact.groups|length > 2 %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                                +{{ contact.groups|length - 2 }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                {{ contact.last_contact_date.strftime('%B %d, %Y') if contact.last_contact_date else 'Never' }}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                {{ contact.email or '--' }}
                            </td>
                            <td class="px-6 py-4 text-right text-sm font-medium text-gray-900">
                                ${{ "{:,.0f}".format(contact.potential_commission or 0) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Include modals -->
{% include 'modals/contact_modal.html' %}
{% include 'modals/daily_todo_modal.html' %}

<!-- Todo Item Template -->
<template id="todoItemTemplate">
    <li class="todo-item group bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-300 ease-in-out transform hover:-translate-y-0.5">
        <div class="px-5 py-4 flex items-center justify-between">
            <div class="flex items-center flex-1 min-w-0">
                <div class="flex-shrink-0 flex items-center space-x-3">
                    <div class="relative">
                        <input type="checkbox" class="todo-checkbox h-5 w-5 text-orange-600 focus:ring-0 focus:outline-none border-gray-300 rounded cursor-pointer transition-all duration-300 ease-in-out hover:border-orange-500">
                        <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white scale-0 transition-transform duration-200 pointer-events-none check-icon">
                            <i class="fas fa-check text-xs"></i>
                        </span>
                    </div>
                </div>
                <div class="ml-4 flex-1 relative group">
                    <!-- Normal Text View -->
                    <p class="todo-text text-sm font-medium text-gray-900 break-words py-2 px-3 rounded-md hover:bg-gray-50 cursor-pointer transition-all duration-200">
                        <!-- Text will be inserted here -->
                    </p>
                    <!-- Edit Input (hidden by default) -->
                    <div class="todo-edit-container hidden absolute inset-0 flex items-center">
                        <input type="text" 
                               class="todo-edit-input block w-full rounded-md border-2 border-gray-200 bg-gray-50 px-3 py-1.5 text-sm font-medium text-gray-900 focus:bg-white focus:border-orange-500 focus:ring-0 focus:outline-none hover:border-gray-300 transition-all duration-200 shadow-sm" 
                               placeholder="Edit to do...">
                    </div>
                    <!-- Edit hint (visible on hover) -->
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-in-out">
                        <i class="fas fa-pencil-alt mr-1"></i>Double-click to edit
                    </span>
                </div>
            </div>
            <div class="ml-4 flex-shrink-0">
                <button class="delete-todo p-2 text-gray-400 hover:text-red-500 transition-all duration-300 ease-in-out rounded-full hover:bg-red-50 group-hover:opacity-100 opacity-0">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </li>
</template>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Task update function
function updateTaskStatus(taskId, completed) {
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${completed ? 'completed' : 'pending'}`
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task status');
    });
}

// Priority update functions
function quickUpdatePriority(taskId, priority) {
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `priority=${priority}`
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task priority');
    });
}

function togglePriorityMenu(taskId) {
    const button = event.currentTarget;
    const menu = document.getElementById(`priority-menu-${taskId}`);
    const allMenus = document.querySelectorAll('[id^="priority-menu-"]');
    
    // Close all other menus
    allMenus.forEach(m => {
        if (m.id !== `priority-menu-${taskId}`) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle this menu
    menu.classList.toggle('hidden');
    
    if (!menu.classList.contains('hidden')) {
        // Get button position
        const rect = button.getBoundingClientRect();
        
        // Position menu below the button
        menu.style.left = `${rect.left}px`;
        menu.style.top = `${rect.bottom}px`;
        
        // Ensure menu doesn't go off screen
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        if (menuRect.right > viewportWidth) {
            menu.style.left = `${viewportWidth - menuRect.width - 10}px`;
        }
        
        if (menuRect.bottom > viewportHeight) {
            menu.style.top = `${rect.top - menuRect.height}px`;
        }
    }
}

// Close priority menus when clicking outside
document.addEventListener('click', function(event) {
    const isClickInsideMenu = event.target.closest('[id^="priority-menu-"]');
    const isClickOnPriorityButton = event.target.closest('button[onclick^="togglePriorityMenu"]');
    
    if (!isClickInsideMenu && !isClickOnPriorityButton) {
        const allMenus = document.querySelectorAll('[id^="priority-menu-"]');
        allMenus.forEach(menu => menu.classList.add('hidden'));
    }
});

// Initialize Group Distribution Chart
document.addEventListener('DOMContentLoaded', function() {
    var groupData = {{ group_stats|tojson|safe }};
    var chartOptions = {
        series: groupData.map(function(item) { return item.count; }),
        chart: {
            width: '100%',
            height: 250,
            type: 'donut'
        },
        labels: groupData.map(function(item) { return item.name; }),
        colors: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'],
        plotOptions: {
            pie: {
                donut: {
                    size: '75%'
                }
            }
        },
        dataLabels: {
            enabled: false
        },
        legend: {
            show: false
        },
        tooltip: {
            enabled: true,
            y: {
                formatter: function(value) {
                    return value + ' contacts';
                }
            }
        }
    };

    var chart = new ApexCharts(document.querySelector("#groupChart"), chartOptions);
    chart.render();
});
</script>

{% endblock %}

{% block scripts %}
<!-- Include the daily todo JavaScript -->
<script src="{{ url_for('static', filename='js/daily_todo.js') }}"></script>

<!-- Todo Item Template -->
<template id="todoItemTemplate">
    <li class="todo-item group bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-300 ease-in-out transform hover:-translate-y-0.5">
        <div class="px-5 py-4 flex items-center justify-between">
            <div class="flex items-center flex-1 min-w-0">
                <div class="flex-shrink-0 flex items-center space-x-3">
                    <div class="relative">
                        <input type="checkbox" class="todo-checkbox h-5 w-5 text-orange-600 focus:ring-0 focus:outline-none border-gray-300 rounded cursor-pointer transition-all duration-300 ease-in-out hover:border-orange-500">
                        <span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white scale-0 transition-transform duration-200 pointer-events-none check-icon">
                            <i class="fas fa-check text-xs"></i>
                        </span>
                    </div>
                </div>
                <div class="ml-4 flex-1 relative group">
                    <!-- Normal Text View -->
                    <p class="todo-text text-sm font-medium text-gray-900 break-words py-2 px-3 rounded-md hover:bg-gray-50 cursor-pointer transition-all duration-200">
                        <!-- Text will be inserted here -->
                    </p>
                    <!-- Edit Input (hidden by default) -->
                    <div class="todo-edit-container hidden absolute inset-0 flex items-center">
                        <input type="text" 
                               class="todo-edit-input block w-full rounded-md border-2 border-gray-200 bg-gray-50 px-3 py-1.5 text-sm font-medium text-gray-900 focus:bg-white focus:border-orange-500 focus:ring-0 focus:outline-none hover:border-gray-300 transition-all duration-200 shadow-sm" 
                               placeholder="Edit to do...">
                    </div>
                    <!-- Edit hint (visible on hover) -->
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 opacity-0 group-hover:opacity-100 transition-all duration-300 ease-in-out">
                        <i class="fas fa-pencil-alt mr-1"></i>Double-click to edit
                    </span>
                </div>
            </div>
            <div class="ml-4 flex-shrink-0">
                <button class="delete-todo p-2 text-gray-400 hover:text-red-500 transition-all duration-300 ease-in-out rounded-full hover:bg-red-50 group-hover:opacity-100 opacity-0">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </li>
</template>

<!-- Task functionality -->
<script>
function handleTaskComplete(event, taskId) {
    // Prevent the default checkbox action so we can do our fetch first
    event.preventDefault();

    const checkbox = event.target;          // The checkbox that was clicked
    const isCompleted = checkbox.checked;   // true if box is checked
    const taskElement = checkbox.closest('.group'); // The .group container for that task row

    // Send the status update to the server
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${isCompleted ? 'completed' : 'pending'}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json(); // Expecting {status: 'success'} from your route
    })
    .then(data => {
        // Once the task is successfully updated, do the fade-out
        taskElement.style.transition = 'opacity 0.3s ease-out';
        taskElement.style.opacity = '0';

        setTimeout(() => {
            // Remove the task from the DOM
            taskElement.remove();

            // Optionally, if you want to show a "No upcoming tasks" message
            // after removing all tasks, check if the container is now empty:
            const taskListContainer = document.querySelector('.divide-y');
            if (taskListContainer && taskListContainer.children.length === 0) {
                taskListContainer.innerHTML = `
                    <div class="px-6 py-8 text-center">
                        <div class="text-gray-500">No upcoming tasks</div>
                        <a href="/tasks/new" 
                           class="mt-2 inline-flex items-center text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-plus mr-2"></i>
                            Create a new task
                        </a>
                    </div>
                `;
            }
        }, 300);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task status');
        // If there was an error, revert the checkbox
        checkbox.checked = !checkbox.checked;
    });
}

</script>
{% endblock %}