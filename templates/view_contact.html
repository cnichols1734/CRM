{% extends "base.html" %}

{% block content %}
<div class="min-h-full bg-gray-50">
    <!-- Back button and header -->
    <div class="bg-white border-b sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-4 flex items-center justify-between">
                <button onclick="history.back()" class="flex items-center text-gray-600 hover:text-gray-900">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back
                </button>
                <div class="flex items-center space-x-3">
                    <button id="editButton" onclick="toggleEditMode()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-pencil-alt mr-2"></i>
                        Edit Contact
                    </button>
                    <button id="saveButton" onclick="saveContact()" 
                            class="hidden inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>
                        Save Changes
                    </button>
                    <button id="cancelButton" onclick="cancelEdit()" 
                            class="hidden inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Main Content -->
            <div class="flex-1">
                <!-- Contact Header -->
                <div class="bg-white rounded-2xl shadow-sm border p-6 mb-4">
                    <div class="flex items-center">
                        <div class="w-16 h-16 rounded-xl flex items-center justify-center text-xl font-semibold mr-5
                            {% set initials = contact.first_name[0]|upper + contact.last_name[0]|upper %}
                            {% set colors = {
                                'A': 'bg-blue-100 text-blue-800', 'B': 'bg-rose-100 text-rose-800', 
                                'C': 'bg-green-100 text-green-800', 'D': 'bg-amber-100 text-amber-800',
                                'E': 'bg-purple-100 text-purple-800', 'F': 'bg-pink-100 text-pink-800',
                                'G': 'bg-indigo-100 text-indigo-800', 'H': 'bg-teal-100 text-teal-800',
                                'I': 'bg-orange-100 text-orange-800', 'J': 'bg-cyan-100 text-cyan-800'
                            } %}
                            {{ colors[initials[0]] or 'bg-gray-100 text-gray-800' }}">
                            {{ contact.first_name[0] }}{{ contact.last_name[0] }}
                        </div>
                        <div class="flex-1">
                            <div id="viewContactName" class="text-2xl font-semibold text-gray-900 mb-1">
                                {{ contact.first_name }} {{ contact.last_name }}
                            </div>
                            <div id="editContactName" class="hidden space-x-3 mb-3">
                                <input type="text" 
                                       name="first_name" 
                                       value="{{ contact.first_name }}"
                                       class="rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 text-xl font-semibold focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors"
                                       placeholder="First Name">
                                <input type="text" 
                                       name="last_name" 
                                       value="{{ contact.last_name }}"
                                       class="rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 text-xl font-semibold focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors"
                                       placeholder="Last Name">
                            </div>
                            {% if current_user.role == 'admin' %}
                            <div class="flex items-center text-gray-600 mb-2">
                                <div class="w-5 h-5 rounded-full bg-gray-100 flex items-center justify-center text-xs mr-2">
                                    {{ contact.owner.first_name[0] }}{{ contact.owner.last_name[0] }}
                                </div>
                                <span class="text-sm">
                                    Owned by {{ contact.owner.first_name }} {{ contact.owner.last_name }}
                                </span>
                            </div>
                            {% endif %}
                            <div class="flex flex-wrap gap-2">
                                {% for group in contact.groups %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                        {{ group.name }}
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <form action="{{ url_for('contacts.edit_contact', contact_id=contact.id) }}" method="POST" id="editContactForm" class="hidden">
                        <div class="divide-y divide-gray-100">
                            <!-- Basic Information Section -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Basic Information</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" name="email" value="{{ contact.email }}" 
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input type="tel" name="phone" value="{{ contact.phone }}"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Potential Commission ($)</label>
                                        <input type="number" 
                                               name="potential_commission" 
                                               value="{{ contact.potential_commission }}"
                                               step="0.01"
                                               min="0"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Created</label>
                                        <p class="px-3 py-2 text-gray-600">{{ contact.created_at.strftime('%B %d, %Y') }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Dates Section -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Last Contact Dates</h2>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <!-- Last Email Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Email</label>
                                        <input type="date" 
                                               name="last_email_date" 
                                               value="{{ contact.last_email_date.strftime('%Y-%m-%d') if contact.last_email_date }}"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <!-- Last Text Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Text</label>
                                        <input type="date" 
                                               name="last_text_date" 
                                               value="{{ contact.last_text_date.strftime('%Y-%m-%d') if contact.last_text_date }}"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <!-- Last Phone Call Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Phone Call</label>
                                        <input type="date" 
                                               name="last_phone_call_date" 
                                               value="{{ contact.last_phone_call_date.strftime('%Y-%m-%d') if contact.last_phone_call_date }}"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <!-- Last Contact Date (Read-only) -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Contact</label>
                                        <p class="px-3 py-2 text-gray-600">
                                            {{ contact.last_contact_date.strftime('%B %d, %Y') if contact.last_contact_date else 'Never' }}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Section -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Address</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Street Address</label>
                                        <input type="text" name="street_address" value="{{ contact.street_address }}"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                        <input type="text" name="city" value="{{ contact.city }}"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                        <input type="text" name="state" value="{{ contact.state }}"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code</label>
                                        <input type="text" name="zip_code" value="{{ contact.zip_code }}"
                                               class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors">
                                    </div>
                                </div>
                            </div>

                            <!-- Groups Section -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Groups</h2>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    {% for group in all_groups %}
                                        <label class="inline-flex items-center px-3 py-2 rounded-lg text-sm
                                                    {% if group in contact.groups %}
                                                        bg-blue-50 border-blue-200 text-blue-700
                                                    {% else %}
                                                        bg-gray-50 border-gray-200 text-gray-700
                                                    {% endif %}
                                                    hover:bg-gray-100 
                                                    border
                                                    cursor-pointer transition-colors duration-200">
                                            <input type="checkbox" 
                                                   name="group_ids" 
                                                   value="{{ group.id }}"
                                                   {% if group in contact.groups %}checked{% endif %}
                                                   class="form-checkbox h-4 w-4 mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            {{ group.name }}
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Client Details Section in Edit Form -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Client Details</h2>
                                
                                <!-- Current Objective -->
                                <div class="mb-4">
                                    <h3 class="text-sm font-medium text-gray-500 mb-1">What does this person want right now?</h3>
                                    <textarea name="current_objective" rows="3" 
                                              class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors resize-y">{{ contact.current_objective or '' }}</textarea>
                                    <p class="mt-1 text-sm text-gray-500">Ex: They want to buy a home, sell a home, they're looking for acreage, They are not looking to make a move right now, but I want to stay in touch with them.</p>
                                </div>

                                <!-- Move Timeline -->
                                <div class="mb-4">
                                    <h3 class="text-sm font-medium text-gray-500 mb-1">What is their timeline?</h3>
                                    <textarea name="move_timeline" rows="2" 
                                              class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors resize-y">{{ contact.move_timeline or '' }}</textarea>
                                    <p class="mt-1 text-sm text-gray-500">Ex: They want to move now, within the next 6 months, or within a year?</p>
                                </div>

                                <!-- Motivation -->
                                <div class="mb-4">
                                    <h3 class="text-sm font-medium text-gray-500 mb-1">Why do they want to move?</h3>
                                    <textarea name="motivation" rows="2" 
                                              class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors resize-y">{{ contact.motivation or '' }}</textarea>
                                    <p class="mt-1 text-sm text-gray-500">Ex: They are having a baby, want a larger home, moving for work, etc.</p>
                                </div>

                                <!-- Financial Status -->
                                <div class="mb-4">
                                    <h3 class="text-sm font-medium text-gray-500 mb-1">Have they shared any financial details with you?</h3>
                                    <textarea name="financial_status" rows="3" 
                                              class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors resize-y">{{ contact.financial_status or '' }}</textarea>
                                    <p class="mt-1 text-sm text-gray-500">Ex: Their budget is $x, they have or have not been preapproved, they have $x for down payment, they have $x in home equity.</p>
                                </div>

                                <!-- Additional Notes -->
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500 mb-1">Any other details to share?</h3>
                                    <textarea name="additional_notes" rows="2" 
                                              class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors resize-y">{{ contact.additional_notes or '' }}</textarea>
                                    <p class="mt-1 text-sm text-gray-500">Ex: No details at this time</p>
                                </div>
                            </div>

                            <!-- Notes Section in Edit Form -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Notes</h2>
                                <textarea name="notes" rows="4" 
                                          class="block w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-3 py-2 focus:bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 hover:border-gray-300 transition-colors resize-y">{{ contact.notes }}</textarea>
                            </div>
                        </div>
                    </form>

                    <div id="viewContactInfo">
                        <div class="divide-y divide-gray-100">
                            <!-- Basic Information Section -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Basic Information</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Email</h3>
                                        <p class="text-gray-900">{{ contact.email or 'No email provided' }}</p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Phone</h3>
                                        <p class="text-gray-900">{{ contact.phone or 'No phone provided' }}</p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Potential Commission</h3>
                                        <p class="text-gray-900">
                                            {% if contact.potential_commission is not none %}
                                                ${{ "{:,.2f}".format(contact.potential_commission|float) }}
                                            {% else %}
                                                $0.00
                                            {% endif %}
                                        </p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Created</h3>
                                        <p class="text-gray-900">{{ contact.created_at.strftime('%B %d, %Y') }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Dates Section -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Last Contact Dates</h2>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Last Email</h3>
                                        <p class="text-gray-900">
                                            {{ contact.last_email_date.strftime('%m/%d/%Y') if contact.last_email_date else 'Never' }}
                                        </p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Last Text</h3>
                                        <p class="text-gray-900">
                                            {{ contact.last_text_date.strftime('%m/%d/%Y') if contact.last_text_date else 'Never' }}
                                        </p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Last Phone Call</h3>
                                        <p class="text-gray-900">
                                            {{ contact.last_phone_call_date.strftime('%m/%d/%Y') if contact.last_phone_call_date else 'Never' }}
                                        </p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Last Contact</h3>
                                        <p class="text-gray-900">
                                            {{ contact.last_contact_date.strftime('%m/%d/%Y') if contact.last_contact_date else 'Never' }}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Section -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Address</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2 bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">Street Address</h3>
                                        <p class="text-gray-900">{{ contact.street_address or 'No street address provided' }}</p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">City</h3>
                                        <p class="text-gray-900">{{ contact.city or 'No city provided' }}</p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">State</h3>
                                        <p class="text-gray-900">{{ contact.state or 'No state provided' }}</p>
                                    </div>

                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <h3 class="text-sm font-medium text-gray-600 mb-1">ZIP Code</h3>
                                        <p class="text-gray-900">{{ contact.zip_code or 'No ZIP code provided' }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Groups Section -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Groups</h2>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex flex-wrap gap-2">
                                        {% for group in contact.groups %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                                {{ group.name }}
                                            </span>
                                        {% else %}
                                            <span class="text-gray-500 italic">No groups assigned</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Client Details Section in View Mode -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Client Details</h2>
                                
                                <!-- Current Objective -->
                                <div class="mb-4">
                                    <h3 class="text-sm font-medium text-gray-600 mb-1">What does this person want right now?</h3>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-gray-900 whitespace-pre-line">{{ contact.current_objective or 'No current objective specified' }}</p>
                                    </div>
                                </div>

                                <!-- Move Timeline -->
                                <div class="mb-4">
                                    <h3 class="text-sm font-medium text-gray-600 mb-1">What is their timeline?</h3>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-gray-900 whitespace-pre-line">{{ contact.move_timeline or 'No timeline specified' }}</p>
                                    </div>
                                </div>

                                <!-- Motivation -->
                                <div class="mb-4">
                                    <h3 class="text-sm font-medium text-gray-600 mb-1">Why do they want to move?</h3>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-gray-900 whitespace-pre-line">{{ contact.motivation or 'No motivation specified' }}</p>
                                    </div>
                                </div>

                                <!-- Financial Status -->
                                <div class="mb-4">
                                    <h3 class="text-sm font-medium text-gray-600 mb-1">Have they shared any financial details with you?</h3>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-gray-900 whitespace-pre-line">{{ contact.financial_status or 'No financial details shared' }}</p>
                                    </div>
                                </div>

                                <!-- Additional Notes -->
                                <div>
                                    <h3 class="text-sm font-medium text-gray-600 mb-1">Any other details to share?</h3>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-gray-900 whitespace-pre-line">{{ contact.additional_notes or 'No additional details shared' }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes Section in View Mode -->
                            <div class="p-6">
                                <h2 class="text-base font-semibold text-gray-900 mb-4">Notes</h2>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-gray-900 whitespace-pre-line">{{ contact.notes or 'No notes added' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Contact Button -->
                <div class="mt-4 flex justify-end">
                    <form action="{{ url_for('contacts.delete_contact', contact_id=contact.id) }}" method="POST" id="deleteContactForm">
                        <button onclick="deleteContact()" 
                                class="inline-flex items-center px-4 py-2 border border-red-200 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 transition-colors">
                            <i class="fas fa-trash-alt mr-2"></i>
                            Delete Contact
                        </button>
                    </form>
                </div>
            </div>

            <!-- Side Container - Related Tasks -->
            <div class="lg:w-96">
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden sticky top-24">
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-900">Related Tasks</h2>
                            <a href="{{ url_for('tasks.create_task', contact_id=contact.id, return_to='contact') }}" 
                               class="inline-flex items-center px-2.5 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-plus mr-1"></i>
                                New Task
                            </a>
                        </div>
                    </div>

                    <!-- Task Filter Tabs -->
                    <div class="border-b border-gray-100">
                        <div class="flex">
                            <button onclick="switchTaskView('pending')" 
                                    id="pendingTasksTab"
                                    class="flex-1 py-2 px-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                                Active Tasks
                            </button>
                            <button onclick="switchTaskView('completed')" 
                                    id="completedTasksTab"
                                    class="flex-1 py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700">
                                Completed
                            </button>
                        </div>
                    </div>

                    <!-- Task Lists -->
                    <div id="pendingTasks" class="divide-y divide-gray-100 max-h-[calc(100vh-300px)] overflow-y-auto">
                        {% for task in contact.tasks|selectattr('status', 'equalto', 'pending')|sort(attribute='due_date') %}
                        <div class="p-4 hover:bg-gray-50">
                            <div class="flex items-start space-x-3">
                                <!-- Priority Indicator -->
                                <div class="flex-shrink-0">
                                    <div class="w-6 h-6 rounded flex items-center justify-center {% if task.priority == 'high' %}bg-red-100 text-red-700{% elif task.priority == 'medium' %}bg-yellow-100 text-yellow-700{% else %}bg-green-100 text-green-700{% endif %}">
                                        <i class="fas fa-flag text-xs"></i>
                                    </div>
                                </div>

                                <!-- Task Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2">
                                        <a href="#" 
                                           data-task-id="{{ task.id }}"
                                           class="task-link text-sm font-medium text-blue-600 hover:text-blue-800 truncate">
                                            {{ task.subject }}
                                        </a>
                                    </div>
                                    <div class="mt-1 flex items-center space-x-2 text-xs text-gray-500">
                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            {{ task.task_type.name }}
                                        </span>
                                        {% set task_date = task.due_date.date() %}
                                        {% set current_date = now.date() %}
                                        {% set days_until_due = (task_date - current_date).days %}
                                        <span class="{% if days_until_due < 0 %}text-red-500{% elif days_until_due == 0 %}text-orange-500{% elif days_until_due <= 2 %}text-yellow-500{% endif %}">
                                            {% if days_until_due < 0 %}
                                                {{ days_until_due|abs }}d overdue
                                            {% elif days_until_due == 0 %}
                                                Due today
                                            {% elif days_until_due == 1 %}
                                                Due tomorrow
                                            {% else %}
                                                Due in {{ days_until_due }}d
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="flex-shrink-0">
                                    <button onclick="quickUpdateStatus({{ task.id }}, true)" 
                                            class="text-gray-400 hover:text-green-500 p-1">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="p-6 text-center text-gray-500 text-sm">
                            No active tasks
                        </div>
                        {% endfor %}
                    </div>

                    <div id="completedTasks" class="hidden divide-y divide-gray-100 max-h-[calc(100vh-300px)] overflow-y-auto">
                        {% for task in contact.tasks|selectattr('status', 'equalto', 'completed')|sort(attribute='completed_at', reverse=true) %}
                        <div class="p-4 hover:bg-gray-50">
                            <div class="flex items-start space-x-3">
                                <!-- Completed Indicator -->
                                <div class="flex-shrink-0">
                                    <div class="w-6 h-6 rounded-full flex items-center justify-center bg-green-100 text-green-700">
                                        <i class="fas fa-check text-xs"></i>
                                    </div>
                                </div>

                                <!-- Task Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2">
                                        <a href="#" 
                                           data-task-id="{{ task.id }}"
                                           class="task-link text-sm font-medium text-gray-600 hover:text-gray-800 truncate">
                                            {{ task.subject }}
                                        </a>
                                    </div>
                                    <div class="mt-1 flex items-center space-x-2 text-xs text-gray-500">
                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            {{ task.task_type.name }}
                                        </span>
                                        <span>
                                            {% if task.completed_at %}
                                                Completed {{ task.completed_at.strftime('%m/%d/%y') }}
                                            {% else %}
                                                Completed recently
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="flex-shrink-0">
                                    <button onclick="quickUpdateStatus({{ task.id }}, false)" 
                                            class="text-gray-400 hover:text-yellow-500 p-1">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="p-6 text-center text-gray-500 text-sm">
                            No completed tasks
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div id="taskModal" 
     data-is-admin="{{ 'true' if current_user.role == 'admin' else 'false' }}"
     data-show-all="{{ 'true' if show_all else 'false' }}"
     class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 z-[200] overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-0 md:p-4">
        <div class="relative bg-white w-full md:rounded-lg shadow-xl md:max-w-4xl min-h-screen md:min-h-0">
            <!-- Modal header -->
            <div class="sticky top-0 z-10 flex items-center justify-between px-4 py-3 md:px-6 md:py-4 border-b border-gray-200 bg-gray-50 md:rounded-t-lg">
                <div class="flex items-center space-x-4">
                    <div id="modalTaskPriorityIndicator" class="w-10 h-10 rounded-lg flex items-center justify-center text-lg">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-900" id="modalTaskSubject"></h3>
                        {% if current_user.role == 'admin' and show_all %}
                        <div class="flex items-center text-gray-500 text-sm mt-0.5 mb-1">
                            <div id="modalTaskOwnerInitials" class="w-4 h-4 rounded-full bg-gray-100 flex items-center justify-center text-xs mr-1.5"></div>
                            <span id="modalTaskOwner"></span>
                        </div>
                        {% endif %}
                        <p class="text-sm text-gray-500" id="modalTaskHeaderDueDate"></p>
                    </div>
                </div>
                <button onclick="closeTaskModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            
            <!-- Modal content -->
            <div class="px-4 py-4 md:px-6 space-y-6" id="modalTaskContent">
                <!-- Status and Priority -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-gray-50 rounded-lg p-3 flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                                <i class="fas fa-tasks text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Status</p>
                                <p id="modalTaskStatus" class="text-sm font-medium text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                                <i class="fas fa-flag text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Priority</p>
                                <p id="modalTaskPriority" class="text-sm font-medium text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Due Date and Scheduled Time -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-gray-50 rounded-lg p-3 flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                                <i class="fas fa-calendar text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Due Date</p>
                                <p id="modalTaskDueDate" class="text-sm font-medium text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                    <div id="modalTaskScheduledContainer" class="hidden bg-gray-50 rounded-lg p-3 flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                                <i class="fas fa-clock text-gray-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Scheduled Time</p>
                                <p id="modalTaskScheduledTime" class="text-sm font-medium text-gray-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Type and Subtype -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                            <i class="fas fa-tag text-gray-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Task Type</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span id="modalTaskType" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800"></span>
                                <span id="modalTaskSubtype" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-50 text-gray-600"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Contact</p>
                            <a id="modalTaskContact" href="#" class="text-sm font-medium text-blue-600 hover:text-blue-800"></a>
                        </div>
                    </div>
                </div>

                <!-- Property Address -->
                <div id="modalTaskPropertyContainer" class="hidden bg-gray-50 rounded-lg p-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                            <i class="fas fa-building text-gray-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Property Address</p>
                            <p id="modalTaskProperty" class="text-sm font-medium text-gray-900"></p>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center bg-white border">
                            <i class="fas fa-align-left text-gray-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-500">Description</p>
                            <p id="modalTaskDescription" class="mt-1 text-sm text-gray-900 whitespace-pre-line"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal footer -->
            <div class="sticky bottom-0 border-t border-gray-200 bg-gray-50 p-4 md:rounded-b-lg">
                <div class="flex flex-col md:flex-row md:justify-between gap-3">
                    <div class="flex flex-col md:flex-row gap-2 md:items-center md:space-x-4">
                        <button onclick="toggleTaskStatus()" 
                                class="flex-1 md:flex-none text-center px-4 py-2 border rounded-lg bg-white hover:bg-gray-50 transition-colors duration-150 text-sm font-medium">
                            <span id="modalTaskStatusButton"></span>
                        </button>
                    </div>
                    <a id="modalTaskFullView" href="#" 
                       class="flex-1 md:flex-none text-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-150 text-sm font-medium">
                        Open Full View
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Get configuration from data attributes
const modalConfig = {
    modal: document.getElementById('taskModal'),
    init() {
        this.isAdmin = this.modal.dataset.isAdmin === 'true';
        this.showAll = this.modal.dataset.showAll === 'true';
        this.setupEventListeners();
    },
    setupEventListeners() {
        // Task links
        document.querySelectorAll('.task-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const taskId = link.dataset.taskId;
                openTaskModal(taskId);
            });
        });

        // Close modal when clicking outside
        this.modal.addEventListener('mousedown', (event) => {
            if (event.target === this.modal) {
                closeTaskModal();
            }
        });

        // Close on escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeTaskModal();
            }
        });
    }
};

// Initialize modal configuration
document.addEventListener('DOMContentLoaded', () => modalConfig.init());

function toggleEditMode() {
    const viewMode = document.getElementById('viewContactInfo');
    const editMode = document.getElementById('editContactForm');
    const viewName = document.getElementById('viewContactName');
    const editName = document.getElementById('editContactName');
    const editBtn = document.getElementById('editButton');
    const saveBtn = document.getElementById('saveButton');
    const cancelBtn = document.getElementById('cancelButton');

    viewMode.classList.add('hidden');
    editMode.classList.remove('hidden');
    viewName.classList.add('hidden');
    editName.classList.remove('hidden');
    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
    cancelBtn.classList.remove('hidden');
}

function cancelEdit() {
    const viewMode = document.getElementById('viewContactInfo');
    const editMode = document.getElementById('editContactForm');
    const viewName = document.getElementById('viewContactName');
    const editName = document.getElementById('editContactName');
    const editBtn = document.getElementById('editButton');
    const saveBtn = document.getElementById('saveButton');
    const cancelBtn = document.getElementById('cancelButton');

    viewMode.classList.remove('hidden');
    editMode.classList.add('hidden');
    viewName.classList.remove('hidden');
    editName.classList.add('hidden');
    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
    cancelBtn.classList.add('hidden');
}

async function saveContact() {
    const form = document.getElementById('editContactForm');
    const formData = new FormData();
    
    // Explicitly add the name fields from the edit name section
    const firstNameInput = document.querySelector('input[name="first_name"]');
    const lastNameInput = document.querySelector('input[name="last_name"]');
    formData.append('first_name', firstNameInput.value);
    formData.append('last_name', lastNameInput.value);
    
    // Add all other form fields
    const formInputs = form.querySelectorAll('input, textarea, select');
    formInputs.forEach(input => {
        if (input.type === 'checkbox') {
            if (input.checked) {
                formData.append(input.name, input.value);
            }
        } else {
            formData.append(input.name, input.value);
        }
    });

    try {
        const response = await fetch(`/contacts/{{ contact.id }}/edit`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert(data.message || 'Error saving changes');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving changes. Check the console for details.');
    }
}

// Phone number formatting
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editContactForm');
    const phoneInput = editForm.querySelector('input[name="phone"]');

    phoneInput.addEventListener('input', function(e) {
        // Remove all non-digit characters
        let inputVal = e.target.value.replace(/\D/g, '');

        // Limit to 10 digits
        if (inputVal.length > 10) {
            inputVal = inputVal.slice(0, 10);
        }

        // Build the formatted output (XXX) XXX-XXXX
        let formattedNumber = '';

        // (XXX
        if (inputVal.length > 0) {
            formattedNumber += '(' + inputVal.substring(0, 3);
        }
        // (XXX) XXX
        if (inputVal.length >= 4) {
            formattedNumber += ') ' + inputVal.substring(3, 6);
        }
        // (XXX) XXX-XXXX
        if (inputVal.length >= 7) {
            formattedNumber += '-' + inputVal.substring(6, 10);
        }

        e.target.value = formattedNumber;
    });
});

async function deleteContact() {
    if (!confirm('Are you sure you want to delete this contact? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/contacts/{{ contact.id }}/delete`, {
            method: 'POST'
        });

        if (response.ok) {
            window.location.href = "{{ url_for('main.index') }}";
        } else {
            const data = await response.json();
            alert(data.message || 'Error deleting contact');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting contact');
    }
}

function switchTaskView(view) {
    const pendingTab = document.getElementById('pendingTasksTab');
    const completedTab = document.getElementById('completedTasksTab');
    const pendingList = document.getElementById('pendingTasks');
    const completedList = document.getElementById('completedTasks');

    if (view === 'pending') {
        pendingTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        pendingTab.classList.remove('text-gray-500');
        completedTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        completedTab.classList.add('text-gray-500');
        pendingList.classList.remove('hidden');
        completedList.classList.add('hidden');
    } else {
        completedTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        completedTab.classList.remove('text-gray-500');
        pendingTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        pendingTab.classList.add('text-gray-500');
        completedList.classList.remove('hidden');
        pendingList.classList.add('hidden');
    }
}

function quickUpdateStatus(taskId, completed) {
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${completed ? 'completed' : 'pending'}`
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task status');
    });
}

let currentTaskId = null;

function openTaskModal(taskId) {
    currentTaskId = taskId;
    
    // Fetch task details
    fetch(`/tasks/${taskId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(task => {
            // Update modal content
            document.getElementById('modalTaskSubject').textContent = task.subject;
            document.getElementById('modalTaskFullView').href = `/tasks/${task.id}`;
            
            // Owner Info (for admin view)
            if (modalConfig.isAdmin && modalConfig.showAll) {
                const ownerInitials = document.getElementById('modalTaskOwnerInitials');
                ownerInitials.textContent = `${task.assigned_to.first_name[0]}${task.assigned_to.last_name[0]}`;
                document.getElementById('modalTaskOwner').textContent = `${task.assigned_to.first_name} ${task.assigned_to.last_name}`;
            }
            
            // Priority Indicator
            const priorityIndicator = document.getElementById('modalTaskPriorityIndicator');
            priorityIndicator.className = `w-10 h-10 rounded-lg flex items-center justify-center text-lg ${
                task.priority === 'high' ? 'bg-red-100 text-red-700' :
                task.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                'bg-green-100 text-green-700'
            }`;
            
            // Priority
            const priorityText = document.getElementById('modalTaskPriority');
            priorityText.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            
            // Status
            const statusText = document.getElementById('modalTaskStatus');
            statusText.textContent = task.status.charAt(0).toUpperCase() + task.status.slice(1);
            statusText.className = `text-sm font-medium ${
                task.status === 'completed' ? 'text-green-700' : 'text-yellow-700'
            }`;
            
            // Due Date
            const dueDate = new Date(task.due_date);
            const now = new Date();
            const diffTime = dueDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let dueDateText = '';
            if (diffDays < 0) {
                dueDateText = `Overdue by ${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''}`;
            } else if (diffDays === 0) {
                dueDateText = 'Due today';
            } else if (diffDays === 1) {
                dueDateText = 'Due tomorrow';
            } else {
                dueDateText = `Due in ${diffDays} days`;
            }
            
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            const formattedDate = dueDate.toLocaleDateString('en-US', options);
            document.getElementById('modalTaskHeaderDueDate').textContent = `${dueDateText}`;
            document.getElementById('modalTaskDueDate').textContent = formattedDate;
            
            // Scheduled Time
            const scheduledContainer = document.getElementById('modalTaskScheduledContainer');
            const scheduledTimeText = document.getElementById('modalTaskScheduledTime');
            if (task.scheduled_time) {
                const scheduledTime = new Date(task.scheduled_time);
                scheduledTimeText.textContent = scheduledTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                scheduledContainer.classList.remove('hidden');
            } else {
                scheduledContainer.classList.add('hidden');
            }
            
            // Type and Subtype
            document.getElementById('modalTaskType').textContent = task.task_type.name;
            document.getElementById('modalTaskSubtype').textContent = task.task_subtype.name;
            
            // Contact
            const contactLink = document.getElementById('modalTaskContact');
            contactLink.textContent = `${task.contact.first_name} ${task.contact.last_name}`;
            contactLink.href = `/contacts/${task.contact.id}`;
            
            // Property Address
            const propertyContainer = document.getElementById('modalTaskPropertyContainer');
            if (task.property_address) {
                document.getElementById('modalTaskProperty').textContent = task.property_address;
                propertyContainer.classList.remove('hidden');
            } else {
                propertyContainer.classList.add('hidden');
            }
            
            // Description
            document.getElementById('modalTaskDescription').textContent = task.description || 'No description provided';
            
            // Status Button
            const statusButton = document.getElementById('modalTaskStatusButton');
            statusButton.textContent = task.status === 'completed' ? 'Mark as Pending' : 'Mark as Complete';
            
            // Show modal
            modalConfig.modal.classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading task details');
        });
}

function closeTaskModal() {
    modalConfig.modal.classList.add('hidden');
    currentTaskId = null;
}

function toggleTaskStatus() {
    if (!currentTaskId) return;
    
    const newStatus = document.getElementById('modalTaskStatus').textContent.toLowerCase() === 'completed' ? 'pending' : 'completed';
    
    quickUpdateStatus(currentTaskId, newStatus === 'completed');
}

// Close modal when clicking outside or pressing Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeTaskModal();
    }
});

document.addEventListener('click', function(event) {
    const modal = document.getElementById('taskModal');
    const modalContent = modal.querySelector('.relative');
    
    if (!modal.classList.contains('hidden') && 
        !modalContent.contains(event.target)) {
        closeTaskModal();
    }
});

// Handle clicks on the modal backdrop
const taskModal = document.getElementById('taskModal');
taskModal.addEventListener('mousedown', function(event) {
    // Only close if clicking directly on the backdrop (the outermost div)
    // and not on any of its children
    if (event.target === taskModal) {
        closeTaskModal();
    }
});

// Add event listeners for task links
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.task-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const taskId = this.getAttribute('data-task-id');
            openTaskModal(taskId);
        });
    });
});
</script>
{% endblock %}