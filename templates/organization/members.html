{% extends "base.html" %}

{% block mobile_title %}Team Members{% endblock %}

{% block content %}
<style>
    /* Premium animations */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    .animate-fade-in-up-delay-1 {
        animation: fadeInUp 0.6s ease-out 0.1s forwards;
        opacity: 0;
    }

    /* Premium table styling */
    .premium-table {
        border-collapse: separate;
        border-spacing: 0;
    }

    .premium-table thead th {
        background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.75rem;
        color: #475569;
    }

    .premium-table tbody tr {
        transition: all 0.15s ease-out;
    }

    .premium-table tbody tr:hover {
        background: linear-gradient(to right, rgba(249, 115, 22, 0.03), rgba(249, 115, 22, 0.08), rgba(249, 115, 22, 0.03));
    }

    /* Premium button styling */
    .premium-btn {
        transition: all 0.2s ease-out;
        border-radius: 0.75rem;
    }

    .premium-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Mobile card styling */
    .mobile-member-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease-out;
    }

    .mobile-member-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
    }

    /* Action buttons */
    .action-link {
        transition: all 0.15s ease;
    }

    .action-link:hover {
        transform: translateY(-1px);
    }
</style>

<!-- Premium gradient background -->
<div class="min-h-full bg-gradient-to-br from-slate-50 via-white to-orange-50/30">
    <div class="p-4 md:p-6">
        <!-- Header Section -->
        <div class="flex justify-between items-center mb-6 animate-fade-in-up">
            <div class="flex items-center space-x-3">
                <!-- Animated Icon -->
                <div class="hidden md:flex w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 items-center justify-center shadow-lg">
                    <i class="fas fa-users text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 hidden md:block">Team Members</h1>
                    <span class="text-sm text-slate-500">{{ members|length }} member{% if members|length != 1 %}s{% endif %}</span>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                {% if can_invite %}
                <button onclick="showInviteModal()" class="premium-btn inline-flex items-center px-4 py-2.5 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-semibold rounded-xl shadow-md hover:shadow-lg hover:from-orange-600 hover:to-orange-700 transition-all">
                    <i class="fas fa-plus mr-2"></i>Invite Member
                </button>
                {% elif not org.can_invite_users %}
                <span class="text-sm text-slate-500 bg-slate-100 px-3 py-2 rounded-lg">
                    <i class="fas fa-lock mr-1"></i>Upgrade to Pro to invite team members
                </span>
                {% elif org.is_at_user_limit %}
                <span class="text-sm text-amber-600 bg-amber-50 px-3 py-2 rounded-lg">
                    <i class="fas fa-exclamation-triangle mr-1"></i>User limit reached
                </span>
                {% endif %}
            </div>
        </div>

        <!-- Main Content Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden animate-fade-in-up-delay-1">
            <!-- Desktop Member List -->
            <div class="hidden md:block overflow-x-auto">
                <table class="premium-table min-w-full">
                    <thead>
                        <tr>
                            <th class="px-6 py-4 text-left border-b border-slate-200">Member</th>
                            <th class="px-6 py-4 text-left border-b border-slate-200">Role</th>
                            <th class="px-6 py-4 text-left border-b border-slate-200">Joined</th>
                            <th class="px-6 py-4 text-left border-b border-slate-200">Last Login</th>
                            <th class="px-6 py-4 text-left border-b border-slate-200">Contacts</th>
                            {% if org_has_feature('AI_ACTION_PLAN') %}
                            <th class="px-6 py-4 text-left border-b border-slate-200">Action Plan</th>
                            {% endif %}
                            <th class="px-6 py-4 text-right border-b border-slate-200">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for member in members %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center shadow-sm">
                                        <span class="text-slate-600 font-semibold text-sm">{{ member.first_name[0] }}{{ member.last_name[0] }}</span>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-semibold text-slate-900">{{ member.first_name }} {{ member.last_name }}</div>
                                        <div class="text-sm text-slate-500">{{ member.email }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-lg 
                                    {% if member.org_role == 'owner' %}bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-sm
                                    {% elif member.org_role == 'admin' %}bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-sm
                                    {% else %}bg-slate-100 text-slate-700{% endif %}">
                                    {{ member.org_role|capitalize }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                                {% if member.created_at %}
                                {{ member.created_at.strftime('%b %d, %Y') }}
                                {% else %}
                                <span class="text-slate-400">—</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                                {% if member.last_login %}
                                {{ member.last_login.strftime('%b %d, %Y') }}
                                {% else %}
                                <span class="text-slate-400">Never</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-100 text-sm font-medium text-slate-700">
                                    {{ member.contacts|length }}
                                </span>
                            </td>
                            {% if org_has_feature('AI_ACTION_PLAN') %}
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {% if action_plan_status.get(member.id) %}
                                <a href="{{ url_for('auth.view_user_action_plan', user_id=member.id) }}"
                                    class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-sm hover:from-emerald-600 hover:to-emerald-700 transition-all">
                                    <i class="fas fa-check mr-1.5 text-xs"></i>
                                    Completed
                                </a>
                                {% else %}
                                <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-100 text-slate-500">
                                    <i class="fas fa-clock mr-1.5 text-xs"></i>
                                    Not Started
                                </span>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex justify-end items-center space-x-2">
                                    <a href="{{ url_for('auth.edit_user', user_id=member.id) }}"
                                        class="action-link inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-blue-50 text-blue-600 hover:bg-blue-100">
                                        <i class="fas fa-edit mr-1.5"></i>Edit
                                    </a>
                                    {% if member.id != current_user.id and role_hierarchy[current_user.org_role] > role_hierarchy[member.org_role] %}
                                    <button onclick="showRoleModal({{ member.id }}, '{{ member.org_role }}')"
                                        class="action-link inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-100 text-slate-600 hover:bg-slate-200">
                                        <i class="fas fa-user-tag mr-1.5"></i>Role
                                    </button>
                                    <button onclick="showDeleteModal({{ member.id }}, '{{ member.first_name }} {{ member.last_name }}')"
                                        class="action-link inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-red-50 text-red-600 hover:bg-red-100">
                                        <i class="fas fa-trash mr-1.5"></i>Delete
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Member Cards -->
            <div class="md:hidden p-4 space-y-4">
                {% for member in members %}
                <div class="mobile-member-card p-4">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center shadow-sm">
                                <span class="text-slate-600 font-semibold">{{ member.first_name[0] }}{{ member.last_name[0] }}</span>
                            </div>
                            <div class="ml-3">
                                <div class="text-base font-semibold text-slate-900">{{ member.first_name }} {{ member.last_name }}</div>
                                <div class="text-sm text-slate-500">{{ member.email }}</div>
                            </div>
                        </div>
                        <span class="px-2.5 py-1 text-xs font-semibold rounded-lg 
                            {% if member.org_role == 'owner' %}bg-gradient-to-r from-purple-500 to-purple-600 text-white
                            {% elif member.org_role == 'admin' %}bg-gradient-to-r from-blue-500 to-blue-600 text-white
                            {% else %}bg-slate-100 text-slate-700{% endif %}">
                            {{ member.org_role|capitalize }}
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-sm border-t border-slate-100 pt-4">
                        <div class="flex flex-col">
                            <span class="text-slate-400 text-xs uppercase tracking-wide mb-1">Joined</span>
                            <span class="text-slate-700 font-medium">{% if member.created_at %}{{ member.created_at.strftime('%b %d, %Y') }}{% else %}—{% endif %}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-slate-400 text-xs uppercase tracking-wide mb-1">Last Login</span>
                            <span class="text-slate-700 font-medium">{% if member.last_login %}{{ member.last_login.strftime('%b %d') }}{% else %}Never{% endif %}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-slate-400 text-xs uppercase tracking-wide mb-1">Contacts</span>
                            <span class="text-slate-700 font-semibold">{{ member.contacts|length }}</span>
                        </div>
                        {% if org_has_feature('AI_ACTION_PLAN') %}
                        <div class="flex flex-col">
                            <span class="text-slate-400 text-xs uppercase tracking-wide mb-1">Action Plan</span>
                            {% if action_plan_status.get(member.id) %}
                            <span class="text-emerald-600 font-semibold"><i class="fas fa-check mr-1"></i>Done</span>
                            {% else %}
                            <span class="text-slate-400">Not Started</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-end space-x-2 border-t border-slate-100 pt-4 mt-4">
                        <a href="{{ url_for('auth.edit_user', user_id=member.id) }}"
                            class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-blue-50 text-blue-600">
                            <i class="fas fa-edit mr-1.5"></i>Edit
                        </a>
                        {% if member.id != current_user.id and role_hierarchy[current_user.org_role] > role_hierarchy[member.org_role] %}
                        <button onclick="showRoleModal({{ member.id }}, '{{ member.org_role }}')"
                            class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-100 text-slate-600">
                            <i class="fas fa-user-tag mr-1.5"></i>Role
                        </button>
                        <button onclick="showDeleteModal({{ member.id }}, '{{ member.first_name }} {{ member.last_name }}')"
                            class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-red-50 text-red-600">
                            <i class="fas fa-trash mr-1.5"></i>Delete
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% if pending_invites %}
        <!-- Pending Invites -->
        <div class="mt-6 animate-fade-in-up-delay-1">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-amber-50 to-orange-50">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center">
                            <i class="fas fa-paper-plane text-white text-sm"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-800">Pending Invitations</h3>
                    </div>
                </div>
                <div class="divide-y divide-slate-100">
                    {% for invite in pending_invites %}
                    <div class="px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center">
                                <i class="fas fa-envelope text-slate-400"></i>
                            </div>
                            <div>
                                <span class="text-sm font-medium text-slate-900">{{ invite.email }}</span>
                                <span class="ml-2 px-2 py-0.5 text-xs font-medium rounded-md bg-slate-100 text-slate-600">{{ invite.role|capitalize }}</span>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 bg-slate-50 px-3 py-1.5 rounded-lg">
                            <i class="fas fa-clock mr-1"></i>Expires: {{ invite.expires_at.strftime('%b %d, %Y') }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Invite Modal -->
<div id="inviteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300">
    <div class="min-h-screen px-4 flex items-center justify-center">
        <div class="relative bg-white/95 rounded-3xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95" id="inviteModalContent">
            <!-- Close Button -->
            <button onclick="hideInviteModal()" class="absolute -top-3 -right-3 w-10 h-10 bg-white hover:bg-gray-50 text-gray-400 hover:text-gray-600 rounded-full shadow-lg flex items-center justify-center transition-all group z-10">
                <i class="fas fa-times text-lg group-hover:rotate-90 transition-transform duration-300"></i>
            </button>

            <!-- Header -->
            <div class="px-8 pt-8 pb-6 border-b border-gray-100">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center shadow-lg shadow-orange-500/20">
                        <i class="fas fa-user-plus text-white text-2xl"></i>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-slate-900 text-center mb-2">Invite Team Member</h3>
                <p class="text-slate-500 text-center">Send an invite to grow your team.</p>
            </div>

            <!-- Form -->
            <form action="{{ url_for('org.send_invite') }}" method="POST" class="px-8 py-6 space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Email Address</label>
                    <input type="email" name="email" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all text-slate-900 placeholder-slate-400"
                        placeholder="colleague@example.com">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Role</label>
                    <select name="role"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all text-slate-900">
                        <option value="member">Member</option>
                        {% if current_user.org_role == 'owner' %}
                        <option value="admin">Admin</option>
                        {% endif %}
                    </select>
                </div>
                <div class="flex items-center justify-end space-x-3 pt-2">
                    <button type="button" onclick="hideInviteModal()"
                        class="px-4 py-2 border border-slate-200 rounded-xl hover:bg-slate-50 font-medium text-slate-600 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-5 py-2.5 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 font-semibold transition-all duration-200 shadow-lg shadow-orange-500/25 hover:shadow-xl hover:shadow-orange-500/35">
                        Send Invite
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<div id="roleModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <div class="flex items-center space-x-3 mb-5">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-500 to-slate-600 flex items-center justify-center">
                <i class="fas fa-user-tag text-white"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-900">Change Member Role</h3>
        </div>
        <form id="roleForm" method="POST">
            <div class="mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-2">New Role</label>
                <select id="roleSelect" name="role"
                    class="block w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
                    <option value="member">Member</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideRoleModal()"
                    class="px-4 py-2 border border-slate-200 rounded-xl hover:bg-slate-50 font-medium text-slate-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-5 py-2.5 bg-gradient-to-r from-slate-700 to-slate-800 text-white rounded-xl hover:from-slate-800 hover:to-slate-900 font-semibold transition-all shadow-lg">
                    Update Role
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Member Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <div class="flex items-center space-x-3 mb-4">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-white"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-900">Delete Team Member</h3>
        </div>
        <p class="text-sm text-slate-600 mb-5 bg-red-50 rounded-xl p-4 border border-red-100">
            Are you sure you want to delete <strong id="deleteMemberName" class="text-red-700"></strong>? This action cannot be undone.
            All of their contacts and data will be permanently deleted.
        </p>
        <form id="deleteForm" method="POST">
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideDeleteModal()"
                    class="px-4 py-2 border border-slate-200 rounded-xl hover:bg-slate-50 font-medium text-slate-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-5 py-2.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:from-red-600 hover:to-red-700 font-semibold transition-all shadow-lg shadow-red-500/25">
                    Delete Member
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function showInviteModal() {
        const modal = document.getElementById('inviteModal');
        const modalContent = document.getElementById('inviteModalContent');
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        });
        document.body.style.overflow = 'hidden';
    }
    function hideInviteModal() {
        const modal = document.getElementById('inviteModal');
        const modalContent = document.getElementById('inviteModalContent');
        modal.classList.add('opacity-0');
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }, 300);
    }
    function showRoleModal(memberId, currentRole) {
        document.getElementById('roleForm').action = '/org/members/' + memberId + '/update-role';
        document.getElementById('roleSelect').value = currentRole;
        document.getElementById('roleModal').classList.remove('hidden');
    }
    function hideRoleModal() {
        document.getElementById('roleModal').classList.add('hidden');
    }
    function showDeleteModal(memberId, memberName) {
        document.getElementById('deleteForm').action = '/org/members/' + memberId + '/remove';
        document.getElementById('deleteMemberName').textContent = memberName;
        document.getElementById('deleteModal').classList.remove('hidden');
    }
    function hideDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const inviteModal = document.getElementById('inviteModal');
            const roleModal = document.getElementById('roleModal');
            const deleteModal = document.getElementById('deleteModal');
            if (inviteModal && !inviteModal.classList.contains('hidden')) {
                hideInviteModal();
            }
            if (roleModal && !roleModal.classList.contains('hidden')) {
                hideRoleModal();
            }
            if (deleteModal && !deleteModal.classList.contains('hidden')) {
                hideDeleteModal();
            }
        }
    });

    document.getElementById('inviteModal')?.addEventListener('click', function(event) {
        if (event.target === this) {
            hideInviteModal();
        }
    });
    document.getElementById('roleModal')?.addEventListener('click', function(event) {
        if (event.target === this) {
            hideRoleModal();
        }
    });
    document.getElementById('deleteModal')?.addEventListener('click', function(event) {
        if (event.target === this) {
            hideDeleteModal();
        }
    });
</script>
{% endblock %}
