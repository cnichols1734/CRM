{% extends "base.html" %}

{% block content %}
<style>
    /* Premium animations */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse-glow {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.5; }
    }
    .animate-fade-in-up { 
        animation: fadeInUp 0.6s ease-out forwards; 
    }
    .animate-fade-in-up-delay-1 { 
        animation: fadeInUp 0.6s ease-out 0.1s forwards; 
        opacity: 0; 
    }
    .animate-fade-in-up-delay-2 { 
        animation: fadeInUp 0.6s ease-out 0.2s forwards; 
        opacity: 0; 
    }
    .animate-fade-in-up-delay-3 { 
        animation: fadeInUp 0.6s ease-out 0.3s forwards; 
        opacity: 0; 
    }
    
    /* Premium input styling */
    .premium-input {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        background-color: #f8fafc;
        font-size: 1rem;
        transition: all 0.2s ease-out;
    }
    .premium-input:hover {
        border-color: #cbd5e1;
    }
    .premium-input:focus {
        outline: none;
        border-color: #f97316;
        background-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
    }
    .premium-input::placeholder {
        color: #94a3b8;
    }
    
    /* Ensure textareas are full width */
    textarea.premium-input {
        min-height: 80px;
        resize: vertical;
    }
    
    /* Premium card hover effect */
    .premium-card {
        transition: all 0.3s ease;
    }
    .premium-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px -12px rgba(0, 0, 0, 0.15);
    }
    
    /* Premium info box */
    .info-box {
        @apply bg-slate-50/80 rounded-xl p-4 border border-slate-100;
    }
</style>

<!-- Premium gradient background -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-orange-50/30">
    <!-- Premium sticky header -->
    <div class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-10 shadow-sm">
        <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-4 flex items-center justify-between">
                <a href="{{ url_for('main.contacts') }}" class="flex items-center text-slate-600 hover:text-orange-600 transition-colors duration-200 group">
                    <div class="w-8 h-8 rounded-lg bg-white shadow-sm border border-slate-200 flex items-center justify-center mr-2 group-hover:border-orange-300 group-hover:shadow-md transition-all duration-200">
                        <i class="fas fa-arrow-left text-sm"></i>
                    </div>
                    <span class="font-medium">Back</span>
                </a>
                <div class="flex items-center space-x-3">
                    <!-- Previous/Next Navigation -->
                    <a href="{{ url_for('contacts.view_contact', contact_id=prev_contact.id) }}" 
                       class="inline-flex items-center px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-all duration-200 min-w-[140px] justify-center shadow-sm">
                        <i class="fas fa-arrow-left mr-2 text-slate-400"></i>
                        <span class="text-slate-700 truncate">{{ prev_contact.first_name }} {{ prev_contact.last_name }}</span>
                    </a>
                    <a href="{{ url_for('contacts.view_contact', contact_id=next_contact.id) }}" 
                       class="inline-flex items-center px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-all duration-200 min-w-[140px] justify-center shadow-sm">
                        <span class="text-slate-700 truncate">{{ next_contact.first_name }} {{ next_contact.last_name }}</span>
                        <i class="fas fa-arrow-right ml-2 text-slate-400"></i>
                    </a>
                    
                    <!-- Edit/Save/Cancel Buttons -->
                    <button id="editButton" onclick="toggleEditMode()" 
                            class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-xl text-sm font-medium shadow-lg shadow-orange-500/25 hover:from-orange-600 hover:to-amber-600 transition-all duration-200">
                        <i class="fas fa-pencil-alt mr-2"></i>
                        Edit Contact
                    </button>
                    <button id="saveButton" onclick="saveContact()" 
                            class="hidden inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl text-sm font-medium shadow-lg shadow-green-500/25 hover:from-green-600 hover:to-emerald-600 transition-all duration-200">
                        <i class="fas fa-check mr-2"></i>
                        Save Changes
                    </button>
                    <button id="cancelButton" onclick="cancelEdit()" 
                            class="hidden inline-flex items-center px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium text-slate-700 hover:bg-slate-50 transition-all duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Main Content -->
            <div class="flex-1 max-w-4xl">
                <!-- Contact Header Card -->
                <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 p-6 mb-6 premium-card animate-fade-in-up">
                    <div class="flex items-center">
                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-xl font-semibold mr-5 shadow-lg
                            {% set initials = contact.first_name[0]|upper + contact.last_name[0]|upper %}
                            {% set colors = {
                                'A': 'bg-gradient-to-br from-blue-400 to-blue-600 text-white', 
                                'B': 'bg-gradient-to-br from-rose-400 to-rose-600 text-white', 
                                'C': 'bg-gradient-to-br from-green-400 to-green-600 text-white', 
                                'D': 'bg-gradient-to-br from-amber-400 to-amber-600 text-white',
                                'E': 'bg-gradient-to-br from-purple-400 to-purple-600 text-white', 
                                'F': 'bg-gradient-to-br from-pink-400 to-pink-600 text-white',
                                'G': 'bg-gradient-to-br from-indigo-400 to-indigo-600 text-white', 
                                'H': 'bg-gradient-to-br from-teal-400 to-teal-600 text-white',
                                'I': 'bg-gradient-to-br from-orange-400 to-orange-600 text-white', 
                                'J': 'bg-gradient-to-br from-cyan-400 to-cyan-600 text-white',
                                'K': 'bg-gradient-to-br from-lime-400 to-lime-600 text-white',
                                'L': 'bg-gradient-to-br from-emerald-400 to-emerald-600 text-white',
                                'M': 'bg-gradient-to-br from-violet-400 to-violet-600 text-white',
                                'N': 'bg-gradient-to-br from-fuchsia-400 to-fuchsia-600 text-white',
                                'O': 'bg-gradient-to-br from-sky-400 to-sky-600 text-white',
                                'P': 'bg-gradient-to-br from-red-400 to-red-600 text-white',
                                'Q': 'bg-gradient-to-br from-yellow-400 to-yellow-600 text-white',
                                'R': 'bg-gradient-to-br from-slate-400 to-slate-600 text-white',
                                'S': 'bg-gradient-to-br from-stone-400 to-stone-600 text-white',
                                'T': 'bg-gradient-to-br from-zinc-400 to-zinc-600 text-white',
                                'U': 'bg-gradient-to-br from-blue-500 to-indigo-600 text-white',
                                'V': 'bg-gradient-to-br from-rose-500 to-pink-600 text-white',
                                'W': 'bg-gradient-to-br from-emerald-500 to-teal-600 text-white',
                                'X': 'bg-gradient-to-br from-amber-500 to-orange-600 text-white',
                                'Y': 'bg-gradient-to-br from-sky-500 to-cyan-600 text-white',
                                'Z': 'bg-gradient-to-br from-slate-500 to-slate-700 text-white'
                            } %}
                            {{ colors[initials[0]] or 'bg-gradient-to-br from-slate-400 to-slate-600 text-white' }}">
                            {{ contact.first_name[0] }}{{ contact.last_name[0] }}
                        </div>
                        <div class="flex-1">
                            <div id="viewContactName" class="text-2xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent mb-2">
                                {{ contact.first_name }} {{ contact.last_name }}
                            </div>
                            <div id="editContactName" class="hidden space-x-3 mb-3">
                                <input type="text" 
                                       name="first_name" 
                                       value="{{ contact.first_name }}"
                                       class="rounded-xl border-2 border-slate-200 bg-white px-4 py-2 text-xl font-semibold focus:bg-white focus:border-orange-400 focus:ring-2 focus:ring-orange-100 hover:border-slate-300 transition-all duration-200"
                                       placeholder="First Name">
                                <input type="text" 
                                       name="last_name" 
                                       value="{{ contact.last_name }}"
                                       class="rounded-xl border-2 border-slate-200 bg-white px-4 py-2 text-xl font-semibold focus:bg-white focus:border-orange-400 focus:ring-2 focus:ring-orange-100 hover:border-slate-300 transition-all duration-200"
                                       placeholder="Last Name">
                            </div>
                            {% if current_user.role == 'admin' %}
                            <div class="flex items-center text-slate-500 mb-3">
                                <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs mr-2 font-medium">
                                    {{ contact.owner.first_name[0] }}{{ contact.owner.last_name[0] }}
                                </div>
                                <span class="text-sm">
                                    Owned by {{ contact.owner.first_name }} {{ contact.owner.last_name }}
                                </span>
                            </div>
                            {% endif %}
                            <div class="flex flex-wrap gap-2">
                                {% for group in contact.groups %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r from-orange-50 to-amber-50 text-orange-700 border border-orange-200">
                                        {{ group.name }}
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information Card -->
                <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden premium-card animate-fade-in-up-delay-1">
                    <!-- Edit Form (Hidden by default) -->
                    <form action="{{ url_for('contacts.edit_contact', contact_id=contact.id) }}" method="POST" id="editContactForm" class="hidden">
                        <div class="divide-y divide-slate-100">
                            <!-- Basic Information Section -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                        <i class="fas fa-user text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Basic Information</h2>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                        <input type="email" name="email" value="{{ contact.email }}" 
                                               class="premium-input">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Phone</label>
                                        <input type="tel" name="phone" value="{{ contact.phone }}"
                                               class="premium-input">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Potential Commission ($)</label>
                                        <input type="number" 
                                               name="potential_commission" 
                                               value="{{ contact.potential_commission }}"
                                               step="0.01"
                                               min="0"
                                               class="premium-input">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Created</label>
                                        <p class="px-4 py-3 text-slate-600 bg-slate-50 rounded-xl">{{ contact.created_at.strftime('%B %d, %Y') }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Dates Section -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                                        <i class="fas fa-calendar-alt text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Last Contact Dates</h2>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <!-- Last Email Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Last Email</label>
                                        <input type="date" 
                                               name="last_email_date" 
                                               value="{{ contact.last_email_date.strftime('%Y-%m-%d') if contact.last_email_date }}"
                                               class="premium-input">
                                    </div>

                                    <!-- Last Text Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Last Text</label>
                                        <input type="date" 
                                               name="last_text_date" 
                                               value="{{ contact.last_text_date.strftime('%Y-%m-%d') if contact.last_text_date }}"
                                               class="premium-input">
                                    </div>

                                    <!-- Last Phone Call Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Last Phone Call</label>
                                        <input type="date" 
                                               name="last_phone_call_date" 
                                               value="{{ contact.last_phone_call_date.strftime('%Y-%m-%d') if contact.last_phone_call_date }}"
                                               class="premium-input">
                                    </div>

                                    <!-- Last Contact Date (Read-only) -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Last Contact</label>
                                        <p class="px-4 py-3 text-slate-600 bg-slate-50 rounded-xl">
                                            {{ contact.last_contact_date.strftime('%B %d, %Y') if contact.last_contact_date else 'Never' }}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Section -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                        <i class="fas fa-map-marker-alt text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Address</h2>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Street Address</label>
                                        <input type="text" name="street_address" value="{{ contact.street_address }}"
                                               class="premium-input">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">City</label>
                                        <input type="text" name="city" value="{{ contact.city }}"
                                               class="premium-input">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">State</label>
                                        <input type="text" name="state" value="{{ contact.state }}"
                                               class="premium-input">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">ZIP Code</label>
                                        <input type="text" name="zip_code" value="{{ contact.zip_code }}"
                                               class="premium-input">
                                    </div>
                                </div>
                            </div>

                            <!-- Groups Section -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center">
                                        <i class="fas fa-users text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Groups</h2>
                                </div>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                    {% for group in all_groups %}
                                        <label class="relative flex items-center px-4 py-3 rounded-xl text-sm
                                                    {% if group in contact.groups %}
                                                        bg-orange-50 border-2 border-orange-400 text-orange-700
                                                    {% else %}
                                                        bg-white border-2 border-slate-200 text-slate-700
                                                    {% endif %}
                                                    hover:bg-orange-50 hover:border-orange-300
                                                    cursor-pointer transition-all duration-200">
                                            <input type="checkbox" 
                                                   name="group_ids" 
                                                   value="{{ group.id }}"
                                                   {% if group in contact.groups %}checked{% endif %}
                                                   class="form-checkbox h-4 w-4 mr-3 rounded border-slate-300 text-orange-500 focus:ring-orange-400">
                                            <span class="font-medium">{{ group.name }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Client Details Section in Edit Form -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center">
                                        <i class="fas fa-clipboard-list text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Client Details</h2>
                                </div>
                                <div class="space-y-6">
                                <!-- Current Objective -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">What does this person want right now?</label>
                                    <textarea name="current_objective" rows="3" 
                                                  class="premium-input resize-y">{{ contact.current_objective or '' }}</textarea>
                                        <p class="mt-2 text-sm text-slate-500">Ex: They want to buy a home, sell a home, they're looking for acreage, They are not looking to make a move right now, but I want to stay in touch with them.</p>
                                </div>

                                <!-- Move Timeline -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">What is their timeline?</label>
                                    <textarea name="move_timeline" rows="2" 
                                                  class="premium-input resize-y">{{ contact.move_timeline or '' }}</textarea>
                                        <p class="mt-2 text-sm text-slate-500">Ex: They want to move now, within the next 6 months, or within a year?</p>
                                </div>

                                <!-- Motivation -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Why do they want to move?</label>
                                    <textarea name="motivation" rows="2" 
                                                  class="premium-input resize-y">{{ contact.motivation or '' }}</textarea>
                                        <p class="mt-2 text-sm text-slate-500">Ex: They are having a baby, want a larger home, moving for work, etc.</p>
                                </div>

                                <!-- Financial Status -->
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Have they shared any financial details with you?</label>
                                    <textarea name="financial_status" rows="3" 
                                                  class="premium-input resize-y">{{ contact.financial_status or '' }}</textarea>
                                        <p class="mt-2 text-sm text-slate-500">Ex: Their budget is $x, they have or have not been preapproved, they have $x for down payment, they have $x in home equity.</p>
                                </div>

                                <!-- Additional Notes -->
                                <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Any other details to share?</label>
                                    <textarea name="additional_notes" rows="2" 
                                                  class="premium-input resize-y">{{ contact.additional_notes or '' }}</textarea>
                                        <p class="mt-2 text-sm text-slate-500">Ex: No details at this time</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes Section in Edit Form -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-slate-500 to-slate-700 flex items-center justify-center">
                                        <i class="fas fa-sticky-note text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Notes</h2>
                                </div>
                                <textarea name="notes" rows="4" 
                                          class="premium-input resize-y">{{ contact.notes }}</textarea>
                            </div>
                        </div>
                    </form>

                    <!-- View Mode (Default) -->
                    <div id="viewContactInfo">
                        <div class="divide-y divide-slate-100">
                            <!-- Basic Information Section -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                        <i class="fas fa-user text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Basic Information</h2>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Email</h3>
                                        <p class="text-slate-900 font-medium">{{ contact.email or 'No email provided' }}</p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Phone</h3>
                                        <p class="text-slate-900 font-medium">{{ contact.phone or 'No phone provided' }}</p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Potential Commission</h3>
                                        <p class="text-slate-900 font-semibold text-lg">
                                            {% if contact.potential_commission is not none %}
                                                ${{ "{:,.2f}".format(contact.potential_commission|float) }}
                                            {% else %}
                                                $0.00
                                            {% endif %}
                                        </p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Created</h3>
                                        <p class="text-slate-900 font-medium">{{ contact.created_at.strftime('%B %d, %Y') }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Dates Section -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                                        <i class="fas fa-calendar-alt text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Last Contact Dates</h2>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Last Email</h3>
                                        <p class="text-slate-900 font-medium">
                                            {{ contact.last_email_date.strftime('%m/%d/%Y') if contact.last_email_date else 'Never' }}
                                        </p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Last Text</h3>
                                        <p class="text-slate-900 font-medium">
                                            {{ contact.last_text_date.strftime('%m/%d/%Y') if contact.last_text_date else 'Never' }}
                                        </p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Last Phone Call</h3>
                                        <p class="text-slate-900 font-medium">
                                            {{ contact.last_phone_call_date.strftime('%m/%d/%Y') if contact.last_phone_call_date else 'Never' }}
                                        </p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Last Contact</h3>
                                        <p class="text-slate-900 font-medium">
                                            {{ contact.last_contact_date.strftime('%m/%d/%Y') if contact.last_contact_date else 'Never' }}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Section -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                        <i class="fas fa-map-marker-alt text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Address</h2>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2 info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">Street Address</h3>
                                        <p class="text-slate-900 font-medium">{{ contact.street_address or 'No street address provided' }}</p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">City</h3>
                                        <p class="text-slate-900 font-medium">{{ contact.city or 'No city provided' }}</p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">State</h3>
                                        <p class="text-slate-900 font-medium">{{ contact.state or 'No state provided' }}</p>
                                    </div>

                                    <div class="info-box">
                                        <h3 class="text-sm font-medium text-slate-500 mb-1">ZIP Code</h3>
                                        <p class="text-slate-900 font-medium">{{ contact.zip_code or 'No ZIP code provided' }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Groups Section -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center">
                                        <i class="fas fa-users text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Groups</h2>
                                </div>
                                <div class="info-box">
                                    <div class="flex flex-wrap gap-2">
                                        {% for group in contact.groups %}
                                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-gradient-to-r from-orange-50 to-amber-50 text-orange-700 border border-orange-200">
                                                {{ group.name }}
                                            </span>
                                        {% else %}
                                            <span class="text-slate-500 italic">No groups assigned</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Client Details Section in View Mode -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center">
                                        <i class="fas fa-clipboard-list text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Client Details</h2>
                                </div>
                                <div class="space-y-4">
                                <!-- Current Objective -->
                                    <div>
                                        <h3 class="text-sm font-medium text-slate-500 mb-2">What does this person want right now?</h3>
                                        <div class="info-box">
                                            <p class="text-slate-900 whitespace-pre-line">{{ contact.current_objective or 'No current objective specified' }}</p>
                                    </div>
                                </div>

                                <!-- Move Timeline -->
                                    <div>
                                        <h3 class="text-sm font-medium text-slate-500 mb-2">What is their timeline?</h3>
                                        <div class="info-box">
                                            <p class="text-slate-900 whitespace-pre-line">{{ contact.move_timeline or 'No timeline specified' }}</p>
                                    </div>
                                </div>

                                <!-- Motivation -->
                                    <div>
                                        <h3 class="text-sm font-medium text-slate-500 mb-2">Why do they want to move?</h3>
                                        <div class="info-box">
                                            <p class="text-slate-900 whitespace-pre-line">{{ contact.motivation or 'No motivation specified' }}</p>
                                    </div>
                                </div>

                                <!-- Financial Status -->
                                    <div>
                                        <h3 class="text-sm font-medium text-slate-500 mb-2">Have they shared any financial details with you?</h3>
                                        <div class="info-box">
                                            <p class="text-slate-900 whitespace-pre-line">{{ contact.financial_status or 'No financial details shared' }}</p>
                                    </div>
                                </div>

                                <!-- Additional Notes -->
                                <div>
                                        <h3 class="text-sm font-medium text-slate-500 mb-2">Any other details to share?</h3>
                                        <div class="info-box">
                                            <p class="text-slate-900 whitespace-pre-line">{{ contact.additional_notes or 'No additional details shared' }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes Section in View Mode -->
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-slate-500 to-slate-700 flex items-center justify-center">
                                        <i class="fas fa-sticky-note text-white text-sm"></i>
                                    </div>
                                    <h2 class="text-lg font-semibold text-slate-800">Notes</h2>
                                </div>
                                <div class="info-box">
                                    <p class="text-slate-900 whitespace-pre-line">{{ contact.notes or 'No notes added' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Contact Button -->
                <div class="mt-6 flex justify-end animate-fade-in-up-delay-2">
                    <form action="{{ url_for('contacts.delete_contact', contact_id=contact.id) }}" method="POST" id="deleteContactForm">
                        <button onclick="deleteContact()" 
                                class="inline-flex items-center px-4 py-2 bg-white border-2 border-red-200 rounded-xl text-sm font-medium text-red-600 hover:bg-red-50 hover:border-red-300 transition-all duration-200">
                            <i class="fas fa-trash-alt mr-2"></i>
                            Delete Contact
                        </button>
                    </form>
                </div>
            </div>

            <!-- Side Container - Related Tasks & Transactions -->
            <div class="lg:w-[420px] xl:w-[480px] flex-shrink-0 space-y-6 animate-fade-in-up-delay-3">
                {% if show_transactions %}
                <!-- Related Transactions Card -->
                <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden premium-card">
                    <div class="p-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center">
                                    <i class="fas fa-file-contract text-white text-sm"></i>
                                </div>
                                <h2 class="text-lg font-semibold text-slate-800">Related Transactions</h2>
                            </div>
                            <a href="{{ url_for('transactions.new_transaction', contact_id=contact.id) }}" 
                               class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-lg text-xs font-medium shadow-sm hover:from-orange-600 hover:to-amber-600 transition-all duration-200">
                                <i class="fas fa-plus mr-1.5"></i>
                                New Transaction
                            </a>
                        </div>
                    </div>

                    <div class="divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        {% for tx in related_transactions %}
                        <a href="{{ url_for('transactions.view_transaction', id=tx.id, ref='contact', contact_id=contact.id) }}" 
                           class="block p-4 hover:bg-slate-50 transition-colors duration-150 group">
                            <div class="flex items-start space-x-3">
                                <!-- Type Indicator -->
                                <div class="flex-shrink-0">
                                    <div class="w-9 h-9 rounded-lg flex items-center justify-center shadow-sm
                                        {% if tx.transaction_type.name == 'seller' %}bg-gradient-to-br from-orange-400 to-orange-500
                                        {% elif tx.transaction_type.name == 'buyer' %}bg-gradient-to-br from-purple-400 to-purple-500
                                        {% elif tx.transaction_type.name == 'landlord' %}bg-gradient-to-br from-cyan-400 to-cyan-500
                                        {% elif tx.transaction_type.name == 'tenant' %}bg-gradient-to-br from-green-400 to-green-500
                                        {% else %}bg-gradient-to-br from-indigo-400 to-indigo-500{% endif %} text-white">
                                        {% if tx.transaction_type.name == 'seller' %}
                                        <i class="fas fa-home text-xs"></i>
                                        {% elif tx.transaction_type.name == 'buyer' %}
                                        <i class="fas fa-key text-xs"></i>
                                        {% elif tx.transaction_type.name == 'landlord' %}
                                        <i class="fas fa-building text-xs"></i>
                                        {% elif tx.transaction_type.name == 'tenant' %}
                                        <i class="fas fa-file-signature text-xs"></i>
                                        {% else %}
                                        <i class="fas fa-handshake text-xs"></i>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Transaction Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-medium text-slate-800 group-hover:text-orange-600 truncate transition-colors duration-150">
                                            {{ tx.street_address }}
                                        </span>
                                    </div>
                                    <div class="mt-1 flex items-center flex-wrap gap-2 text-xs">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                            {% if tx.transaction_type.name == 'seller' %}bg-orange-100 text-orange-700
                                            {% elif tx.transaction_type.name == 'buyer' %}bg-purple-100 text-purple-700
                                            {% elif tx.transaction_type.name == 'landlord' %}bg-cyan-100 text-cyan-700
                                            {% elif tx.transaction_type.name == 'tenant' %}bg-green-100 text-green-700
                                            {% else %}bg-indigo-100 text-indigo-700{% endif %}">
                                            {{ tx.transaction_type.display_name }}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                            {% if tx.status == 'draft' %}bg-slate-100 text-slate-600
                                            {% elif tx.status == 'active' %}bg-green-100 text-green-700
                                            {% elif tx.status == 'pending' %}bg-amber-100 text-amber-700
                                            {% elif tx.status == 'under_contract' %}bg-blue-100 text-blue-700
                                            {% elif tx.status == 'closed' %}bg-indigo-100 text-indigo-700
                                            {% else %}bg-red-100 text-red-700{% endif %}">
                                            {{ tx.status|replace('_', ' ')|title }}
                                        </span>
                                    </div>
                                    <div class="mt-1 text-xs text-slate-500">
                                        {{ tx.created_at.strftime('%b %d, %Y') }}
                                    </div>
                                </div>

                                <!-- Arrow -->
                                <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-150">
                                    <i class="fas fa-chevron-right text-slate-400 text-sm"></i>
                                </div>
                            </div>
                        </a>
                        {% else %}
                        <div class="p-8 text-center">
                            <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-file-contract text-slate-400 text-xl"></i>
                            </div>
                            <p class="text-slate-500 text-sm">No transactions</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Related Files Card -->
                <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden premium-card">
                    <div class="p-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                                    <i class="fas fa-folder-open text-white text-sm"></i>
                                </div>
                                <h2 class="text-lg font-semibold text-slate-800">Related Files</h2>
                            </div>
                            <button onclick="document.getElementById('fileUploadInput').click()" 
                                    class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg text-xs font-medium shadow-sm hover:from-emerald-600 hover:to-teal-600 transition-all duration-200">
                                <i class="fas fa-upload mr-1.5"></i>
                                Upload File
                            </button>
                            <input type="file" id="fileUploadInput" class="hidden" 
                                   accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.csv,.xlsx,.xls"
                                   onchange="uploadContactFile(this)">
                        </div>
                    </div>

                    <!-- Drop Zone (hidden by default, shown on drag) -->
                    <div id="fileDropZone" class="hidden p-8 border-2 border-dashed border-emerald-300 bg-emerald-50 m-4 rounded-xl text-center transition-all duration-200">
                        <i class="fas fa-cloud-upload-alt text-4xl text-emerald-400 mb-3"></i>
                        <p class="text-emerald-600 font-medium">Drop files here to upload</p>
                        <p class="text-emerald-500 text-sm mt-1">Max 10 MB per file</p>
                    </div>

                    <!-- File List -->
                    <div id="contactFilesList" class="divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        {% for file in contact_files %}
                        <div class="p-4 hover:bg-slate-50 transition-colors duration-150 group file-item" data-file-id="{{ file.id }}">
                            <div class="flex items-center space-x-3">
                                <!-- File Icon -->
                                <div class="flex-shrink-0">
                                    {% if file.is_image %}
                                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center shadow-sm">
                                        <i class="fas fa-file-image text-white"></i>
                                    </div>
                                    {% elif file.file_extension == 'pdf' %}
                                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-400 to-red-500 flex items-center justify-center shadow-sm">
                                        <i class="fas fa-file-pdf text-white"></i>
                                    </div>
                                    {% elif file.file_extension in ['doc', 'docx'] %}
                                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-400 to-blue-500 flex items-center justify-center shadow-sm">
                                        <i class="fas fa-file-word text-white"></i>
                                    </div>
                                    {% elif file.file_extension in ['xls', 'xlsx', 'csv'] %}
                                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-400 to-green-500 flex items-center justify-center shadow-sm">
                                        <i class="fas fa-file-excel text-white"></i>
                                    </div>
                                    {% else %}
                                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-400 to-slate-500 flex items-center justify-center shadow-sm">
                                        <i class="fas fa-file text-white"></i>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- File Info -->
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-800 truncate">{{ file.original_filename }}</p>
                                    <div class="flex items-center gap-2 mt-1 text-xs text-slate-500">
                                        <span>{{ file.human_file_size }}</span>
                                        <span></span>
                                        <span>{{ file.created_at.strftime('%b %d, %Y') }}</span>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-150">
                                    <button onclick="downloadContactFile({{ file.id }})" 
                                            class="p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors"
                                            title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button onclick="deleteContactFile({{ file.id }}, '{{ file.original_filename }}')" 
                                            class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                            title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div id="noFilesMessage" class="p-8 text-center">
                            <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-folder-open text-slate-400 text-xl"></i>
                            </div>
                            <p class="text-slate-500 text-sm">No files uploaded</p>
                            <p class="text-slate-400 text-xs mt-1">Click upload or drag files here</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Upload Progress (hidden by default) -->
                    <div id="uploadProgress" class="hidden p-4 border-t border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin rounded-full h-5 w-5 border-2 border-emerald-500 border-t-transparent"></div>
                            <span class="text-sm text-slate-600">Uploading...</span>
                        </div>
                    </div>
                </div>

                <!-- Related Tasks Card -->
                <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden premium-card">
                    <div class="p-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                    <i class="fas fa-tasks text-white text-sm"></i>
                                </div>
                                <h2 class="text-lg font-semibold text-slate-800">Related Tasks</h2>
                            </div>
                            <a href="{{ url_for('tasks.create_task', contact_id=contact.id, return_to='contact') }}" 
                               class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-lg text-xs font-medium shadow-sm hover:from-orange-600 hover:to-amber-600 transition-all duration-200">
                                <i class="fas fa-plus mr-1.5"></i>
                                New Task
                            </a>
                        </div>
                    </div>

                    <!-- Task Filter Tabs -->
                    <div class="border-b border-slate-100 px-2">
                        <div class="flex">
                            <button onclick="switchTaskView('pending')" 
                                    id="pendingTasksTab"
                                    class="flex-1 py-3 px-4 text-sm font-medium text-orange-600 border-b-2 border-orange-500 transition-all duration-200">
                                Active Tasks
                            </button>
                            <button onclick="switchTaskView('completed')" 
                                    id="completedTasksTab"
                                    class="flex-1 py-3 px-4 text-sm font-medium text-slate-500 hover:text-slate-700 border-b-2 border-transparent transition-all duration-200">
                                Completed
                            </button>
                        </div>
                    </div>

                    <!-- Task Lists -->
                    <div id="pendingTasks" class="divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        {% for task in contact.tasks|selectattr('status', 'equalto', 'pending')|sort(attribute='due_date') %}
                        <div class="p-4 hover:bg-slate-50 transition-colors duration-150">
                            <div class="flex items-start space-x-3">
                                <!-- Priority Indicator -->
                                <div class="flex-shrink-0">
                                    <div class="w-7 h-7 rounded-lg flex items-center justify-center shadow-sm {% if task.priority == 'high' %}bg-gradient-to-br from-red-400 to-red-500 text-white{% elif task.priority == 'medium' %}bg-gradient-to-br from-yellow-400 to-amber-500 text-white{% else %}bg-gradient-to-br from-green-400 to-emerald-500 text-white{% endif %}">
                                        <i class="fas fa-flag text-xs"></i>
                                    </div>
                                </div>

                                <!-- Task Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2">
                                        <a href="#" 
                                           data-task-id="{{ task.id }}"
                                           class="task-link text-sm font-medium text-slate-800 hover:text-orange-600 truncate transition-colors duration-150">
                                            {{ task.subject }}
                                        </a>
                                    </div>
                                    <div class="mt-1 flex items-center space-x-2 text-xs text-slate-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
                                            {{ task.task_type.name }}
                                        </span>
                                        {% set task_date = task.due_date.date() %}
                                        {% set current_date = now.date() %}
                                        {% set days_until_due = (task_date - current_date).days %}
                                        <span class="font-medium {% if days_until_due < 0 %}text-red-500{% elif days_until_due == 0 %}text-orange-500{% elif days_until_due <= 2 %}text-yellow-600{% endif %}">
                                            {% if days_until_due < 0 %}
                                                {{ days_until_due|abs }}d overdue
                                            {% elif days_until_due == 0 %}
                                                Due today
                                            {% elif days_until_due == 1 %}
                                                Due tomorrow
                                            {% else %}
                                                Due in {{ days_until_due }}d
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="flex-shrink-0">
                                    <button onclick="quickUpdateStatus({{ task.id }}, true)" 
                                            class="w-7 h-7 rounded-lg text-slate-400 hover:text-green-500 hover:bg-green-50 flex items-center justify-center transition-all duration-150">
                                        <i class="fas fa-check text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="p-8 text-center">
                            <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-check-circle text-slate-400 text-xl"></i>
                            </div>
                            <p class="text-slate-500 text-sm">No active tasks</p>
                        </div>
                        {% endfor %}
                    </div>

                    <div id="completedTasks" class="hidden divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        {% for task in contact.tasks|selectattr('status', 'equalto', 'completed')|sort(attribute='completed_at', reverse=true) %}
                        <div class="p-4 hover:bg-slate-50 transition-colors duration-150">
                            <div class="flex items-start space-x-3">
                                <!-- Completed Indicator -->
                                <div class="flex-shrink-0">
                                    <div class="w-7 h-7 rounded-full flex items-center justify-center bg-gradient-to-br from-green-400 to-emerald-500 text-white shadow-sm">
                                        <i class="fas fa-check text-xs"></i>
                                    </div>
                                </div>

                                <!-- Task Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2">
                                        <a href="#" 
                                           data-task-id="{{ task.id }}"
                                           class="task-link text-sm font-medium text-slate-600 hover:text-slate-800 truncate transition-colors duration-150">
                                            {{ task.subject }}
                                        </a>
                                    </div>
                                    <div class="mt-1 flex items-center space-x-2 text-xs text-slate-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                                            {{ task.task_type.name }}
                                        </span>
                                        <span>
                                            {% if task.completed_at %}
                                                Completed {{ task.completed_at.strftime('%m/%d/%y') }}
                                            {% else %}
                                                Completed recently
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="flex-shrink-0">
                                    <button onclick="quickUpdateStatus({{ task.id }}, false)" 
                                            class="w-7 h-7 rounded-lg text-slate-400 hover:text-yellow-500 hover:bg-yellow-50 flex items-center justify-center transition-all duration-150">
                                        <i class="fas fa-undo text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="p-8 text-center">
                            <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-clipboard-list text-slate-400 text-xl"></i>
                            </div>
                            <p class="text-slate-500 text-sm">No completed tasks</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div id="taskModal" 
     data-is-admin="{{ 'true' if current_user.role == 'admin' else 'false' }}"
     data-show-all="{{ 'true' if show_all else 'false' }}"
     class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-0 md:p-4">
        <div class="relative bg-white w-full md:rounded-2xl shadow-2xl md:max-w-4xl min-h-screen md:min-h-0">
            <!-- Modal header -->
            <div class="sticky top-0 z-10 flex items-center justify-between px-4 py-4 md:px-6 md:py-5 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white md:rounded-t-2xl">
                <div class="flex items-center space-x-4">
                    <div id="modalTaskPriorityIndicator" class="w-12 h-12 rounded-xl flex items-center justify-center text-lg shadow-sm">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900" id="modalTaskSubject"></h3>
                        {% if current_user.role == 'admin' and show_all %}
                        <div class="flex items-center text-slate-500 text-sm mt-0.5 mb-1">
                            <div id="modalTaskOwnerInitials" class="w-5 h-5 rounded-full bg-slate-100 flex items-center justify-center text-xs mr-2 font-medium"></div>
                            <span id="modalTaskOwner"></span>
                        </div>
                        {% endif %}
                        <p class="text-sm text-slate-500" id="modalTaskHeaderDueDate"></p>
                    </div>
                </div>
                <button onclick="closeTaskModal()" class="w-10 h-10 rounded-xl hover:bg-slate-100 flex items-center justify-center transition-colors duration-150">
                    <i class="fas fa-times text-slate-400"></i>
                </button>
            </div>
            
            <!-- Modal content -->
            <div class="px-4 py-4 md:px-6 space-y-4" id="modalTaskContent">
                <!-- Status and Priority -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-slate-50 rounded-xl p-4 flex-1 border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border border-slate-200 shadow-sm">
                                <i class="fas fa-tasks text-slate-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Status</p>
                                <p id="modalTaskStatus" class="text-sm font-semibold text-slate-900"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-xl p-4 flex-1 border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border border-slate-200 shadow-sm">
                                <i class="fas fa-flag text-slate-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Priority</p>
                                <p id="modalTaskPriority" class="text-sm font-semibold text-slate-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Due Date and Scheduled Time -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-slate-50 rounded-xl p-4 flex-1 border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border border-slate-200 shadow-sm">
                                <i class="fas fa-calendar text-slate-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Due Date</p>
                                <p id="modalTaskDueDate" class="text-sm font-semibold text-slate-900"></p>
                            </div>
                        </div>
                    </div>
                    <div id="modalTaskScheduledContainer" class="hidden bg-slate-50 rounded-xl p-4 flex-1 border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border border-slate-200 shadow-sm">
                                <i class="fas fa-clock text-slate-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Scheduled Time</p>
                                <p id="modalTaskScheduledTime" class="text-sm font-semibold text-slate-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Type and Subtype -->
                <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border border-slate-200 shadow-sm">
                            <i class="fas fa-tag text-slate-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Task Type</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span id="modalTaskType" class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-slate-200 text-slate-800"></span>
                                <span id="modalTaskSubtype" class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-slate-100 text-slate-600"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact -->
                <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border border-slate-200 shadow-sm">
                            <i class="fas fa-user text-slate-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Contact</p>
                            <a id="modalTaskContact" href="#" class="text-sm font-semibold text-orange-600 hover:text-orange-700 transition-colors duration-150"></a>
                        </div>
                    </div>
                </div>

                <!-- Property Address -->
                <div id="modalTaskPropertyContainer" class="hidden bg-slate-50 rounded-xl p-4 border border-slate-100">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border border-slate-200 shadow-sm">
                            <i class="fas fa-building text-slate-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Property Address</p>
                            <p id="modalTaskProperty" class="text-sm font-semibold text-slate-900"></p>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border border-slate-200 shadow-sm">
                            <i class="fas fa-align-left text-slate-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-slate-500">Description</p>
                            <p id="modalTaskDescription" class="mt-1 text-sm text-slate-900 whitespace-pre-line"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal footer -->
            <div class="sticky bottom-0 border-t border-slate-200 bg-gradient-to-r from-slate-50 to-white p-4 md:rounded-b-2xl">
                <div class="flex flex-col md:flex-row md:justify-between gap-3">
                    <div class="flex flex-col md:flex-row gap-2 md:items-center md:space-x-4">
                        <button onclick="toggleTaskStatus()" 
                                class="flex-1 md:flex-none text-center px-5 py-2.5 border-2 border-slate-200 rounded-xl bg-white hover:bg-slate-50 transition-all duration-150 text-sm font-medium">
                            <span id="modalTaskStatusButton"></span>
                        </button>
                    </div>
                    <a id="modalTaskFullView" href="#" 
                       class="flex-1 md:flex-none text-center px-5 py-2.5 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-xl hover:from-orange-600 hover:to-amber-600 transition-all duration-150 text-sm font-semibold shadow-lg shadow-orange-500/25">
                        Open Full View
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Get configuration from data attributes
const modalConfig = {
    modal: document.getElementById('taskModal'),
    init() {
        this.isAdmin = this.modal.dataset.isAdmin === 'true';
        this.showAll = this.modal.dataset.showAll === 'true';
        this.setupEventListeners();
    },
    setupEventListeners() {
        // Task links
        document.querySelectorAll('.task-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const taskId = link.dataset.taskId;
                openTaskModal(taskId);
            });
        });

        // Close modal when clicking outside
        this.modal.addEventListener('mousedown', (event) => {
            if (event.target === this.modal) {
                closeTaskModal();
            }
        });

        // Close on escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeTaskModal();
            }
        });
    }
};

// Initialize modal configuration
document.addEventListener('DOMContentLoaded', () => modalConfig.init());

function toggleEditMode() {
    const viewMode = document.getElementById('viewContactInfo');
    const editMode = document.getElementById('editContactForm');
    const viewName = document.getElementById('viewContactName');
    const editName = document.getElementById('editContactName');
    const editBtn = document.getElementById('editButton');
    const saveBtn = document.getElementById('saveButton');
    const cancelBtn = document.getElementById('cancelButton');

    viewMode.classList.add('hidden');
    editMode.classList.remove('hidden');
    viewName.classList.add('hidden');
    editName.classList.remove('hidden');
    editBtn.classList.add('hidden');
    saveBtn.classList.remove('hidden');
    cancelBtn.classList.remove('hidden');
}

function cancelEdit() {
    const viewMode = document.getElementById('viewContactInfo');
    const editMode = document.getElementById('editContactForm');
    const viewName = document.getElementById('viewContactName');
    const editName = document.getElementById('editContactName');
    const editBtn = document.getElementById('editButton');
    const saveBtn = document.getElementById('saveButton');
    const cancelBtn = document.getElementById('cancelButton');

    viewMode.classList.remove('hidden');
    editMode.classList.add('hidden');
    viewName.classList.remove('hidden');
    editName.classList.add('hidden');
    editBtn.classList.remove('hidden');
    saveBtn.classList.add('hidden');
    cancelBtn.classList.add('hidden');
}

async function saveContact() {
    const form = document.getElementById('editContactForm');
    const formData = new FormData();
    
    // Explicitly add the name fields from the edit name section
    const firstNameInput = document.querySelector('input[name="first_name"]');
    const lastNameInput = document.querySelector('input[name="last_name"]');
    formData.append('first_name', firstNameInput.value);
    formData.append('last_name', lastNameInput.value);
    
    // Add all other form fields
    const formInputs = form.querySelectorAll('input, textarea, select');
    formInputs.forEach(input => {
        if (input.type === 'checkbox') {
            if (input.checked) {
                formData.append(input.name, input.value);
            }
        } else {
            formData.append(input.name, input.value);
        }
    });

    try {
        const response = await fetch(`/contacts/{{ contact.id }}/edit`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert(data.message || 'Error saving changes');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving changes. Check the console for details.');
    }
}

// Phone number formatting
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editContactForm');
    const phoneInput = editForm.querySelector('input[name="phone"]');

    phoneInput.addEventListener('input', function(e) {
        // Remove all non-digit characters
        let inputVal = e.target.value.replace(/\D/g, '');

        // Limit to 10 digits
        if (inputVal.length > 10) {
            inputVal = inputVal.slice(0, 10);
        }

        // Build the formatted output (XXX) XXX-XXXX
        let formattedNumber = '';

        // (XXX
        if (inputVal.length > 0) {
            formattedNumber += '(' + inputVal.substring(0, 3);
        }
        // (XXX) XXX
        if (inputVal.length >= 4) {
            formattedNumber += ') ' + inputVal.substring(3, 6);
        }
        // (XXX) XXX-XXXX
        if (inputVal.length >= 7) {
            formattedNumber += '-' + inputVal.substring(6, 10);
        }

        e.target.value = formattedNumber;
    });
});

async function deleteContact() {
    if (!confirm('Are you sure you want to delete this contact? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/contacts/{{ contact.id }}/delete`, {
            method: 'POST'
        });

        if (response.ok) {
            window.location.href = "{{ url_for('main.contacts') }}";
        } else {
            const data = await response.json();
            alert(data.message || 'Error deleting contact');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting contact');
    }
}

function switchTaskView(view) {
    const pendingTab = document.getElementById('pendingTasksTab');
    const completedTab = document.getElementById('completedTasksTab');
    const pendingList = document.getElementById('pendingTasks');
    const completedList = document.getElementById('completedTasks');

    if (view === 'pending') {
        pendingTab.classList.add('text-orange-600', 'border-b-2', 'border-orange-500');
        pendingTab.classList.remove('text-slate-500');
        completedTab.classList.remove('text-orange-600', 'border-b-2', 'border-orange-500');
        completedTab.classList.add('text-slate-500');
        pendingList.classList.remove('hidden');
        completedList.classList.add('hidden');
    } else {
        completedTab.classList.add('text-orange-600', 'border-b-2', 'border-orange-500');
        completedTab.classList.remove('text-slate-500');
        pendingTab.classList.remove('text-orange-600', 'border-b-2', 'border-orange-500');
        pendingTab.classList.add('text-slate-500');
        completedList.classList.remove('hidden');
        pendingList.classList.add('hidden');
    }
}

function quickUpdateStatus(taskId, completed) {
    fetch(`/tasks/${taskId}/quick-update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${completed ? 'completed' : 'pending'}`
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task status');
    });
}

let currentTaskId = null;

function openTaskModal(taskId) {
    currentTaskId = taskId;
    
    // Fetch task details
    fetch(`/tasks/${taskId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(task => {
            // Update modal content
            document.getElementById('modalTaskSubject').textContent = task.subject;
            document.getElementById('modalTaskFullView').href = `/tasks/${task.id}?ref=contact&contact_id={{ contact.id }}`;
            
            // Owner Info (for admin view)
            if (modalConfig.isAdmin && modalConfig.showAll) {
                const ownerInitials = document.getElementById('modalTaskOwnerInitials');
                ownerInitials.textContent = `${task.assigned_to.first_name[0]}${task.assigned_to.last_name[0]}`;
                document.getElementById('modalTaskOwner').textContent = `${task.assigned_to.first_name} ${task.assigned_to.last_name}`;
            }
            
            // Priority Indicator
            const priorityIndicator = document.getElementById('modalTaskPriorityIndicator');
            priorityIndicator.className = `w-12 h-12 rounded-xl flex items-center justify-center text-lg shadow-sm ${
                task.priority === 'high' ? 'bg-gradient-to-br from-red-400 to-red-500 text-white' :
                task.priority === 'medium' ? 'bg-gradient-to-br from-yellow-400 to-amber-500 text-white' :
                'bg-gradient-to-br from-green-400 to-emerald-500 text-white'
            }`;
            
            // Priority
            const priorityText = document.getElementById('modalTaskPriority');
            priorityText.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            
            // Status
            const statusText = document.getElementById('modalTaskStatus');
            statusText.textContent = task.status.charAt(0).toUpperCase() + task.status.slice(1);
            statusText.className = `text-sm font-semibold ${
                task.status === 'completed' ? 'text-green-600' : 'text-yellow-600'
            }`;
            
            // Due Date
            const dueDate = new Date(task.due_date);
            const now = new Date();
            const diffTime = dueDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let dueDateText = '';
            if (diffDays < 0) {
                dueDateText = `Overdue by ${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''}`;
            } else if (diffDays === 0) {
                dueDateText = 'Due today';
            } else if (diffDays === 1) {
                dueDateText = 'Due tomorrow';
            } else {
                dueDateText = `Due in ${diffDays} days`;
            }
            
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            const formattedDate = dueDate.toLocaleDateString('en-US', options);
            document.getElementById('modalTaskHeaderDueDate').textContent = `${dueDateText}`;
            document.getElementById('modalTaskDueDate').textContent = formattedDate;
            
            // Scheduled Time
            const scheduledContainer = document.getElementById('modalTaskScheduledContainer');
            const scheduledTimeText = document.getElementById('modalTaskScheduledTime');
            if (task.scheduled_time) {
                const scheduledTime = new Date(task.scheduled_time);
                scheduledTimeText.textContent = scheduledTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                scheduledContainer.classList.remove('hidden');
            } else {
                scheduledContainer.classList.add('hidden');
            }
            
            // Type and Subtype
            document.getElementById('modalTaskType').textContent = task.task_type.name;
            document.getElementById('modalTaskSubtype').textContent = task.task_subtype.name;
            
            // Contact
            const contactLink = document.getElementById('modalTaskContact');
            contactLink.textContent = `${task.contact.first_name} ${task.contact.last_name}`;
            contactLink.href = `/contacts/${task.contact.id}`;
            
            // Property Address
            const propertyContainer = document.getElementById('modalTaskPropertyContainer');
            if (task.property_address) {
                document.getElementById('modalTaskProperty').textContent = task.property_address;
                propertyContainer.classList.remove('hidden');
            } else {
                propertyContainer.classList.add('hidden');
            }
            
            // Description
            document.getElementById('modalTaskDescription').textContent = task.description || 'No description provided';
            
            // Status Button
            const statusButton = document.getElementById('modalTaskStatusButton');
            statusButton.textContent = task.status === 'completed' ? 'Mark as Pending' : 'Mark as Complete';
            
            // Show modal
            modalConfig.modal.classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading task details');
        });
}

function closeTaskModal() {
    modalConfig.modal.classList.add('hidden');
    currentTaskId = null;
}

function toggleTaskStatus() {
    if (!currentTaskId) return;
    
    const newStatus = document.getElementById('modalTaskStatus').textContent.toLowerCase() === 'completed' ? 'pending' : 'completed';
    
    quickUpdateStatus(currentTaskId, newStatus === 'completed');
}

// Close modal when clicking outside or pressing Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeTaskModal();
    }
});

document.addEventListener('click', function(event) {
    const modal = document.getElementById('taskModal');
    const modalContent = modal.querySelector('.relative');
    
    if (!modal.classList.contains('hidden') && 
        !modalContent.contains(event.target)) {
        closeTaskModal();
    }
});

// Handle clicks on the modal backdrop
const taskModal = document.getElementById('taskModal');
taskModal.addEventListener('mousedown', function(event) {
    // Only close if clicking directly on the backdrop (the outermost div)
    // and not on any of its children
    if (event.target === taskModal) {
        closeTaskModal();
    }
});

// Add event listeners for task links
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.task-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const taskId = this.getAttribute('data-task-id');
            openTaskModal(taskId);
        });
    });
});

// =============================================================================
// CONTACT FILE MANAGEMENT
// =============================================================================

const contactId = {{ contact.id }};

// File upload via button click
function uploadContactFile(input) {
    if (!input.files || input.files.length === 0) return;
    
    const file = input.files[0];
    const formData = new FormData();
    formData.append('file', file);
    
    // Show progress
    document.getElementById('uploadProgress').classList.remove('hidden');
    
    fetch(`/contact/${contactId}/files`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('uploadProgress').classList.add('hidden');
        input.value = ''; // Reset input
        
        if (data.success) {
            // Add file to list
            addFileToList(data.file);
            showToast('File uploaded successfully', 'success');
        } else {
            showToast(data.error || 'Upload failed', 'error');
        }
    })
    .catch(error => {
        document.getElementById('uploadProgress').classList.add('hidden');
        input.value = '';
        showToast('Upload failed. Please try again.', 'error');
        console.error('Upload error:', error);
    });
}

// Add new file to the list
function addFileToList(file) {
    const filesList = document.getElementById('contactFilesList');
    const noFilesMsg = document.getElementById('noFilesMessage');
    
    // Remove "no files" message if present
    if (noFilesMsg) {
        noFilesMsg.remove();
    }
    
    // Get icon based on file type
    let iconHtml = '';
    const ext = file.original_filename.split('.').pop().toLowerCase();
    
    if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
        iconHtml = `<div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center shadow-sm">
            <i class="fas fa-file-image text-white"></i>
        </div>`;
    } else if (ext === 'pdf') {
        iconHtml = `<div class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-400 to-red-500 flex items-center justify-center shadow-sm">
            <i class="fas fa-file-pdf text-white"></i>
        </div>`;
    } else if (['doc', 'docx'].includes(ext)) {
        iconHtml = `<div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-400 to-blue-500 flex items-center justify-center shadow-sm">
            <i class="fas fa-file-word text-white"></i>
        </div>`;
    } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
        iconHtml = `<div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-400 to-green-500 flex items-center justify-center shadow-sm">
            <i class="fas fa-file-excel text-white"></i>
        </div>`;
    } else {
        iconHtml = `<div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-400 to-slate-500 flex items-center justify-center shadow-sm">
            <i class="fas fa-file text-white"></i>
        </div>`;
    }
    
    const fileHtml = `
        <div class="p-4 hover:bg-slate-50 transition-colors duration-150 group file-item" data-file-id="${file.id}">
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">${iconHtml}</div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-slate-800 truncate">${file.original_filename}</p>
                    <div class="flex items-center gap-2 mt-1 text-xs text-slate-500">
                        <span>${file.file_size}</span>
                        <span></span>
                        <span>${file.created_at}</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-150">
                    <button onclick="downloadContactFile(${file.id})" 
                            class="p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors"
                            title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    <button onclick="deleteContactFile(${file.id}, '${file.original_filename.replace(/'/g, "\\'")}')" 
                            class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="Delete">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    filesList.insertAdjacentHTML('afterbegin', fileHtml);
}

// Download file
function downloadContactFile(fileId) {
    fetch(`/contact/${contactId}/files/${fileId}/download`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Open signed URL in new tab
            window.open(data.url, '_blank');
        } else {
            showToast(data.error || 'Download failed', 'error');
        }
    })
    .catch(error => {
        showToast('Download failed. Please try again.', 'error');
        console.error('Download error:', error);
    });
}

// Delete file
function deleteContactFile(fileId, filename) {
    if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
        return;
    }
    
    fetch(`/contact/${contactId}/files/${fileId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove from DOM
            const fileItem = document.querySelector(`.file-item[data-file-id="${fileId}"]`);
            if (fileItem) {
                fileItem.remove();
            }
            
            // Show "no files" message if list is empty
            const filesList = document.getElementById('contactFilesList');
            if (filesList.querySelectorAll('.file-item').length === 0) {
                filesList.innerHTML = `
                    <div id="noFilesMessage" class="p-8 text-center">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-folder-open text-slate-400 text-xl"></i>
                        </div>
                        <p class="text-slate-500 text-sm">No files uploaded</p>
                        <p class="text-slate-400 text-xs mt-1">Click upload or drag files here</p>
                    </div>
                `;
            }
            
            showToast('File deleted', 'success');
        } else {
            showToast(data.error || 'Delete failed', 'error');
        }
    })
    .catch(error => {
        showToast('Delete failed. Please try again.', 'error');
        console.error('Delete error:', error);
    });
}

// Simple toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white z-50 transition-all duration-300 transform translate-y-2 opacity-0 ${
        type === 'success' ? 'bg-emerald-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-slate-700'
    }`;
    toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>${message}`;
    document.body.appendChild(toast);
    
    // Animate in
    requestAnimationFrame(() => {
        toast.classList.remove('translate-y-2', 'opacity-0');
    });
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-y-2', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Drag and drop support
const fileDropZone = document.getElementById('fileDropZone');
const filesCard = fileDropZone.closest('.premium-card');

filesCard.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileDropZone.classList.remove('hidden');
});

filesCard.addEventListener('dragleave', (e) => {
    if (!filesCard.contains(e.relatedTarget)) {
        fileDropZone.classList.add('hidden');
    }
});

filesCard.addEventListener('drop', (e) => {
    e.preventDefault();
    fileDropZone.classList.add('hidden');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        // Create a mock input event
        const input = document.getElementById('fileUploadInput');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(files[0]);
        input.files = dataTransfer.files;
        uploadContactFile(input);
    }
});
</script>
{% endblock %}
