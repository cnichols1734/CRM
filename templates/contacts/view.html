{% extends "base.html" %}

{% block content %}
<style>
    /* Email body content - render HTML like Gmail */
    .email-body-content ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
    .email-body-content ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5rem 0; }
    .email-body-content li { margin: 0.25rem 0; }
    .email-body-content p { margin: 0.5rem 0; }
    .email-body-content strong, .email-body-content b { font-weight: 600; }
    .email-body-content em, .email-body-content i { font-style: italic; }
    .email-body-content a { color: #2563eb; text-decoration: underline; }
    .email-body-content blockquote { border-left: 3px solid #e2e8f0; padding-left: 1rem; margin: 0.5rem 0; color: #64748b; }

    /* Input styling */
    .premium-input {
        display: block;
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        background-color: #fff;
        font-size: 0.9375rem;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .premium-input:hover { border-color: #cbd5e1; }
    .premium-input:focus { outline: none; border-color: #f97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.08); }
    .premium-input::placeholder { color: #94a3b8; }
    textarea.premium-input { min-height: 80px; resize: vertical; }

    /* Detail grid styling */
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }
    .detail-cell { padding: 0.625rem 0; border-bottom: 1px solid #f1f5f9; }
    .detail-cell:nth-last-child(-n+2) { border-bottom: none; }
    .detail-cell:nth-child(odd) { padding-right: 1.5rem; }
    .detail-cell:nth-child(even) { padding-left: 1.5rem; border-left: 1px solid #f1f5f9; }
    .detail-label { color: #64748b; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.125rem; }
    .detail-value { color: #1e293b; font-size: 0.875rem; font-weight: 500; }
    @media (max-width: 640px) {
        .detail-grid { grid-template-columns: 1fr; }
        .detail-cell:nth-child(even) { padding-left: 0; border-left: none; }
        .detail-cell:nth-child(odd) { padding-right: 0; }
        .detail-cell:nth-last-child(1) { border-bottom: none; }
        .detail-cell:nth-last-child(2) { border-bottom: 1px solid #f1f5f9; }
    }

    /* Section divider */
    .section-title {
        font-size: 0.6875rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding-bottom: 0.75rem;
        margin-bottom: 0;
    }

    /* Quick action buttons in header */
    .quick-action-btn {
        display: inline-flex; align-items: center; gap: 0.375rem;
        padding: 0.375rem 0.75rem; border-radius: 0.375rem;
        font-size: 0.8125rem; font-weight: 500; color: #475569;
        background: #f8fafc; border: 1px solid #e2e8f0;
        transition: all 0.15s ease;
    }
    .quick-action-btn:hover { background: #f1f5f9; border-color: #cbd5e1; color: #1e293b; }
    .quick-action-btn i { font-size: 0.75rem; color: #94a3b8; }
    .quick-action-btn:hover i { color: #64748b; }
</style>

<!-- Page wrapper -->
<div class="min-h-screen bg-slate-50">
    <!-- Sticky nav bar -->
    <div class="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="h-12 flex items-center justify-between">
                <a href="{{ url_for('main.contacts') }}"
                    class="flex items-center gap-1.5 text-sm text-slate-500 hover:text-slate-800 transition-colors">
                    <i class="fas fa-arrow-left text-xs"></i>
                    <span>Contacts</span>
                </a>
                <div class="flex items-center gap-2">
                    <!-- Previous/Next Navigation -->
                    <a href="{{ url_for('contacts.view_contact', contact_id=prev_contact.id) }}"
                        class="hidden md:inline-flex items-center gap-1.5 px-3 py-1.5 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-md transition-colors">
                        <i class="fas fa-arrow-left text-xs text-slate-400"></i>
                        <span class="truncate max-w-[120px]">{{ prev_contact.first_name }} {{ prev_contact.last_name }}</span>
                    </a>
                    <a href="{{ url_for('contacts.view_contact', contact_id=next_contact.id) }}"
                        class="hidden md:inline-flex items-center gap-1.5 px-3 py-1.5 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-md transition-colors">
                        <span class="truncate max-w-[120px]">{{ next_contact.first_name }} {{ next_contact.last_name }}</span>
                        <i class="fas fa-arrow-right text-xs text-slate-400"></i>
                    </a>

                    <div class="w-px h-5 bg-slate-200 hidden md:block"></div>

                    <!-- Edit/Save/Cancel Buttons -->
                    <button id="editButton" onclick="toggleEditMode()"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-orange-500 text-white rounded-md text-sm font-medium hover:bg-orange-600 transition-colors">
                        <i class="fas fa-pencil-alt text-xs"></i>
                        Edit
                    </button>
                    <button id="saveButton" onclick="saveContact()"
                        class="hidden inline-flex items-center gap-1.5 px-3 py-1.5 bg-emerald-500 text-white rounded-md text-sm font-medium hover:bg-emerald-600 transition-colors">
                        <i class="fas fa-check text-xs"></i>
                        Save
                    </button>
                    <button id="cancelButton" onclick="cancelEdit()"
                        class="hidden inline-flex items-center px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-md transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Main Content -->
            <div class="flex-1 min-w-0">
                <!-- Contact Header Card -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5 mb-5">
                    <div class="flex items-start gap-4">
                        {% set initials = contact.first_name[0]|upper + contact.last_name[0]|upper %}
                        {% set avatar_colors = {
                            'A': 'bg-blue-500', 'B': 'bg-rose-500', 'C': 'bg-green-500',
                            'D': 'bg-amber-500', 'E': 'bg-purple-500', 'F': 'bg-pink-500',
                            'G': 'bg-indigo-500', 'H': 'bg-teal-500', 'I': 'bg-orange-500',
                            'J': 'bg-cyan-500', 'K': 'bg-lime-600', 'L': 'bg-emerald-500',
                            'M': 'bg-violet-500', 'N': 'bg-fuchsia-500', 'O': 'bg-sky-500',
                            'P': 'bg-red-500', 'Q': 'bg-yellow-500', 'R': 'bg-slate-500',
                            'S': 'bg-stone-500', 'T': 'bg-zinc-500', 'U': 'bg-blue-600',
                            'V': 'bg-rose-600', 'W': 'bg-emerald-600', 'X': 'bg-amber-600',
                            'Y': 'bg-sky-600', 'Z': 'bg-slate-600'
                        } %}
                        <div class="w-14 h-14 rounded-full flex items-center justify-center text-lg font-semibold text-white flex-shrink-0 {{ avatar_colors[initials[0]] or 'bg-slate-500' }}">
                            {{ contact.first_name[0] }}{{ contact.last_name[0] }}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div id="viewContactName" class="text-xl font-bold text-slate-900">
                                {{ contact.first_name }} {{ contact.last_name }}
                            </div>
                            <div id="editContactName" class="hidden flex gap-2 mb-2">
                                <input type="text" name="first_name" value="{{ contact.first_name }}"
                                    class="premium-input text-lg font-semibold max-w-[200px]"
                                    placeholder="First Name">
                                <input type="text" name="last_name" value="{{ contact.last_name }}"
                                    class="premium-input text-lg font-semibold max-w-[200px]"
                                    placeholder="Last Name">
                            </div>
                            <!-- Contact info line -->
                            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1 text-sm text-slate-500">
                                {% if contact.email %}
                                <a href="mailto:{{ contact.email }}" class="hover:text-slate-700 transition-colors">
                                    <i class="fas fa-envelope text-xs mr-1 text-slate-400"></i>{{ contact.email }}
                                </a>
                                {% endif %}
                                {% if contact.email and contact.phone %}
                                <span class="text-slate-300">&middot;</span>
                                {% endif %}
                                {% if contact.phone %}
                                <a href="tel:{{ contact.phone }}" class="hover:text-slate-700 transition-colors">
                                    <i class="fas fa-phone text-xs mr-1 text-slate-400"></i>{{ contact.phone }}
                                </a>
                                {% endif %}
                            </div>
                            {% if current_user.role == 'admin' %}
                            <div class="flex items-center gap-1.5 mt-1.5 text-xs text-slate-400">
                                <div class="w-4 h-4 rounded-full bg-slate-200 flex items-center justify-center text-[9px] font-medium text-slate-500">
                                    {{ contact.owner.first_name[0] }}{{ contact.owner.last_name[0] }}
                                </div>
                                <span>{{ contact.owner.first_name }} {{ contact.owner.last_name }}</span>
                            </div>
                            {% endif %}
                            {% if contact.groups %}
                            <div class="flex flex-wrap gap-1.5 mt-2.5">
                                {% for group in contact.groups %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-50 text-orange-600 border border-orange-100">
                                    {{ group.name }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Quick Actions Row -->
                    <div class="flex flex-wrap items-center gap-2 mt-4 pt-4 border-t border-slate-100">
                        {% if contact.phone %}
                        <a href="tel:{{ contact.phone }}" class="quick-action-btn">
                            <i class="fas fa-phone"></i><span>Call</span>
                        </a>
                        {% endif %}
                        {% if contact.email %}
                        <button type="button" onclick="openEmailToContact()" class="quick-action-btn">
                            <i class="fas fa-envelope"></i><span>Email</span>
                        </button>
                        {% endif %}
                        {% if contact.phone %}
                        <a href="sms:{{ contact.phone }}" class="quick-action-btn">
                            <i class="fas fa-comment"></i><span>Text</span>
                        </a>
                        {% endif %}
                        <a href="{{ url_for('tasks.create_task') }}?contact_id={{ contact.id }}" class="quick-action-btn">
                            <i class="fas fa-plus"></i><span>New Task</span>
                        </a>
                        <button onclick="showVoiceMemoModal()" class="quick-action-btn">
                            <i class="fas fa-microphone"></i><span>Voice Memo</span>
                        </button>
                        <button onclick="showLogActivityModal()" class="quick-action-btn">
                            <i class="fas fa-clipboard-list"></i><span>Log Activity</span>
                        </button>
                    </div>
                </div>

                <!-- Contact Information Card -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <!-- Edit Form (Hidden by default) -->
                    <form action="{{ url_for('contacts.edit_contact', contact_id=contact.id) }}" method="POST"
                        id="editContactForm" class="hidden">
                        <div class="divide-y divide-slate-100">
                            <!-- Basic Information Section -->
                            <div class="p-5">
                                <h3 class="section-title">Basic Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Email</label>
                                        <input type="email" name="email" value="{{ contact.email }}" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Phone</label>
                                        <input type="tel" name="phone" value="{{ contact.phone }}" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Potential Commission ($)</label>
                                        <input type="number" name="potential_commission" value="{{ contact.potential_commission }}" step="0.01" min="0" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Created</label>
                                        <p class="px-3 py-2 text-slate-500 bg-slate-50 rounded-md text-sm">{{ contact.created_at.strftime('%B %d, %Y') }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Dates Section -->
                            <div class="p-5">
                                <h3 class="section-title">Last Contact Dates</h3>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Last Email</label>
                                        <input type="date" name="last_email_date" value="{{ contact.last_email_date.strftime('%Y-%m-%d') if contact.last_email_date }}" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Last Text</label>
                                        <input type="date" name="last_text_date" value="{{ contact.last_text_date.strftime('%Y-%m-%d') if contact.last_text_date }}" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Last Phone Call</label>
                                        <input type="date" name="last_phone_call_date" value="{{ contact.last_phone_call_date.strftime('%Y-%m-%d') if contact.last_phone_call_date }}" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Last Contact</label>
                                        <p class="px-3 py-2 text-slate-500 bg-slate-50 rounded-md text-sm">{{ contact.last_contact_date.strftime('%B %d, %Y') if contact.last_contact_date else 'Never' }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Section -->
                            <div class="p-5">
                                <h3 class="section-title">Address</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Street Address</label>
                                        <input type="text" name="street_address" value="{{ contact.street_address }}" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">City</label>
                                        <input type="text" name="city" value="{{ contact.city }}" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">State</label>
                                        <input type="text" name="state" value="{{ contact.state }}" class="premium-input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">ZIP Code</label>
                                        <input type="text" name="zip_code" value="{{ contact.zip_code }}" class="premium-input">
                                    </div>
                                </div>
                            </div>

                            <!-- Groups Section -->
                            <div class="p-5">
                                <h3 class="section-title">Groups</h3>
                                {% set contact_group_ids = contact.groups | map(attribute='id') | list %}
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="editGroupsGrid">
                                    {% for group in all_groups %}
                                    {% set is_member = group.id in contact_group_ids %}
                                    <label class="group-edit-label relative flex items-center px-3 py-2.5 rounded-lg text-sm cursor-pointer transition-all duration-150"
                                           data-originally-selected="{{ 'true' if is_member else 'false' }}">
                                        <input type="checkbox" name="group_ids" value="{{ group.id }}"
                                            {% if is_member %}checked{% endif %}
                                            class="h-3.5 w-3.5 mr-2.5 rounded border-slate-300 text-orange-500 accent-orange-500 focus:ring-orange-400">
                                        <span class="font-medium">{{ group.name }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                                <script>
                                    // Dynamic group label styling based on checkbox state + original state
                                    document.addEventListener('DOMContentLoaded', function() {
                                        function updateGroupLabels() {
                                            document.querySelectorAll('.group-edit-label').forEach(function(label) {
                                                var cb = label.querySelector('input[type="checkbox"]');
                                                var wasSelected = label.dataset.originallySelected === 'true';
                                                var isChecked = cb.checked;

                                                // Reset inline styles and classes
                                                label.style.border = '';
                                                label.style.background = '';
                                                label.classList.remove(
                                                    'bg-orange-50', 'text-orange-700',
                                                    'bg-white', 'text-slate-600', 'text-orange-400'
                                                );

                                                if (isChecked) {
                                                    // Currently selected: solid orange
                                                    label.style.border = '1px solid #fb923c';
                                                    label.classList.add('bg-orange-50', 'text-orange-700');
                                                } else if (wasSelected && !isChecked) {
                                                    // Was selected, now deselected: dashed orange border
                                                    label.style.border = '2px dashed #fdba74';
                                                    label.style.background = '#fff7ed';
                                                    label.classList.add('text-orange-400');
                                                } else {
                                                    // Not selected, never was: default
                                                    label.style.border = '1px solid #e2e8f0';
                                                    label.classList.add('bg-white', 'text-slate-600');
                                                }
                                            });
                                        }
                                        // Run on load and on every checkbox change
                                        updateGroupLabels();
                                        document.querySelectorAll('.group-edit-label input[type="checkbox"]').forEach(function(cb) {
                                            cb.addEventListener('change', updateGroupLabels);
                                        });
                                    });
                                </script>
                            </div>

                            <!-- Client Details Section in Edit Form -->
                            <div class="p-5">
                                <h3 class="section-title">Client Details</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">What does this person want right now?</label>
                                        <textarea name="current_objective" rows="3" class="premium-input resize-y">{{ contact.current_objective or '' }}</textarea>
                                        <p class="mt-1.5 text-xs text-slate-400">Ex: They want to buy a home, sell a home, they're looking for acreage.</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">What is their timeline?</label>
                                        <textarea name="move_timeline" rows="2" class="premium-input resize-y">{{ contact.move_timeline or '' }}</textarea>
                                        <p class="mt-1.5 text-xs text-slate-400">Ex: They want to move now, within the next 6 months, or within a year?</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Why do they want to move?</label>
                                        <textarea name="motivation" rows="2" class="premium-input resize-y">{{ contact.motivation or '' }}</textarea>
                                        <p class="mt-1.5 text-xs text-slate-400">Ex: Having a baby, want a larger home, moving for work, etc.</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Have they shared any financial details?</label>
                                        <textarea name="financial_status" rows="3" class="premium-input resize-y">{{ contact.financial_status or '' }}</textarea>
                                        <p class="mt-1.5 text-xs text-slate-400">Ex: Budget is $x, preapproved status, down payment amount, home equity.</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1.5">Any other details to share?</label>
                                        <textarea name="additional_notes" rows="2" class="premium-input resize-y">{{ contact.additional_notes or '' }}</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes Section in Edit Form -->
                            <div class="p-5">
                                <h3 class="section-title">Notes</h3>
                                <textarea name="notes" rows="4" class="premium-input resize-y">{{ contact.notes }}</textarea>
                            </div>
                        </div>
                    </form>

                    <!-- View Mode (Default) -->
                    <div id="viewContactInfo">
                        <div class="divide-y divide-slate-100">
                            <!-- Basic Information Section -->
                            <div class="p-5">
                                <h3 class="section-title">Details</h3>
                                <div class="detail-grid">
                                    <div class="detail-cell">
                                        <div class="detail-label">Email</div>
                                        <div class="detail-value">{% if contact.email %}<a href="mailto:{{ contact.email }}" class="hover:text-orange-600 transition-colors">{{ contact.email }}</a>{% else %}<span class="text-slate-300">&mdash;</span>{% endif %}</div>
                                    </div>
                                    <div class="detail-cell">
                                        <div class="detail-label">Phone</div>
                                        <div class="detail-value">{% if contact.phone %}<a href="tel:{{ contact.phone }}" class="hover:text-orange-600 transition-colors">{{ contact.phone }}</a>{% else %}<span class="text-slate-300">&mdash;</span>{% endif %}</div>
                                    </div>
                                    <div class="detail-cell">
                                        <div class="detail-label">Commission</div>
                                        <div class="detail-value">{% if contact.potential_commission is not none %}${{ "{:,.2f}".format(contact.potential_commission|float) }}{% else %}<span class="text-slate-300">&mdash;</span>{% endif %}</div>
                                    </div>
                                    <div class="detail-cell">
                                        <div class="detail-label">Created</div>
                                        <div class="detail-value text-slate-500">{{ contact.created_at.strftime('%b %d, %Y') }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Dates Section -->
                            <div class="p-5">
                                <h3 class="section-title">Last Contact Dates</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-2">
                                    <div>
                                        <div class="text-xs text-slate-400 font-medium mb-0.5">Email</div>
                                        <div id="lastEmailDate" class="text-sm font-medium text-slate-700">{{ contact.last_email_date.strftime('%m/%d/%Y') if contact.last_email_date else 'Never' }}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-slate-400 font-medium mb-0.5">Text</div>
                                        <div id="lastTextDate" class="text-sm font-medium text-slate-700">{{ contact.last_text_date.strftime('%m/%d/%Y') if contact.last_text_date else 'Never' }}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-slate-400 font-medium mb-0.5">Phone Call</div>
                                        <div id="lastPhoneCallDate" class="text-sm font-medium text-slate-700">{{ contact.last_phone_call_date.strftime('%m/%d/%Y') if contact.last_phone_call_date else 'Never' }}</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-slate-400 font-medium mb-0.5">Last Contact</div>
                                        <div id="lastContactDate" class="text-sm font-medium text-slate-700">{{ contact.last_contact_date.strftime('%m/%d/%Y') if contact.last_contact_date else 'Never' }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Address Section -->
                            <div class="p-5">
                                <h3 class="section-title">Address</h3>
                                <div class="detail-grid">
                                    <div class="detail-cell">
                                        <div class="detail-label">Street</div>
                                        <div class="detail-value">{{ contact.street_address or '\u2014' }}</div>
                                    </div>
                                    <div class="detail-cell">
                                        <div class="detail-label">City</div>
                                        <div class="detail-value">{{ contact.city or '\u2014' }}</div>
                                    </div>
                                    <div class="detail-cell">
                                        <div class="detail-label">State</div>
                                        <div class="detail-value">{{ contact.state or '\u2014' }}</div>
                                    </div>
                                    <div class="detail-cell">
                                        <div class="detail-label">ZIP</div>
                                        <div class="detail-value">{{ contact.zip_code or '\u2014' }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Groups Section -->
                            <div class="p-5">
                                <h3 class="section-title">Groups</h3>
                                <div class="flex flex-wrap gap-1.5">
                                    {% for group in contact.groups %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-50 text-orange-600 border border-orange-100">
                                        {{ group.name }}
                                    </span>
                                    {% else %}
                                    <span class="text-sm text-slate-300">&mdash;</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Client Details Section in View Mode -->
                            <div class="p-5">
                                <h3 class="section-title">Client Details</h3>
                                <div class="space-y-3">
                                    <div>
                                        <div class="text-xs font-medium text-slate-400 mb-1">What does this person want right now?</div>
                                        <p class="text-sm text-slate-700 whitespace-pre-line">{{ contact.current_objective or '\u2014' }}</p>
                                    </div>
                                    <div>
                                        <div class="text-xs font-medium text-slate-400 mb-1">Timeline</div>
                                        <p class="text-sm text-slate-700 whitespace-pre-line">{{ contact.move_timeline or '\u2014' }}</p>
                                    </div>
                                    <div>
                                        <div class="text-xs font-medium text-slate-400 mb-1">Motivation</div>
                                        <p class="text-sm text-slate-700 whitespace-pre-line">{{ contact.motivation or '\u2014' }}</p>
                                    </div>
                                    <div>
                                        <div class="text-xs font-medium text-slate-400 mb-1">Financial Details</div>
                                        <p class="text-sm text-slate-700 whitespace-pre-line">{{ contact.financial_status or '\u2014' }}</p>
                                    </div>
                                    <div>
                                        <div class="text-xs font-medium text-slate-400 mb-1">Other Details</div>
                                        <p class="text-sm text-slate-700 whitespace-pre-line">{{ contact.additional_notes or '\u2014' }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes Section in View Mode -->
                            <div class="p-5">
                                <h3 class="section-title">Notes</h3>
                                <p class="text-sm text-slate-700 whitespace-pre-line">{{ contact.notes or '\u2014' }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Contact -->
                <div class="mt-4 flex justify-end">
                    <form action="{{ url_for('contacts.delete_contact', contact_id=contact.id) }}" method="POST"
                        id="deleteContactForm">
                        <button onclick="deleteContact()"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-slate-400 hover:text-red-500 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                            Delete Contact
                        </button>
                    </form>
                </div>
            </div>

            <!-- Side Container - Related Tasks & Transactions -->
            <div class="lg:w-[400px] xl:w-[440px] flex-shrink-0 space-y-4">

                {% if show_transactions %}
                <!-- Related Transactions Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Transactions</h2>
                        <a href="{{ url_for('transactions.new_transaction', contact_id=contact.id) }}" class="inline-flex items-center px-2 py-0.5 text-xs font-medium text-orange-600 hover:text-orange-700 transition-colors">
                            <i class="fas fa-plus text-[10px] mr-1"></i> New
                        </a>
                    </div>

                    <div class="divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        {% for tx in related_transactions %}
                        <a href="{{ url_for('transactions.view_transaction', id=tx.id, ref='contact', contact_id=contact.id) }}"
                            class="block p-3 hover:bg-slate-50 transition-colors group">
                            <div class="flex items-center gap-3">
                                <!-- Simple colored icon -->
                                <i class="fas fa-home flex-shrink-0
                                    {% if tx.transaction_type.name == 'seller' %}text-orange-500
                                    {% elif tx.transaction_type.name == 'buyer' %}text-purple-500
                                    {% elif tx.transaction_type.name == 'landlord' %}text-cyan-500
                                    {% elif tx.transaction_type.name == 'tenant' %}text-green-500
                                    {% else %}text-indigo-500{% endif %}"></i>

                                <!-- Transaction Content -->
                                <div class="flex-1 min-w-0">
                                    <span class="text-sm font-medium text-slate-800 group-hover:text-orange-600 truncate block transition-colors">
                                        {{ tx.street_address }}
                                    </span>
                                    <div class="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                        <span class="{% if tx.transaction_type.name == 'seller' %}text-orange-600{% elif tx.transaction_type.name == 'buyer' %}text-purple-600{% elif tx.transaction_type.name == 'landlord' %}text-cyan-600{% elif tx.transaction_type.name == 'tenant' %}text-green-600{% else %}text-indigo-600{% endif %}">{{ tx.transaction_type.display_name }}</span>
                                        <span class="text-slate-300">·</span>
                                        <span class="{% if tx.status == 'active' %}text-green-600{% elif tx.status == 'pending' %}text-amber-600{% elif tx.status == 'closed' %}text-indigo-600{% else %}text-slate-500{% endif %}">{{ tx.status|replace('_', ' ')|title }}</span>
                                    </div>
                                    <div class="text-xs text-slate-400 mt-0.5">{{ tx.created_at.strftime('%b %d, %Y') }}</div>
                                </div>

                                <!-- Arrow -->
                                <i class="fas fa-chevron-right text-slate-300 text-xs opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"></i>
                            </div>
                        </a>
                        {% else %}
                        <div class="px-4 py-6 text-center">
                            <p class="text-slate-400 text-sm">No transactions</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Related Tasks Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Tasks</h2>
                        <a href="{{ url_for('tasks.create_task', contact_id=contact.id, return_to='contact') }}" class="inline-flex items-center px-2 py-0.5 text-xs font-medium text-orange-600 hover:text-orange-700 transition-colors">
                            <i class="fas fa-plus text-[10px] mr-1"></i> New
                        </a>
                    </div>

                    <!-- Task Filter Tabs -->
                    <div class="border-b border-slate-100 px-2">
                        <div class="flex">
                            <button onclick="switchTaskView('pending')" id="pendingTasksTab"
                                class="flex-1 py-3 px-4 text-sm font-medium text-orange-600 border-b-2 border-orange-500 transition-all duration-200">
                                Active Tasks
                            </button>
                            <button onclick="switchTaskView('completed')" id="completedTasksTab"
                                class="flex-1 py-3 px-4 text-sm font-medium text-slate-500 hover:text-slate-700 border-b-2 border-transparent transition-all duration-200">
                                Completed
                            </button>
                        </div>
                    </div>

                    <!-- Task Lists -->
                    <div id="pendingTasks" class="divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        {% for task in contact.tasks|selectattr('status', 'equalto',
                        'pending')|sort(attribute='due_date') %}
                        <div class="p-3 hover:bg-slate-50 transition-colors duration-150">
                            <div class="flex items-center gap-3">
                                <!-- Priority dot -->
                                <div class="w-2 h-2 rounded-full flex-shrink-0 {% if task.priority == 'high' %}bg-red-500{% elif task.priority == 'medium' %}bg-amber-500{% else %}bg-green-500{% endif %}"></div>

                                <!-- Task Content -->
                                <div class="flex-1 min-w-0">
                                    <a href="#" data-task-id="{{ task.id }}"
                                        class="task-link text-sm font-medium text-slate-800 hover:text-orange-600 truncate block transition-colors">
                                        {{ task.subject }}
                                    </a>
                                    <div class="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                        <span>{{ task.task_type.name }}</span>
                                        <span class="text-slate-300">·</span>
                                        {% set task_date = task.due_date.date() %}
                                        {% set current_date = now.date() %}
                                        {% set days_until_due = (task_date - current_date).days %}
                                        <span class="{% if days_until_due < 0 %}text-red-500{% elif days_until_due == 0 %}text-orange-500{% elif days_until_due <= 2 %}text-amber-600{% else %}text-slate-500{% endif %}">
                                            {% if days_until_due < 0 %}{{ days_until_due|abs }}d overdue{% elif days_until_due == 0 %}Due today{% elif days_until_due == 1 %}Due tomorrow{% else %}Due in {{ days_until_due }}d{% endif %}
                                        </span>
                                    </div>
                                </div>

                                <!-- Quick Complete -->
                                <button onclick="quickUpdateStatus({{ task.id }}, true)"
                                    class="w-6 h-6 rounded text-slate-300 hover:text-green-500 hover:bg-green-50 flex items-center justify-center transition-all flex-shrink-0">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="px-4 py-6 text-center">
                            <p class="text-slate-400 text-sm">No active tasks</p>
                        </div>
                        {% endfor %}
                    </div>

                    <div id="completedTasks" class="hidden divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        {% for task in contact.tasks|selectattr('status', 'equalto',
                        'completed')|sort(attribute='completed_at', reverse=true) %}
                        <div class="p-3 hover:bg-slate-50 transition-colors duration-150">
                            <div class="flex items-center gap-3">
                                <!-- Completed check -->
                                <i class="fas fa-check-circle text-green-500 text-sm flex-shrink-0"></i>

                                <!-- Task Content -->
                                <div class="flex-1 min-w-0">
                                    <a href="#" data-task-id="{{ task.id }}"
                                        class="task-link text-sm text-slate-500 hover:text-slate-700 truncate block line-through decoration-slate-300 transition-colors">
                                        {{ task.subject }}
                                    </a>
                                    <div class="flex items-center gap-2 text-xs text-slate-400 mt-0.5">
                                        <span>{{ task.task_type.name }}</span>
                                        <span class="text-slate-300">·</span>
                                        <span>{% if task.completed_at %}{{ task.completed_at.strftime('%m/%d/%y') }}{% else %}Recently{% endif %}</span>
                                    </div>
                                </div>

                                <!-- Undo -->
                                <button onclick="quickUpdateStatus({{ task.id }}, false)"
                                    class="w-6 h-6 rounded text-slate-300 hover:text-amber-500 hover:bg-amber-50 flex items-center justify-center transition-all flex-shrink-0">
                                    <i class="fas fa-undo text-xs"></i>
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="px-4 py-6 text-center">
                            <p class="text-slate-400 text-sm">No completed tasks</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Related Files Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Files</h2>
                        <button onclick="document.getElementById('fileUploadInput').click()" class="inline-flex items-center px-2 py-0.5 text-xs font-medium text-orange-600 hover:text-orange-700 transition-colors">
                            <i class="fas fa-plus text-[10px] mr-1"></i> Upload
                        </button>
                        <input type="file" id="fileUploadInput" class="hidden"
                            accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.csv,.xlsx,.xls"
                            onchange="uploadContactFile(this)">
                    </div>

                    <!-- Drop Zone (hidden by default, shown on drag) -->
                    <div id="fileDropZone"
                        class="hidden p-8 border-2 border-dashed border-emerald-300 bg-emerald-50 m-4 rounded-xl text-center transition-all duration-200">
                        <i class="fas fa-cloud-upload-alt text-4xl text-emerald-400 mb-3"></i>
                        <p class="text-emerald-600 font-medium">Drop files here to upload</p>
                        <p class="text-emerald-500 text-sm mt-1">Max 10 MB per file</p>
                    </div>

                    <!-- File List -->
                    <div id="contactFilesList" class="divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        {% for file in contact_files %}
                        <div class="p-3 hover:bg-slate-50 transition-colors duration-150 group file-item"
                            data-file-id="{{ file.id }}">
                            <div class="flex items-center gap-3">
                                <!-- File Icon - simple colored icon -->
                                {% if file.is_image %}
                                <i class="fas fa-file-image text-pink-500 flex-shrink-0"></i>
                                {% elif file.file_extension == 'pdf' %}
                                <i class="fas fa-file-pdf text-red-500 flex-shrink-0"></i>
                                {% elif file.file_extension in ['doc', 'docx'] %}
                                <i class="fas fa-file-word text-blue-500 flex-shrink-0"></i>
                                {% elif file.file_extension in ['xls', 'xlsx', 'csv'] %}
                                <i class="fas fa-file-excel text-green-500 flex-shrink-0"></i>
                                {% else %}
                                <i class="fas fa-file text-slate-400 flex-shrink-0"></i>
                                {% endif %}

                                <!-- File Info -->
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-800 truncate">{{ file.original_filename }}</p>
                                    <p class="text-xs text-slate-500">{{ file.human_file_size }} · {{ file.created_at.strftime('%b %d, %Y') }}</p>
                                </div>

                                <!-- Actions -->
                                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="downloadContactFile({{ file.id }})"
                                        class="p-1.5 text-slate-400 hover:text-emerald-600 rounded transition-colors" title="Download">
                                        <i class="fas fa-download text-xs"></i>
                                    </button>
                                    <button onclick="deleteContactFile({{ file.id }}, '{{ file.original_filename }}')"
                                        class="p-1.5 text-slate-400 hover:text-red-500 rounded transition-colors" title="Delete">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div id="noFilesMessage" class="px-4 py-6 text-center">
                            <p class="text-slate-400 text-sm">No files</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Upload Progress (hidden by default) -->
                    <div id="uploadProgress" class="hidden p-4 border-t border-slate-100">
                        <div class="flex items-center gap-3">
                            <div
                                class="animate-spin rounded-full h-5 w-5 border-2 border-emerald-500 border-t-transparent">
                            </div>
                            <span class="text-sm text-slate-600">Uploading...</span>
                        </div>
                    </div>
                </div>

                <!-- Unified Activity Timeline Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Activity Timeline</h2>
                        <button onclick="showLogActivityModal()" class="inline-flex items-center px-2 py-0.5 text-xs font-medium text-orange-600 hover:text-orange-700 transition-colors">
                            <i class="fas fa-plus text-[10px] mr-1"></i> Log
                        </button>
                    </div>

                    <!-- Filter Buttons -->
                    <div id="activityTimelineFilters" class="px-4 py-2 border-b border-slate-100 bg-white">
                        <div class="flex flex-wrap gap-1.5">
                            <button data-filter="all" class="timeline-filter-btn inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md transition-all bg-slate-800 text-white">
                                All <span class="filter-count ml-1 opacity-70">0</span>
                            </button>
                            <button data-filter="interaction" class="timeline-filter-btn inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                                Calls <span class="filter-count ml-1 opacity-50">0</span>
                            </button>
                            <button data-filter="email" class="timeline-filter-btn inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                                Emails <span class="filter-count ml-1 opacity-50">0</span>
                            </button>
                            <button data-filter="task" class="timeline-filter-btn inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                                Tasks <span class="filter-count ml-1 opacity-50">0</span>
                            </button>
                            <button data-filter="file" class="timeline-filter-btn inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                                Files <span class="filter-count ml-1 opacity-50">0</span>
                            </button>
                            <button data-filter="voice_memo" class="timeline-filter-btn inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-md transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                                Memos <span class="filter-count ml-1 opacity-50">0</span>
                            </button>
                        </div>
                    </div>

                    <!-- Timeline Container -->
                    <div id="activityTimelineContainer" class="max-h-[500px] overflow-y-auto">
                        <!-- Activities will be rendered here by JavaScript -->
                    </div>

                    <!-- Pagination Footer -->
                    <div class="px-4 py-3 border-t border-slate-100 bg-slate-50/50">
                        <div class="flex items-center justify-between">
                            <span id="timelinePaginationInfo" class="text-xs text-slate-500">Loading...</span>
                            <button id="timelineLoadMoreBtn" class="hidden text-xs text-orange-600 hover:text-orange-700 font-medium">
                                <i class="fas fa-chevron-down mr-1"></i>Load More
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Voice Memos Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Voice Memos</h2>
                        <button onclick="showVoiceMemoModal()" class="inline-flex items-center px-2 py-0.5 text-xs font-medium text-orange-600 hover:text-orange-700 transition-colors">
                            <i class="fas fa-plus text-[10px] mr-1"></i> Record
                        </button>
                    </div>

                    <!-- Voice Memos List -->
                    <div id="voiceMemosList" class="divide-y divide-slate-100 max-h-80 overflow-y-auto">
                        <div class="px-4 py-6 text-center" id="voiceMemosEmpty">
                            <p class="text-slate-400 text-sm">No voice memos</p>
                        </div>
                    </div>
                </div>

                <!-- Email History Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                        <h2 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Email History</h2>
                        {% if email_threads %}
                        <span class="text-xs text-slate-400">{{ email_threads|length }} thread{{ 's' if email_threads|length != 1 else '' }}</span>
                        {% endif %}
                    </div>

                    <div class="max-h-[600px] overflow-y-auto">
                        {% if not gmail_connected %}
                        <!-- Gmail Not Connected State -->
                        <div class="p-6 text-center">
                            <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-envelope text-slate-400 text-lg"></i>
                            </div>
                            <p class="text-slate-700 font-medium mb-1">See email history</p>
                            <p class="text-slate-500 text-sm mb-4">Connect Gmail to sync conversations</p>
                            <a href="{{ url_for('gmail.connect') }}" class="inline-flex items-center px-3 py-1.5 bg-white border border-slate-200 rounded-md hover:bg-slate-50 transition-colors text-sm font-medium">
                                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Connect Gmail
                            </a>
                        </div>

                        {% elif email_threads|length == 0 %}
                        <!-- No Emails State -->
                        <div class="p-6 text-center">
                            <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-inbox text-slate-400 text-lg"></i>
                            </div>
                            <p class="text-slate-600 font-medium">No emails yet</p>
                            <p class="text-slate-400 text-sm mt-1">Emails will appear here automatically</p>
                        </div>

                        {% else %}
                        <!-- Email Threads List -->
                        <div class="divide-y divide-slate-100">
                            {% for thread in email_threads %}
                            <div class="email-thread-item" data-thread-id="{{ thread.thread_id }}">
                                <!-- Thread Row (Collapsed) -->
                                <button onclick="toggleEmailThread('{{ thread.thread_id }}')" class="w-full p-4 hover:bg-slate-50 transition-colors text-left group">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="flex-1 min-w-0">
                                            <p class="font-semibold text-slate-800 truncate group-hover:text-blue-600 transition-colors">{{ thread.subject or '(No subject)' }}</p>
                                            <p class="text-sm text-slate-500 mt-1">
                                                {{ thread.message_count }} message{{ 's' if thread.message_count != 1 else '' }} · 
                                                <span class="thread-date" data-date="{{ thread.latest_at }}">{{ thread.latest_at }}</span>
                                            </p>
                                        </div>
                                        <i class="fas fa-chevron-down text-slate-300 text-sm mt-1 transition-transform duration-200 thread-chevron-{{ thread.thread_id }}"></i>
                                    </div>
                                </button>

                                <!-- Expanded Thread Messages -->
                                <div id="thread-messages-{{ thread.thread_id }}" class="hidden border-t border-slate-100 bg-slate-50/50">
                                    <div class="p-4 space-y-3">
                                        {% for msg in thread.messages %}
                                        <!-- Individual Message Card -->
                                        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                                            <!-- Message Header -->
                                            <div class="px-4 py-3 border-b border-slate-100">
                                                <div class="flex items-center justify-between">
                                                    <span class="font-semibold text-slate-800">
                                                        {% if msg.direction == 'outbound' %}You{% else %}{{ msg.from_name or msg.from_email.split('@')[0] }}{% endif %}
                                                    </span>
                                                    <span class="text-xs text-slate-400 msg-date" data-date="{{ msg.sent_at }}">{{ msg.sent_at }}</span>
                                                </div>
                                                <div class="flex items-center gap-2 mt-1">
                                                    {% if msg.direction == 'outbound' %}
                                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded uppercase font-bold tracking-wide">Sent</span>
                                                    {% else %}
                                                    <span class="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded uppercase font-bold tracking-wide">Received</span>
                                                    {% endif %}
                                                    {% if msg.has_attachments %}
                                                    <span class="text-xs text-slate-400 flex items-center gap-1">
                                                        <i class="fas fa-paperclip"></i> Attachments
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <!-- Message Body -->
                                            <div class="px-4 py-3">
                                                <div class="prose prose-sm prose-slate max-w-none email-body-content text-sm text-slate-600">
                                                    {% if msg.body_html %}
                                                    {{ msg.body_html|safe }}
                                                    {% elif msg.body_text %}
                                                    <pre class="whitespace-pre-wrap font-sans text-slate-600 text-sm">{{ msg.body_text }}</pre>
                                                    {% else %}
                                                    <p>{{ msg.snippet }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Activity Modal -->
<div id="logActivityModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative bg-white w-full max-w-md rounded-xl shadow-xl">
            <!-- Modal header -->
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white rounded-t-xl">
                <div class="flex items-center space-x-3">
                    <div class="w-9 h-9 rounded-lg bg-slate-100 flex items-center justify-center">
                        <i class="fas fa-clipboard-list text-slate-500"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">Log Activity</h3>
                        <p class="text-sm text-slate-500">Record an interaction with {{ contact.first_name }}</p>
                    </div>
                </div>
                <button onclick="closeLogActivityModal()"
                    class="w-8 h-8 rounded-md hover:bg-slate-100 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-slate-400"></i>
                </button>
            </div>

            <!-- Modal content -->
            <form id="logActivityForm" class="p-6 space-y-5">
                <!-- Activity Type -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        Activity Type <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-5 gap-2">
                        <button type="button" onclick="selectActivityType('call')" data-type="call"
                            class="activity-type-btn flex flex-col items-center justify-center p-3 rounded-lg border border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition-colors">
                            <i class="fas fa-phone text-lg text-slate-500 mb-1"></i>
                            <span class="text-xs text-slate-600">Call</span>
                        </button>
                        <button type="button" onclick="selectActivityType('email')" data-type="email"
                            class="activity-type-btn flex flex-col items-center justify-center p-3 rounded-lg border border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition-colors">
                            <i class="fas fa-envelope text-lg text-slate-500 mb-1"></i>
                            <span class="text-xs text-slate-600">Email</span>
                        </button>
                        <button type="button" onclick="selectActivityType('text')" data-type="text"
                            class="activity-type-btn flex flex-col items-center justify-center p-3 rounded-lg border border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition-colors">
                            <i class="fas fa-comment text-lg text-slate-500 mb-1"></i>
                            <span class="text-xs text-slate-600">Text</span>
                        </button>
                        <button type="button" onclick="selectActivityType('meeting')" data-type="meeting"
                            class="activity-type-btn flex flex-col items-center justify-center p-3 rounded-lg border border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition-colors">
                            <i class="fas fa-users text-lg text-slate-500 mb-1"></i>
                            <span class="text-xs text-slate-600">Meeting</span>
                        </button>
                        <button type="button" onclick="selectActivityType('other')" data-type="other"
                            class="activity-type-btn flex flex-col items-center justify-center p-3 rounded-lg border border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition-colors">
                            <i class="fas fa-ellipsis-h text-lg text-slate-500 mb-1"></i>
                            <span class="text-xs text-slate-600">Other</span>
                        </button>
                    </div>
                    <input type="hidden" name="activity_type" id="activityType" required>
                </div>

                <!-- Activity Date -->
                <div>
                    <label for="activityDate" class="block text-sm font-medium text-slate-700 mb-2">
                        Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="activity_date" id="activityDate" required
                        class="w-full px-4 py-2.5 border border-slate-200 rounded-lg bg-white focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-200 transition-colors">
                </div>

                <!-- Notes -->
                <div>
                    <label for="activityNotes" class="block text-sm font-medium text-slate-700 mb-2">
                        Notes <span class="text-slate-400">(optional)</span>
                    </label>
                    <textarea name="notes" id="activityNotes" rows="3" placeholder="What did you discuss?"
                        class="w-full px-4 py-2.5 border border-slate-200 rounded-lg bg-white focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-200 transition-colors resize-none"></textarea>
                </div>

                <!-- Follow-up Date -->
                <div>
                    <label for="followUpDate" class="block text-sm font-medium text-slate-700 mb-2">
                        Follow-up Date <span class="text-slate-400">(optional)</span>
                    </label>
                    <input type="date" name="follow_up_date" id="followUpDate"
                        class="w-full px-4 py-2.5 border border-slate-200 rounded-lg bg-white focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-200 transition-colors">
                </div>
            </form>

            <!-- Modal footer -->
            <div class="flex justify-end gap-3 px-6 py-4 border-t border-slate-200 bg-slate-50 rounded-b-xl">
                <button onclick="closeLogActivityModal()"
                    class="px-5 py-2.5 border border-slate-200 rounded-lg bg-white hover:bg-slate-50 transition-colors text-sm font-medium text-slate-600">
                    Cancel
                </button>
                <button onclick="submitLogActivity()" id="logActivitySubmitBtn"
                    class="px-5 py-2.5 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors text-sm font-medium">
                    <i class="fas fa-check mr-2"></i>Log Activity
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Voice Memo Recording Modal -->
<div id="voiceMemoModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative bg-white w-full max-w-md rounded-xl shadow-xl">
            <!-- Modal header -->
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white rounded-t-xl">
                <div class="flex items-center space-x-3">
                    <div class="w-9 h-9 rounded-lg bg-slate-100 flex items-center justify-center">
                        <i class="fas fa-microphone text-slate-500"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">Voice Memo</h3>
                        <p class="text-sm text-slate-500">Record a memo for {{ contact.first_name }}</p>
                    </div>
                </div>
                <button onclick="closeVoiceMemoModal()"
                    class="w-8 h-8 rounded-md hover:bg-slate-100 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-slate-400"></i>
                </button>
            </div>

            <!-- Modal content -->
            <div class="p-6 text-center">
                <!-- Recording Status -->
                <div id="voiceMemoStatus" class="mb-6">
                    <p id="voiceMemoStatusText" class="text-slate-600">Tap the button to start recording</p>
                </div>

                <!-- Timer Display -->
                <div id="voiceMemoTimer" class="text-4xl font-mono text-slate-800 mb-6">
                    0:00
                </div>

                <!-- Record Button -->
                <div class="mb-6">
                    <button id="voiceMemoRecordBtn" onclick="toggleRecording()"
                        class="w-20 h-20 rounded-full bg-rose-500 text-white flex items-center justify-center mx-auto shadow-sm hover:bg-rose-600 transition-colors">
                        <i class="fas fa-microphone text-3xl" id="voiceMemoIcon"></i>
                    </button>
                </div>

                <!-- Audio Preview (hidden until recording complete) -->
                <div id="voiceMemoPreview" class="hidden mb-4">
                    <audio id="voiceMemoAudio" controls class="w-full"></audio>
                </div>

                <!-- Error Message -->
                <div id="voiceMemoError" class="hidden text-red-500 text-sm mb-4">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    <span id="voiceMemoErrorText"></span>
                </div>

                <!-- Info Text -->
                <p class="text-xs text-slate-400 mb-4">Maximum recording time: 3 minutes</p>
            </div>

            <!-- Modal footer -->
            <div class="flex justify-end gap-3 px-6 py-4 border-t border-slate-200 bg-slate-50 rounded-b-xl">
                <button onclick="closeVoiceMemoModal()" id="voiceMemoCancelBtn"
                    class="px-5 py-2.5 border border-slate-200 rounded-lg bg-white hover:bg-slate-50 transition-colors text-sm font-medium text-slate-600">
                    Cancel
                </button>
                <button onclick="saveVoiceMemo()" id="voiceMemoSaveBtn" disabled
                    class="px-5 py-2.5 bg-slate-800 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-900 transition-colors text-sm font-medium">
                    <i class="fas fa-save mr-2"></i>Save Memo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Voice Memo Detail Modal -->
<div id="voiceMemoDetailModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative bg-white w-full max-w-lg rounded-xl shadow-xl">
            <!-- Modal header -->
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-white rounded-t-xl">
                <div class="flex items-center space-x-3">
                    <div class="w-9 h-9 rounded-lg bg-slate-100 flex items-center justify-center">
                        <i class="fas fa-file-audio text-slate-500"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">Voice Memo</h3>
                        <p class="text-sm text-slate-500" id="memoDetailDate">-</p>
                    </div>
                </div>
                <button onclick="closeVoiceMemoDetailModal()"
                    class="w-8 h-8 rounded-md hover:bg-slate-100 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-slate-400"></i>
                </button>
            </div>

            <!-- Modal content -->
            <div class="p-6">
                <!-- Audio Player -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-slate-700">Recording</span>
                        <span class="text-sm text-slate-500" id="memoDetailDuration">0:00</span>
                    </div>
                    <audio id="memoDetailAudio" controls class="w-full"></audio>
                </div>

                <!-- Transcript Section -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-slate-700">
                            <i class="fas fa-file-alt mr-1.5 text-slate-400"></i>Transcript
                        </span>
                        <span id="memoDetailTranscriptStatus"
                            class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 hidden">
                            AI Generated
                        </span>
                    </div>
                    <div id="memoDetailTranscript"
                        class="bg-slate-50 rounded-lg p-4 min-h-[100px] max-h-[300px] overflow-y-auto">
                        <p class="text-slate-600 text-sm leading-relaxed" id="memoTranscriptText">-</p>
                    </div>
                </div>
            </div>

            <!-- Modal footer -->
            <div class="flex justify-between gap-3 px-6 py-4 border-t border-slate-200 bg-slate-50 rounded-b-xl">
                <button onclick="deleteVoiceMemoFromDetail()"
                    class="px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors text-sm font-medium">
                    <i class="fas fa-trash-alt mr-1.5"></i>Delete
                </button>
                <button onclick="closeVoiceMemoDetailModal()"
                    class="px-5 py-2.5 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors text-sm font-medium text-slate-600">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div id="taskModal" data-is-admin="{{ 'true' if current_user.role == 'admin' else 'false' }}"
    data-show-all="{{ 'true' if show_all else 'false' }}"
    class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-0 md:p-4">
        <div class="relative bg-white w-full md:rounded-xl shadow-xl md:max-w-4xl min-h-screen md:min-h-0">
            <!-- Modal header -->
            <div
                class="sticky top-0 z-10 flex items-center justify-between px-4 py-4 md:px-6 md:py-4 border-b border-slate-200 bg-white md:rounded-t-xl">
                <div class="flex items-center space-x-4">
                    <div id="modalTaskPriorityIndicator"
                        class="w-10 h-10 rounded-lg flex items-center justify-center text-base">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900" id="modalTaskSubject"></h3>
                        {% if current_user.role == 'admin' and show_all %}
                        <div class="flex items-center text-slate-500 text-sm mt-0.5 mb-1">
                            <div id="modalTaskOwnerInitials"
                                class="w-5 h-5 rounded-full bg-slate-100 flex items-center justify-center text-xs mr-2 font-medium">
                            </div>
                            <span id="modalTaskOwner"></span>
                        </div>
                        {% endif %}
                        <p class="text-sm text-slate-500" id="modalTaskHeaderDueDate"></p>
                    </div>
                </div>
                <button onclick="closeTaskModal()"
                    class="w-8 h-8 rounded-md hover:bg-slate-100 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-slate-400"></i>
                </button>
            </div>

            <!-- Modal content -->
            <div class="px-4 py-4 md:px-6 space-y-4" id="modalTaskContent">
                <!-- Status and Priority -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-slate-50 rounded-lg p-3 flex-1 border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-8 h-8 rounded-md flex items-center justify-center bg-white border border-slate-200">
                                <i class="fas fa-tasks text-slate-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Status</p>
                                <p id="modalTaskStatus" class="text-sm font-semibold text-slate-900"></p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-lg p-3 flex-1 border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-8 h-8 rounded-md flex items-center justify-center bg-white border border-slate-200">
                                <i class="fas fa-flag text-slate-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Priority</p>
                                <p id="modalTaskPriority" class="text-sm font-semibold text-slate-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Due Date and Scheduled Time -->
                <div class="flex flex-wrap gap-3">
                    <div class="bg-slate-50 rounded-lg p-3 flex-1 border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-8 h-8 rounded-md flex items-center justify-center bg-white border border-slate-200">
                                <i class="fas fa-calendar text-slate-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Due Date</p>
                                <p id="modalTaskDueDate" class="text-sm font-semibold text-slate-900"></p>
                            </div>
                        </div>
                    </div>
                    <div id="modalTaskScheduledContainer"
                        class="hidden bg-slate-50 rounded-lg p-3 flex-1 border border-slate-100">
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-8 h-8 rounded-md flex items-center justify-center bg-white border border-slate-200">
                                <i class="fas fa-clock text-slate-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500">Scheduled Time</p>
                                <p id="modalTaskScheduledTime" class="text-sm font-semibold text-slate-900"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Type and Subtype -->
                <div class="bg-slate-50 rounded-lg p-3 border border-slate-100">
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-8 h-8 rounded-md flex items-center justify-center bg-white border border-slate-200">
                            <i class="fas fa-tag text-slate-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Task Type</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span id="modalTaskType"
                                    class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-slate-200 text-slate-800"></span>
                                <span id="modalTaskSubtype"
                                    class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-slate-100 text-slate-600"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact -->
                <div class="bg-slate-50 rounded-lg p-3 border border-slate-100">
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-8 h-8 rounded-md flex items-center justify-center bg-white border border-slate-200">
                            <i class="fas fa-user text-slate-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Contact</p>
                            <a id="modalTaskContact" href="#"
                                class="text-sm font-semibold text-orange-600 hover:text-orange-700 transition-colors duration-150"></a>
                        </div>
                    </div>
                </div>

                <!-- Property Address -->
                <div id="modalTaskPropertyContainer" class="hidden bg-slate-50 rounded-lg p-3 border border-slate-100">
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-8 h-8 rounded-md flex items-center justify-center bg-white border border-slate-200">
                            <i class="fas fa-building text-slate-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Property Address</p>
                            <p id="modalTaskProperty" class="text-sm font-semibold text-slate-900"></p>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="bg-slate-50 rounded-lg p-3 border border-slate-100">
                    <div class="flex items-start space-x-3">
                        <div
                            class="w-8 h-8 rounded-md flex items-center justify-center bg-white border border-slate-200">
                            <i class="fas fa-align-left text-slate-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-slate-500">Description</p>
                            <p id="modalTaskDescription" class="mt-1 text-sm text-slate-900 whitespace-pre-line"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal footer -->
            <div
                class="sticky bottom-0 border-t border-slate-200 bg-white p-4 md:rounded-b-xl">
                <div class="flex flex-col md:flex-row md:justify-between gap-3">
                    <div class="flex flex-col md:flex-row gap-2 md:items-center md:space-x-4">
                        <button onclick="toggleTaskStatus()"
                            class="flex-1 md:flex-none text-center px-5 py-2.5 border border-slate-200 rounded-lg bg-white hover:bg-slate-50 transition-colors text-sm font-medium">
                            <span id="modalTaskStatusButton"></span>
                        </button>
                    </div>
                    <a id="modalTaskFullView" href="#"
                        class="flex-1 md:flex-none text-center px-5 py-2.5 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm font-medium">
                        Open Full View
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // =========================================================================
    // VOICE MEMO RECORDING
    // =========================================================================

    let voiceMemoRecorder = null;
    let voiceMemoStream = null;
    let voiceMemoChunks = [];
    let voiceMemoBlob = null;
    let voiceMemoTimer = null;
    let voiceMemoSeconds = 0;
    let isRecording = false;
    const MAX_RECORDING_SECONDS = 180; // 3 minutes

    // Load voice memos on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadVoiceMemos();
    });

    function showVoiceMemoModal() {
        // Reset state
        resetVoiceMemoState();
        document.getElementById('voiceMemoModal').classList.remove('hidden');
    }

    function closeVoiceMemoModal() {
        // Stop recording if in progress
        if (isRecording) {
            stopRecording();
        }
        // Stop any audio streams
        if (voiceMemoStream) {
            voiceMemoStream.getTracks().forEach(track => track.stop());
            voiceMemoStream = null;
        }
        resetVoiceMemoState();
        document.getElementById('voiceMemoModal').classList.add('hidden');
    }

    function resetVoiceMemoState() {
        voiceMemoChunks = [];
        voiceMemoBlob = null;
        voiceMemoSeconds = 0;
        isRecording = false;

        if (voiceMemoTimer) {
            clearInterval(voiceMemoTimer);
            voiceMemoTimer = null;
        }

        document.getElementById('voiceMemoTimer').textContent = '0:00';
        document.getElementById('voiceMemoStatusText').textContent = 'Tap the button to start recording';
        document.getElementById('voiceMemoIcon').className = 'fas fa-microphone text-3xl';
        document.getElementById('voiceMemoRecordBtn').classList.remove('bg-red-500', 'animate-pulse');
        document.getElementById('voiceMemoRecordBtn').classList.add('bg-rose-500');
        document.getElementById('voiceMemoPreview').classList.add('hidden');
        document.getElementById('voiceMemoError').classList.add('hidden');
        document.getElementById('voiceMemoSaveBtn').disabled = true;
    }

    async function toggleRecording() {
        if (isRecording) {
            stopRecording();
        } else {
            await startRecording();
        }
    }

    async function startRecording() {
        try {
            // Request microphone permission
            voiceMemoStream = await navigator.mediaDevices.getUserMedia({ audio: true });

            // Create MediaRecorder
            voiceMemoRecorder = new MediaRecorder(voiceMemoStream, { mimeType: 'audio/webm' });
            voiceMemoChunks = [];

            voiceMemoRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    voiceMemoChunks.push(e.data);
                }
            };

            voiceMemoRecorder.onstop = () => {
                voiceMemoBlob = new Blob(voiceMemoChunks, { type: 'audio/webm' });

                // Show audio preview
                const audioUrl = URL.createObjectURL(voiceMemoBlob);
                document.getElementById('voiceMemoAudio').src = audioUrl;
                document.getElementById('voiceMemoPreview').classList.remove('hidden');

                // Enable save button
                document.getElementById('voiceMemoSaveBtn').disabled = false;
            };

            // Start recording
            voiceMemoRecorder.start(1000); // Collect data every second
            isRecording = true;

            // Update UI
            document.getElementById('voiceMemoStatusText').textContent = 'Recording...';
            document.getElementById('voiceMemoIcon').className = 'fas fa-stop text-3xl';
            document.getElementById('voiceMemoRecordBtn').classList.remove('bg-rose-500');
            document.getElementById('voiceMemoRecordBtn').classList.add('bg-red-500', 'animate-pulse');

            // Start timer
            voiceMemoSeconds = 0;
            voiceMemoTimer = setInterval(() => {
                voiceMemoSeconds++;
                updateTimerDisplay();

                // Auto-stop at max duration
                if (voiceMemoSeconds >= MAX_RECORDING_SECONDS) {
                    stopRecording();
                }
            }, 1000);

        } catch (err) {
            console.error('Error accessing microphone:', err);
            document.getElementById('voiceMemoErrorText').textContent =
                err.name === 'NotAllowedError'
                    ? 'Microphone access denied. Please allow microphone access and try again.'
                    : 'Could not access microphone. Please check your device settings.';
            document.getElementById('voiceMemoError').classList.remove('hidden');
        }
    }

    function stopRecording() {
        if (voiceMemoRecorder && voiceMemoRecorder.state !== 'inactive') {
            voiceMemoRecorder.stop();
        }

        if (voiceMemoTimer) {
            clearInterval(voiceMemoTimer);
            voiceMemoTimer = null;
        }

        if (voiceMemoStream) {
            voiceMemoStream.getTracks().forEach(track => track.stop());
        }

        isRecording = false;

        // Update UI
        document.getElementById('voiceMemoStatusText').textContent = 'Recording complete. Preview or save your memo.';
        document.getElementById('voiceMemoIcon').className = 'fas fa-microphone text-3xl';
        document.getElementById('voiceMemoRecordBtn').classList.remove('bg-red-500', 'animate-pulse');
        document.getElementById('voiceMemoRecordBtn').classList.add('bg-rose-500');
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(voiceMemoSeconds / 60);
        const seconds = voiceMemoSeconds % 60;
        document.getElementById('voiceMemoTimer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    async function saveVoiceMemo() {
        if (!voiceMemoBlob) {
            showToast('No recording to save', 'error');
            return;
        }

        const saveBtn = document.getElementById('voiceMemoSaveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

        try {
            const formData = new FormData();
            formData.append('audio', voiceMemoBlob, 'memo.webm');
            formData.append('duration', voiceMemoSeconds);

            const response = await fetch('/contact/{{ contact.id }}/voice-memos', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast('Voice memo saved!', 'success');
                closeVoiceMemoModal();

                // Add to the list
                addVoiceMemoToList(data.memo);

                // Refresh activity timeline
                if (window.activityTimeline) {
                    window.activityTimeline.refresh();
                }
            } else {
                showToast(data.error || 'Failed to save voice memo', 'error');
            }
        } catch (err) {
            console.error('Error saving voice memo:', err);
            showToast('Failed to save voice memo. Please try again.', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Memo';
        }
    }

    async function loadVoiceMemos() {
        try {
            const response = await fetch('/contact/{{ contact.id }}/voice-memos');
            const data = await response.json();

            if (data.success && data.memos.length > 0) {
                const list = document.getElementById('voiceMemosList');
                list.innerHTML = ''; // Clear empty state

                data.memos.forEach(memo => {
                    addVoiceMemoToList(memo, false);
                });
            }
        } catch (err) {
            console.error('Error loading voice memos:', err);
        }
    }

    // Store memo data for opening detail modal
    const voiceMemoData = {};

    function addVoiceMemoToList(memo, prepend = true) {
        const list = document.getElementById('voiceMemosList');
        const emptyState = document.getElementById('voiceMemosEmpty');

        // Hide empty state if exists
        if (emptyState) {
            emptyState.remove();
        }

        // Store memo data for detail modal
        voiceMemoData[memo.id] = memo;

        const duration = formatDuration(memo.duration_seconds);

        const memoDiv = document.createElement('div');
        memoDiv.className = 'p-3 hover:bg-slate-50 transition-colors group';
        memoDiv.id = `voice-memo-${memo.id}`;
        memoDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <button onclick="event.stopPropagation(); playVoiceMemo(${memo.id}, '${memo.audio_url}')"
                    class="text-rose-500 hover:text-rose-600 transition-colors flex-shrink-0">
                    <i class="fas fa-play text-sm" id="play-icon-${memo.id}"></i>
                </button>
                <div class="flex-1 min-w-0 cursor-pointer" onclick="openVoiceMemoDetail(voiceMemoData[${memo.id}])">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-800">${duration}</span>
                        <span class="text-xs text-slate-400">${memo.created_at}</span>
                    </div>
                    ${memo.transcription ? `<p class="mt-0.5 text-sm text-slate-500 line-clamp-1">${memo.transcription}</p>` :
                (memo.transcription_status === 'pending' ? '<p class="mt-0.5 text-xs text-slate-400 italic">Transcribing...</p>' : '')}
                </div>
                <button onclick="event.stopPropagation(); deleteVoiceMemo(${memo.id})"
                    class="text-slate-300 hover:text-red-500 transition-colors flex-shrink-0 opacity-0 group-hover:opacity-100">
                    <i class="fas fa-trash-alt text-xs"></i>
                </button>
            </div>
            <audio id="audio-${memo.id}" src="${memo.audio_url}" class="hidden"></audio>
        `;

        if (prepend) {
            list.insertBefore(memoDiv, list.firstChild);
        } else {
            list.appendChild(memoDiv);
        }
    }

    function formatDuration(seconds) {
        if (!seconds) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function playVoiceMemo(memoId, audioUrl) {
        const audio = document.getElementById(`audio-${memoId}`);
        const playIcon = document.getElementById(`play-icon-${memoId}`);

        if (audio.paused) {
            // Pause all other audios
            document.querySelectorAll('[id^="audio-"]').forEach(a => {
                if (a.id !== `audio-${memoId}`) {
                    a.pause();
                    a.currentTime = 0;
                }
            });
            document.querySelectorAll('[id^="play-icon-"]').forEach(icon => {
                icon.className = 'fas fa-play text-sm';
            });

            audio.play();
            playIcon.className = 'fas fa-pause text-sm';

            audio.onended = () => {
                playIcon.className = 'fas fa-play text-sm';
            };
        } else {
            audio.pause();
            playIcon.className = 'fas fa-play text-sm';
        }
    }

    async function deleteVoiceMemo(memoId) {
        if (!confirm('Delete this voice memo?')) return;

        try {
            const response = await fetch(`/contact/{{ contact.id }}/voice-memos/${memoId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                const memoElement = document.getElementById(`voice-memo-${memoId}`);
                if (memoElement) {
                    memoElement.remove();
                }

                // Show empty state if no more memos
                const list = document.getElementById('voiceMemosList');
                if (list.children.length === 0) {
                    list.innerHTML = `
                        <div class="p-8 text-center" id="voiceMemosEmpty">
                            <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-microphone text-slate-400 text-xl"></i>
                            </div>
                            <p class="text-slate-500 text-sm">No voice memos yet</p>
                            <button onclick="showVoiceMemoModal()" class="mt-3 text-sm text-rose-600 hover:text-rose-700 font-medium">
                                <i class="fas fa-plus mr-1"></i>Record your first memo
                            </button>
                        </div>
                    `;
                }

                showToast('Voice memo deleted', 'success');
                // Refresh activity timeline
                if (window.activityTimeline) {
                    window.activityTimeline.refresh();
                }
            } else {
                showToast(data.error || 'Failed to delete voice memo', 'error');
            }
        } catch (err) {
            console.error('Error deleting voice memo:', err);
            showToast('Failed to delete voice memo', 'error');
        }
    }

    // Close voice memo modal when clicking outside
    document.getElementById('voiceMemoModal').addEventListener('mousedown', function (event) {
        if (event.target === this) {
            closeVoiceMemoModal();
        }
    });

    // =========================================================================
    // VOICE MEMO DETAIL MODAL
    // =========================================================================

    let currentDetailMemoId = null;

    function openVoiceMemoDetail(memo) {
        currentDetailMemoId = memo.id;

        // Set date
        document.getElementById('memoDetailDate').textContent = memo.created_at;

        // Set duration
        document.getElementById('memoDetailDuration').textContent = formatDuration(memo.duration_seconds);

        // Set audio
        document.getElementById('memoDetailAudio').src = memo.audio_url;

        // Set transcript
        const transcriptText = document.getElementById('memoTranscriptText');
        const statusBadge = document.getElementById('memoDetailTranscriptStatus');

        if (memo.transcription) {
            transcriptText.textContent = memo.transcription;
            statusBadge.classList.remove('hidden');
        } else if (memo.transcription_status === 'pending') {
            transcriptText.innerHTML = '<span class="text-slate-400 italic">Transcription in progress...</span>';
            statusBadge.classList.add('hidden');
        } else if (memo.transcription_status === 'failed') {
            transcriptText.innerHTML = '<span class="text-slate-400 italic">Transcription failed</span>';
            statusBadge.classList.add('hidden');
        } else {
            transcriptText.innerHTML = '<span class="text-slate-400 italic">No transcript available</span>';
            statusBadge.classList.add('hidden');
        }

        // Show modal
        document.getElementById('voiceMemoDetailModal').classList.remove('hidden');
    }

    function closeVoiceMemoDetailModal() {
        // Pause audio if playing
        const audio = document.getElementById('memoDetailAudio');
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
        currentDetailMemoId = null;
        document.getElementById('voiceMemoDetailModal').classList.add('hidden');
    }

    async function deleteVoiceMemoFromDetail() {
        if (!currentDetailMemoId) return;

        if (!confirm('Delete this voice memo?')) return;

        try {
            const response = await fetch(`/contact/{{ contact.id }}/voice-memos/${currentDetailMemoId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                const memoElement = document.getElementById(`voice-memo-${currentDetailMemoId}`);
                if (memoElement) {
                    memoElement.remove();
                }

                // Show empty state if no more memos
                const list = document.getElementById('voiceMemosList');
                if (list.children.length === 0) {
                    list.innerHTML = `
                        <div class="p-8 text-center" id="voiceMemosEmpty">
                            <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-microphone text-slate-400 text-xl"></i>
                            </div>
                            <p class="text-slate-500 text-sm">No voice memos yet</p>
                            <button onclick="showVoiceMemoModal()" class="mt-3 text-sm text-rose-600 hover:text-rose-700 font-medium">
                                <i class="fas fa-plus mr-1"></i>Record your first memo
                            </button>
                        </div>
                    `;
                }

                closeVoiceMemoDetailModal();
                showToast('Voice memo deleted', 'success');
                // Refresh activity timeline
                if (window.activityTimeline) {
                    window.activityTimeline.refresh();
                }
            } else {
                showToast(data.error || 'Failed to delete voice memo', 'error');
            }
        } catch (err) {
            console.error('Error deleting voice memo:', err);
            showToast('Failed to delete voice memo', 'error');
        }
    }

    // Close detail modal when clicking outside
    document.getElementById('voiceMemoDetailModal').addEventListener('mousedown', function (event) {
        if (event.target === this) {
            closeVoiceMemoDetailModal();
        }
    });

    // =========================================================================
    // LOG ACTIVITY MODAL
    // =========================================================================

    let selectedActivityType = null;

    function showLogActivityModal() {
        // Reset form
        document.getElementById('logActivityForm').reset();
        selectedActivityType = null;
        document.getElementById('activityType').value = '';

        // Clear activity type button selections
        document.querySelectorAll('.activity-type-btn').forEach(btn => {
            btn.classList.remove('border-slate-800', 'bg-slate-50');
            btn.classList.add('border-slate-200');
            btn.querySelector('i').classList.remove('text-slate-800');
            btn.querySelector('i').classList.add('text-slate-500');
            btn.querySelector('span').classList.remove('text-slate-800');
            btn.querySelector('span').classList.add('text-slate-600');
        });

        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('activityDate').value = today;

        // Show modal
        document.getElementById('logActivityModal').classList.remove('hidden');
    }

    function closeLogActivityModal() {
        document.getElementById('logActivityModal').classList.add('hidden');
    }

    function selectActivityType(type) {
        selectedActivityType = type;
        document.getElementById('activityType').value = type;

        // Update button styles
        document.querySelectorAll('.activity-type-btn').forEach(btn => {
            const btnType = btn.dataset.type;
            if (btnType === type) {
                btn.classList.remove('border-slate-200');
                btn.classList.add('border-slate-800', 'bg-slate-50');
                btn.querySelector('i').classList.remove('text-slate-500');
                btn.querySelector('i').classList.add('text-slate-800');
                btn.querySelector('span').classList.remove('text-slate-600');
                btn.querySelector('span').classList.add('text-slate-800');
            } else {
                btn.classList.remove('border-cyan-500', 'bg-cyan-50');
                btn.classList.add('border-slate-200');
                btn.querySelector('i').classList.remove('text-cyan-600');
                btn.querySelector('i').classList.add('text-slate-500');
                btn.querySelector('span').classList.remove('text-cyan-700');
                btn.querySelector('span').classList.add('text-slate-600');
            }
        });
    }

    function submitLogActivity() {
        const form = document.getElementById('logActivityForm');
        const formData = new FormData(form);

        // Validate
        if (!selectedActivityType) {
            showToast('Please select an activity type', 'error');
            return;
        }

        const activityDate = document.getElementById('activityDate').value;
        if (!activityDate) {
            showToast('Please select a date', 'error');
            return;
        }

        // Disable submit button
        const submitBtn = document.getElementById('logActivitySubmitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

        fetch('/contact/{{ contact.id }}/log-activity', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Activity logged successfully!', 'success');
                    closeLogActivityModal();

                    // Update the contact date fields in the UI if they exist
                    if (data.updated_dates) {
                        updateContactDates(data.updated_dates);
                    }

                    // Refresh the activity timeline
                    if (window.activityTimeline) {
                        window.activityTimeline.refresh();
                    }
                } else {
                    showToast(data.error || 'Failed to log activity', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Log Activity';
            });
    }

    function updateContactDates(dates) {
        // Update the date display fields in the contact details section
        const dateFields = {
            'last_email_date': 'lastEmailDate',
            'last_text_date': 'lastTextDate',
            'last_phone_call_date': 'lastPhoneCallDate',
            'last_contact_date': 'lastContactDate'
        };

        for (const [key, elementId] of Object.entries(dateFields)) {
            const element = document.getElementById(elementId);
            if (element && dates[key]) {
                // Format the date for display
                const date = new Date(dates[key]);
                const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                element.textContent = formatted;
            }
        }
    }

    // Close log activity modal when clicking outside
    document.getElementById('logActivityModal').addEventListener('mousedown', function (event) {
        if (event.target === this) {
            closeLogActivityModal();
        }
    });

    // Close on escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && !document.getElementById('logActivityModal').classList.contains('hidden')) {
            closeLogActivityModal();
        }
    });

    // =========================================================================
    // TASK MODAL
    // =========================================================================

    // Get configuration from data attributes
    const modalConfig = {
        modal: document.getElementById('taskModal'),
        init() {
            this.isAdmin = this.modal.dataset.isAdmin === 'true';
            this.showAll = this.modal.dataset.showAll === 'true';
            this.setupEventListeners();
        },
        setupEventListeners() {
            // Task links
            document.querySelectorAll('.task-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const taskId = link.dataset.taskId;
                    openTaskModal(taskId);
                });
            });

            // Close modal when clicking outside
            this.modal.addEventListener('mousedown', (event) => {
                if (event.target === this.modal) {
                    closeTaskModal();
                }
            });

            // Close on escape key
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeTaskModal();
                }
            });
        }
    };

    // Initialize modal configuration
    document.addEventListener('DOMContentLoaded', () => modalConfig.init());

    function toggleEditMode() {
        const viewMode = document.getElementById('viewContactInfo');
        const editMode = document.getElementById('editContactForm');
        const viewName = document.getElementById('viewContactName');
        const editName = document.getElementById('editContactName');
        const editBtn = document.getElementById('editButton');
        const saveBtn = document.getElementById('saveButton');
        const cancelBtn = document.getElementById('cancelButton');

        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        viewName.classList.add('hidden');
        editName.classList.remove('hidden');
        editBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
    }

    function cancelEdit() {
        const viewMode = document.getElementById('viewContactInfo');
        const editMode = document.getElementById('editContactForm');
        const viewName = document.getElementById('viewContactName');
        const editName = document.getElementById('editContactName');
        const editBtn = document.getElementById('editButton');
        const saveBtn = document.getElementById('saveButton');
        const cancelBtn = document.getElementById('cancelButton');

        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
        viewName.classList.remove('hidden');
        editName.classList.add('hidden');
        editBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
    }

    async function saveContact() {
        const form = document.getElementById('editContactForm');
        const formData = new FormData();

        // Explicitly add the name fields from the edit name section
        const firstNameInput = document.querySelector('input[name="first_name"]');
        const lastNameInput = document.querySelector('input[name="last_name"]');
        formData.append('first_name', firstNameInput.value);
        formData.append('last_name', lastNameInput.value);

        // Add all other form fields
        const formInputs = form.querySelectorAll('input, textarea, select');
        formInputs.forEach(input => {
            if (input.type === 'checkbox') {
                if (input.checked) {
                    formData.append(input.name, input.value);
                }
            } else {
                formData.append(input.name, input.value);
            }
        });

        try {
            const response = await fetch(`/contacts/{{ contact.id }}/edit`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.message || 'Error saving changes');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving changes. Check the console for details.');
        }
    }

    // Phone number formatting
    document.addEventListener('DOMContentLoaded', function () {
        const editForm = document.getElementById('editContactForm');
        const phoneInput = editForm.querySelector('input[name="phone"]');

        phoneInput.addEventListener('input', function (e) {
            // Remove all non-digit characters
            let inputVal = e.target.value.replace(/\D/g, '');

            // Limit to 10 digits
            if (inputVal.length > 10) {
                inputVal = inputVal.slice(0, 10);
            }

            // Build the formatted output (XXX) XXX-XXXX
            let formattedNumber = '';

            // (XXX
            if (inputVal.length > 0) {
                formattedNumber += '(' + inputVal.substring(0, 3);
            }
            // (XXX) XXX
            if (inputVal.length >= 4) {
                formattedNumber += ') ' + inputVal.substring(3, 6);
            }
            // (XXX) XXX-XXXX
            if (inputVal.length >= 7) {
                formattedNumber += '-' + inputVal.substring(6, 10);
            }

            e.target.value = formattedNumber;
        });
    });

    async function deleteContact() {
        if (!confirm('Are you sure you want to delete this contact? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/contacts/{{ contact.id }}/delete`, {
                method: 'POST'
            });

            if (response.ok) {
                window.location.href = "{{ url_for('main.contacts') }}";
            } else {
                const data = await response.json();
                alert(data.message || 'Error deleting contact');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting contact');
        }
    }

    function switchTaskView(view) {
        const pendingTab = document.getElementById('pendingTasksTab');
        const completedTab = document.getElementById('completedTasksTab');
        const pendingList = document.getElementById('pendingTasks');
        const completedList = document.getElementById('completedTasks');

        if (view === 'pending') {
            pendingTab.classList.add('text-orange-600', 'border-b-2', 'border-orange-500');
            pendingTab.classList.remove('text-slate-500');
            completedTab.classList.remove('text-orange-600', 'border-b-2', 'border-orange-500');
            completedTab.classList.add('text-slate-500');
            pendingList.classList.remove('hidden');
            completedList.classList.add('hidden');
        } else {
            completedTab.classList.add('text-orange-600', 'border-b-2', 'border-orange-500');
            completedTab.classList.remove('text-slate-500');
            pendingTab.classList.remove('text-orange-600', 'border-b-2', 'border-orange-500');
            pendingTab.classList.add('text-slate-500');
            completedList.classList.remove('hidden');
            pendingList.classList.add('hidden');
        }
    }

    function quickUpdateStatus(taskId, completed) {
        fetch(`/tasks/${taskId}/quick-update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `status=${completed ? 'completed' : 'pending'}`
        })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating task status');
            });
    }

    let currentTaskId = null;

    function openTaskModal(taskId) {
        currentTaskId = taskId;

        // Fetch task details
        fetch(`/tasks/${taskId}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(task => {
                // Update modal content
                document.getElementById('modalTaskSubject').textContent = task.subject;
                document.getElementById('modalTaskFullView').href = `/tasks/${task.id}?ref=contact&contact_id={{ contact.id }}`;

                // Owner Info (for admin view)
                if (modalConfig.isAdmin && modalConfig.showAll) {
                    const ownerInitials = document.getElementById('modalTaskOwnerInitials');
                    ownerInitials.textContent = `${task.assigned_to.first_name[0]}${task.assigned_to.last_name[0]}`;
                    document.getElementById('modalTaskOwner').textContent = `${task.assigned_to.first_name} ${task.assigned_to.last_name}`;
                }

                // Priority Indicator
                const priorityIndicator = document.getElementById('modalTaskPriorityIndicator');
                priorityIndicator.className = `w-10 h-10 rounded-lg flex items-center justify-center text-base ${task.priority === 'high' ? 'bg-red-50 text-red-500' :
                    task.priority === 'medium' ? 'bg-amber-50 text-amber-500' :
                        'bg-green-50 text-green-500'
                    }`;

                // Priority
                const priorityText = document.getElementById('modalTaskPriority');
                priorityText.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);

                // Status
                const statusText = document.getElementById('modalTaskStatus');
                statusText.textContent = task.status.charAt(0).toUpperCase() + task.status.slice(1);
                statusText.className = `text-sm font-semibold ${task.status === 'completed' ? 'text-green-600' : 'text-yellow-600'
                    }`;

                // Due Date
                const dueDate = new Date(task.due_date);
                const now = new Date();
                const diffTime = dueDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let dueDateText = '';
                if (diffDays < 0) {
                    dueDateText = `Overdue by ${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''}`;
                } else if (diffDays === 0) {
                    dueDateText = 'Due today';
                } else if (diffDays === 1) {
                    dueDateText = 'Due tomorrow';
                } else {
                    dueDateText = `Due in ${diffDays} days`;
                }

                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                const formattedDate = dueDate.toLocaleDateString('en-US', options);
                document.getElementById('modalTaskHeaderDueDate').textContent = `${dueDateText}`;
                document.getElementById('modalTaskDueDate').textContent = formattedDate;

                // Scheduled Time
                const scheduledContainer = document.getElementById('modalTaskScheduledContainer');
                const scheduledTimeText = document.getElementById('modalTaskScheduledTime');
                if (task.scheduled_time) {
                    const scheduledTime = new Date(task.scheduled_time);
                    scheduledTimeText.textContent = scheduledTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    scheduledContainer.classList.remove('hidden');
                } else {
                    scheduledContainer.classList.add('hidden');
                }

                // Type and Subtype
                document.getElementById('modalTaskType').textContent = task.task_type.name;
                document.getElementById('modalTaskSubtype').textContent = task.task_subtype.name;

                // Contact
                const contactLink = document.getElementById('modalTaskContact');
                contactLink.textContent = `${task.contact.first_name} ${task.contact.last_name}`;
                contactLink.href = `/contacts/${task.contact.id}`;

                // Property Address
                const propertyContainer = document.getElementById('modalTaskPropertyContainer');
                if (task.property_address) {
                    document.getElementById('modalTaskProperty').textContent = task.property_address;
                    propertyContainer.classList.remove('hidden');
                } else {
                    propertyContainer.classList.add('hidden');
                }

                // Description
                document.getElementById('modalTaskDescription').textContent = task.description || 'No description provided';

                // Status Button
                const statusButton = document.getElementById('modalTaskStatusButton');
                statusButton.textContent = task.status === 'completed' ? 'Mark as Pending' : 'Mark as Complete';

                // Show modal
                modalConfig.modal.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading task details');
            });
    }

    function closeTaskModal() {
        modalConfig.modal.classList.add('hidden');
        currentTaskId = null;
    }

    function toggleTaskStatus() {
        if (!currentTaskId) return;

        const newStatus = document.getElementById('modalTaskStatus').textContent.toLowerCase() === 'completed' ? 'pending' : 'completed';

        quickUpdateStatus(currentTaskId, newStatus === 'completed');
    }

    // Close modal when clicking outside or pressing Escape
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeTaskModal();
        }
    });

    document.addEventListener('click', function (event) {
        const modal = document.getElementById('taskModal');
        const modalContent = modal.querySelector('.relative');

        if (!modal.classList.contains('hidden') &&
            !modalContent.contains(event.target)) {
            closeTaskModal();
        }
    });

    // Handle clicks on the modal backdrop
    const taskModal = document.getElementById('taskModal');
    taskModal.addEventListener('mousedown', function (event) {
        // Only close if clicking directly on the backdrop (the outermost div)
        // and not on any of its children
        if (event.target === taskModal) {
            closeTaskModal();
        }
    });

    // Add event listeners for task links
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.task-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const taskId = this.getAttribute('data-task-id');
                openTaskModal(taskId);
            });
        });
    });

    // =============================================================================
    // CONTACT FILE MANAGEMENT
    // =============================================================================

    const contactId = {{ contact.id }};

    // File upload via button click
    function uploadContactFile(input) {
        if (!input.files || input.files.length === 0) return;

        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);

        // Show progress
        document.getElementById('uploadProgress').classList.remove('hidden');

        fetch(`/contact/${contactId}/files`, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('uploadProgress').classList.add('hidden');
                input.value = ''; // Reset input

                if (data.success) {
                    // Add file to list
                    addFileToList(data.file);
                    showToast('File uploaded successfully', 'success');
                    // Refresh activity timeline
                    if (window.activityTimeline) {
                        window.activityTimeline.refresh();
                    }
                } else {
                    showToast(data.error || 'Upload failed', 'error');
                }
            })
            .catch(error => {
                document.getElementById('uploadProgress').classList.add('hidden');
                input.value = '';
                showToast('Upload failed. Please try again.', 'error');
                console.error('Upload error:', error);
            });
    }

    // Add new file to the list
    function addFileToList(file) {
        const filesList = document.getElementById('contactFilesList');
        const noFilesMsg = document.getElementById('noFilesMessage');

        // Remove "no files" message if present
        if (noFilesMsg) {
            noFilesMsg.remove();
        }

        // Get icon class based on file type
        let iconClass = 'fa-file text-slate-400';
        const ext = file.original_filename.split('.').pop().toLowerCase();

        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
            iconClass = 'fa-file-image text-pink-500';
        } else if (ext === 'pdf') {
            iconClass = 'fa-file-pdf text-red-500';
        } else if (['doc', 'docx'].includes(ext)) {
            iconClass = 'fa-file-word text-blue-500';
        } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
            iconClass = 'fa-file-excel text-green-500';
        }

        const fileHtml = `
        <div class="p-3 hover:bg-slate-50 transition-colors group file-item" data-file-id="${file.id}">
            <div class="flex items-center gap-3">
                <i class="fas ${iconClass} flex-shrink-0"></i>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-slate-800 truncate">${file.original_filename}</p>
                    <p class="text-xs text-slate-500">${file.file_size} · ${file.created_at}</p>
                </div>
                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="downloadContactFile(${file.id})"
                            class="p-1.5 text-slate-400 hover:text-emerald-600 rounded transition-colors" title="Download">
                        <i class="fas fa-download text-xs"></i>
                    </button>
                    <button onclick="deleteContactFile(${file.id}, '${file.original_filename.replace(/'/g, "\\'")}')"
                            class="p-1.5 text-slate-400 hover:text-red-500 rounded transition-colors" title="Delete">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

        filesList.insertAdjacentHTML('afterbegin', fileHtml);
    }

    // Download file
    function downloadContactFile(fileId) {
        fetch(`/contact/${contactId}/files/${fileId}/download`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Open signed URL in new tab
                    window.open(data.url, '_blank');
                } else {
                    showToast(data.error || 'Download failed', 'error');
                }
            })
            .catch(error => {
                showToast('Download failed. Please try again.', 'error');
                console.error('Download error:', error);
            });
    }

    // Delete file
    function deleteContactFile(fileId, filename) {
        if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
            return;
        }

        fetch(`/contact/${contactId}/files/${fileId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from DOM
                    const fileItem = document.querySelector(`.file-item[data-file-id="${fileId}"]`);
                    if (fileItem) {
                        fileItem.remove();
                    }

                    // Show "no files" message if list is empty
                    const filesList = document.getElementById('contactFilesList');
                    if (filesList.querySelectorAll('.file-item').length === 0) {
                        filesList.innerHTML = `
                    <div id="noFilesMessage" class="p-8 text-center">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-folder-open text-slate-400 text-xl"></i>
                        </div>
                        <p class="text-slate-500 text-sm">No files uploaded</p>
                        <p class="text-slate-400 text-xs mt-1">Click upload or drag files here</p>
                    </div>
                `;
                    }

                    showToast('File deleted', 'success');
                    // Refresh activity timeline
                    if (window.activityTimeline) {
                        window.activityTimeline.refresh();
                    }
                } else {
                    showToast(data.error || 'Delete failed', 'error');
                }
            })
            .catch(error => {
                showToast('Delete failed. Please try again.', 'error');
                console.error('Delete error:', error);
            });
    }

    // Simple toast notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white z-50 transition-all duration-300 transform translate-y-2 opacity-0 ${type === 'success' ? 'bg-emerald-500' :
            type === 'error' ? 'bg-red-500' : 'bg-slate-700'
            }`;
        toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>${message}`;
        document.body.appendChild(toast);

        // Animate in
        requestAnimationFrame(() => {
            toast.classList.remove('translate-y-2', 'opacity-0');
        });

        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-y-2', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Drag and drop support
    const fileDropZone = document.getElementById('fileDropZone');
    const filesCard = fileDropZone ? fileDropZone.closest('.bg-white') : null;

    if (filesCard) {
        filesCard.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('hidden');
        });

        filesCard.addEventListener('dragleave', (e) => {
            if (!filesCard.contains(e.relatedTarget)) {
                fileDropZone.classList.add('hidden');
            }
        });

        filesCard.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('hidden');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Create a mock input event
                const input = document.getElementById('fileUploadInput');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                input.files = dataTransfer.files;
            uploadContactFile(input);
        }
    });
    }

    // =========================================================================
    // EMAIL HISTORY FUNCTIONS
    // =========================================================================

    function toggleEmailThread(threadId) {
        const messagesDiv = document.getElementById('thread-messages-' + threadId);
        const chevron = document.querySelector('.thread-chevron-' + threadId);
        const container = document.querySelector(`[data-thread-id="${threadId}"]`);

        if (messagesDiv.classList.contains('hidden')) {
            messagesDiv.classList.remove('hidden');
            chevron.classList.add('rotate-180');
            if (container) container.classList.add('bg-slate-50/30');
        } else {
            messagesDiv.classList.add('hidden');
            chevron.classList.remove('rotate-180');
            if (container) container.classList.remove('bg-slate-50/30');
        }
    }

    function scrollToEmailThread(threadId) {
        // Find the thread container in the Email History section
        const container = document.querySelector(`[data-thread-id="${threadId}"]`);

        if (container) {
            // Scroll the thread into view
            container.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Expand the thread if it's collapsed
            const messagesDiv = document.getElementById('thread-messages-' + threadId);
            if (messagesDiv && messagesDiv.classList.contains('hidden')) {
                // Wait for scroll to complete, then toggle
                setTimeout(() => {
                    toggleEmailThread(threadId);
                    // Highlight the thread briefly
                    container.classList.add('ring-2', 'ring-blue-400', 'ring-opacity-50');
                    setTimeout(() => {
                        container.classList.remove('ring-2', 'ring-blue-400', 'ring-opacity-50');
                    }, 2000);
                }, 300);
            } else {
                // Already expanded, just highlight
                container.classList.add('ring-2', 'ring-blue-400', 'ring-opacity-50');
                setTimeout(() => {
                    container.classList.remove('ring-2', 'ring-blue-400', 'ring-opacity-50');
                }, 2000);
            }
        } else {
            // Thread not found in Email History section (maybe Gmail not synced)
            showToast('Email thread not found. Try syncing your Gmail.', 'info');
        }
    }

    function toggleFullEmail(msgId) {
        const fullEmailDiv = document.getElementById('full-email-' + msgId);
        const snippetDiv = document.getElementById('msg-snippet-' + msgId);
        const toggleBtn = document.getElementById('toggle-btn-' + msgId);
        
        if (fullEmailDiv.classList.contains('hidden')) {
            fullEmailDiv.classList.remove('hidden');
            if (snippetDiv) snippetDiv.classList.add('hidden');
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-chevron-up text-xs"></i><span>Hide full message</span>';
            }
        } else {
            fullEmailDiv.classList.add('hidden');
            if (snippetDiv) snippetDiv.classList.remove('hidden');
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down text-xs"></i><span>Show full message</span>';
            }
        }
    }

    // Format email dates on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Format thread dates
        document.querySelectorAll('.thread-date, .msg-date').forEach(function(el) {
            const dateStr = el.dataset.date;
            if (dateStr) {
                // Parse ISO date string - append Z if not present to treat as UTC
                let date = new Date(dateStr.endsWith('Z') ? dateStr : dateStr + 'Z');
                
                // Fallback if invalid date
                if (isNaN(date.getTime())) {
                    date = new Date(dateStr);
                }
                
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                // Handle edge cases (future dates or very recent)
                if (diffDays < 0 || diffMs < 0) {
                    // Date appears to be in the future - show as "Just now"
                    el.textContent = 'Just now';
                } else if (diffDays === 0) {
                    // Today - show time
                    el.textContent = 'Today at ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                } else if (diffDays === 1) {
                    el.textContent = 'Yesterday';
                } else if (diffDays < 7) {
                    el.textContent = diffDays + ' days ago';
                } else {
                    el.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }
        });
    });

    // Open email modal for this contact
    function openEmailToContact() {
        emailModal.open({
            contactId: {{ contact.id }},
            to: '{{ contact.email }}',
            title: 'Email {{ contact.first_name }} {{ contact.last_name }}',
            onSend: function(result) {
                // Refresh timeline to show the sent email
                if (window.activityTimeline) {
                    window.activityTimeline.refresh();
                }
            }
        });
    }
</script>

<!-- Activity Timeline Manager -->
<script src="{{ url_for('static', filename='js/activity-timeline.js') }}"></script>
<script>
    // Initialize Activity Timeline
    document.addEventListener('DOMContentLoaded', function() {
        window.activityTimeline = new ActivityTimelineManager({{ contact.id }});
    });
</script>

<!-- Email Compose Modal -->
{% include 'modals/email_modal.html' %}

{% endblock %}